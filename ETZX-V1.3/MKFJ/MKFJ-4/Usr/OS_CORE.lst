C51 COMPILER V8.08   OS_CORE                                                               08/07/2012 09:07:58 PAGE 1   


C51 COMPILER V8.08, COMPILATION OF MODULE OS_CORE
OBJECT MODULE PLACED IN .\OS_CORE.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\OS\OS_CORE.C OPTIMIZE(SIZE) BROWSE DEBUG OBJECTEXTEND PRINT(.\OS_CORE.ls
                    -t) OBJECT(.\OS_CORE.obj)

line level    source

   1          /*********************************************************************************************************
   2          **                                                             Small RTOS(51)
   3          **                                   The Real-Time Kernel(For Keil c51)
   4          **
   5          **                                  (c) Copyright 2002-2003, chenmingji
   6          **                                           All Rights Reserved
   7          **
   8          **                                                  V1.20.1
   9          **
  10          **
  11          **--------------文件信息--------------------------------------------------------------------------------
  12          **文   件   名: OS_CORE.C
  13          **创   建   人: 陈明计
  14          **最后修改日期: 2004年2月4日
  15          **描        述: Small RTOS(51)与CPU无关的核心代码
  16          **
  17          **--------------历史版本信息----------------------------------------------------------------------------
  18          ** 创建人: 陈明计
  19          ** 版  本: V0.50~V1.00
  20          ** 日　期: 2002年2月22日~2002年6月20日
  21          ** 描　述: 基本完成Small RTOS核
  22          **
  23          **------------------------------------------------------------------------------------------------------
  24          ** 修改人: 陈明计
  25          ** 版  本: V1.10~V1.21
  26          ** 日　期: 2002年9月1日~2003年1月23日
  27          ** 描　述: 完善Small RTOS
  28          **
  29          **------------------------------------------------------------------------------------------------------
  30          ** 修改人: 陈明计
  31          ** 版  本: V1.20.0
  32          ** 日　期: 2003年8月17日
  33          ** 描　述: 增加支持任务动态建立和删除，函数功能向一般的RTOS靠齐
  34          **
  35          **------------------------------------------------------------------------------------------------------
  36          ** 修改人: 陈明计
  37          ** 版  本: V1.20.1
  38          ** 日　期: 2004年2月4日
  39          ** 描　述: 修改OSWait(K_SIG | K_TMO, x) 只能通过信号唤醒的bug。
  40          **
  41          **--------------当前版本修订------------------------------------------------------------------------------
  42          ** 修改人: 
  43          ** 日　期:
  44          ** 描　述:
  45          **
  46          **------------------------------------------------------------------------------------------------------
  47          ********************************************************************************************************/
  48          
  49          #define  IN_OS_CORE
  50          #include "config.h"
*** WARNING C318 IN LINE 77 OF config.h: can't open file 'OS_CFG.H'
*** WARNING C318 IN LINE 78 OF config.h: can't open file 'OS_CPU.H'
*** ERROR C129 IN LINE 48 OF ..\OS\OS_Q.H: missing ';' before 'OSQCreate'
  51          
C51 COMPILER V8.08   OS_CORE                                                               08/07/2012 09:07:58 PAGE 2   

  52          uint8 data OSIntNesting;
  53          
  54          uint8 data OSTaskID;
  55          uint8 data OSNextTaskID;
  56          
  57          uint8 data OSWaitTick[OS_MAX_TASKS];
  58          #if OS_MAX_TASKS < 9
*** WARNING C322 IN LINE 58 OF ..\OS\OS_CORE.C: unknown identifier
  59          uint8 data OSTaskRuning[1];
  60          uint8 data OSTaskCreated[1];
  61          #else
              uint8 data OSTaskRuning[2];
              uint8 data OSTaskCreated[2];
              #endif
  65          
  66          uint8 const OSMapTbl[] = {0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x00};
  67          uint8 data Os_Enter_Sum;
  68          
  69          
  70          void  OSSched(void) small;
  71          
  72          /*********************************************************************************************************
  73          ** 函数名称: OSInit
  74          ** 功能描述: 系统变量初始化
  75          ** 输　入: 无
  76          ** 输　出: 无
  77          ** 全局变量: 
  78          ** 调用模块: 无
  79          **
  80          ** 作　者: 陈明计
  81          ** 日　期: 2003年8月3日
  82          **-------------------------------------------------------------------------------------------------------
  83          ** 修改人:
  84          ** 日　期:
  85          **------------------------------------------------------------------------------------------------------
  86          ********************************************************************************************************/
  87                  void OSInit(void) small
  88          {
  89              OSTaskRuning[0] = 0;
  90              OSTaskCreated[0] = 0;
  91          #if OS_MAX_TASKS > 8
*** WARNING C322 IN LINE 91 OF ..\OS\OS_CORE.C: unknown identifier
                  OSTaskRuning[1] = 0;
                  OSTaskCreated[1] = 0;
              #endif
  95              Os_Enter_Sum = 0;
  96              OSTaskID = OS_MAX_TASKS;
  97              OSNextTaskID = 0;
  98              OSIntNesting = 0;
  99              OSCPUInit();
 100          }
 101          
 102          /*********************************************************************************************************
 103          ** 函数名称: _OSTaskCreate
 104          ** 功能描述: 创建任务
 105          ** 输　入: TaskID:任务ID
 106          **         task  :任务地址
 107          **         ptos  :任务堆栈，在51中为重入栈
 108          ** 输　出: 无
 109          ** 全局变量: 
 110          ** 调用模块: 无
 111          **
C51 COMPILER V8.08   OS_CORE                                                               08/07/2012 09:07:58 PAGE 3   

 112          ** 作　者: 陈明计
 113          ** 日　期: 2003年8月3日
 114          **-------------------------------------------------------------------------------------------------------
 115          ** 修改人:
 116          ** 日　期:
 117          **------------------------------------------------------------------------------------------------------
 118          ********************************************************************************************************/
 119                  uint8 _OSTaskCreate(uint8 TaskID, void (code * task)(void), void xdata *ptos) small
 120          {
 121              if (TaskID < OS_MAX_TASKS)
 122              {
 123                  OS_ENTER_CRITICAL();
 124          #if OS_MAX_TASKS < 9
*** WARNING C322 IN LINE 124 OF ..\OS\OS_CORE.C: unknown identifier
 125                  if ((OSTaskCreated[0] & OSMapTbl[TaskID]) != 0)
 126                  {
 127                      return FALSE;
 128                  }
 129                  OSTaskCreated[0] |= OSMapTbl[TaskID];
 130                  OSTaskRuning[0] |= OSMapTbl[TaskID];
 131          #else
                      if (TaskID < 8)
                      {
                          if ((OSTaskCreated[0] & OSMapTbl[TaskID]) != 0)
                          {
                              return FALSE;
                          }
                          OSTaskCreated[0] |= OSMapTbl[TaskID];
                          OSTaskRuning[0] |= OSMapTbl[TaskID];
                      }
                      else
                      {
                          if ((OSTaskCreated[1] & OSMapTbl[TaskID & 0x07]) != 0)
                          {
                              return FALSE;
                          }
                          OSTaskCreated[1] |= OSMapTbl[TaskID & 0x07];
                          OSTaskRuning[1] |= OSMapTbl[TaskID & 0x07];
                      }
              #endif
 151                  OSTaskStkInit(task, ptos, TaskID);
 152                  OSSched();
 153                  OS_EXIT_CRITICAL();
 154                  return TRUE;
 155              }
 156              return FALSE;
 157          }
 158          
 159          /*********************************************************************************************************
 160          ** 函数名称: OSTaskDel
 161          ** 功能描述: 删除任务
 162          ** 输　入: TaskID:任务ID
 163          ** 输　出: 无
 164          ** 全局变量: 
 165          ** 调用模块: 无
 166          **
 167          ** 作　者: 陈明计
 168          ** 日　期: 2003年8月3日
 169          **-------------------------------------------------------------------------------------------------------
 170          ** 修改人:
 171          ** 日　期:
 172          **------------------------------------------------------------------------------------------------------
C51 COMPILER V8.08   OS_CORE                                                               08/07/2012 09:07:58 PAGE 4   

 173          ********************************************************************************************************/
 174                  uint8 OSTaskDel(uint8 TaskID) small
 175          {
 176              if (TaskID < OS_MAX_TASKS)
 177              {
 178                  OS_ENTER_CRITICAL();
 179          #if OS_MAX_TASKS < 9
*** WARNING C322 IN LINE 179 OF ..\OS\OS_CORE.C: unknown identifier
 180                  OSTaskCreated[0] &= ~OSMapTbl[TaskID];
 181          #else
                      if (TaskID < 8)
                      {
                          OSTaskCreated[0] &= ~OSMapTbl[TaskID];
                      }
                      else
                      {
                          OSTaskCreated[1] &= ~OSMapTbl[TaskID & 0x07];
                      }
              #endif
 191                  OSTaskStkDel(TaskID);
 192                  OSSched();
 193                  OS_EXIT_CRITICAL();
 194                  return TRUE;
 195              }
 196              else
 197              {
 198                  return FALSE;
 199              }
 200          }
 201          
 202          /*********************************************************************************************************
 203          ** 函数名称: OSTaskResume
 204          ** 功能描述: 恢复任务
 205          ** 输　入: TaskID : 任务ID
 206          ** 输　出: 无
 207          ** 全局变量: OSTaskRuning
 208          ** 调用模块: 无
 209          **
 210          ** 作　者: 陈明计
 211          ** 日　期: 2003年8月3日
 212          **-------------------------------------------------------------------------------------------------------
 213          ** 修改人:
 214          ** 日　期:
 215          **------------------------------------------------------------------------------------------------------
 216          ********************************************************************************************************/
 217                  void OSTaskResume(uint8 TaskID)  small
 218          {
 219              if (TaskID < OS_MAX_TASKS)
 220              {
 221                  OS_ENTER_CRITICAL();
 222          #if OS_MAX_TASKS < 9
*** WARNING C322 IN LINE 222 OF ..\OS\OS_CORE.C: unknown identifier
 223                  OSTaskRuning[0] |= OSMapTbl[TaskID];
 224          #else
                      if (TaskID < 8)
                      {
                          OSTaskRuning[0] |= OSMapTbl[TaskID];
                      }
                      else
                      {
                          OSTaskRuning[1] |= OSMapTbl[TaskID & 0x07];
                      }
C51 COMPILER V8.08   OS_CORE                                                               08/07/2012 09:07:58 PAGE 5   

              #endif
 234                  OS_EXIT_CRITICAL();
 235              }
 236              OSSched();                                              //开始任务切换
 237          }
 238          
 239          /*********************************************************************************************************
 240          ** 函数名称: OS_TaskSuspend
 241          ** 功能描述: 使指定任务休眠，但不进行任务切换
 242          ** 输　入: TaskID : 任务ID
 243          ** 输　出: 无
 244          ** 全局变量: OSWaitTick
 245          ** 调用模块: 无
 246          **
 247          ** 作　者: 陈明计
 248          ** 日　期: 2003年8月3日
 249          **-------------------------------------------------------------------------------------------------------
 250          ** 修改人:
 251          ** 日　期:
 252          **-------------------------------------------------------------------------------------------------------
 253          ********************************************************************************************************/
 254                  void OS_TaskSuspend(uint8 TaskID)    small
 255          {
 256              if (TaskID < OS_MAX_TASKS)
 257              {
 258                  OS_ENTER_CRITICAL();
 259          #if OS_MAX_TASKS < 9
*** WARNING C322 IN LINE 259 OF ..\OS\OS_CORE.C: unknown identifier
 260                  OSTaskRuning[0] &= ~OSMapTbl[TaskID];
 261          #else
                      if (TaskID < 8)
                      {
                          OSTaskRuning[0] &= ~OSMapTbl[TaskID];
                      }
                      else
                      {
                          OSTaskRuning[1] &= ~OSMapTbl[TaskID & 0x07];
                      }
              #endif
 271                  OS_EXIT_CRITICAL();
 272              }
 273          }
 274          
 275          
 276          /*********************************************************************************************************
 277          ** 函数名称: OSTaskSuspend
 278          ** 功能描述: 使指定任务休眠
 279          ** 输　入: TaskID : 任务ID
 280          ** 输　出: 无
 281          ** 全局变量: OSWaitTick
 282          ** 调用模块: OS_TaskSuspend,OSSched
 283          **
 284          ** 作　者: 陈明计
 285          ** 日　期: 2003年8月3日
 286          **-------------------------------------------------------------------------------------------------------
 287          ** 修改人:
 288          ** 日　期:
 289          **-------------------------------------------------------------------------------------------------------
 290          ********************************************************************************************************/
 291                  void OSTaskSuspend(uint8 TaskID)    small
 292          {
 293              OSWaitTick[TaskID] = 0;                                 /* 没有超时处理         */
C51 COMPILER V8.08   OS_CORE                                                               08/07/2012 09:07:58 PAGE 6   

 294          
 295              OS_TaskSuspend(TaskID);
 296              OSSched();                                              /* 开始任务切换 */
 297          }
 298          
 299          /*********************************************************************************************************
 300          ** 函数名称: OSFindNextRunningTask
 301          ** 功能描述: 查找下一个优先级最高的就绪任务
 302          ** 输　入: 无
 303          ** 输　出: OSNextTaskID:存储查找结果
 304          ** 全局变量: OSTaskRuning,OSTaskCreated
 305          ** 调用模块: 无
 306          **
 307          ** 作　者: 陈明计
 308          ** 日　期: 2003年8月3日
 309          **-------------------------------------------------------------------------------------------------------
 310          ** 修改人:
 311          ** 日　期:
 312          **-------------------------------------------------------------------------------------------------------
 313          ********************************************************************************************************/
 314                  void OSFindNextRunningTask(void) small
 315          {
 316              uint8 temp;
 317          
 318              temp = OSTaskRuning[0] & OSTaskCreated[0];
 319          #if OS_MAX_TASKS < 9
*** WARNING C322 IN LINE 319 OF ..\OS\OS_CORE.C: unknown identifier
 320                          /* 查找处于就绪状态的任务中优先级最高的任务 */
 321              for (OSNextTaskID = 0; OSNextTaskID < OS_MAX_TASKS; OSNextTaskID++)
 322              {
 323                  if ((temp & 0x01) != 0)
 324                  {
 325                      break;
 326                  }
 327                  temp = temp >> 1;
 328              }
 329              return;
 330          #else
                              /* 查找处于就绪状态的任务中优先级最高的任务 */
                  for (OSNextTaskID = 0; OSNextTaskID < 8; OSNextTaskID++)
                  {
                      if ((temp & 0x01) != 0)
                      {
                          return;
                      }
                      temp = temp >> 1;
                  }
                  temp = OSTaskRuning[1] & OSTaskCreated[1];
                  for (; OSNextTaskID < OS_MAX_TASKS; OSNextTaskID++)
                  {
                      if ((temp & 0x01) != 0)
                      {
                          break;
                      }
                      temp = temp >> 1;
                  }
                  return;
              #endif
 351          }
 352          
 353          /*********************************************************************************************************
 354          ** 函数名称: OSIntExit
C51 COMPILER V8.08   OS_CORE                                                               08/07/2012 09:07:58 PAGE 7   

 355          ** 功能描述: 中断退出处理函数,在此进行中断后的任务切换
 356          ** 输　入: 无
 357          ** 输　出: 无
 358          ** 全局变量: OSIntNesting,OSNextTaskID
 359          ** 调用模块: OSIntCtxSw
 360          **
 361          ** 作　者: 陈明计
 362          ** 日　期: 2003年8月3日
 363          **-------------------------------------------------------------------------------------------------------
 364          ** 修改人:
 365          ** 日　期:
 366          **------------------------------------------------------------------------------------------------------
 367          ********************************************************************************************************/
 368                  uint8 OSIntExit(void)    small
 369          
 370          {
 371              OS_ENTER_CRITICAL();
 372                          /* 中断嵌套处理 */
 373              if (OSIntNesting > 0)
 374              {
 375                  OSIntNesting--;
 376              }
 377              if (OSIntNesting == 0)
 378              {
 379                  Os_Enter_Sum = 0;               /* 因为在中断中，所以关中断计数器为0 */
 380                  OSFindNextRunningTask();
 381                  OSIntCtxSw();                   /* 进行任务调度 */
 382                  return TRUE;
 383              }
 384              OS_EXIT_CRITICAL();
 385              return FALSE;
 386          }
 387          
 388          /*********************************************************************************************************
 389          ** 函数名称: OSSched
 390          ** 功能描述: 非中断的任务切换函数
 391          ** 输　入: 无
 392          ** 输　出: 无
 393          ** 全局变量: OSIntNesting,OSNextTaskID
 394          ** 调用模块: OS_TASK_SW
 395          **
 396          ** 作　者: 陈明计
 397          ** 日　期: 2003年8月3日
 398          **------------------------------------------------------------------------------------------------------
 399          ** 修改人:
 400          ** 日　期:
 401          **-------------------------------------------------------------------------------------------------------
 402          ********************************************************************************************************/
 403                  void  OSSched(void) small
 404          
 405          {
 406              OS_ENTER_CRITICAL();
 407              if (OSIntNesting == 0)              /* 是否是中断中调用 */
 408              {
 409                  OSFindNextRunningTask();
 410                  OS_TASK_SW();                   /* 进行任务调度 */
 411              }
 412              OS_EXIT_CRITICAL();
 413          }
 414          
 415          /*********************************************************************************************************
 416          ** 函数名称: OSTimeTick
C51 COMPILER V8.08   OS_CORE                                                               08/07/2012 09:07:58 PAGE 8   

 417          ** 功能描述: 系统时钟处理函数,处理各个任务的延时
 418          ** 输　入: 无
 419          ** 输　出: 无
 420          ** 全局变量: OSWaitTick
 421          ** 调用模块: OSIntSendSignal
 422          **
 423          ** 作　者: 陈明计
 424          ** 日　期: 2003年8月3日
 425          **------------------------------------------------------------------------------------------------------
 426          ** 修改人:
 427          ** 日　期:
 428          **-------------------------------------------------------------------------------------------------------
 429          ********************************************************************************************************/
 430                  void  OSTimeTick(void)  small
 431          {
 432              uint8 i;
 433          
 434              for (i = 0; i < OS_MAX_TASKS; i++)                 
 435              {
 436                  if (OSWaitTick[i] != 0 )
 437                  {
 438                      OSWaitTick[i]--;
 439                      if (OSWaitTick[i] == 0)
 440                      {
 441          #if OS_MAX_TASKS < 9
*** WARNING C322 IN LINE 441 OF ..\OS\OS_CORE.C: unknown identifier
 442                          OSTaskRuning[0] |= OSMapTbl[i];
 443          #else
                              if (i < 8)
                              {
                                  OSTaskRuning[0] |= OSMapTbl[i];
                              }
                              else
                              {
                                  OSTaskRuning[1] |= OSMapTbl[i & 0x07];
                              }
              #endif
 453                      }
 454                  }
 455              }
 456              OSSched();
 457          }
 458          
 459          /*********************************************************************************************************
 460          ** 函数名称: OSTimeDly
 461          ** 功能描述: 系统等待函数,任务调用此函数可以等待一定时间
 462          ** 输　入:  ticks : 等待超时时的系统嘀嗒数
 463          ** 输　出 : 无
 464          **
 465          ** 全局变量: OSWaitTick
 466          ** 调用模块: OS_TaskSuspend,OSSched
 467          **
 468          ** 作　者: 陈明计
 469          ** 日　期: 2003年8月3日
 470          **-------------------------------------------------------------------------------------------------------
 471          ** 修改人:
 472          ** 日　期:
 473          **-------------------------------------------------------------------------------------------------------
 474          ********************************************************************************************************/
 475                  void OSTimeDly(uint8 ticks)     small
 476          {
 477              OSWaitTick[OSTaskID] = ticks;               /* 设置超时时间         */
C51 COMPILER V8.08   OS_CORE                                                               08/07/2012 09:07:58 PAGE 9   

 478              OS_ENTER_CRITICAL();
 479              while (OSWaitTick[OSTaskID] != 0)           /* 判断超时时间是否到   */
 480              {
 481                  OS_TaskSuspend(OSTaskID);               /* 任务进入等待状态     */
 482                  OSSched();                               /* 开始任务切换         */
 483              }
 484              OS_EXIT_CRITICAL();
 485          }
 486          
 487          /*********************************************************************************************************
 488          ** 函数名称: OSTimeDlyResume
 489          ** 功能描述: 让处在延时期的任务结束延时
 490          ** 输　入:  TaskID : 任务ID
 491          ** 输　出 : 无
 492          ** 全局变量: OSWaitTick
 493          ** 调用模块: OSTaskResume
 494          **
 495          ** 作　者: 陈明计
 496          ** 日　期: 2003年8月3日
 497          **-------------------------------------------------------------------------------------------------------
 498          ** 修改人:
 499          ** 日　期:
 500          **-------------------------------------------------------------------------------------------------------
 501          ********************************************************************************************************/
 502                  void OSTimeDlyResume(uint8 TaskID)    small
 503          {
 504              OSWaitTick[TaskID] = 0;
 505              OSTaskResume(TaskID);
 506          }
 507          
 508          
 509          /*********************************************************************************************************
 510          ** 函数名称: OSWait
 511          ** 功能描述: 系统等待函数,任务调用此函数可以等待一定时间或信号
 512          ** 输　入: typ: 等待事件类型,目前可以取以下值,或是其中任意个值的按位或
 513          **             K_SIG: 等待信号
 514          **             K_TMO: 等待超时
 515          **        ticks : 等待超时时的系统嘀嗒数
 516          ** 输　出 : NOT_OK : 参数错误
 517          **         TMO_EVENT : 超时到
 518          **         SIG_EVENT : 有信号
 519          ** 全局变量: OSWaitTick
 520          ** 调用模块: OSTaskSuspend,OSTimeDly,OS_ENTER_CRITICAL,OS_EXIT_CRITICAL
 521          **
 522          ** 作　者: 陈明计
 523          ** 日　期: 2003年8月3日
 524          **------------------------------------------------------------------------------------------------------
 525          ** 修改人: 陈明计
 526          ** 日　期: 2004年2月4日
 527          **-------------------------------------------------------------------------------------------------------
 528          ********************************************************************************************************/
 529          #ifndef OSWait_EN
 530          #define OSWait_EN   0
 531          #endif
 532          
 533          #if OSWait_EN > 0
                      uint8 OSWait(uint8 typ, uint8 ticks)    small
              {
                  OSWaitTick[OSTaskID] = ticks;               /* 设置超时时间         */
                                                              /* 可以优化寄存器的使用  */
                  switch(typ)
                  {
C51 COMPILER V8.08   OS_CORE                                                               08/07/2012 09:07:58 PAGE 10  

                  case K_SIG:                                 /* 等待信号，即挂起自己  */
                      OSTaskSuspend(OSTaskID);
                      return SIG_EVENT;
                  case K_TMO:                                 /* 等待超时，即延时一段时间 */
                      OSTimeDly(OSWaitTick[OSTaskID]);
                      return TMO_EVENT;
                  case (K_TMO | K_SIG):                       /* 等待信号（挂起自己）直到超时  */
                                                              /* 别的任务或中断可以恢复它 */
                      OS_ENTER_CRITICAL();
                      if (OSWaitTick[OSTaskID] == 0)          /* 判断超时时间是否到   */
                      {
                          return TMO_EVENT;
                      }
                      OS_TaskSuspend(OSTaskID);               /* 任务进入等待状态     */
                      OSSched();
                      OS_EXIT_CRITICAL();
                      if (OSWaitTick[OSTaskID] != 0)
                      {
                          OSWaitTick[OSTaskID] = 0;
                          return SIG_EVENT;
                      }
                      return TMO_EVENT;
                  default:
                      OSWaitTick[OSTaskID] = 0;
                      return NOT_OK;
                  }
              }
              #endif
 568          /*********************************************************************************************************
 569          **                            End Of File
 570          ********************************************************************************************************/

C51 COMPILATION COMPLETE.  10 WARNING(S),  1 ERROR(S)
