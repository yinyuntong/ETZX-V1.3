C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE SINGLEBUS
OBJECT MODULE PLACED IN SingleBus.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE SingleBus.c OPTIMIZE(SIZE) BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*
   2          ************************Copyright(c)************************
   3          *                                  湖南熙旺达科技有限公司
   4          *                               All Rights Reserved
   5          *                                        
   6          *
   7          *-----------------------文件信息---------------------------
   8          *文件名称               :SingleBus.c
   9          *文件描述               :单总线程序
  10          *创建人                 :陈卫国
  11          *创建日期               :2008-9-22
  12          *版本号                 :V1.0
  13          *注释                   :                                       
  14          *----------------------------------------------------------
  15          *修改人                         :
  16          *修改日期                       :
  17          *版本号                 :
  18          *注释                   :
  19          ***********************************************************
  20          */
  21          #define _IN_SINGLE_BUS_
  22          #include "config.h"
  23          extern uint8    xdata  GT23_Rec_Data[128];
  24          
  25          //总线0变量定义
  26          uint8 bdata byBus0State0        = 0;                                                    //单总线0状态字1
  27          sbit  bBus0StartRec                     = byBus0State0^0;                               //单总线0开始接收起始位标志
  28          sbit  bBus0OnRec                        = byBus0State0^1;                               //单总线0开始接收数据位标志
  29          sbit  bBus0Enable                       = byBus0State0^2;                               //单总线0允许发送标志
  30          sbit  bBus0ReqSend                      = byBus0State0^3;                               //单总线0请求发送标志
  31          sbit  bBus0OnSendBit            = byBus0State0^4;                               //单总线0正在发送一个数据位标志
  32          sbit  bBus0OnSendFreq           = byBus0State0^5;                               //单总线0正在发送一个数据帧标志
  33          sbit  bBus0SendError            = byBus0State0^6;                               //单总线0发送错误标志
  34          sbit  bBus0Error                        = byBus0State0^7;                               //单总线0故障标志
  35          uint8 bdata byBus0State1        = 0;                                                    //单总线0状态字2
  36          sbit  bBus0RecFinish            = byBus0State1^0;                               //单总线0接收完成标志
  37          sbit  bBus0RecBit9                      = byBus0State1^1;                               //单总线0接收字节数据的第9位
  38          sbit  bBus0SendFinish           = byBus0State1^2;                               //单总线0发送完成标志
  39          sbit  bBus0Disable                      = byBus0State1^3;                               //单总线0禁止发送标志
  40          sbit  bBus0SendBit                      = byBus0State1^4;                               //单总线0正在发送的数据位
  41          sbit  bBus0RecBit                       = byBus0State1^5;                               //单总线0正在接收的数据位
  42          uint8 data byBus0RecCount = 0;                                                          //高4位是总线0接收定时中断计数，低4位是接收到的位计数
  43          uint8 data byBus0RecBuf;                                                                        //总线0接收缓冲单元
  44          uint8 data byBus0SendBuf;                                                                       //总线0发送缓冲单元     
  45          uint8 data byBus0RecData[BUS0_FREQ_SIZE];                                       //总线0接收缓冲区
  46          uint8 data byBus0SendData[BUS0_FREQ_SIZE];                                      //总线0发送缓冲区
  47          uint8 data byBus0SendCount = 0;                                                         //高4位是总线0发送定时中断计数，低4位是发送的位计数
  48          uint8 data byBus0RecSendCount = 0;                                                      //高4位是总线0接收到的字节计数，低4位是总线0发送完的字节计数
  49          uint8 data byBus0SendStopCount;                                                         //总线0停止时间计数
  50          uint8 data byBus0RecTimeOut = 0;                                                        //总线0接收超时计数
  51          uint8 data byBus0DisableCount = 0;                                                      //总线0禁止计数  
  52          uint8 idata byBus0TxQ[BUS0_TX_Q_ZISE];                                          //总线0发送队列                                                 
  53          uint8 data byBus0TxHead = 0;                                                            //单总线0发送队列头指针
  54          uint8 data byBus0TxTail = 0;                                                            //单总线0发送队列尾指针
  55          #define IncBus0TxPtr(addr)    {addr=(addr+1)%BUS0_TX_Q_ZISE;}
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 2   

  56          #define Bus0TxBuffLen()       ((byBus0TxTail+BUS0_TX_Q_ZISE-byBus0TxHead)%BUS0_TX_Q_ZISE)
  57          //发送和接收引脚定义
  58          sbit  Bus0RecPin        = P3^2;                                                                 //单总线1接收引脚定义
  59          sbit  Bus0SendPin       = P4^3;                                                                 //单总线1发送引脚定义
  60          
  61          extern STUartControl    idata stUartControl;
  62          extern STLocalControl   xdata stLocalControl;
  63          uint16  xdata PageNumber=0;
  64          uint16  xdata SerchRoomCount=0;                                            //查房的时间计数器
  65          uint16  xdata SET_BY_SERIAL_COUNT=0;                                       //编号的时间计数器    
  66          uint8   xdata SerchRoom=0;
  67          uint8   xdata Real_TimeBuf[5]={0x00,0x00,0x00,0x00,0x00};
  68          uint32  xdata INSPERCTOR_Count=0;
  69          uint16  xdata BusLow_Count=0;
  70          uint16  xdata Self_BusLow_Count=0;
  71          uint16  xdata Self_BusHigh_Count=0;
  72          bit   BusLow_Flag;
  73          bit   Self_BusLow_Flag;
  74          bit   SerchRoomFlag;
  75          bit   SerchRoomKeyFlag;
  76          bit   SET_BY_SERIAL_FLAG;                                 //单总线对设备编号标志位
  77          bit   HaveSerchRoomFlag;
  78          bit   Page_Flag;
  79          bit   INSPERCTOR_Flag;
  80          bit   INDICTION_Flag;
  81          bit   NUMBER_SET_STOP_FLAG;
  82          bit   AllBusLow_Flag;
  83          bit   BusLowRenewOK_Flag;
  84          extern bit   Display_BusLow_Flag;
  85          extern uint8 xdata  Modify_Room_Number;
  86          extern uint8 xdata  Modify_SEC_Name;
  87          extern bit Broadcasting_Flag;
  88          extern bit CheckBusLow_Flag;
  89          uint16 xdata  INDICTION_Count=0; 
  90          //---------------------------------
  91          //---------------------------------
  92          //2012/5/26添加多个护士到位
  93          uint16 xdata NurseComeCount=0;
  94          uint8  xdata NurseComeRoom[3]={0,0,0};
  95          //---------------------------------
  96          //---------------------------------
  97          extern uint8 xdata  Page_Color[5]; 
  98          extern bit Key_SerchRoom_Flag2;
  99          extern bit Key_SerchRoom_Flag3;
 100          //uint16 xdata AllBusLow_Count=0;
 101          extern uint8  xdata Fbaud_Type;
 102          extern uint32 xdata Fbaud;   //波特率的数值
 103          
 104          
 105          extern bit bLcdOn;
 106          uint8 xdata BusLowDTime=100;
 107          
 108          bit bBus0SndBitOk =0;
 109          
 110          extern void Delayms(uint16 ms);
 111          
 112          
 113          void ReadPageColour(void)
 114          {
 115   1          uint16 xdata fcolor,bcolor,ccolor;
 116   1              uint8  xdata byData1,byData2,byData3;
 117   1          if(Modify_SEC_Name==0x01)
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 3   

 118   1          {
 119   2            byData1=Page_Color[0];//字体颜色 
 120   2                byData2=Page_Color[1];//字体背景色,也是清屏色
 121   2                byData3=Page_Color[2];//中间填充色
 122   2                if(byData1==0x00) 
 123   2                fcolor= BLACK;
 124   2                else if(byData1==0x01) 
 125   2                fcolor= RED;
 126   2                else if(byData1==0x02) 
 127   2                fcolor= GREEN;
 128   2                else if(byData1==0x03) 
 129   2                fcolor= BLUE1;
 130   2                else if(byData1==0x04) 
 131   2                fcolor= BLUE;
 132   2                else if(byData1==0x05) 
 133   2                fcolor= YELLOW;
 134   2                else if(byData1==0x06) 
 135   2                fcolor= PURPLE;
 136   2                else if(byData1==0x07) 
 137   2                fcolor= CYAN;
 138   2                else if(byData1==0x08) 
 139   2                fcolor= WHITE;
 140   2                else
 141   2                fcolor=WHITE;//字体颜色
 142   2            if(byData2==0x00) 
 143   2                bcolor= BLACK;
 144   2                else if(byData2==0x01) 
 145   2                bcolor= RED;
 146   2                else if(byData2==0x02) 
 147   2                bcolor= GREEN;
 148   2                else if(byData2==0x03) 
 149   2                bcolor= BLUE1;
 150   2                else if(byData2==0x04) 
 151   2                bcolor= BLUE;
 152   2                else if(byData2==0x05) 
 153   2                bcolor= YELLOW;
 154   2                else if(byData2==0x06) 
 155   2                bcolor= PURPLE;
 156   2                else if(byData2==0x07) 
 157   2                bcolor= CYAN;
 158   2                else if(byData2==0x08) 
 159   2                bcolor= WHITE;
 160   2                else
 161   2                bcolor=BLUE1; 
 162   2                if(byData3==0x00) 
 163   2                ccolor= BLACK;
 164   2                else if(byData3==0x01) 
 165   2                ccolor= RED;
 166   2                else if(byData3==0x02) 
 167   2                ccolor= GREEN;
 168   2                else if(byData3==0x03) 
 169   2                ccolor= BLUE1;
 170   2                else if(byData3==0x04) 
 171   2                ccolor= BLUE;
 172   2                else if(byData3==0x05) 
 173   2                ccolor= YELLOW;
 174   2                else if(byData3==0x06) 
 175   2                ccolor= PURPLE;
 176   2                else if(byData3==0x07) 
 177   2                ccolor= CYAN;
 178   2                else if(byData3==0x08) 
 179   2                ccolor= WHITE;
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 4   

 180   2                else
 181   2                ccolor=YELLOW; 
 182   2          }
 183   1              else
 184   1              {
 185   2                fcolor=WHITE;//字体颜色
 186   2                bcolor=BLUE1; //字体背景色,也是清屏色
 187   2                ccolor=YELLOW;//房号与几床到几床的中间填充颜色
 188   2              }
 189   1          Lcd_Clear(bcolor,0);
 190   1              Lcd_Fill(0,168,480,10,ccolor);
 191   1          if(Modify_SEC_Name==0x01)
 192   1          {
 193   2             byData1=Page_Color[3];//字体颜色 
 194   2                 byData2=Page_Color[4];//字体背景色,也是清屏色
 195   2                 if(byData1==0x00) 
 196   2                 fcolor= BLACK;
 197   2                 else if(byData1==0x01) 
 198   2                 fcolor= RED;
 199   2                 else if(byData1==0x02) 
 200   2                 fcolor= GREEN;
 201   2                 else if(byData1==0x03) 
 202   2                 fcolor= BLUE1;
 203   2                 else if(byData1==0x04) 
 204   2                 fcolor= BLUE;
 205   2                 else if(byData1==0x05) 
 206   2                 fcolor= YELLOW;
 207   2                 else if(byData1==0x06) 
 208   2                 fcolor= PURPLE;
 209   2                 else if(byData1==0x07) 
 210   2                 fcolor= CYAN;
 211   2                 else if(byData1==0x08) 
 212   2                 fcolor= WHITE;
 213   2                 else
 214   2                 fcolor=WHITE;//字体颜色
 215   2             if(byData2==0x00) 
 216   2                 bcolor= BLACK;
 217   2                 else if(byData2==0x01) 
 218   2                 bcolor= RED;
 219   2                 else if(byData2==0x02) 
 220   2                 bcolor= GREEN;
 221   2                 else if(byData2==0x03) 
 222   2                 bcolor= BLUE1;
 223   2                 else if(byData2==0x04) 
 224   2                 bcolor= BLUE;
 225   2                 else if(byData2==0x05) 
 226   2                 bcolor= YELLOW;
 227   2                 else if(byData2==0x06) 
 228   2                 bcolor= PURPLE;
 229   2                 else if(byData2==0x07) 
 230   2                 bcolor= CYAN;
 231   2                 else if(byData2==0x08) 
 232   2                 bcolor= WHITE;
 233   2                 else
 234   2                 bcolor=WHITE; 
 235   2          }
 236   1              else
 237   1              {
 238   2                 fcolor=BLUE1;//字体颜色
 239   2                 bcolor=WHITE;//字体背景色,也是清屏色
 240   2              }
 241   1          Lcd_Fill(0,178,480,94,bcolor);      
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 5   

 242   1      } 
 243          /**********************************************************
 244          *函数名称                       :SingleBusInit  
 245          *函数描述               :单总线初始化
 246          *输入参数               :
 247          *返回值                         :       
 248          *全局变量                       :
 249          *调用模块                       :
 250          ***********************************************************
 251          *创建人                 :陈卫国
 252          *创建日期                       :2008-9-22
 253          ***********************************************************
 254          *修改人                         :
 255          *修改日期               :
 256          *注释                   :
 257          **********************************************************/
 258          void SingleBusInit(void)
 259          {
 260   1              //总线0发送脚设置为推挽输出，接收脚设置为高阻输入
 261   1              P4M1 &= 0xF7;
 262   1          P4M0 |= 0x08;
 263   1              P3M1 |= 0x04;
 264   1          P3M0 &= 0xFB;
 265   1              //总线电平设置
 266   1              Bus0SendPin = 0;
 267   1              Bus0RecPin  = 1;        
 268   1              TMOD |= 0x01;
 269   1              TL0 = TIMER0_L;
 270   1              TH0 = TIMER0_H;
 271   1              TF0 = 0;                                                                                                //清除中断标志
 272   1              AUXR &= 0x7F;                                                                                   //传统12分频速度  
 273   1              ET0 = 1;                                                                                                //允许定时器0中断 
 274   1              TR0 = 1;                                                                                                //启动定时器
 275   1              //其它控制设置
 276   1              byBus0SendStopCount = 240;                                                              //上电总线0禁止发送时间设置
 277   1              IE0 = 0;
 278   1              IT0 = 1;                                                                                                //外部中断0为下降沿触发模式                     
 279   1              if(Bus0RecPin)
 280   1              {       //如果总线正常,开中断                   
 281   2                      EX0 = 1;
 282   2              }
 283   1              else
 284   1              {       //如果总线不正常,置总线故障标志                 
 285   2                      bBus0Error = 1;
 286   2              } 
 287   1              PageNumber=0;   
 288   1      }
 289          /**********************************************************
 290          *函数名称                       :Bus0RecInt     
 291          *函数描述               :外部中断0函数,单总线0接收中断
 292          *输入参数               :
 293          *返回值                         :       
 294          *全局变量                       :
 295          *调用模块                       :
 296          ***********************************************************
 297          *创建人                 :陈卫国
 298          *创建日期                       :2008-9-22
 299          ***********************************************************
 300          *修改人                         :
 301          *修改日期               :
 302          *注释                   :
 303          **********************************************************/
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 6   

 304          #pragma disable
 305          void Bus0RecInt(void) interrupt 0
 306          { 
 307   1              DisableBus0RecInt();                                                                    //禁止再次下降沿中断
 308   1              bBus0StartRec = 1;                                                                              //启动起始位沿检测
 309   1              bBus0Enable = 0;                                                                                //禁止总线发送                                                  
 310   1              byBus0RecCount = 0;                                                                             //清接收寄存器  
 311   1      }
 312          /**********************************************************
 313          *函数名称                       :Timer0Int      
 314          *函数描述               :定时器0溢出中断,定时器每93.75us中断一次
 315                                                   程序间隔检查总线0与总线1的接收和发送
 316          *输入参数               :
 317          *返回值                         :       
 318          *全局变量                       :
 319          *调用模块                       :
 320          ***********************************************************
 321          *创建人                 :陈卫国
 322          *创建日期                       :2008-9-22
 323          ***********************************************************
 324          *修改人                         :
 325          *修改日期               :
 326          *注释                   :
 327          **********************************************************/
 328          #pragma disable
 329          void Timer0Int(void) interrupt 1
 330          { 
 331   1          TR0=0;
 332   1              TH0=TIMER0_H;
 333   1              TL0=TIMER0_L;
 334   1              TR0=1;
 335   1      
 336   1              bBus0RecBit = Bus0RecPin;       
 337   1              /*******************************总线0接收处理***********************************/
 338   1          if(bBus0StartRec)                                                                           //判断总线所处的状态，接收到起始位
 339   1              {                       
 340   2                      byBus0RecCount += 0x10;                                                         //增加定时中断计数次数
 341   2                      if(0x50 == (byBus0RecCount & 0xf0))                                     //到总线起始位检测时间
 342   2                      {                       
 343   3                              bBus0StartRec = 0;
 344   3                              byBus0RecCount = 0x00;                                                  //重新开始计数                  
 345   3                              if(bBus0RecBit)                 
 346   3                              {       //无效起始位                                                                                                                                            
 347   4                                      if((!bBus0SendError)&&bBus0OnSendFreq)
 348   4                                      {       //没有发生过总线发送错误,且有一帧数据正在发送,停止帧数据发送,置发送错误标志                                             
 349   5                                              byBus0State0 &= (~BUS0_SEND_CON);
 350   5                                              bBus0SendError = 1;
 351   5                                              Bus0SendPin = 0;                                                //释放总线                                      
 352   5                                      }                               
 353   4                                      byBus0SendStopCount = 240;                                      
 354   4                                      byBus0RecSendCount = 0x00;                                      //接收出错,重置接收发送计数值
 355   4                                      EnableBus0RecInt();
 356   4                                      PW = bPWState;                                                          //恢复语音功放的控制引脚
 357   4                              }
 358   3                              else                                                            
 359   3                              {       //有效起始位
 360   4                                      bBus0OnRec = 1;                                                         //开始接收数据位                                                                                        
 361   4                              }
 362   3                      }
 363   2              }
 364   1              else if(bBus0OnRec)
 365   1              {               
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 7   

 366   2                      byBus0RecCount += 0x10;                                                         //增加定时中断计数次数                  
 367   2                      if(0xa0 == (byBus0RecCount & 0xf0))
 368   2                      {
 369   3                              byBus0RecCount &= 0x0f;                                                 //清除定时中断计数次数
 370   3                              byBus0RecCount += 0x01;
 371   3                              if(0x0a == (byBus0RecCount & 0x0f))     
 372   3                              {       //收到第10位,结束位                                     
 373   4                                      bBus0OnRec = 0;                                                         //停止数据接收                                  
 374   4                                      if(bBus0RecBit)
 375   4                                      {       //有效的结束位                                                  
 376   5                                              if(((bit)(byBus0RecSendCount & 0xf0) == bBus0RecBit9)) 
 377   5                                              {       //数据桢错误
 378   6                                                      byBus0RecTimeOut = 0;
 379   6                                                      byBus0RecSendCount &= 0x0f;                                                                                     
 380   6                                              }
 381   5                                              else 
 382   5                                              {       //数据桢正确                                    
 383   6                                                      byBus0RecTimeOut = 230;                         //设置下一个字节数据接收超时时间
 384   6                                                      byBus0RecData[byBus0RecSendCount>>4] = byBus0RecBuf;
 385   6                                                      byBus0RecSendCount += 0x10;                                                                                                                                                                     
 386   6                                                      if((byBus0RecSendCount & 0xf0) >= BUS0_FREQ_SIZE_HI)
 387   6                                                      {                                                                                                                                                                               
 388   7                                                              byBus0RecSendCount &= 0x0f;                                                     
 389   7                                                              if(!((bBus0OnSendFreq == 1)&&(bBus0ReqSend == 0)))
 390   7                                                              {       //如果接收到的这帧数据是自己发送的不置标志                                                      
 391   8                                                                      bBus0RecFinish = 1;                                                                                                                                                                                                                                                                                                             
 392   8                                                              }                                                                                                                                               
 393   7                                                              byBus0RecTimeOut = 0;
 394   7                                                              byBus0DisableCount = 10;
 395   7                                                              bBus0Disable = 1;                               //禁止总线使用
 396   7                                                              PW = bPWState;                                  //恢复语音功放的控制引脚
 397   7                                                      }       
 398   6                                              }                               
 399   5                                              byBus0SendStopCount = 240;
 400   5                                              EnableBus0RecInt();                                             
 401   5                                      }
 402   4                                      else                                                    
 403   4                                      {       //无效结束位
 404   5                                              bBus0Error = 1;                                                                         
 405   5                                              if((!bBus0SendError) && bBus0OnSendFreq)
 406   5                                              {       //没有发生过总线发送错误,且有一帧数据正在发送,停止帧数据发送,置发送错误标志
 407   6                                                      byBus0State0 &= (~BUS0_SEND_CON);
 408   6                                                      bBus0SendError = 1;                                                     
 409   6                                                      Bus0SendPin = 0;                                        //释放总线
 410   6                                              }
 411   5                                              byBus0RecSendCount = 0x00;                              //接收出错,重置接收发送计数值
 412   5                                              PW = bPWState;                                                  //恢复语音功放的控制引脚
 413   5                                      }
 414   4                              }
 415   3                              else if(0x09 == (byBus0RecCount & 0x0f))
 416   3                              {       //第9位数据
 417   4                                      bBus0RecBit9 = bBus0RecBit;                                     
 418   4                              }
 419   3                              else                                                                                    
 420   3                              {       //有效数据位
 421   4                                      byBus0RecBuf >>= 1;
 422   4                                      if(bBus0RecBit)
 423   4                                      {       //为高电平
 424   5                                              byBus0RecBuf |= 0x80;
 425   5                                      }       
 426   4                              }
 427   3                      }
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 8   

 428   2              }
 429   1              /*******************************总线0发送处理***********************************/
 430   1          if((byBus0State0 & BUS0_CAN_SEND) == BUS0_CAN_SEND)
 431   1              {       //总线0上有数据发送请求,且总线允许发送          
 432   2                      if(bBus0RecBit)
 433   2                      {       //总线正常,可以发送
 434   3                              Bus0SendPin = 1;
 435   3                              bBus0SendBit = 0;                                                               //发送起始位数据                        
 436   3                              byBus0SendCount = 0;
 437   3                              byBus0State0 &= (~BUS0_CAN_SEND);
 438   3                              byBus0SendBuf = byBus0SendData[byBus0RecSendCount & 0x0f];
 439   3                              bBus0OnSendBit = 1;                                                             //取出待发送的数据并置正在发送标志              
 440   3                      }
 441   2                      else
 442   2                      {       //总线不正常,停止发送
 443   3                              byBus0State0 &= (~BUS0_SEND_CON);
 444   3                              bBus0SendError = 1;                     
 445   3                              byBus0RecSendCount &= 0xf0;
 446   3                              Bus0SendPin = 0;
 447   3                              byBus0SendStopCount = 240;
 448   3                      }
 449   2              }
 450   1              else if(bBus0OnSendBit)
 451   1              {       //有数据位正在发送,首先发送的是起始位   
 452   2                      byBus0SendCount += 0x10;
 453   2                      if(0x50 == (byBus0SendCount & 0xf0))
 454   2                      {//处于一个数据位的中间
 455   3                              if(bBus0SendBit == bBus0RecBit) bBus0SndBitOk =1;
 456   3                              else
 457   3                              {       //不相同,发送失败                                                               
 458   4                                      byBus0State0 &= ~BUS0_SEND_CON;
 459   4                                      byBus0RecSendCount &= 0xf0;
 460   4                                      bBus0SendError = 1;                                     
 461   4                                      Bus0SendPin = 0; 
 462   4                                      byBus0SendStopCount = 240;
 463   4      
 464   4                                      bBus0SndBitOk = 0;
 465   4                              }
 466   3                      }
 467   2                      
 468   2                      //if(bBus0SendBit == bBus0RecBit)       
 469   2                      else if(bBus0SndBitOk ==1)
 470   2                      {       //发送的数据和接收的数据相同
 471   3                              //byBus0SendCount += 0x10;
 472   3                              if(0xa0 == (byBus0SendCount & 0xf0))
 473   3                              {       //一位数据发送完毕,首先发送的是起始位
 474   4                                      bBus0SndBitOk =0;
 475   4                                      
 476   4                                      byBus0SendCount &= 0x0f;
 477   4                                      byBus0SendCount += 0x01;                                
 478   4                                      if(0x09 == (byBus0SendCount & 0x0f))
 479   4                                      {       //发送到第9位了
 480   5                                              bBus0SendBit = !(bit)(byBus0RecSendCount & 0x0f);
 481   5                                              Bus0SendPin = !bBus0SendBit;                                            
 482   5                                      }
 483   4                                      else if(0x0a == (byBus0SendCount & 0x0f))
 484   4                                      {       //发送到结束位了
 485   5                                              bBus0SendBit = 1;
 486   5                                              Bus0SendPin = 0;        
 487   5                                      }
 488   4                                      else if(0x0b == (byBus0SendCount & 0x0f))
 489   4                                      {       //已经发送完结束位了
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 9   

 490   5                                              bBus0OnSendBit = 0;                                             
 491   5                                              byBus0RecSendCount += 0x01;                                                                     
 492   5                                              if((byBus0RecSendCount & 0x0f) >= BUS0_FREQ_SIZE)
 493   5                                              {       //发送完一帧数据                                                                                                
 494   6                                                      byBus0RecSendCount &= 0xf0;                     //重新进入数据帧的发送阶段
 495   6                                                      byBus0State0 &= (~BUS0_SEND_CON);
 496   6                                                      byBus0SendStopCount = 240;
 497   6                                                      byBus0State1 |= BUS0_SEND_FINISH;                                                               
 498   6                                                      byBus0DisableCount = 10;                                                
 499   6                                              }
 500   5                                              else
 501   5                                              {                                               
 502   6                                                      byBus0SendStopCount = 10;
 503   6                                                      bBus0ReqSend = 1;
 504   6                                              }
 505   5                                              EnableBus0RecInt();                                             //再次使能接收中断
 506   5                                      }
 507   4                                      else
 508   4                                      {
 509   5                                              if(byBus0SendBuf & 0x01)
 510   5                                              {       //发送高电平
 511   6                                                      bBus0SendBit = 1;
 512   6                                                      Bus0SendPin = 0;                                        
 513   6                                              }
 514   5                                              else
 515   5                                              {       //发送低电平
 516   6                                                      bBus0SendBit = 0;
 517   6                                                      Bus0SendPin = 1;
 518   6                                              }
 519   5                                              byBus0SendBuf >>= 1;                                    //发送数据位移位操作
 520   5                                      }
 521   4                              }
 522   3                      }
 523   2      /*              else
 524   2                      {       //不相同,发送失败                                                               
 525   2                              byBus0State0 &= ~BUS0_SEND_CON;
 526   2                              byBus0RecSendCount &= 0xf0;
 527   2                              bBus0SendError = 1;                                     
 528   2                              Bus0SendPin = 0; 
 529   2                              byBus0SendStopCount = 240;
 530   2                      }*/
 531   2              }               
 532   1              /*******************************总线0控制处理***********************************/
 533   1              if(0 == (byBus0State0 & BUS0_ON_REC))
 534   1              {       
 535   2                      if(byBus0SendStopCount != 0)
 536   2                      {
 537   3                              if((--byBus0SendStopCount) == 0)
 538   3                              {                               
 539   4                                      bBus0Enable = 1;                                                                
 540   4                              }
 541   3                      }               
 542   2                      if(bBus0Error)
 543   2                      {                                                               
 544   3                              bBus0Enable = 0;                        
 545   3                              if(bBus0RecBit)
 546   3                              {                               
 547   4                                      bBus0Error = 0;
 548   4                                      EnableBus0RecInt();
 549   4                                      byBus0SendStopCount = 240;
 550   4                              }
 551   3                      }
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 10  

 552   2              }       
 553   1              /*******************************总线0超时处理***********************************/
 554   1              if(byBus0RecTimeOut != 0)
 555   1              {
 556   2                      if(--byBus0RecTimeOut == 0)                                                     
 557   2                      {       //接收超时到
 558   3                              byBus0RecSendCount &= 0x0f;
 559   3                              PW = bPWState;
 560   3                      }
 561   2              }
 562   1              if(byBus0DisableCount != 0)
 563   1              {
 564   2                      if(--byBus0DisableCount == 0)                                           
 565   2                      {       //禁止超时到            
 566   3                              bBus0Disable = 0;
 567   3                      }
 568   2              }       
 569   1              /***********总线0自动发送管理**********/         
 570   1              if((byBus0State0 & BUS0_ON_WORK) == 0x00)                               
 571   1              {       //总线0没有工作                         
 572   2                      if(bBus0SendError)                                              
 573   2                      {       //产生了发送错误,自动重发                                                               
 574   3                              bBus0SendError = 0;                             
 575   3                              byBus0State0 |= BUS0_REQ_SEND;          
 576   3                      }
 577   2                      else                                                                    
 578   2                      {       //总线0无发送错误               
 579   3                              if(!(bBus0SendFinish|bBus0Disable))
 580   3                              {       //总线0没有禁止使用,且发送结束处理已经完成
 581   4                                      if(Bus0TxBuffLen() >= BUS0_FREQ_SIZE)
 582   4                                      {       //有一帧完整的数据在发送队列中                                                                                                                                          
 583   5                                              byBus0SendData[0] = byBus0TxQ[byBus0TxHead];
 584   5                                              IncBus0TxPtr(byBus0TxHead);
 585   5                                              byBus0SendData[1] = byBus0TxQ[byBus0TxHead];
 586   5                                              IncBus0TxPtr(byBus0TxHead);
 587   5                                              byBus0SendData[2] = byBus0TxQ[byBus0TxHead];
 588   5                                              IncBus0TxPtr(byBus0TxHead);
 589   5                                              byBus0SendData[3] = byBus0TxQ[byBus0TxHead];
 590   5                                              IncBus0TxPtr(byBus0TxHead);
 591   5                                              byBus0SendData[4] = byBus0TxQ[byBus0TxHead];
 592   5                                              IncBus0TxPtr(byBus0TxHead);
 593   5                                              byBus0SendData[5] = byBus0TxQ[byBus0TxHead];
 594   5                                              IncBus0TxPtr(byBus0TxHead);
 595   5                                              byBus0SendData[6] = byBus0TxQ[byBus0TxHead];
 596   5                                              IncBus0TxPtr(byBus0TxHead);     
 597   5                                              byBus0State0 |= BUS0_REQ_SEND;                                          
 598   5                                      }
 599   4                                      else
 600   4                                      {       //没有一帧完整的数据在发送队列中了
 601   5                                              byBus0TxHead = byBus0TxTail = 0;
 602   5                                      }                                                               
 603   4                              }
 604   3                      }
 605   2              } 
 606   1      } 
 607          /**********************************************************
 608          *函数名称                       :Bus0OutputData 
 609          *函数描述               :单总线0将待发送数据放入缓冲区
 610          *输入参数               :pbyData:待发送的数据指针
 611          *返回值                         :TRUE:发送成功,FALSE:队列满,发送失败    
 612          *全局变量                       :
 613          *调用模块                       :
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 11  

 614          ***********************************************************
 615          *创建人                 :陈卫国
 616          *创建日期                       :2008-9-22
 617          ***********************************************************
 618          *修改人                         :
 619          *修改日期               :
 620          *注释                   :
 621          **********************************************************/
 622          uint8 Bus0OutputData(uint8* pbyData)
 623          {
 624   1              uint8 byTemp = BUS0_FREQ_SIZE;
 625   1      
 626   1              EA=0;
 627   1              if(Bus0TxBuffLen() >= (BUS0_TX_Q_ZISE - 1))
 628   1              {       //没有空间存储了,失败   
 629   2                      EA=1;;
 630   2                      return(FALSE);
 631   2              }       
 632   1              while(byTemp--)
 633   1              {       //数据入发送队列
 634   2                      byBus0TxQ[byBus0TxTail] = *pbyData++;
 635   2                      IncBus0TxPtr(byBus0TxTail);
 636   2              }
 637   1              EA=1;;  
 638   1              return(TRUE);   
 639   1      }
 640          /**********************************************************
 641          *函数名称                       :BcdToHex       
 642          *函数描述               :BCD转换成十六进制
 643          *输入参数               :byData:待转换的BCD码
 644          *返回值                         :byRet:转化后的16进制数据
 645          *全局变量                       :
 646          *调用模块                       :
 647          ***********************************************************
 648          *创建人                 :陈卫国
 649          *创建日期                       :2008-9-22
 650          ***********************************************************
 651          *修改人                         :
 652          *修改日期               :
 653          *注释                   :
 654          **********************************************************/
 655          uint8 BcdToHex(uint8 byData)
 656          {
 657   1              uint8 byRet;
 658   1              byRet = byData >> 4;
 659   1              byRet *= 10;
 660   1              byData &= 0x0f;
 661   1              byRet += byData;
 662   1              return(byRet);
 663   1      }
 664          /**********************************************************
 665          /**********************************************************
 666          *函数名称                       :AddrCompareCheck       
 667          *函数描述               :比较检测时的地址
 668          *输入参数               :pstBusFreq:待比较的数据帧指针
 669          *返回值                         :1:发送的是检测时数据,0:不是发送检测到的数据    
 670          *全局变量                       :
 671          *调用模块                       :
 672          ***********************************************************
 673          *创建人                 :熊坚强
 674          *创建日期                       :2012-3-14
 675          ***********************************************************
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 12  

 676          *修改人                         :
 677          *修改日期               :
 678          *注释                   :
 679          **********************************************************/
 680          bit AddrCompareCheck(pSTBusFreq pstBusFreq)
 681          {
 682   1              if((pstBusFreq->byRecSecAddr==0x01)&&(pstBusFreq->byRecRoomAddr==0x02)&&(pstBusFreq->byRecBedAddr==0x03))
 683   1              {       
 684   2                      return(1);
 685   2              } 
 686   1              else
 687   1          return(0);
 688   1      }
 689          /**********************************************************
 690          /**********************************************************
 691          *函数名称                       :AddrCompare    
 692          *函数描述               :比较地址(含广播地址)
 693          *输入参数               :pstBusFreq:待比较的数据帧指针
 694          *返回值                         :1:发送到本机的数据,0:不是发送到本机的数据      
 695          *全局变量                       :
 696          *调用模块                       :
 697          ***********************************************************
 698          *创建人                 :陈卫国
 699          *创建日期                       :2008-9-22
 700          ***********************************************************
 701          *修改人                         :
 702          *修改日期               :
 703          *注释                   :
 704          **********************************************************/
 705          bit AddrCompare(pSTBusFreq pstBusFreq)
 706          {
 707   1              if((pstBusFreq->byRecSecAddr != 0xff) && (pstBusFreq->byRecSecAddr != stLocalControl.stEepromCfgData.bySe
             -lfSecAddr))
 708   1              {       
 709   2                      return(0);
 710   2              } 
 711   1              if((pstBusFreq->byRecRoomAddr != 0xff) && (pstBusFreq->byRecRoomAddr != stLocalControl.stEepromCfgData.by
             -SelfRoomAddr))
 712   1              {       
 713   2                      return(0);
 714   2              }
 715   1              if((pstBusFreq->byRecBedAddr != 0xff) && (pstBusFreq->byRecBedAddr != stLocalControl.stEepromCfgData.bySe
             -lfBedAddr))
 716   1              {       
 717   2                      return(0);
 718   2              }
 719   1              return(1); 
 720   1      }
 721          /**********************************************************
 722          *函数名称                       :MakeCH0TimerOut        
 723          *函数描述               :设置通道0超时参数
 724          *输入参数               :byTimerOut:超时时间,byTimerOutCount:超时次数
 725          *返回值                         :
 726          *全局变量                       :stLocalControl
 727          *调用模块                       :
 728          ***********************************************************
 729          *创建人                 :陈卫国
 730          *创建日期                       :2008-9-22
 731          ***********************************************************
 732          *修改人                         :
 733          *修改日期               :
 734          *注释                   :
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 13  

 735          **********************************************************/  
 736          void MakeCH0TimerOut(uint8 byTimerOut, uint8 byTimerOutCount)
 737          {
 738   1              stLocalControl.stCH0TimerOut.byTimerOutSet   = byTimerOut;
 739   1              stLocalControl.stCH0TimerOut.byTimerOut      = byTimerOut;
 740   1              stLocalControl.stCH0TimerOut.byTimerOutCount = byTimerOutCount; 
 741   1      }
 742          /**********************************************************
 743          *函数名称                       :MakeCH1TimerOut        
 744          *函数描述               :设置通道1超时参数
 745          *输入参数               :byTimerOut:超时时间,byTimerOutCount:超时次数
 746          *返回值                         :
 747          *全局变量                       :stLocalControl
 748          *调用模块                       :
 749          ***********************************************************
 750          *创建人                 :陈卫国
 751          *创建日期                       :2008-9-22
 752          ***********************************************************
 753          *修改人                         :
 754          *修改日期               :
 755          *注释                   :
 756          **********************************************************/   
 757          void MakeCH1TimerOut(uint8 byTimerOut, uint8 byTimerOutCount)
 758          {
 759   1              stLocalControl.stCH1TimerOut.byTimerOutSet   = byTimerOut;
 760   1              stLocalControl.stCH1TimerOut.byTimerOut      = byTimerOut;
 761   1              stLocalControl.stCH1TimerOut.byTimerOutCount = byTimerOutCount; 
 762   1      } 
 763          /**********************************************************
 764          *函数名称                       :SaveIndicationData     
 765          *函数描述               :保存信息指示数据内容
 766          *输入参数               :pstBus0SendFreq:待保存的数据帧指针
 767          *返回值                         :
 768          *全局变量                       :stLocalControl
 769          *调用模块                       :
 770          ***********************************************************
 771          *创建人                 :陈卫国
 772          *创建日期                       :2008-9-22
 773          ***********************************************************
 774          *修改人                         :
 775          *修改日期               :
 776          *注释                   :
 777          **********************************************************/
 778          void SaveIndicationData(pSTBusFreq pstBus0SendFreq)
 779          {       
 780   1              stLocalControl.stIndicationData.stAddr.bySecAddr  = pstBus0SendFreq->bySndSecAddr;
 781   1              stLocalControl.stIndicationData.stAddr.byRoomAddr = pstBus0SendFreq->bySndRoomAddr;
 782   1              stLocalControl.stIndicationData.stAddr.byBedAddr  = pstBus0SendFreq->bySndBedAddr;
 783   1              stLocalControl.stIndicationData.byCallCmd         = pstBus0SendFreq->byRecSecAddr; 
 784   1      }
 785          /**********************************************************
 786          *函数名称                       :SaveCallAddr   
 787          *函数描述               :保存主动通话方地址
 788          *输入参数               :pstBus0SendFreq:待保存的数据帧指针
 789          *返回值                         :
 790          *全局变量                       :stLocalControl
 791          *调用模块                       :
 792          ***********************************************************
 793          *创建人                 :陈卫国
 794          *创建日期                       :2008-9-22
 795          ***********************************************************
 796          *修改人                         :
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 14  

 797          *修改日期               :
 798          *注释                   :
 799          **********************************************************/
 800          void SaveCallAddr(pSTBusFreq pstBusFreq)
 801          {       
 802   1              stLocalControl.stCallAddr.bySecAddr  = pstBusFreq->bySndSecAddr;
 803   1              stLocalControl.stCallAddr.byRoomAddr = pstBusFreq->bySndRoomAddr;
 804   1              stLocalControl.stCallAddr.byBedAddr  = pstBusFreq->bySndBedAddr;
 805   1      }
 806          /**********************************************************
 807          *函数名称                       :LedControl     
 808          *函数描述               :指示灯显示状态控制
 809          *输入参数               :
 810          *返回值                         :
 811          *全局变量                       :
 812          *调用模块                       :SetLedSetState,SetLedDealState
 813          ***********************************************************
 814          *创建人                 :熊坚强
 815          *创建日期                       :2008-9-22
 816          ***********************************************************
 817          *修改人                         :
 818          *修改日期               :
 819          *注释                   :
 820          **********************************************************/ 
 821          void LedControl(void)
 822          {
 823   1              if(bNurseIn)
 824   1              {
 825   2                      SetMDLedState(LED_ON<<4);         //护士到位门灯指示为绿色
 826   2              }
 827   1              else if((bConfusionNoting|bServiceNoting|bHelpNoting))
 828   1              {
 829   2                      SetMDLedState(LED_ON<<2);//红色   //有普通呼叫门灯显示为红色
 830   2              }
 831   1              else if(bEmergencyNoting)
 832   1              {               
 833   2                      SetMDLedState(LED_FLASH<<2); //有紧急呼叫门灯显示为红色闪烁
 834   2              }
 835   1              else
 836   1              {
 837   2                      SetMDLedState(0);
 838   2              }
 839   1              if(bIndicatingOther)
 840   1              {
 841   2                  SetLedDealState(LED_FLASH); //如果有其他呼叫，门口处理灯闪烁
 842   2              }
 843   1              else if((bChannel1Talk|bChannel1Talked|bChannel0Talk|bChannel0Talked|bSelfBroad|bSickRoomBroad|bOfficeBro
             -ad|bAllBroad))
 844   1              {       
 845   2                      SetLedDealState(LED_ON);        //设备处于通话状态设定处理灯长亮
 846   2              } 
 847   1              else
 848   1              {
 849   2                      SetLedDealState(LED_OFF);
 850   2              }       
 851   1      }
 852          /**********************************************************
 853          *函数名称                       :VoiceChannelCtx        
 854          *函数描述               :语音通道切换处理函数
 855          *输入参数               :
 856          *返回值                         :
 857          *全局变量                       :
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 15  

 858          *调用模块                       :
 859          ***********************************************************
 860          *创建人                 :陈卫国
 861          *创建日期                       :2008-9-22
 862          ***********************************************************
 863          *修改人                         :
 864          *修改日期               :
 865          *注释                   :
 866          **********************************************************/ 
 867          void VoiceChannelCtx(void)
 868          {       
 869   1              if(bChannel1Talked)       //通道1为SA
 870   1              {       //通道1被动通话
 871   2                      CCAP1H = stLocalControl.stEepromCfgData.byCH1TalkedVol;
 872   2                      CloseCGB();
 873   2                      OpenCBD();
 874   2                      CTD = 0;
 875   2                      CTA = 1;
 876   2                      bPWState =  PW = 0;                     
 877   2              }
 878   1              else if(bChannel1Talk)
 879   1              {       //通道1主动通话
 880   2                      CCAP1H = stLocalControl.stEepromCfgData.byCH1TalkVol;
 881   2                      CloseCGB();
 882   2                      OpenCBD();
 883   2                      CTD = 0;
 884   2                      CTA = 1;
 885   2                      bPWState =  PW = 0;             
 886   2              } 
 887   1              else if((bSickRoomBroad|bOfficeBroad|bAllBroad))        //广播状态为SD通道
 888   1              {       //广播状态
 889   2                      CCAP1H = stLocalControl.stEepromCfgData.byBroadVol;
 890   2                      CloseCBD();
 891   2                      OpenCGB();
 892   2                      CTA = CTD = 0;
 893   2                      bPWState = PW = 0;              
 894   2              }
 895   1              else if(bChannel0Talked)  //通道2为SD
 896   1              {       //通道0被叫通话状态
 897   2                      CCAP1H = stLocalControl.stEepromCfgData.byCH0TalkedVol;
 898   2                      CloseCBD();
 899   2                      OpenCGB();
 900   2                      CTA = 0;
 901   2                      CTD = 1;
 902   2                      bPWState = PW = 0;              
 903   2              }
 904   1              else if(bChannel0Talk)
 905   1              {       //通道0主动通话状态
 906   2                      CCAP1H = stLocalControl.stEepromCfgData.byCH0TalkVol;
 907   2                      CloseCBD();
 908   2                      OpenCGB();
 909   2                      CTA = 0;
 910   2                      CTD = 1;
 911   2                      bPWState = PW = 0;              
 912   2              }       
 913   1              else if(bSelfBroad)             //广播状态为SD通道
 914   1              {       //主动广播状态
 915   2                      CCAP1H = stLocalControl.stEepromCfgData.byBroadVol;
 916   2                      CloseCBD();
 917   2                      OpenCGB();
 918   2                      CTA = 0;
 919   2                      CTD = 1;
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 16  

 920   2                      bPWState = PW = 0;                      
 921   2              }
 922   1              else if((bCalledRing|bWaitListen))      //报号关闭SA、SD通道
 923   1              {       //被呼叫振铃或者等待接听
 924   2                      CCAP1H = stLocalControl.stEepromCfgData.bySelfRingVol;
 925   2                      CloseCBD();
 926   2                      OpenCGB();
 927   2                      CTA = CTD = 0;
 928   2                      bPWState = PW = 0;              
 929   2              }
 930   1              else if(bIndicatingOther&&bEnSoundNote)  //报号为SD通道
 931   1              {       //正在指示其它分机且许可报号
 932   2                      CCAP1H = stLocalControl.stEepromCfgData.byRingVol;
 933   2                      CloseCBD();
 934   2                      OpenCGB();
 935   2                      CTA = CTD = 0;
 936   2                      bPWState = PW = 0;              
 937   2              }
 938   1              else if(bMusicPlaying)
 939   1              {       //背景音乐播放状态
 940   2                      CCAP1H = stLocalControl.stEepromCfgData.byMusicVol;
 941   2                      CloseCGB();
 942   2                      OpenCBD();
 943   2                      CTA = CTD = 0;
 944   2                      bPWState = PW = 0;                              
 945   2              }
 946   1              else if(bVoiceNoting)
 947   1              {       //语音提示
 948   2                      CCAP1H = stLocalControl.stEepromCfgData.byNoteVol;
 949   2                      CloseCGB();
 950   2                      OpenCBD();
 951   2                      CTA = CTD = 0;
 952   2                      bPWState = PW = 0;
 953   2              }
 954   1              else
 955   1              {       //没有任何语音状态存在          
 956   2                      CCAP1H = 10;
 957   2                      CloseCGB();
 958   2                      CloseCBD();
 959   2                      CTA = CTD = 0;
 960   2                      bPWState = PW = 1;
 961   2              }       
 962   1      }
 963          /**********************************************************
 964          *函数名称                       :SysReset       
 965          *函数描述               :系统复位,该函数仅仅将通道0复位,将通道0
 966                                                   恢复到空闲状态
 967          *输入参数               :
 968          *返回值                         :
 969          *全局变量                       :
 970          *调用模块                       :
 971          ***********************************************************
 972          *创建人                 :陈卫国
 973          *创建日期                       :2008-9-22
 974          ***********************************************************
 975          *修改人                         :
 976          *修改日期               :
 977          *注释                   :
 978          **********************************************************/
 979          void SysReset(void)
 980          {       
 981   1          Broadcasting_Flag=0;
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 17  

 982   1              bBusy = bWaitAck = bWaitListen = bCalledRing = bChannel0Talked = bChannel0Talk = bSickRoomBroad = bOffice
             -Broad = bAllBroad = bSelfBroad = 0;                   
 983   1              MakeCH0TimerOut(0, 0);  
 984   1              VoiceChannelCtx();
 985   1              LedControl();
 986   1              bIndication = 0; 
 987   1              SetLcdState(1);         
 988   1              ShowPage();     
 989   1      }
 990          /**********************************************************
 991          *函数名称                       :Bus0RecDeal    
 992          *函数描述               :单总线0收到一帧数据处理函数,该函数首先
 993                                                   取出收到的数据,针对每条命令执行对应的控
 994                                                   制动作
 995          *输入参数               :
 996          *返回值                         :
 997          *全局变量                       :stLocalControl
 998          *调用模块                       :
 999          ***********************************************************
1000          *创建人                 :熊坚强
1001          *创建日期                       :2008-9-22
1002          ***********************************************************
1003          *修改人                         :
1004          *修改日期               :
1005          *注释                   :
1006          **********************************************************/
1007          void Bus0RecDeal(void)
1008          {
1009   1              uint8 idata timebuf[5];
1010   1              //取出收到的数据帧                      
1011   1              EA=0;
1012   1              memcpy(&(stLocalControl.stBusDealFreq), byBus0RecData, sizeof(STBusFreq));
1013   1              bBus0RecFinish = 0;     
1014   1              EA=1;;  
1015   1              if(bLanding && (stLocalControl.stBusDealFreq.byCmd != CMD_ENTER))
1016   1              {       //如果是登记状态,收到的命令不是登记确认命令,不作处理
1017   2                      return;
1018   2              }
1019   1              //-----------------------------------------
1020   1              //-----------------------------------------
1021   1              //调试使用
1022   1               //SBUF=stLocalControl.stBusDealFreq.byCmd;
1023   1              //while(!TI);
1024   1              //TI=0;         
1025   1              //-----------------------------------------
1026   1              //-----------------------------------------
1027   1              switch(stLocalControl.stBusDealFreq.byCmd)
1028   1              {
1029   2                /*case CMD_ENTER:                                                                             //确认登记命令
1030   2                              if(bLanding)
1031   2                              {       
1032   2                                      if(AddrCompare(&(stLocalControl.stBusDealFreq)))
1033   2                                      {                                                                               
1034   2                                              SetLedDealState(LED_OFF);
1035   2                                              SetMDLedState(LED_OFF);
1036   2                                              SetLcdState(1);
1037   2                                              ReadPageColour();       
1038   2                                              ShowPage();                                                             
1039   2                                              byDevState1 = stLocalControl.stBusDealFreq.byRecSecAddr & 0x80;                                                                         
1040   2                                              MakeCH0TimerOut(0, 0);                                                                          
1041   2                                      }
1042   2                              }                       
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 18  

1043   2                              break;*/
1044   2                      //---------------------------------------------------------------------
1045   2                      //---------------------------------------------------------------------
1046   2                      //增加自动检测命令--2012.3.13
1047   2                      case CMD_BUS0_CHECK:     //单总线检测
1048   2                              RST_BUS=0;      
1049   2                              stLocalControl.stBusDealFreq.byCmd = CMD_BUS_ANSWER; 
1050   2                              stLocalControl.stBusDealFreq.byRecSecAddr = CMD_BUS0_CHECK;
1051   2                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));           
1052   2                              break;  
1053   2      
1054   2                      case CMD_SD_TAL_VOL_CHECK:
1055   2                              RST_BUS=0;       //SD、SA通道正常
1056   2                              
1057   2                              stLocalControl.stBusDealFreq.byCmd = CMD_BUS_ANSWER; 
1058   2                              stLocalControl.stBusDealFreq.byRecSecAddr = CMD_SD_TAL_VOL_CHECK;
1059   2                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
1060   2                              CTD=1;
1061   2                              OpenCGB();
1062   2                              CloseCBD();
1063   2                              PW =0;  //打开功放34119
1064   2                              break;
1065   2      
1066   2                      case CMD_SD_TAL_VOL_CHECK_END:
1067   2                              RST_BUS=0;      //SD、SA通道正常
1068   2                              
1069   2                              stLocalControl.stBusDealFreq.byCmd = CMD_BUS_ANSWER; 
1070   2                              stLocalControl.stBusDealFreq.byRecSecAddr = CMD_SD_TAL_VOL_CHECK_END;
1071   2                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));                   
1072   2                              break;
1073   2                              
1074   2      
1075   2                      case CMD_SA_TAL_VOL_CHECK:
1076   2                              RST_BUS=0;      //SD、SA通道正常
1077   2                              
1078   2                              stLocalControl.stBusDealFreq.byCmd = CMD_BUS_ANSWER; 
1079   2                              stLocalControl.stBusDealFreq.byRecSecAddr = CMD_SA_TAL_VOL_CHECK;
1080   2                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
1081   2                              CTA = 1;
1082   2                              CloseCGB();
1083   2                              OpenCBD();
1084   2                              PW=0;   //打开功放34119
1085   2                              break;
1086   2      
1087   2      
1088   2                      case CMD_SA_TAL_VOL_CHECK_END:
1089   2                              RST_BUS=0;      //SD、SA通道正常
1090   2                              
1091   2                              stLocalControl.stBusDealFreq.byCmd = CMD_BUS_ANSWER; 
1092   2                              stLocalControl.stBusDealFreq.byRecSecAddr = CMD_SA_TAL_VOL_CHECK_END;
1093   2                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
1094   2                              CTA = 0;
1095   2                              CloseCBD();
1096   2                              PW=1;   //关闭功放34119
1097   2                              break;
1098   2                      //---------------------------------------------------------------------
1099   2                      case CMD_QUEST:                                                                         //查询命令
1100   2                              stLocalControl.stBusDealFreq.bySndSecAddr = stLocalControl.stEepromCfgData.bySelfSecAddr;
1101   2                              stLocalControl.stBusDealFreq.bySndRoomAddr = stLocalControl.stEepromCfgData.bySelfRoomAddr;
1102   2                              stLocalControl.stBusDealFreq.bySndBedAddr = stLocalControl.stEepromCfgData.bySelfBedAddr;
1103   2                              stLocalControl.stBusDealFreq.byCmd = CMD_ANSWER;                        
1104   2                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));                   
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 19  

1105   2                              break;                  
1106   2                      case CMD_NURSE_COME:                                                    //护士到位命令并且是护士查房命令                        
1107   2                              if((stLocalControl.stBusDealFreq.byRecSecAddr == stLocalControl.stEepromCfgData.bySelfSecAddr) &&((stLo
             -calControl.stBusDealFreq.byRecRoomAddr&0x7f) == (stLocalControl.stEepromCfgData.bySelfRoomAddr&0x7f)))  //...比较区号和
             -亢
1108   2                              {               
1109   3                                      bNurseIn = 1;                          //如确认的设备是本房的,表明护士到达本房,置到位标志                               
1110   3                                      LedControl();
1111   3                                      VoiceChannelCtx();  
1112   3                                      INSPERCTOR_Count=0;
1113   3                                      //----------------------------------------------------------------
1114   3                                      //----------------------------------------------------------------
1115   3                                      //2012/5/26添加多个护士到位
1116   3                                      NurseComeCount++;
1117   3                                      if(NurseComeCount==1)
1118   3                                      {
1119   4                                        NurseComeRoom[0]=stLocalControl.stBusDealFreq.bySndBedAddr;
1120   4                                        INSPERCTOR_Flag=0;
1121   4                                      }
1122   3                                      else if(NurseComeCount>1)
1123   3                                      {
1124   4                        if(NurseComeRoom[0]==stLocalControl.stBusDealFreq.bySndBedAddr)
1125   4                                        goto  NurseIN;
1126   4                                        if(NurseComeRoom[1]==0x00)
1127   4                                        {
1128   5                                           if(stLocalControl.stBusDealFreq.bySndBedAddr!=NurseComeRoom[0]&&stLocalControl.stBusDealFreq.bySn
             -dBedAddr!=NurseComeRoom[2])
1129   5                                               {
1130   6                                             NurseComeRoom[1]=stLocalControl.stBusDealFreq.bySndBedAddr;
1131   6                                             INSPERCTOR_Flag=0;
1132   6                                             goto  NurseIN;  
1133   6                                               }
1134   5                                        }
1135   4                                        else if(NurseComeRoom[1]==stLocalControl.stBusDealFreq.bySndBedAddr)
1136   4                                        goto  NurseIN;                                        
1137   4                                        if(NurseComeRoom[2]==0x00)
1138   4                                        {
1139   5                                           if(stLocalControl.stBusDealFreq.bySndBedAddr!=NurseComeRoom[0]&&stLocalControl.stBusDealFreq.bySn
             -dBedAddr!=NurseComeRoom[1])
1140   5                                               {
1141   6                                             NurseComeRoom[2]=stLocalControl.stBusDealFreq.bySndBedAddr;
1142   6                                             INSPERCTOR_Flag=0;
1143   6                                                 goto  NurseIN;
1144   6                                               }
1145   5                                        }
1146   4                                        else if(NurseComeRoom[2]==stLocalControl.stBusDealFreq.bySndBedAddr)
1147   4                                        goto  NurseIN;        
1148   4                                      }
1149   3                                      //----------------------------------------------------------------
1150   3                                      //----------------------------------------------------------------
1151   3                                      //2012/4/24将此命令同时认为是查房命令
1152   3      NurseIN:                if(!INSPERCTOR_Flag)
1153   3                               {
1154   4                                       INSPERCTOR_Flag=1;
1155   4                                       SerchRoom++;
1156   4                                           if(SerchRoom>15)   //查房大于15次的话，重新回到第1页进行显示
1157   4                                           {
1158   5                                             PageNumber++;
1159   5                                             SerchRoom=1;
1160   5                                           }                     
1161   4                                       if(PageNumber==1)   //第一屏已经写满
1162   4                                       {
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 20  

1163   5                                         Page_Flag=1;
1164   5                                         FmWriteByte(Serch_Room_Page_ADDR,INIT_FLAG);
1165   5                                   }                                                     
1166   4                                           FmWriteByte(Serch_Room_ADDR, SerchRoom);//存储第几次查房数据
1167   4      
1168   4                                               
1169   4                                               if(SerchRoom==1)         //如果第一次查房
1170   4                                       {
1171   5                                         FmWriteByte(Serch_Room_ADDR+0x1000, stLocalControl.stBusDealFreq.bySndBedAddr);
1172   5                                                 HaveSerchRoomFlag=1;
1173   5                                             FmWriteBytes(Serch_Room_TIME_ADDR+0x1000,5,Real_TimeBuf);
1174   5                                       }
1175   4                                           else if(SerchRoom==2) //如果第二次查房
1176   4                                   { 
1177   5                                         FmWriteByte(Serch_Room_ADDR+0x2000, stLocalControl.stBusDealFreq.bySndBedAddr);
1178   5                                         HaveSerchRoomFlag=1; 
1179   5                                             FmWriteBytes(Serch_Room_TIME_ADDR+0x2000,5,Real_TimeBuf);
1180   5                                       }
1181   4                                           else if(SerchRoom==3)//如果第三次查房
1182   4                                   {
1183   5                                         FmWriteByte(Serch_Room_ADDR+0x3000, stLocalControl.stBusDealFreq.bySndBedAddr);
1184   5                                         HaveSerchRoomFlag=1;
1185   5                                             FmWriteBytes(Serch_Room_TIME_ADDR+0x3000,5,Real_TimeBuf);
1186   5                                       }
1187   4                                           else if(SerchRoom==4)//如果第四次查房
1188   4                                   {
1189   5                                     FmWriteByte(Serch_Room_ADDR+0x4000, stLocalControl.stBusDealFreq.bySndBedAddr);
1190   5                                         HaveSerchRoomFlag=1;
1191   5                                             FmWriteBytes(Serch_Room_TIME_ADDR+0x4000,5,Real_TimeBuf);
1192   5                                   }
1193   4                                           else if(SerchRoom==5)//如果第五次查房
1194   4                                   {
1195   5                                         FmWriteByte(Serch_Room_ADDR+0x5000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1196   5                                         HaveSerchRoomFlag=1;
1197   5                                             FmWriteBytes(Serch_Room_TIME_ADDR+0x5000,5,Real_TimeBuf);
1198   5                                   }
1199   4                                           else if(SerchRoom==6)//如果第六次查房
1200   4                                   {
1201   5                                         FmWriteByte(Serch_Room_ADDR+0x6000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1202   5                                         HaveSerchRoomFlag=1;
1203   5                                             FmWriteBytes(Serch_Room_TIME_ADDR+0x6000,5,Real_TimeBuf);
1204   5                                   }
1205   4                                           else if(SerchRoom==7)//如果第七次查房
1206   4                                   {
1207   5                                         FmWriteByte(Serch_Room_ADDR+0x7000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1208   5                                         HaveSerchRoomFlag=1;
1209   5                                             FmWriteBytes(Serch_Room_TIME_ADDR+0x7000,5,Real_TimeBuf);
1210   5                                   }
1211   4                                           else if(SerchRoom==8)//如果第八次查房
1212   4                                   {
1213   5                                          FmWriteByte(Serch_Room_ADDR+0x8000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1214   5                                          HaveSerchRoomFlag=1;
1215   5                                              FmWriteBytes(Serch_Room_TIME_ADDR+0x8000,5,Real_TimeBuf);
1216   5                                       }
1217   4                                           else if(SerchRoom==9)//如果第九次查房
1218   4                                   {
1219   5                                          FmWriteByte(Serch_Room_ADDR+0x9000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1220   5                                          HaveSerchRoomFlag=1;
1221   5                                              FmWriteBytes(Serch_Room_TIME_ADDR+0x9000,5,Real_TimeBuf);
1222   5                                   }
1223   4                                           else if(SerchRoom==10)//如果第十次查房
1224   4                                   {
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 21  

1225   5                                          FmWriteByte(Serch_Room_ADDR+0xA000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1226   5                                          HaveSerchRoomFlag=1;
1227   5                                              FmWriteBytes(Serch_Room_TIME_ADDR+0xA000,5,Real_TimeBuf);
1228   5                                   }
1229   4                                          else if(SerchRoom==11)//如果第十一次查房
1230   4                                  {
1231   5                                         FmWriteByte(Serch_Room_ADDR+0xB000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1232   5                                         HaveSerchRoomFlag=1;
1233   5                                             FmWriteBytes(Serch_Room_TIME_ADDR+0xB000,5,Real_TimeBuf);
1234   5                                  }
1235   4                                          else if(SerchRoom==12)//如果第十二次查房
1236   4                                  {
1237   5                                         FmWriteByte(Serch_Room_ADDR+0xC000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1238   5                                         HaveSerchRoomFlag=1;
1239   5                                             FmWriteBytes(Serch_Room_TIME_ADDR+0xC000,5,Real_TimeBuf);
1240   5                                  }
1241   4                                          else if(SerchRoom==13)//如果第十三次查房
1242   4                                  {    
1243   5                                         FmWriteByte(Serch_Room_ADDR+0x2D000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1244   5                                         HaveSerchRoomFlag=1;
1245   5                                             FmWriteBytes(Serch_Room_TIME_ADDR+0xD000,5,Real_TimeBuf);
1246   5                                  }
1247   4                                          else if(SerchRoom==14)//如果第十四次查房
1248   4                                  {   
1249   5                                        FmWriteByte(Serch_Room_ADDR+0x2E000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1250   5                                        HaveSerchRoomFlag=1;
1251   5                                            FmWriteBytes(Serch_Room_TIME_ADDR+0xE000,5,Real_TimeBuf);
1252   5                                  }
1253   4                                          else if(SerchRoom==15)//如果第十五次查房
1254   4                                  {
1255   5                                        FmWriteByte(Serch_Room_ADDR+0x2F000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1256   5                                        HaveSerchRoomFlag=1;
1257   5                                            FmWriteBytes(Serch_Room_TIME_ADDR+0xF000,5,Real_TimeBuf);
1258   5                                  } 
1259   4                                }     
1260   3                                  //--------------------------------------------------------------------------------------
1261   3                                      //--------------------------------------------------------------------------------------                                        
1262   3                               }
1263   2                               //-----------------------------------------------------------------------------------------
1264   2                               //-----------------------------------------------------------------------------------------
1265   2                               //取消掉当有护士到位前提下，如果护士到位别的房间，门灯护士到位指示灯熄灭的情况，而是只有当护士离开后才
             -熄灭
1266   2                              /*else if(bNurseIn)
1267   2                              {                                       
1268   2                                      bNurseIn = 0;                        //不是到位本房间但本机的护士到位标志置位了,清除之前的护士到位标志  
             -                        
1269   2                                      LedControl();
1270   2                                      VoiceChannelCtx();                      
1271   2                              } */
1272   2                              //------------------------------------------------------------------------------------------
1273   2                              //------------------------------------------------------------------------------------------
1274   2                              break;
1275   2                      case CMD_NURSE_BACK:                                                    //护士离开命令
1276   2                              if((stLocalControl.stBusDealFreq.byRecSecAddr == stLocalControl.stEepromCfgData.bySelfSecAddr) &&((stLo
             -calControl.stBusDealFreq.byRecRoomAddr&0x7f) == (stLocalControl.stEepromCfgData.bySelfRoomAddr&0x7f))) //...比较区号和房
             -号
1277   2                              {       //清除的设备是本房的,表明护士离开本房,清到位标志
1278   3                                      bNurseIn = 0;                                   
1279   3                                      LedControl();
1280   3                                      VoiceChannelCtx();                              
1281   3                              }                       
1282   2                              break;          
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 22  

1283   2                      case CMD_COMM_CALL:                                                                     //普通呼叫命令
1284   2                              if(!bBusy)
1285   2                              {       //通道0空闲                     
1286   3                                      bBusy = 1;
1287   3                                      if(bIndicatingOther)
1288   3                                      {       //如果正在指示其他分机,停止指示 
1289   4                                          //----------------------------------------------------------------------------------------
1290   4                                              //----------------------------------------------------------------------------------------
1291   4                                              bConfusionNoting = bServiceNoting = bHelpNoting = bEmergencyNoting = bIndicatingOther = 0;      
1292   4                                          VoiceChannelCtx();
1293   4                                      LedControl();
1294   4                                              //----------------------------------------------------------------------------------------
1295   4                                              //----------------------------------------------------------------------------------------                                                                              
             -                                
1296   4                                              bIndication = 0; 
1297   4                                      SetLcdState(1);                 
1298   4                                      ShowPage();     
1299   4                                      }                               
1300   3                                      //清除所有呼叫指示标志
1301   3                                      bConfusionNoting = bServiceNoting = bHelpNoting = bEmergencyNoting = bIndicatingOther = 0;
1302   3                                      VoiceChannelCtx();                                                      //语音切换                                      
1303   3                                      //保存主动呼叫方地址
1304   3                                      SaveCallAddr(&(stLocalControl.stBusDealFreq));                  
1305   3                                      MakeCH0TimerOut(250, 0);                                        //设置超时5s
1306   3                                      if(AddrCompare(&(stLocalControl.stBusDealFreq)))
1307   3                                      {       //呼叫本机设备  
1308   4                                              if(!(bChannel1Talk|bChannel1Talked))
1309   4                                              {       //通道1空闲,则本机为空闲状态,返回应答命令
1310   5                                                      stLocalControl.stBusDealFreq.bySndSecAddr = stLocalControl.stEepromCfgData.bySelfSecAddr;
1311   5                                                      stLocalControl.stBusDealFreq.bySndRoomAddr = stLocalControl.stEepromCfgData.bySelfRoomAddr;
1312   5                                                      stLocalControl.stBusDealFreq.bySndBedAddr = stLocalControl.stEepromCfgData.bySelfBedAddr;
1313   5                                                      stLocalControl.stBusDealFreq.byCmd = CMD_COMM_ANSWER;
1314   5                                                      stLocalControl.stBusDealFreq.byRecSecAddr = stLocalControl.stCallAddr.bySecAddr;
1315   5                                                      stLocalControl.stBusDealFreq.byRecRoomAddr = stLocalControl.stCallAddr.byRoomAddr;
1316   5                                                      stLocalControl.stBusDealFreq.byRecBedAddr = stLocalControl.stCallAddr.byBedAddr;
1317   5                                                      Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
1318   5                                              }                               
1319   4                                      }
1320   3                                      LedControl();                                                           //指示灯切换
1321   3                              }
1322   2                              break;
1323   2                      case CMD_COMM_ANSWER:                                                           //普通应答命令                  
1324   2                              bBusy = 1;
1325   2                              //设置振铃超时                  
1326   2                              MakeCH0TimerOut(50, stLocalControl.stEepromCfgData.byRingTime);
1327   2                              if(AddrCompare(&(stLocalControl.stBusDealFreq)))
1328   2                              {       //应答本机,清等待应答,进入等待接听状态  
1329   3                                      bWaitAck = 0;                                   
1330   3                                      bWaitListen = 1;                                                                                
1331   3                                      if((bChannel1Talk|bChannel1Talked)||(!bDealKeyDown))
1332   3                                      {       //如果通道1忙,或者本机主动通话条件不存在了,缩短超时时间                         
1333   4                                              MakeCH0TimerOut(5, 0);
1334   4                                              break;
1335   4                                      }
1336   3                                      VoiceChannelCtx();
1337   3                                      LedControl();                           
1338   3                              }
1339   2                              break;
1340   2                      case CMD_CALL_LISTEN:                                                           //接听命令                                      
1341   2                              bBusy = 1;
1342   2                              //设置通话超时
1343   2                              MakeCH0TimerOut(50, stLocalControl.stEepromCfgData.byTalkTime);
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 23  

1344   2                              if(AddrCompare(&(stLocalControl.stBusDealFreq)))
1345   2                              {       //接听本机,清等待接听,进入通道0主动通话状态             
1346   3                                      bWaitListen = 0;                                
1347   3                                      bChannel0Talk = 1;                                                              
1348   3                                      if((bChannel1Talk|bChannel1Talked)||(!bDealKeyDown))
1349   3                                      {       //如果通道1忙,或者本机主动通话条件不存在了,缩短超时时间                         
1350   4                                              MakeCH0TimerOut(5, 0);
1351   4                                              break;
1352   4                                      }
1353   3                                      VoiceChannelCtx();
1354   3                                      LedControl();
1355   3                              }
1356   2                              break;                  
1357   2                      case CMD_BROADCAST1:                                                            //收到病区广播命令
1358   2                      case CMD_BROADCAST2:                                                            //收到办公区广播命令
1359   2                      case CMD_BROADCAST3:                                                            //收到全区广播命令
1360   2                              if(!bBusy)
1361   2                              {       //通道0空闲                     
1362   3                                      bBusy = 1;      
1363   3                                      //暂存命令                              
1364   3                                      stLocalControl.stBusDealFreq.byRecSecAddr = stLocalControl.stBusDealFreq.byCmd;                                 
1365   3                                      //设置广播超时
1366   3                                      MakeCH0TimerOut(50, stLocalControl.stEepromCfgData.byBroadTime); 
1367   3                                      //保存主动呼叫方地址                            
1368   3                                      SaveCallAddr(&(stLocalControl.stBusDealFreq));                          
1369   3                                      if(bIndicatingOther)
1370   3                                      {       
1371   4                                              //----------------------------------------------------------------------------------------
1372   4                                              //----------------------------------------------------------------------------------------
1373   4                                              bConfusionNoting = bServiceNoting = bHelpNoting = bEmergencyNoting = bIndicatingOther = 0;      
1374   4                                          VoiceChannelCtx();
1375   4                                      LedControl();
1376   4                                              //----------------------------------------------------------------------------------------
1377   4                                              //----------------------------------------------------------------------------------------                                                                              
1378   4                                              bIndication = 0; 
1379   4                                      SetLcdState(1);                 
1380   4                                      ShowPage();                                     
1381   4                                      }
1382   3                                      bConfusionNoting = bServiceNoting = bHelpNoting = bEmergencyNoting = bIndicatingOther = 0;
1383   3                                      VoiceChannelCtx();
1384   3                                      LedControl();
1385   3                                      if((bChannel1Talk|bChannel1Talked))
1386   3                                      {
1387   4                                              break;
1388   4                                      }                       
1389   3                                      switch(stLocalControl.stBusDealFreq.byRecSecAddr)
1390   3                                      {       //针对具体命令,看本机是否允许相应的广播
1391   4                                              case CMD_BROADCAST1:
1392   4                                                      bSickRoomBroad = bEnSickRoomBroad;                                              
1393   4                                                      break;
1394   4                                              case CMD_BROADCAST2:
1395   4                                                      bOfficeBroad = bEnOfficeBroad;                                          
1396   4                                                      break;
1397   4                                              case CMD_BROADCAST3:
1398   4                                                      bAllBroad = bEnAllBroad;        //全区广播状态                                  
1399   4                                                      break;
1400   4                                      }
1401   3                                      VoiceChannelCtx();
1402   3                                      LedControl();
1403   3                                      ShowBROADCASTing();
1404   3                              }
1405   2                              break;                  
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 24  

1406   2                      case CMD_INFO_INDICATION:                                                       //收到呼叫指示命令                                                                                                              
1407   2                              if(!bBusy)              
1408   2                              {                       
1409   3                                      SaveIndicationData(&(stLocalControl.stBusDealFreq));
1410   3                                      if((stLocalControl.stBusDealFreq.bySndSecAddr == stLocalControl.stEepromCfgData.bySelfSecAddr) &&
1411   3                                              ((stLocalControl.stBusDealFreq.bySndRoomAddr&0x7f) == (stLocalControl.stEepromCfgData.bySelfRoomAddr&
             -0x7f)))
1412   3                                      {       //收到的是本房的呼叫指示,不需要作处理,清除上次的呼叫指示
1413   4                                              if(bIndicatingOther)
1414   4                                          {   
1415   5                                                 //----------------------------------------------------------------------------------------
1416   5                                                 //----------------------------------------------------------------------------------------
1417   5                                                 bConfusionNoting = bServiceNoting = bHelpNoting = bEmergencyNoting = bIndicatingOther = 0;   
1418   5                                             VoiceChannelCtx();
1419   5                                         LedControl();
1420   5                                                 //----------------------------------------------------------------------------------------
1421   5                                                 //----------------------------------------------------------------------------------------                                                           
             -                
1422   5                                                 bIndication = 0; 
1423   5                                         SetLcdState(1);                      
1424   5                                         ShowPage();                                  
1425   5                                          }
1426   4                                              bConfusionNoting = bServiceNoting = bHelpNoting = bEmergencyNoting = bIndicatingOther = 0;
1427   4                                              switch(stLocalControl.stBusDealFreq.byRecSecAddr & 0x1f)
1428   4                                              {
1429   5                                                      case CMD_INFUSION_CALL:                         //输液呼叫
1430   5                                                              bConfusionNoting = bEnInfusionDeal;                                                                                             
1431   5                                                              break;
1432   5                                                      case CMD_SERVICE_CALL:                          //服务呼叫
1433   5                                                              bServiceNoting = bEnServiceDeal;                                                                                        
1434   5                                                              break;
1435   5                                                      case CMD_HELP_CALL:                                     //求援呼叫
1436   5                                                              bHelpNoting = bEnHelpDeal;                                                                                      
1437   5                                                              break;
1438   5                                                      case CMD_EMERGENCY_CALL:                        //紧急呼叫
1439   5                                                              bEmergencyNoting = bEnEmergencyDeal;                                                                                    
1440   5                                                              break;
1441   5                                                      default:
1442   5                                                              return;
1443   5                                              }
1444   4                                              VoiceChannelCtx();
1445   4                                              LedControl();                                   
1446   4                                      }
1447   3                                      else
1448   3                                      {       //收到的不是本房的呼叫指示,判断是否本机能够处理
1449   4                                      /*      bConfusionNoting = bServiceNoting = bHelpNoting = bEmergencyNoting = bIndicatingOther = 0;
1450   4                                              VoiceChannelCtx();
1451   4                                          LedControl();
1452   4                                              switch(stLocalControl.stBusDealFreq.byRecSecAddr & 0x1f)
1453   4                                              {
1454   4                                                      case CMD_INFUSION_CALL:                         //输液呼叫
1455   4                                                              if(!bEnInfusionDeal)
1456   4                                                              {       
1457   4                                                                      return;                                                                                                 
1458   4                                                              }                                                                                               
1459   4                                                              break;
1460   4                                                      case CMD_SERVICE_CALL:                          //服务呼叫
1461   4                                                              if(!bEnServiceDeal)
1462   4                                                              {       
1463   4                                                                      return;                                                 
1464   4                                                              }                                                                                       
1465   4                                                              break;
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 25  

1466   4                                                      case CMD_HELP_CALL:                                     //求援呼叫
1467   4                                                              if(!bEnHelpDeal)
1468   4                                                              {       
1469   4                                                                      return;                                                 
1470   4                                                              }                                                                                       
1471   4                                                              break;
1472   4                                                      case CMD_EMERGENCY_CALL:                        //紧急呼叫
1473   4                                                              if(!bEnEmergencyDeal)
1474   4                                                              {
1475   4                                                                      return;                                         
1476   4                                                              }                                                                                       
1477   4                                                              break;
1478   4                                                      default:
1479   4                                                              return;
1480   4                                              } */
1481   4                                              bIndicatingOther = 1;
1482   4                                              if((bChannel1Talked|bChannel1Talk))
1483   4                                              {       //如果通道1处于通话状态,不作处理
1484   5                                                      return;
1485   5                                              }       
1486   4                                              VoiceChannelCtx();
1487   4                                              LedControl();
1488   4                                              bIndication = 1;
1489   4                                      ShowCallFace(stLocalControl.stBusDealFreq.bySndRoomAddr, stLocalControl.stBusDealFreq.bySndBedA
             -ddr, stLocalControl.stIndicationData.byCallCmd&0x1f);                 
1490   4                                      }               
1491   3                              }                       
1492   2                              break;
1493   2                      case CMD_INFUSION_ANSWER:                                                       //处理输液呼叫命令
1494   2                      case CMD_SERVICE_ANSWER:                                                        //处理服务呼叫命令
1495   2                      case CMD_EMERGENCY_ANSWER:                                                      //处理紧急呼叫命令
1496   2                      case CMD_HELP_ANSWER:                                                           //处理求援呼叫命令
1497   2                              if(!bBusy)
1498   2                              {       //通道0不忙                             
1499   3                                      bBusy = 1;
1500   3                                  if(bIndicatingOther)
1501   3                                      {
1502   4                                              //----------------------------------------------------------------------------------------
1503   4                                              //----------------------------------------------------------------------------------------
1504   4                                              bConfusionNoting = bServiceNoting = bHelpNoting = bEmergencyNoting = bIndicatingOther = 0;      
1505   4                                          VoiceChannelCtx();
1506   4                                      LedControl();
1507   4                                              //----------------------------------------------------------------------------------------
1508   4                                              //----------------------------------------------------------------------------------------                                      
1509   4                                              bIndication = 0; 
1510   4                                      SetLcdState(1);                 
1511   4                                      ShowPage();                                                                             
1512   4                                      }                               
1513   3                                      //保存主动呼叫方地址                            
1514   3                                      SaveCallAddr(&(stLocalControl.stBusDealFreq));                          
1515   3                                      MakeCH0TimerOut(250, 0);
1516   3                                      bConfusionNoting = bServiceNoting = bHelpNoting = bEmergencyNoting = bIndicatingOther = 0;
1517   3                                      VoiceChannelCtx();                              
1518   3                                      LedControl();  
1519   3                              }
1520   2                              break;
1521   2                      case CMD_STOP_INDICATION:                                                       //停止指示命令
1522   2                               if(bIndicatingOther)
1523   2                               {      
1524   3                                      //----------------------------------------------------------------------------------------
1525   3                                  //----------------------------------------------------------------------------------------
1526   3                                  bConfusionNoting = bServiceNoting = bHelpNoting = bEmergencyNoting = bIndicatingOther = 0;  
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 26  

1527   3                                      VoiceChannelCtx();
1528   3                                  LedControl();
1529   3                                  //----------------------------------------------------------------------------------------
1530   3                                  //----------------------------------------------------------------------------------------          
1531   3                                      bIndication = 0; 
1532   3                                  SetLcdState(1);                     
1533   3                                  ShowPage(); 
1534   3                               } 
1535   2                               bConfusionNoting = bServiceNoting = bHelpNoting = bEmergencyNoting = bIndicatingOther = 0;
1536   2                               VoiceChannelCtx();
1537   2                               LedControl();
1538   2                               break;
1539   2                      case CMD_INFUSION_CLEAR:                                                        //清除输液呼叫命令
1540   2                      case CMD_SERVICE_CLEAR:                                                         //清除服务呼叫命令
1541   2                      case CMD_HELP_CLEAR:                                                            //清除求援呼叫命令
1542   2                      case CMD_EMERGENCY_CLEAR:                                                       //清除紧急呼叫命令                       
1543   2                              if(     (stLocalControl.stBusDealFreq.byRecSecAddr == stLocalControl.stIndicationData.stAddr.bySecAddr) &&
1544   2                                      (stLocalControl.stBusDealFreq.byRecRoomAddr == stLocalControl.stIndicationData.stAddr.byRoomAddr) &&
1545   2                                      (stLocalControl.stBusDealFreq.byRecBedAddr == stLocalControl.stIndicationData.stAddr.byBedAddr) &&
1546   2                                      ((stLocalControl.stBusDealFreq.byCmd-0x0a) == (stLocalControl.stIndicationData.byCallCmd & 0x1f)))
1547   2                              {       //清除本机正在指示的呼叫信息 
1548   3                                 if(bIndicatingOther)
1549   3                                      {       
1550   4                                          //----------------------------------------------------------------------------------------
1551   4                                              //----------------------------------------------------------------------------------------
1552   4                                              bConfusionNoting = bServiceNoting = bHelpNoting = bEmergencyNoting = bIndicatingOther = 0;      
1553   4                                          VoiceChannelCtx();
1554   4                                      LedControl();
1555   4                                              //----------------------------------------------------------------------------------------
1556   4                                              //----------------------------------------------------------------------------------------
1557   4                                              bIndication = 0; 
1558   4                                              SetLcdState(1);                 
1559   4                                              ShowPage();                                             
1560   4                                      }                               
1561   3                                      bConfusionNoting = bServiceNoting = bHelpNoting = bEmergencyNoting = bIndicatingOther = 0;
1562   3                                      VoiceChannelCtx();
1563   3                                      LedControl();   
1564   3                              }       
1565   2                              break;                  
1566   2                      case CMD_SYSTERM_RESET:                                                         //系统复位命令
1567   2                              SysReset();
1568   2                              break; 
1569   2                      case CMD_START_VOICE:                                                           //启动播音命令
1570   2                              if(AddrCompare(&(stLocalControl.stBusDealFreq)))
1571   2                              {       
1572   3                                      bChannel1Talked = bChannel1Talk = 0;                            
1573   3                                      MakeCH1TimerOut(0, 0);                          
1574   3                                      bVoiceNoting = bEnVoiceNote;                            
1575   3                                      VoiceChannelCtx();
1576   3                                      LedControl();                                                           
1577   3                              }
1578   2                              break;
1579   2                      case CMD_MUSIC_PLAY:                                                            //背景音乐播放
1580   2                              if(AddrCompare(&(stLocalControl.stBusDealFreq)))
1581   2                              {       
1582   3                                      bChannel1Talked = bChannel1Talk = 0;
1583   3                                      MakeCH1TimerOut(0, 0);                          
1584   3                                      bMusicPlaying = bEnMusicplay;                           
1585   3                                      VoiceChannelCtx();
1586   3                                      LedControl();                                   
1587   3                              }
1588   2                              break;  
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 27  

1589   2                      case CMD_STOP_VOICE:                                                            //停止所有音乐播放
1590   2                              if(AddrCompare(&(stLocalControl.stBusDealFreq)))
1591   2                              {       
1592   3                                      bVoiceNoting = bMusicPlaying = 0;
1593   3                                      VoiceChannelCtx();                                      
1594   3                              }
1595   2                              break; 
1596   2                      case CMD_CHANNEL_CHANGE:                                                        //通道切换命令  
1597   2                              //将通道0的状态切换到通道1上,同时清除通道0的状态                                                        
1598   2                              bBusy = bWaitAck = bWaitListen = bCalledRing =  
1599   2                                      bSickRoomBroad = bOfficeBroad = bAllBroad = bSelfBroad = 0;                     
1600   2                              MakeCH0TimerOut(0, 0);  
1601   2                              //-----------------------------------------------------------------------------------------------
1602   2                              //-----------------------------------------------------------------------------------------------
1603   2                              //2012/5/18消除非本房分机时的呼叫指示   
1604   2                              if(bIndicatingOther)
1605   2                          {
1606   3                                  bConfusionNoting = bServiceNoting = bHelpNoting = bEmergencyNoting = bIndicatingOther = 0;  
1607   3                                      VoiceChannelCtx();
1608   3                                  LedControl();                               
1609   3                                  bIndication = 0; 
1610   3                                  SetLcdState(1);                     
1611   3                                  ShowPage();                                                                                 
1612   3                              } 
1613   2                              //-----------------------------------------------------------------------------------------------
1614   2                              //-----------------------------------------------------------------------------------------------       
1615   2                              if((bChannel0Talked|bChannel0Talk))
1616   2                              { 
1617   3                                      bChannel1Talked = bChannel0Talked;
1618   3                                      bChannel1Talk = bChannel0Talk;
1619   3                                      bChannel0Talked = bChannel0Talk = 0;                                                            
1620   3                                      //设置通道1通话超时                                     
1621   3                                      MakeCH1TimerOut(50, stLocalControl.stEepromCfgData.byTalkTime);
1622   3                                      if(bChannel1Talk&&(!bDealKeyDown))
1623   3                                      {       //本机主动通话条件不存在了,缩短超时时间                                                                         
1624   4                                              MakeCH1TimerOut(5, 0);
1625   4                                              break;                  
1626   4                                      }                               
1627   3                                      VoiceChannelCtx();
1628   3                                      LedControl(); 
1629   3                              }       
1630   2                              break;
1631   2                      case CMD_CHANNEL_CLOSE:                                                         //关闭通道切换命令                      
1632   2                              if((bChannel1Talked|bChannel1Talk))
1633   2                              {               //如果通道1处于通话状态,结束后需指示新的信息,如没有,保持状态
1634   3                                      if(bIndicatingOther)
1635   3                                      {       //如果有指示,立即显示指示信息 
1636   4                                        bIndication = 0; 
1637   4                                        SetLcdState(1);                       
1638   4                                        ShowPage();
1639   4                                      }
1640   3                              }
1641   2                              bChannel1Talked = bChannel1Talk = 0;                            
1642   2                              MakeCH1TimerOut(0, 0);  
1643   2                              VoiceChannelCtx();
1644   2                              LedControl();                   
1645   2                              break;
1646   2               /*     case CMD_OPEN_485BUS_IN:                                                        //打开485输出命令       
1647   2                              if(AddrCompare(&(stLocalControl.stBusDealFreq)))
1648   2                              { 
1649   2                                      KDR = 0;
1650   2                                      stLocalControl.stBusDealFreq.byRecSecAddr = CMD_OPEN_485BUS_IN;
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 28  

1651   2                                      stLocalControl.stBusDealFreq.byRecRoomAddr = stLocalControl.stBusDealFreq.bySndRoomAddr;
1652   2                                      stLocalControl.stBusDealFreq.byRecBedAddr = stLocalControl.stBusDealFreq.bySndBedAddr;
1653   2                                      stLocalControl.stBusDealFreq.bySndSecAddr = stLocalControl.stEepromCfgData.bySelfSecAddr;
1654   2                                      stLocalControl.stBusDealFreq.bySndRoomAddr = stLocalControl.stEepromCfgData.bySelfRoomAddr;
1655   2                                      stLocalControl.stBusDealFreq.bySndBedAddr = stLocalControl.stEepromCfgData.bySelfBedAddr;
1656   2                                      stLocalControl.stBusDealFreq.byCmd = 0x02;                                                      
1657   2                                      Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));   
1658   2                              }
1659   2                              break;
1660   2                      case CMD_CLOSE_485BUS:                                                          //关闭485输出
1661   2                              KDR = 1;                        
1662   2                              break;*/
1663   2                      //------------------------------------------------------
1664   2                      //------------------------------------------------------
1665   2                      //2012/4/9设置系统波特率
1666   2                      case CMD_SET_BAUD:
1667   2                           if(stLocalControl.stBusDealFreq.bySndSecAddr == stLocalControl.stEepromCfgData.bySelfSecAddr)
1668   2                               {
1669   3                             Fbaud_Type=stLocalControl.stBusDealFreq.byRecSecAddr;
1670   3                                 FmWriteByte(Set_Baud_ADDR,INIT_FLAG);
1671   3                                 FmWriteByte(System_Baud_ADDR,Fbaud_Type);
1672   3                                 switch(Fbaud_Type)
1673   3                         {
1674   4                           case 1:
1675   4                               Fbaud=1200;
1676   4                               break;
1677   4                               case 2:
1678   4                               Fbaud=2400;
1679   4                                   break;
1680   4                               case 3:
1681   4                               Fbaud=4800;
1682   4                               break;
1683   4                               case 4:
1684   4                               Fbaud=9600;
1685   4                               break;
1686   4                               case 5:
1687   4                               Fbaud=14400;
1688   4                               break;
1689   4                               case 6:
1690   4                               Fbaud=19200;
1691   4                               break;
1692   4                               case 7:
1693   4                               Fbaud=28800;
1694   4                               break;
1695   4                               case 8:
1696   4                               Fbaud=38400;
1697   4                               break;
1698   4                               case 9:
1699   4                               Fbaud=57600;
1700   4                               break;
1701   4                               case 10:
1702   4                               Fbaud=115200;
1703   4                               break;
1704   4                          }
1705   3                         if(Fbaud>2000)
1706   3                         {
1707   4                                   AUXR |= 0x40;                 //1T模式 
1708   4                           TL1=TH1=256-(Fosc/32/Fbaud);
1709   4                         }
1710   3                         else
1711   3                         {
1712   4                                       AUXR &= 0xBF;
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 29  

1713   4                                       TL1=TH1=256-(Fosc/32/Fbaud/12);
1714   4                         }
1715   3                               }  
1716   2                          break;
1717   2                      //------------------------------------------------------
1718   2                      //------------------------------------------------------
1719   2                      //2012/5/8设置系统区号命令
1720   2                      case CMD_SET_SEC_SERIAL:
1721   2                               stLocalControl.stEepromCfgData.bySelfSecAddr=stLocalControl.stBusDealFreq.byRecSecAddr;
1722   2                               SaveParameter();
1723   2                               ReadPageColour();
1724   2                               SetLcdState(1);        
1725   2                               ShowPage();
1726   2                      break;
1727   2                      //------------------------------------------------------
1728   2                      //------------------------------------------------------
1729   2                      case CMD_OPEN_LCD:                                                                      //打开LCD背光显示
1730   2                           if(AddrCompare(&(stLocalControl.stBusDealFreq)))
1731   2                               {
1732   3                                 stLocalControl.stBusDealFreq.byRecSecAddr = CMD_OPEN_LCD;
1733   3                                 stLocalControl.stBusDealFreq.byRecRoomAddr = stLocalControl.stBusDealFreq.bySndRoomAddr;
1734   3                                 stLocalControl.stBusDealFreq.byRecBedAddr = stLocalControl.stBusDealFreq.bySndBedAddr;
1735   3                                 stLocalControl.stBusDealFreq.byCmd = 0x02;
1736   3                                 stLocalControl.stBusDealFreq.bySndSecAddr  = 0x01;
1737   3                                 stLocalControl.stBusDealFreq.bySndRoomAddr = 0x02;
1738   3                                 stLocalControl.stBusDealFreq.bySndBedAddr  = 0x03;
1739   3                                 Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
1740   3                                 SetLcdState(1);
1741   3                               } 
1742   2                           break;
1743   2                      case CMD_CLOSE_LCD:                                                                     //关闭LCD背光显示
1744   2                           if(AddrCompare(&(stLocalControl.stBusDealFreq)))
1745   2                               {
1746   3                                 stLocalControl.stBusDealFreq.byRecSecAddr = CMD_CLOSE_LCD;
1747   3                                 stLocalControl.stBusDealFreq.byRecRoomAddr = stLocalControl.stBusDealFreq.bySndRoomAddr;
1748   3                                 stLocalControl.stBusDealFreq.byRecBedAddr = stLocalControl.stBusDealFreq.bySndBedAddr;
1749   3                                 stLocalControl.stBusDealFreq.byCmd = 0x02;
1750   3                                 stLocalControl.stBusDealFreq.bySndSecAddr  = 0x01;
1751   3                                 stLocalControl.stBusDealFreq.bySndRoomAddr = 0x02;
1752   3                                 stLocalControl.stBusDealFreq.bySndBedAddr  = 0x03;
1753   3                                 Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
1754   3                                 SetLcdState(0);
1755   3                               }
1756   2                           break;
1757   2                      //--------------------------------------------------------------
1758   2                      //--------------------------------------------------------------
1759   2                       case CMD_ENABLE_SOUND:                                                                 //许可语音报号命令
1760   2                           if(AddrCompare(&(stLocalControl.stBusDealFreq)))
1761   2                               {
1762   3                                 stLocalControl.stBusDealFreq.byRecSecAddr = CMD_ENABLE_SOUND;
1763   3                                 stLocalControl.stBusDealFreq.byRecRoomAddr = stLocalControl.stBusDealFreq.bySndRoomAddr;
1764   3                                 stLocalControl.stBusDealFreq.byRecBedAddr = stLocalControl.stBusDealFreq.bySndBedAddr;
1765   3                                 stLocalControl.stBusDealFreq.byCmd = 0x02;
1766   3                                 stLocalControl.stBusDealFreq.bySndSecAddr  = 0x01;
1767   3                                 stLocalControl.stBusDealFreq.bySndRoomAddr = 0x02;
1768   3                                 stLocalControl.stBusDealFreq.bySndBedAddr  = 0x03;
1769   3                                 Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
1770   3                                 FmWriteByte(Close_EnSoundNote_ADDR,0x00);
1771   3                             byEnable1=0xFF;
1772   3                               } 
1773   2                           break;
1774   2                      case CMD_DISABLE_SOUND:                                                                 //关闭语音报号命令 
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 30  

1775   2                           if(AddrCompare(&(stLocalControl.stBusDealFreq)))
1776   2                               {
1777   3                                 stLocalControl.stBusDealFreq.byRecSecAddr = CMD_DISABLE_SOUND;
1778   3                                 stLocalControl.stBusDealFreq.byRecRoomAddr = stLocalControl.stBusDealFreq.bySndRoomAddr;
1779   3                                 stLocalControl.stBusDealFreq.byRecBedAddr = stLocalControl.stBusDealFreq.bySndBedAddr;
1780   3                                 stLocalControl.stBusDealFreq.byCmd = 0x02;
1781   3                                 stLocalControl.stBusDealFreq.bySndSecAddr  = 0x01;
1782   3                                 stLocalControl.stBusDealFreq.bySndRoomAddr = 0x02;
1783   3                                 stLocalControl.stBusDealFreq.bySndBedAddr  = 0x03;
1784   3                                 Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
1785   3                                 FmWriteByte(Close_EnSoundNote_ADDR,0x01);
1786   3                             byEnable1=0xF7;
1787   3                               }
1788   2                           break;
1789   2                      //--------------------------------------------------------------
1790   2                      //--------------------------------------------------------------
1791   2                      case CMD_SEC_CLR:                                                                       //清除科室内容
1792   2                              if(AddrCompare(&(stLocalControl.stBusDealFreq)))
1793   2                              {
1794   3                                 stLocalControl.stBusDealFreq.byRecSecAddr = CMD_SEC_CLR;
1795   3                                 stLocalControl.stBusDealFreq.byRecRoomAddr = stLocalControl.stBusDealFreq.bySndRoomAddr;
1796   3                                 stLocalControl.stBusDealFreq.byRecBedAddr = stLocalControl.stBusDealFreq.bySndBedAddr;
1797   3                                 stLocalControl.stBusDealFreq.byCmd = 0x02;
1798   3                                 stLocalControl.stBusDealFreq.bySndSecAddr  = 0x01;
1799   3                                 stLocalControl.stBusDealFreq.bySndRoomAddr = 0x02;
1800   3                                 stLocalControl.stBusDealFreq.bySndBedAddr  = 0x03;
1801   3                                 Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
1802   3                                 Modify_SEC_Name      = 0x00;
1803   3                                 FmWriteByte(LCD_SEC_MSK_ADDR, 0);
1804   3                                 SetLcdState(1);
1805   3                                 ReadPageColour();                                                                    
1806   3                                 ShowPage(); 
1807   3                              }
1808   2                              break;                  
1809   2                      case CMD_POWER_ON:                                                                      //本机重新热启动
1810   2                              if(AddrCompare(&(stLocalControl.stBusDealFreq)))
1811   2                              {                                       
1812   3                                      EA=0;
1813   3                                      //关闭所有打开的中断
1814   3                                      CCAPM0 = 0x00;
1815   3                                      ET0 = 0;
1816   3                                      TR0 = 0;
1817   3                                      EX0 = EX1 = 0;
1818   3                                      IAP_CONTR = 0x20;               
1819   3                                      break;                                                  
1820   3                              }
1821   2                              break;  
1822   2                      case CMD_SET_BY_SERIAL:                                                          //收到编号的命令       
1823   2                           if(stLocalControl.stBusDealFreq.bySndBedAddr==0x00) //床号为0表示为门口分机编号
1824   2                               {
1825   3                                 SET_BY_SERIAL_FLAG=1;
1826   3                                 SetLedDealState(LED_FLASH);
1827   3                                 ShowNumberPage();
1828   3                               }
1829   2                               break;
1830   2                       /*case  CMD_INSPERCTOR_ENTER:  //收到查房命令，发送给TFT显示屏
1831   2                       {
1832   2                         if(!INSPERCTOR_Flag)
1833   2                         {
1834   2                            if((stLocalControl.stBusDealFreq.byRecSecAddr == stLocalControl.stEepromCfgData.bySelfSecAddr) &&
1835   2                                      ((stLocalControl.stBusDealFreq.byRecRoomAddr&0x7F) == (stLocalControl.stEepromCfgData.bySelfRoomAddr&0
             -x7F)))  //...比较区号和房号
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 31  

1836   2                                {
1837   2                                  INSPERCTOR_Flag=1;
1838   2                                  SerchRoom++;
1839   2                                      if(SerchRoom>15)        //查房大于15次的话，重新回到第1页进行显示
1840   2                                      {
1841   2                                         PageNumber++;
1842   2                                         SerchRoom=1;
1843   2                                      }                          
1844   2                             if(PageNumber==1)   //第一屏已经写满
1845   2                             {
1846   2                                Page_Flag=1;
1847   2                                    FmWriteByte(Serch_Room_Page_ADDR,INIT_FLAG);
1848   2                             }                                                           
1849   2                                      FmWriteByte(Serch_Room_ADDR, SerchRoom);//存储第几次查房数据
1850   2                                      if(SerchRoom==1)          //如果第一次查房
1851   2                              {
1852   2                                    FmWriteByte(Serch_Room_ADDR+0x1000, stLocalControl.stBusDealFreq.bySndBedAddr);
1853   2                                        HaveSerchRoomFlag=1;
1854   2                                        FmWriteBytes(Serch_Room_TIME_ADDR+0x1000,5,Real_TimeBuf);
1855   2                                  }
1856   2                                      else if(SerchRoom==2) //如果第二次查房
1857   2                              { 
1858   2                                    FmWriteByte(Serch_Room_ADDR+0x2000, stLocalControl.stBusDealFreq.bySndBedAddr);
1859   2                                    HaveSerchRoomFlag=1; 
1860   2                                        FmWriteBytes(Serch_Room_TIME_ADDR+0x2000,5,Real_TimeBuf);
1861   2                                  }
1862   2                                      else if(SerchRoom==3)//如果第三次查房
1863   2                              {
1864   2                                    FmWriteByte(Serch_Room_ADDR+0x3000, stLocalControl.stBusDealFreq.bySndBedAddr);
1865   2                                    HaveSerchRoomFlag=1;
1866   2                                        FmWriteBytes(Serch_Room_TIME_ADDR+0x3000,5,Real_TimeBuf);
1867   2                                  }
1868   2                                      else if(SerchRoom==4)//如果第四次查房
1869   2                              {
1870   2                                FmWriteByte(Serch_Room_ADDR+0x4000, stLocalControl.stBusDealFreq.bySndBedAddr);
1871   2                                    HaveSerchRoomFlag=1;
1872   2                                        FmWriteBytes(Serch_Room_TIME_ADDR+0x4000,5,Real_TimeBuf);
1873   2                               }
1874   2                                      else if(SerchRoom==5)//如果第五次查房
1875   2                              {
1876   2                                    FmWriteByte(Serch_Room_ADDR+0x5000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1877   2                                    HaveSerchRoomFlag=1;
1878   2                                        FmWriteBytes(Serch_Room_TIME_ADDR+0x5000,5,Real_TimeBuf);
1879   2                              }
1880   2                                      else if(SerchRoom==6)//如果第六次查房
1881   2                              {
1882   2                                    FmWriteByte(Serch_Room_ADDR+0x6000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1883   2                                    HaveSerchRoomFlag=1;
1884   2                                        FmWriteBytes(Serch_Room_TIME_ADDR+0x6000,5,Real_TimeBuf);
1885   2                              }
1886   2                                      else if(SerchRoom==7)//如果第七次查房
1887   2                              {
1888   2                                    FmWriteByte(Serch_Room_ADDR+0x7000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1889   2                                    HaveSerchRoomFlag=1;
1890   2                                        FmWriteBytes(Serch_Room_TIME_ADDR+0x7000,5,Real_TimeBuf);
1891   2                              }
1892   2                                      else if(SerchRoom==8)//如果第八次查房
1893   2                              {
1894   2                                    FmWriteByte(Serch_Room_ADDR+0x8000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1895   2                                    HaveSerchRoomFlag=1;
1896   2                                        FmWriteBytes(Serch_Room_TIME_ADDR+0x8000,5,Real_TimeBuf);
1897   2                              }
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 32  

1898   2                                      else if(SerchRoom==9)//如果第九次查房
1899   2                              {
1900   2                                    FmWriteByte(Serch_Room_ADDR+0x9000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1901   2                                    HaveSerchRoomFlag=1;
1902   2                                        FmWriteBytes(Serch_Room_TIME_ADDR+0x9000,5,Real_TimeBuf);
1903   2                              }
1904   2                                      else if(SerchRoom==10)//如果第十次查房
1905   2                              {
1906   2                                    FmWriteByte(Serch_Room_ADDR+0xA000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1907   2                                    HaveSerchRoomFlag=1;
1908   2                                        FmWriteBytes(Serch_Room_TIME_ADDR+0xA000,5,Real_TimeBuf);
1909   2                              }
1910   2                                      else if(SerchRoom==11)//如果第十一次查房
1911   2                              {
1912   2                                    FmWriteByte(Serch_Room_ADDR+0xB000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1913   2                                    HaveSerchRoomFlag=1;
1914   2                                        FmWriteBytes(Serch_Room_TIME_ADDR+0xB000,5,Real_TimeBuf);
1915   2                              }
1916   2                                      else if(SerchRoom==12)//如果第十二次查房
1917   2                              {
1918   2                                    FmWriteByte(Serch_Room_ADDR+0xC000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1919   2                                    HaveSerchRoomFlag=1;
1920   2                                        FmWriteBytes(Serch_Room_TIME_ADDR+0xC000,5,Real_TimeBuf);
1921   2                              }
1922   2                                      else if(SerchRoom==13)//如果第十三次查房
1923   2                              {        
1924   2                                    FmWriteByte(Serch_Room_ADDR+0x2D000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1925   2                                    HaveSerchRoomFlag=1;
1926   2                                        FmWriteBytes(Serch_Room_TIME_ADDR+0xD000,5,Real_TimeBuf);
1927   2                              }
1928   2                                      else if(SerchRoom==14)//如果第十四次查房
1929   2                              {       
1930   2                                    FmWriteByte(Serch_Room_ADDR+0x2E000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1931   2                                    HaveSerchRoomFlag=1;
1932   2                                        FmWriteBytes(Serch_Room_TIME_ADDR+0xE000,5,Real_TimeBuf);
1933   2                              }
1934   2                                      else if(SerchRoom==15)//如果第十五次查房
1935   2                              {
1936   2                                    FmWriteByte(Serch_Room_ADDR+0x2F000, stLocalControl.stBusDealFreq.bySndBedAddr); 
1937   2                                    HaveSerchRoomFlag=1;
1938   2                                        FmWriteBytes(Serch_Room_TIME_ADDR+0xF000,5,Real_TimeBuf);
1939   2                              } 
1940   2                            }
1941   2                         }
1942   2                       }
1943   2                       break; */
1944   2                 case   CMD_DATA_SEND:   
1945   2                 {
1946   3                        Real_TimeBuf[4]=BcdToHex(stLocalControl.stBusDealFreq.byRecBedAddr); // 获取实时时间
1947   3                        Real_TimeBuf[3]=BcdToHex(stLocalControl.stBusDealFreq.byRecRoomAddr & 0x1F);
1948   3                        Real_TimeBuf[2]=BcdToHex(stLocalControl.stBusDealFreq.byRecSecAddr & 0x3F);
1949   3                    Real_TimeBuf[1]=BcdToHex(stLocalControl.stBusDealFreq.bySndBedAddr & 0x3F); 
1950   3                        Real_TimeBuf[0]=BcdToHex(stLocalControl.stBusDealFreq.bySndRoomAddr & 0x7F); 
1951   3                        if(HaveSerchRoomFlag)
1952   3                        {
1953   4                          HaveSerchRoomFlag=0;
1954   4                              timebuf[0]=BcdToHex(stLocalControl.stBusDealFreq.bySndRoomAddr & 0x7F); //分
1955   4                          timebuf[1]=BcdToHex(stLocalControl.stBusDealFreq.bySndBedAddr & 0x3F);      //时
1956   4                              timebuf[2]=BcdToHex(stLocalControl.stBusDealFreq.byRecSecAddr & 0x3F);  //日
1957   4                              timebuf[3]=BcdToHex(stLocalControl.stBusDealFreq.byRecRoomAddr & 0x1F); //月
1958   4                              timebuf[4]=BcdToHex(stLocalControl.stBusDealFreq.byRecBedAddr);            //年
1959   4                              if(SerchRoom==1)
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 33  

1960   4                               { 
1961   5                                      FmWriteBytes(Serch_Room_TIME_ADDR+0x1000,5,timebuf);
1962   5                               }
1963   4                              else if(SerchRoom==2)
1964   4                               {
1965   5                                      FmWriteBytes(Serch_Room_TIME_ADDR+0x2000,5,timebuf);
1966   5                               }
1967   4                              else if(SerchRoom==3)
1968   4                              {
1969   5                                 FmWriteBytes(Serch_Room_TIME_ADDR+0x3000,5,timebuf);
1970   5                              }
1971   4                              else if(SerchRoom==4)
1972   4                              {
1973   5                                 FmWriteBytes(Serch_Room_TIME_ADDR+0x4000,5,timebuf);
1974   5                              }
1975   4                              else if(SerchRoom==5)
1976   4                              {
1977   5                                 FmWriteBytes(Serch_Room_TIME_ADDR+0x5000,5,timebuf);
1978   5                              }
1979   4                              else if(SerchRoom==6)
1980   4                              {
1981   5                                 FmWriteBytes(Serch_Room_TIME_ADDR+0x6000,5,timebuf);
1982   5                              }
1983   4                              else if(SerchRoom==7)
1984   4                              {
1985   5                                 FmWriteBytes(Serch_Room_TIME_ADDR+0x7000,5,timebuf);
1986   5                              }
1987   4                              else if(SerchRoom==8)
1988   4                              {
1989   5                                 FmWriteBytes(Serch_Room_TIME_ADDR+0x8000,5,timebuf);
1990   5                              }
1991   4                              else if(SerchRoom==9)
1992   4                              {
1993   5                                 FmWriteBytes(Serch_Room_TIME_ADDR+0x9000,5,timebuf);
1994   5                              }
1995   4                              else if(SerchRoom==10)
1996   4                              {
1997   5                                 FmWriteBytes(Serch_Room_TIME_ADDR+0xA000,5,timebuf);
1998   5                              }
1999   4                              else if(SerchRoom==11)
2000   4                              {
2001   5                                 FmWriteBytes(Serch_Room_TIME_ADDR+0xB000,5,timebuf);
2002   5                              }
2003   4                              else if(SerchRoom==12)
2004   4                              {
2005   5                                 FmWriteBytes(Serch_Room_TIME_ADDR+0xC000,5,timebuf);
2006   5                              }
2007   4                              else if(SerchRoom==13)
2008   4                              {
2009   5                                 FmWriteBytes(Serch_Room_TIME_ADDR+0xD000,5,timebuf);
2010   5                              }
2011   4                              else if(SerchRoom==14)
2012   4                              {
2013   5                                 FmWriteBytes(Serch_Room_TIME_ADDR+0xE000,5,timebuf);
2014   5                              }
2015   4                              else if(SerchRoom==15)
2016   4                              {
2017   5                                 FmWriteBytes(Serch_Room_TIME_ADDR+0xF000,5,timebuf);
2018   5                              } 
2019   4                       }
2020   3                 }
2021   2                 break;       
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 34  

2022   2              }       
2023   1      }
2024          /**********************************************************
2025          *函数名称                       :Bus0SendDeal   
2026          *函数描述               :单总线0发送完一帧数据处理函数,该函数首先
2027                                                   取出收到的数据,针对每条命令执行对应的控
2028                                                   制动作
2029          *输入参数               :
2030          *返回值                         :
2031          *全局变量                       :stLocalControl
2032          *调用模块                       :
2033          ***********************************************************
2034          *创建人                 :陈卫国
2035          *创建日期                       :2008-9-22
2036          ***********************************************************
2037          *修改人                         :
2038          *修改日期               :
2039          *注释                   :
2040          **********************************************************/
2041          void Bus0SendDeal(void)
2042          {
2043   1              //取出发送完成的数据帧
2044   1              EA=0;
2045   1              memcpy(&(stLocalControl.stBusDealFreq), byBus0SendData, sizeof(STBusFreq));             
2046   1              bBus0SendFinish = 0;                                                                            
2047   1              EA=1;   
2048   1              switch(stLocalControl.stBusDealFreq.byCmd)
2049   1              {
2050   2                 /*case CMD_LANDING:                                                                  //登记命令
2051   2                              if(bLanding)
2052   2                              {       //本机确实处在登记状态,设置等待确认超时
2053   2                                      MakeCH0TimerOut(150, 0);                                                                
2054   2                              }                       
2055   2                              break;*/
2056   2                      case CMD_COMM_CALL:                                                                     //普通呼叫命令                                                  
2057   2                      case CMD_INFUSION_ANSWER:                                                       //处理输液呼叫
2058   2                      case CMD_SERVICE_ANSWER:                                                        //处理服务呼叫
2059   2                      case CMD_EMERGENCY_ANSWER:                                                      //处理紧急呼叫
2060   2                      case CMD_HELP_ANSWER:                                                           //处理求援呼叫                                                  
2061   2                              if(!bBusy)
2062   2                              {
2063   3                                      bBusy = bWaitAck = 1;
2064   3                                      SaveCallAddr(&(stLocalControl.stBusDealFreq)); 
2065   3                                      MakeCH0TimerOut(250, 0);                                                
2066   3                              }               
2067   2                      case CMD_INFUSION_CLEAR:                                                        //清除输液呼叫
2068   2                      case CMD_SERVICE_CLEAR:                                                         //清除服务呼叫
2069   2                      case CMD_HELP_CLEAR:                                                            //清除求援呼叫
2070   2                      case CMD_EMERGENCY_CLEAR:                                                       //清除紧急呼叫
2071   2                              //停止正在指示的呼叫    
2072   2                              if(bIndicatingOther)
2073   2                              {
2074   3                                //----------------------------------------------------------------------------------------
2075   3                                //----------------------------------------------------------------------------------------
2076   3                                bConfusionNoting = bServiceNoting = bHelpNoting = bEmergencyNoting = bIndicatingOther = 0;    
2077   3                                VoiceChannelCtx();
2078   3                                LedControl();
2079   3                                //----------------------------------------------------------------------------------------
2080   3                                //----------------------------------------------------------------------------------------                            
2081   3                                bIndication = 0; 
2082   3                                SetLcdState(1);                       
2083   3                                ShowPage();                   
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 35  

2084   3                              }
2085   2                              bConfusionNoting = bServiceNoting = bHelpNoting = bEmergencyNoting = bIndicatingOther = 0;
2086   2                              VoiceChannelCtx();
2087   2                              LedControl();                   
2088   2                              break;  
2089   2                      case CMD_COMM_ANSWER:                                                           //普通应答命令
2090   2                              if(bBusy)
2091   2                              {
2092   3                                      bCalledRing = 1;                                                                
2093   3                                      if((bChannel1Talk|bChannel1Talked))
2094   3                                      {       //本机已经处于通话状态了,缩短超时,退出                                  
2095   4                                              MakeCH0TimerOut(5, 0);
2096   4                                              break;
2097   4                                      }
2098   3                                      MakeCH0TimerOut(50, stLocalControl.stEepromCfgData.byRingTime);
2099   3                                      VoiceChannelCtx();
2100   3                                      LedControl();                           
2101   3                                      if(bEnAutoListen)
2102   3                                      {
2103   4                                              stLocalControl.stBusDealFreq.bySndSecAddr = stLocalControl.stEepromCfgData.bySelfSecAddr;
2104   4                                              stLocalControl.stBusDealFreq.bySndRoomAddr = stLocalControl.stEepromCfgData.bySelfRoomAddr;
2105   4                                              stLocalControl.stBusDealFreq.bySndBedAddr = stLocalControl.stEepromCfgData.bySelfBedAddr;
2106   4                                              stLocalControl.stBusDealFreq.byCmd = CMD_CALL_LISTEN;
2107   4                                              stLocalControl.stBusDealFreq.byRecSecAddr = stLocalControl.stCallAddr.bySecAddr;
2108   4                                              stLocalControl.stBusDealFreq.byRecRoomAddr = stLocalControl.stCallAddr.byRoomAddr;
2109   4                                              stLocalControl.stBusDealFreq.byRecBedAddr = stLocalControl.stCallAddr.byBedAddr;
2110   4                                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr)); 
2111   4                                      }                                       
2112   3                              }
2113   2                              break;
2114   2                      case CMD_CALL_LISTEN:                                                           //接听命令
2115   2                              if(bBusy)
2116   2                              {
2117   3                                      bCalledRing = 0;
2118   3                                      bChannel0Talked = 1;                                                    
2119   3                                      if((bChannel1Talk|bChannel1Talked))
2120   3                                      {       //本机已经处于通话状态了,缩短超时,退出                                  
2121   4                                              MakeCH0TimerOut(5, 0);
2122   4                                              break;
2123   4                                      }
2124   3                                      //设置通话超时
2125   3                                      MakeCH0TimerOut(50, stLocalControl.stEepromCfgData.byTalkTime);                         
2126   3                                      VoiceChannelCtx();
2127   3                                      LedControl();
2128   3                              }
2129   2                              break;
2130   2                      case CMD_BROADCAST1:
2131   2                      case CMD_BROADCAST2:
2132   2                      case CMD_BROADCAST3:                                                            //广播命令
2133   2                              //停止正在指示的呼叫
2134   2                              if(bIndicatingOther)
2135   2                              {                               
2136   3                                bIndication = 0; 
2137   3                                SetLcdState(1);                       
2138   3                                ShowPage();
2139   3                              }
2140   2                              bConfusionNoting = bServiceNoting = bHelpNoting = bEmergencyNoting = bIndicatingOther = 0;
2141   2                              VoiceChannelCtx();                      
2142   2                              if(!bBusy)
2143   2                              {       
2144   3                                      bBusy = 1;                              
2145   3                                      //保存主动呼叫方地址(本机地址)
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 36  

2146   3                                      SaveCallAddr(&(stLocalControl.stBusDealFreq));                          
2147   3                                      bSelfBroad = 1;
2148   3                                      if((bChannel1Talk|bChannel1Talked)||(!bDealKeyDown))
2149   3                                      {       //本机广播条件不存在了,缩短超时,退出                    
2150   4                                              MakeCH0TimerOut(5, 0);
2151   4                                              break;
2152   4                                      }
2153   3                                      //设置广播超时
2154   3                                      MakeCH0TimerOut(50, stLocalControl.stEepromCfgData.byBroadTime);
2155   3                                      VoiceChannelCtx();                              
2156   3                              }
2157   2                              LedControl();                   
2158   2                              break;                  
2159   2                      case CMD_CHANNEL_CLOSE:                                                         //关闭语音通道命令
2160   2                              bChannel1Talk = bChannel1Talked = 0;                    
2161   2                              MakeCH1TimerOut(0, 0);
2162   2                              VoiceChannelCtx();
2163   2                              LedControl();
2164   2                              if(bIndicatingOther)
2165   2                              { 
2166   3                                bIndication = 0; 
2167   3                                SetLcdState(1);                       
2168   3                                ShowPage();
2169   3                              }       
2170   2                              break;  
2171   2                      case CMD_GET_BUS:                                                                       //占用总线
2172   2                              Bus0SendPin = 1;                                                                //制造总线故障
2173   2                              SaveParameter();
2174   2                              Bus0SendPin = 0;                                                                //释放总线
2175   2                              PW = bPWState;                                                                  //恢复语音功放的控制引脚                        
2176   2                              break;  
2177   2                      case CMD_SYSTERM_RESET:                                                         //系统复位命令
2178   2                              SysReset();
2179   2                              break;
2180   2                      case CMD_BUS_ANSWER:
2181   2                              switch(stLocalControl.stBusDealFreq.byRecSecAddr)
2182   2                              {
2183   3                                      case CMD_SD_TAL_VOL_CHECK_END:
2184   3                                              CTD=0;
2185   3                                              CloseCGB();
2186   3                                              PW=1; //关闭功放34119
2187   3                                              break;
2188   3                              }
2189   2                              break;
2190   2              }       
2191   1      }       
2192          
2193          /**********************************************************
2194          *函数名称                       :TimerOutDeal   
2195          *函数描述               :超时处理函数
2196          *输入参数               :
2197          *返回值                         :
2198          *全局变量                       :stLocalControl
2199          *调用模块                       :Bus0OutputData                                  
2200          ***********************************************************
2201          *创建人                 :熊坚强
2202          *创建日期                       :2008-9-22
2203          ***********************************************************
2204          *修改人                         :
2205          *修改日期               :
2206          *注释                   :
2207          **********************************************************/
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 37  

2208          void TimerOutDeal(void)
2209          { 
2210   1              //通道0超时处理         
2211   1              if(stLocalControl.stCH0TimerOut.byTimerOut != 0)
2212   1              {       //有超时设置存在
2213   2                      stLocalControl.stCH0TimerOut.byTimerOut--;
2214   2                      if(stLocalControl.stCH0TimerOut.byTimerOut == 0)
2215   2                      {       //超时一次到了 
2216   3                              if(stLocalControl.stCH0TimerOut.byTimerOutCount == 0x00)
2217   3                              {       //所有超时完成
2218   4                                      if(bLanding)
2219   4                                      {       //上电状态
2220   5                                              stLocalControl.stBusDealFreq.bySndSecAddr = stLocalControl.stEepromCfgData.bySelfSecAddr;
2221   5                                              stLocalControl.stBusDealFreq.bySndRoomAddr = stLocalControl.stEepromCfgData.bySelfRoomAddr;
2222   5                                              stLocalControl.stBusDealFreq.bySndBedAddr = stLocalControl.stEepromCfgData.bySelfBedAddr;
2223   5                                              stLocalControl.stBusDealFreq.byCmd = CMD_LANDING;
2224   5                                              stLocalControl.stBusDealFreq.byRecSecAddr = stLocalControl.stEepromCfgData.bySerialNum1;
2225   5                                              stLocalControl.stBusDealFreq.byRecRoomAddr = stLocalControl.stEepromCfgData.bySerialNum2;
2226   5                                              stLocalControl.stBusDealFreq.byRecBedAddr = stLocalControl.stEepromCfgData.bySerialNum3;
2227   5                                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
2228   5                                      }
2229   4                                      else if((bWaitAck|bWaitListen|bChannel0Talk|bSelfBroad))
2230   4                                      {       //等待应答，等待接听，主动通话，主动广播状态                    
2231   5                                              stLocalControl.stBusDealFreq.bySndSecAddr = stLocalControl.stEepromCfgData.bySelfSecAddr;
2232   5                                              stLocalControl.stBusDealFreq.bySndRoomAddr = stLocalControl.stEepromCfgData.bySelfRoomAddr;
2233   5                                              stLocalControl.stBusDealFreq.bySndBedAddr = stLocalControl.stEepromCfgData.bySelfBedAddr;
2234   5                                              stLocalControl.stBusDealFreq.byCmd = CMD_SYSTERM_RESET;
2235   5                                              stLocalControl.stBusDealFreq.byRecSecAddr = stLocalControl.stCallAddr.bySecAddr;
2236   5                                              stLocalControl.stBusDealFreq.byRecRoomAddr = stLocalControl.stCallAddr.byRoomAddr;
2237   5                                              stLocalControl.stBusDealFreq.byRecBedAddr = stLocalControl.stCallAddr.byBedAddr;
2238   5                                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
2239   5                                      }                               
2240   4                                      else
2241   4                                      {
2242   5                                              bBusy = bCalledRing = bChannel0Talked = bSickRoomBroad = bOfficeBroad = bAllBroad = 0;
2243   5                                              VoiceChannelCtx();
2244   5                                              LedControl();
2245   5                                      }
2246   4                              }
2247   3                              else
2248   3                              {       //超时次数没有完
2249   4                                      stLocalControl.stCH0TimerOut.byTimerOutCount--;
2250   4                                      if(stLocalControl.stCH0TimerOut.byTimerOutCount == 0x00)
2251   4                                      {       //所有超时完成
2252   5                                              if(bLanding)
2253   5                                              {       //上电状态
2254   6                                                      stLocalControl.stBusDealFreq.bySndSecAddr = stLocalControl.stEepromCfgData.bySelfSecAddr;
2255   6                                                      stLocalControl.stBusDealFreq.bySndRoomAddr = stLocalControl.stEepromCfgData.bySelfRoomAddr;
2256   6                                                      stLocalControl.stBusDealFreq.bySndBedAddr = stLocalControl.stEepromCfgData.bySelfBedAddr;
2257   6                                                      stLocalControl.stBusDealFreq.byCmd = CMD_LANDING;
2258   6                                                      stLocalControl.stBusDealFreq.byRecSecAddr = stLocalControl.stEepromCfgData.bySerialNum1;
2259   6                                                      stLocalControl.stBusDealFreq.byRecRoomAddr = stLocalControl.stEepromCfgData.bySerialNum2;
2260   6                                                      stLocalControl.stBusDealFreq.byRecBedAddr = stLocalControl.stEepromCfgData.bySerialNum3;
2261   6                                                      Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
2262   6                                              }
2263   5                                              else if((bWaitAck|bWaitListen|bChannel0Talk|bSelfBroad))
2264   5                                              {       //等待应答，等待接听，主动通话，主动广播状态            
2265   6                                                      stLocalControl.stBusDealFreq.bySndSecAddr = stLocalControl.stEepromCfgData.bySelfSecAddr;
2266   6                                                      stLocalControl.stBusDealFreq.bySndRoomAddr = stLocalControl.stEepromCfgData.bySelfRoomAddr;
2267   6                                                      stLocalControl.stBusDealFreq.bySndBedAddr = stLocalControl.stEepromCfgData.bySelfBedAddr;
2268   6                                                      stLocalControl.stBusDealFreq.byCmd = CMD_SYSTERM_RESET;
2269   6                                                      stLocalControl.stBusDealFreq.byRecSecAddr = stLocalControl.stCallAddr.bySecAddr;
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 38  

2270   6                                                      stLocalControl.stBusDealFreq.byRecRoomAddr = stLocalControl.stCallAddr.byRoomAddr;
2271   6                                                      stLocalControl.stBusDealFreq.byRecBedAddr = stLocalControl.stCallAddr.byBedAddr;
2272   6                                                      Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
2273   6                                              }                               
2274   5                                              else
2275   5                                              {
2276   6                                                      bBusy = bCalledRing = bChannel0Talked = bSickRoomBroad = bOfficeBroad = bAllBroad = 0;
2277   6                                                      VoiceChannelCtx();
2278   6                                                      LedControl();
2279   6                                              }
2280   5                                      }
2281   4                                      else
2282   4                                      {       //超时次数没有完成，重新加载单位超时时间                        
2283   5                                              stLocalControl.stCH0TimerOut.byTimerOut = stLocalControl.stCH0TimerOut.byTimerOutSet;
2284   5                                      }
2285   4                              }                       
2286   3                      }
2287   2              }
2288   1              //通道1超时处理
2289   1              if(stLocalControl.stCH1TimerOut.byTimerOut != 0)
2290   1              {       //有超时设置存在
2291   2                      stLocalControl.stCH1TimerOut.byTimerOut--;
2292   2                      if(stLocalControl.stCH1TimerOut.byTimerOut == 0)
2293   2                      {       //超时一次到了 
2294   3                              if(stLocalControl.stCH1TimerOut.byTimerOutCount == 0x00)
2295   3                              {       //所有超时完成
2296   4                                      if(bChannel1Talk)
2297   4                                      {       //主动通话状态，发送切换命令                    
2298   5                                              stLocalControl.stBusDealFreq.byCmd = CMD_CHANNEL_CLOSE;                                         
2299   5                                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
2300   5                                      }
2301   4                                      else if(bChannel1Talked)
2302   4                                      {       //被动通话状态，自己复位
2303   5                                              bChannel1Talked = 0;
2304   5                                              if(bIndicatingOther)
2305   5                                              { 
2306   6                                                 bIndication = 0; 
2307   6                                         SetLcdState(1);                      
2308   6                                         ShowPage();  
2309   6                                              }
2310   5                                              VoiceChannelCtx();
2311   5                                              LedControl();
2312   5                                      }       
2313   4                              }
2314   3                              else
2315   3                              {       //超时次数没有完
2316   4                                      stLocalControl.stCH1TimerOut.byTimerOutCount--;
2317   4                                      if(stLocalControl.stCH1TimerOut.byTimerOutCount == 0x00)
2318   4                                      {       //所有超时完成
2319   5                                              if(bChannel1Talk)
2320   5                                              {       //主动通话状态，发送切换命令                                            
2321   6                                                      stLocalControl.stBusDealFreq.byCmd = CMD_CHANNEL_CLOSE;                                         
2322   6                                                      Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));   
2323   6                                              }
2324   5                                              else if(bChannel1Talked)
2325   5                                              {       //被动通话状态，自己复位
2326   6                                                      bChannel1Talked = 0;
2327   6                                                      if(bIndicatingOther)
2328   6                                                      { 
2329   7                                                        bIndication = 0; 
2330   7                                            SetLcdState(1);                   
2331   7                                            ShowPage();       
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 39  

2332   7                                                      }
2333   6                                                      VoiceChannelCtx();
2334   6                                                      LedControl();
2335   6                                              }
2336   5                                      }
2337   4                                      else
2338   4                                      {       //超时次数没有完成，重新加载单位超时时间                                
2339   5                                              stLocalControl.stCH1TimerOut.byTimerOut = stLocalControl.stCH1TimerOut.byTimerOutSet;
2340   5                                      }
2341   4                              }                       
2342   3                      }
2343   2              }
2344   1              //灯状态控制    
2345   1              if(--stLocalControl.byLedFlashTime == 0x00)
2346   1              {
2347   2                      stLocalControl.byLedFlashTime = 50;
2348   2                      if((stLocalControl.byLedState & 0x0f) == LED_FLASH)
2349   2                      {       //红灯闪烁状态  
2350   3                              bLedDealState = !bLedDealState;
2351   3                              LED_DEAL = bLedDealState;
2352   3                      }
2353   2              }
2354   1              if(--stLocalControl.byLedFlashDelay == 0x00)
2355   1              {
2356   2                      stLocalControl.byLedFlashDelay = 25;
2357   2                      if((stLocalControl.byMDLedState&LED_FLASH) == LED_FLASH)
2358   2                      {       //红灯闪烁状态
2359   3                              bLedRedState = !bLedRedState;
2360   3                              #ifdef DL_SWAP
                                      MDR = !bLedRedState;
                                      #else
2363   3                              MDR = bLedRedState;
2364   3                              #endif
2365   3                      }
2366   2                      if((stLocalControl.byMDLedState&(LED_FLASH<<2)) == (LED_FLASH<<2))
2367   2                      {       //绿灯闪烁状态
2368   3                              bLedGreenState = !bLedGreenState;
2369   3                              #ifdef DL_SWAP
                                      MDG = !bLedGreenState;
                                      #else
2372   3                              MDG = bLedGreenState;
2373   3                              #endif
2374   3                      }  
2375   2                      if((stLocalControl.byMDLedState&(LED_FLASH<<4)) == (LED_FLASH<<4))
2376   2                      {       //蓝灯闪烁状态
2377   3                              bLedBlueState = !bLedBlueState;
2378   3                              #ifdef DL_SWAP
                                      MDB = !bLedBlueState;
                                      #else
2381   3                              MDB = bLedBlueState;
2382   3                              #endif
2383   3                      }
2384   2              }
2385   1      
2386   1              //控制屏幕打开
2387   1              if (bLcdOn)
2388   1              {
2389   2                      LCD_LED=0;
2390   2                      LCD_LED=1;
2391   2              }
2392   1              else LCD_LED=0;
2393   1      
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 40  

2394   1              
2395   1              if(SET_BY_SERIAL_FLAG)//如果收到设备编号命令，则开始5秒定时
2396   1              {
2397   2                      SET_BY_SERIAL_COUNT++;
2398   2              }
2399   1               else   SET_BY_SERIAL_COUNT=0;
2400   1      
2401   1               
2402   1               if(SET_BY_SERIAL_COUNT>250)            //5秒时间到
2403   1               {
2404   2                      SET_BY_SERIAL_FLAG=0;
2405   2                      SET_BY_SERIAL_COUNT=0;
2406   2                      SetLedDealState(LED_OFF);
2407   2                      NUMBER_SET_STOP_FLAG=1;
2408   2               }
2409   1               
2410   1              if(SerchRoomKeyFlag)  SerchRoomCount++;
2411   1              else SerchRoomCount=0;
2412   1              
2413   1              if(SerchRoomCount>300)                  //6秒时间到
2414   1              { 
2415   2                SerchRoomCount=0;
2416   2                SerchRoomFlag=1;
2417   2                SerchRoomKeyFlag=0;
2418   2                Key_SerchRoom_Flag2=0;
2419   2                Key_SerchRoom_Flag3=0;
2420   2              }
2421   1      
2422   1              
2423   1              if(INSPERCTOR_Flag)  INSPERCTOR_Count++;
2424   1              else INSPERCTOR_Count=0;
2425   1              if(INSPERCTOR_Count>3000) //两次护士查房的时间间隔时间必须大于1分钟才有效记录 
2426   1              {
2427   2                INSPERCTOR_Count=0;
2428   2                INSPERCTOR_Flag=0;
2429   2            //---------------------------------
2430   2            //---------------------------------
2431   2            //2012/5/26添加多个护士到位
2432   2                memset(NurseComeRoom,0,3);
2433   2                NurseComeCount=0;
2434   2            //---------------------------------
2435   2            //---------------------------------
2436   2              }
2437   1      
2438   1              
2439   1              //-----------------------------------
2440   1              if(INDICTION_Flag)  INDICTION_Count++;
2441   1              else  INDICTION_Count=0;
2442   1              if(INDICTION_Count>50)  // 1秒到
2443   1              {
2444   2                INDICTION_Count=0;
2445   2                INDICTION_Flag=0;
2446   2              }
2447   1      
2448   1      
2449   1      
2450   1              if(Bus0RecPin ==1)      //总线正常
2451   1              {
2452   2                      BusLowDTime = 100;      //20ms*100=2s           
2453   2              }
2454   1              else
2455   1              {//Bus0RecPin =0
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 41  

2456   2                      if(BusLowDTime)
2457   2                      {
2458   3                              if(--BusLowDTime ==0)
2459   3                              {
2460   4                                      RST_BUS =1;     //断开SD到总线
2461   4                                      Bus0SendPin =0; //使SD为高电平
2462   4                                      Delayms(400);
2463   4      
2464   4                                      
2465   4                                      if(Bus0RecPin ==0)
2466   4                                      {//本机有故障 //使灯快闪
2467   5                                              ShowSelfError();     //液晶屏提示本机故障
2468   5                                              do
2469   5                                              {
2470   6                                                      RST_BUS =1;     //断开SD到总线
2471   6                                                      Bus0SendPin =0; //使SD为高电平
2472   6                                                      
2473   6                                                      SetLedDealState(1);
2474   6                                                      Delayms(100);           //延时200ms
2475   6      
2476   6                                                      SetLedDealState(0);
2477   6                                                      Delayms(100);
2478   6                                              }while(Bus0RecPin==0);  //一直等待为高
2479   5      
2480   5                                              
2481   5                                              RST_BUS = 0;    //使SD线路连通                                  
2482   5                                              BusLowDTime = 100;
2483   5                                              //使灯恢复常灭
2484   5                                              SetLedDealState(0);
2485   5                                              ShowNormal();
2486   5                                      }
2487   4      
2488   4                                      
2489   4                                      else 
2490   4                                      {//是外部总线引起
2491   5                                              ShowBusError();
2492   5                                              RST_BUS = 0;    //使SD线路连通
2493   5                                              Bus0SendPin =0; //使SD为高电平
2494   5      
2495   5                                              do
2496   5                                              {
2497   6                                                              
2498   6                                                      RST_BUS = 0;    //使SD线路连通
2499   6                                                      Bus0SendPin =0; //使SD为高电平
2500   6                                                      
2501   6                                                      SetLedDealState(1);     //灯慢闪
2502   6                                                      Delayms(400);           //延时600ms 
2503   6                                                      SetLedDealState(0);
2504   6                                                      Delayms(400);
2505   6                                                      
2506   6                                              }while(Bus0RecPin==0);  //一直等待为高
2507   5                                              
2508   5      
2509   5                                              //使灯恢复常灭
2510   5      Bus0BugRet:
2511   5                                              SetLedDealState(0);
2512   5                                              ShowNormal();
2513   5                                              Bus0SendPin =0; //使SD为高电平
2514   5                                              RST_BUS = 0;    //使SD线路连通                                  
2515   5                                              BusLowDTime = 100;
2516   5      
2517   5                                      }                               
C51 COMPILER V9.00   SINGLEBUS                                                             06/23/2017 13:33:25 PAGE 42  

2518   4                              }
2519   3                      }
2520   2              }       
2521   1      }
*** WARNING C280 IN LINE 2510 OF SINGLEBUS.C: 'Bus0BugRet': unreferenced label
2522                    


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   6733    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     30       9
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     32       4
   IDATA SIZE       =     29       5
   BIT SIZE         =     13    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
