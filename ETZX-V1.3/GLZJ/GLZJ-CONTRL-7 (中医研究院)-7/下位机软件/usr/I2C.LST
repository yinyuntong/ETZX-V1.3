C51 COMPILER V9.00   I2C                                                                   02/15/2019 14:56:43 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE I2C
OBJECT MODULE PLACED IN I2C.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE I2C.c LARGE BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          /*
   2          ************************Copyright(c)************************
   3          *            湖南一特电子股份有限公司
   4          *             All Rights Reserved
   5          *              
   6          *
   7          *-----------------------文件信息---------------------------
   8          *文件名称         :I2C.c
   9          *文件描述       :I2C驱动程序
  10          *创建人         :尹运同
  11          *创建日期       :2009-4-6
  12          *版本号           :V1.0
  13          *注释         :         
  14          *----------------------------------------------------------
  15          *修改人       :
  16          *修改日期       :
  17          *版本号           :
  18          *注释         :
  19          ***********************************************************
  20          */
  21          #define _IN_I2C_
  22          #include "config.h"
  23          
  24          void Delay_us(uchar cnt);
  25          void Start();
  26          void Stop();
  27          void WriteACK(uchar ack);
  28          void WaitACK();
  29          void writebyte(uchar wdata);
  30          uchar Readbyte();
  31          void writeData(uchar address,uchar mdata);
  32          void writeDataStr(uchar address,uchar count,uchar * buf);
  33          uchar ReadData(uchar address);
  34          void ReadDataStr(uchar address,uchar count,uchar * buff);
  35          
  36          /********************************************
  37          内部函数，延时1us
  38          ********************************************/
  39          void Delay_us(uchar cnt)
  40          { /*根据晶振频率制定延时时间*///18.432M
  41   1        uchar i;
  42   1        for(i=0; i<cnt; i++)
  43   1        {
  44   2          _nop_();
  45   2          _nop_();
  46   2          _nop_();
  47   2          _nop_();
  48   2          _nop_();
  49   2          _nop_();
  50   2          _nop_();
  51   2          _nop_();
  52   2          _nop_();
  53   2      
  54   2      
  55   2          _nop_();
C51 COMPILER V9.00   I2C                                                                   02/15/2019 14:56:43 PAGE 2   

  56   2          _nop_();
  57   2          _nop_();
  58   2          _nop_();
  59   2          _nop_();
  60   2          _nop_();
  61   2          _nop_();
  62   2          _nop_();
  63   2          _nop_();
  64   2      
  65   2        }
  66   1      
  67   1        return;
  68   1      }
  69          
  70          /********************************************
  71          内部函数，I2C开始
  72          ********************************************/
  73          void Start()
  74          {  
  75   1         SCL=0;
  76   1         Delay_us(10);
  77   1      
  78   1         SDA=1;
  79   1         Delay_us(10);
  80   1         SCL=1;
  81   1         Delay_us(10);
  82   1         SDA=0;
  83   1         Delay_us(10);
  84   1         SCL=0;
  85   1         Delay_us(10);
  86   1      }
  87          
  88          /********************************************
  89          内部函数，I2C结束
  90          ********************************************/
  91          void Stop()
  92          {
  93   1         SCL=0;
  94   1         Delay_us(10);
  95   1         SDA=0;
  96   1      
  97   1         Delay_us(10);
  98   1         SCL=1;
  99   1         Delay_us(10);
 100   1         SDA=1;
 101   1         Delay_us(10);
 102   1         SCL=0;
 103   1      
 104   1      }
 105          /********************************************
 106          内部函数，输出ACK ,每个字节传输完成，输出ack=0,结束读书据，ack=1;
 107          ********************************************/
 108          void WriteACK(uchar ack)
 109          {
 110   1      
 111   1         SCL=0;
 112   1         Delay_us(10);
 113   1         SDA=ack;
 114   1         Delay_us(10);
 115   1         SCL=1;
 116   1         Delay_us(10);
 117   1         SCL=0;
C51 COMPILER V9.00   I2C                                                                   02/15/2019 14:56:43 PAGE 3   

 118   1         Delay_us(10);
 119   1      }
 120          /********************************************
 121          内部函数，等待ACK
 122          ********************************************/
 123          void WaitACK()
 124          {  
 125   1         uint errtime=2550;
 126   1         SDA=1;
 127   1         SCL=0;
 128   1         Delay_us(10); /*读ACK*/
 129   1         SCL=1;
 130   1         Delay_us(10);
 131   1         while(SDA)
 132   1         {  errtime--;
 133   2            if(!errtime) 
 134   2          {
 135   3            Stop();
 136   3          SCL=0;
 137   3          return;
 138   3          }
 139   2         }
 140   1         SCL=0;
 141   1         Delay_us(10);
 142   1         return;
 143   1      }
 144          /********************************************
 145          内部函数.输出数据字节
 146          入口:B=数据
 147          ********************************************/
 148          void writebyte(uchar wdata)
 149          {
 150   1         uchar i;
 151   1         SCL=0;
 152   1         for(i=0;i<8;i++)
 153   1         {
 154   2             Delay_us(10);
 155   2             if(wdata&0x80) SDA=1;
 156   2             else SDA=0;
 157   2             wdata<<=1;
 158   2           Delay_us(10);
 159   2             SCL=1;
 160   2             Delay_us(10);
 161   2             SCL=0;
 162   2         }
 163   1         SDA=1;
 164   1         WaitACK();     //I2C器件或通讯出错，将会退出I2C通讯
 165   1      }
 166          /********************************************
 167          内部函数.输入数据
 168          出口:B
 169          ********************************************/
 170          uchar Readbyte()
 171          {
 172   1         uchar i,bytedata;
 173   1         SDA=1;
 174   1         for(i=0;i<8;i++)
 175   1         {
 176   2            SCL=1; 
 177   2            bytedata<<=1;
 178   2            bytedata|=SDA;
 179   2            SCL=0;
C51 COMPILER V9.00   I2C                                                                   02/15/2019 14:56:43 PAGE 4   

 180   2            Delay_us(10);
 181   2         }
 182   1         return(bytedata);
 183   1      }
 184          /********************************************
 185          输出数据->pcf8563
 186          ********************************************/
 187          void writeData(uchar address,uchar mdata)
 188          {
 189   1         Start();
 190   1         writebyte(0xa2); /*写命令*/
 191   1         writebyte(address); /*写地址*/
 192   1         writebyte(mdata); /*写数据*/
 193   1         Stop();
 194   1      }
 195          
 196          /********************************************
 197          输出数据->pcf8563
 198          ********************************************/
 199          void writeDataStr(uchar address,uchar count,uchar * buff) /*多字节*/
 200          {
 201   1         uchar i;
 202   1         Start();
 203   1         writebyte(0xa2); /*写命令*/
 204   1         writebyte(address); /*写地址*/
 205   1         for(i=0;i<count;i++)
 206   1          {
 207   2            writebyte(*buff); /*写数据*/
 208   2          buff++;
 209   2          }
 210   1         
 211   1         Stop();
 212   1      }
 213          
 214          
 215          /********************************************
 216          输入数据<-pcf8563
 217          ********************************************/
 218          uchar ReadData(uchar address) /*单字节*/
 219          {  uchar rdata;
 220   1         Start();
 221   1         writebyte(0xa2); /*写命令*/
 222   1         writebyte(address); /*写地址*/
 223   1         Start();
 224   1         writebyte(0xa3); /*读命令*/
 225   1         rdata=Readbyte();
 226   1         WriteACK(1);
 227   1         Stop();
 228   1         return(rdata);
 229   1      }
 230          
 231          void ReadDataStr(uchar address,uchar count,uchar * buff) /*多字节*/
 232          {  uchar i;
 233   1         Start();
 234   1         writebyte(0xa2); /*写命令*/
 235   1         writebyte(address); /*写地址*/
 236   1         Start();
 237   1         writebyte(0xa3); /*读命令*/
 238   1         for(i=0;i<count;i++)
 239   1         {
 240   2              buff[i]=Readbyte();
 241   2              if(i<count-1) WriteACK(0);
C51 COMPILER V9.00   I2C                                                                   02/15/2019 14:56:43 PAGE 5   

 242   2         }
 243   1        WriteACK(1);
 244   1         Stop();
 245   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    437    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----       9
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
