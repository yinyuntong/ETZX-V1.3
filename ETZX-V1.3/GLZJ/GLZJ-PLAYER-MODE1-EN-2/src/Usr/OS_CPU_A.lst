A51 MACRO ASSEMBLER  OS_CPU_A                                                             05/26/2014 18:04:22 PAGE     1


MACRO ASSEMBLER A51 V8.00d
OBJECT MODULE PLACED IN .\OS_CPU_A.obj
ASSEMBLER INVOKED BY: C:\Keil\C51\BIN\A51.EXE ..\Target\OS_CPU_A.ASM SET(LARGE) DEBUG PRINT(.\OS_CPU_A.lst) OBJECT(.\OS_
                      CPU_A.obj) EP

LOC  OBJ            LINE     SOURCE

                       1     ;******************************************************************************************
                             ***************
                       2     ;**                                            Small RTOS 51 
                       3     ;**                                   The Real-Time Kernel For Keil c51
                       4     ;**
                       5     ;**                                  (c) Copyright 2002-2003, chenmingji
                       6     ;**                                           All Rights Reserved
                       7     ;**
                       8     ;**                                                  V1.12.1
                       9     ;**
                      10     ;**
                      11     ;**--------------------文件信息------------------------------------------------------------
                             ---------------
                      12     ;**文   件   名: OS_CPU_A.ASM
                      13     ;**创   建   人: 陈明计
                      14     ;**版        本: V1.12.1
                      15     ;**最后修改日期:  2002年2月5日
                      16     ;**描　      述:  Small RTOS 51 与CPU(8051系列)相关的汇编程序
                      17     ;**---------------------历史版本信息-------------------------------------------------------
                             ---------------
                      18     ;** 创建人: 陈明计
                      19     ;** 版  本:V0.50
                      20     ;** 日　期: 2002年2月22日
                      21     ;** 描　述: 原始版本
                      22     ;**
                      23     ;**----------------------------------------------------------------------------------------
                             --------------
                      24     ;** 修改人: 陈明计
                      25     ;** 版  本: V1.00
                      26     ;** 日　期: 2002年6月10日
                      27     ;** 描　述: 支持软的非屏蔽中断
                      28     ;**
                      29     ;**----------------------------------------------------------------------------------------
                             --------------
                      30     ;** 修改人: 陈明计
                      31     ;** 版  本: V1.10.3
                      32     ;** 日　期: 2002年9月16日
                      33     ;** 描　述: 修改了LoadCtx代码使之执行更快，代码更小
                      34     ;**         
                      35     ;**----------------------------------------------------------------------------------------
                             --------------
                      36     ;** 修改人: 陈明计
                      37     ;** 版  本: V1.10.4
                      38     ;** 日　期: 2002年10月5日
                      39     ;** 描　述: 将OS_CPU_A.ASM和OS_CPU_A_task16.ASM合并
                      40     ;**
                      41     ;**----------------------------------------------------------------------------------------
                             --------------
                      42     ;** 修改人: 陈明计
                      43     ;** 版  本: V1.11.0
                      44     ;** 日　期: 2002年12月2日
                      45     ;** 描　述: 根据新版本要求使任务堆栈包含Os_Enter_Sum，使优先级最低
                      46     ;**         的任务只保存少量寄存器；增加注释
                      47     ;**----------------------------------------------------------------------------------------
                             --------------
                      48     ;** 修改人: 陈明计
                      49     ;** 版  本: V1.12.0
A51 MACRO ASSEMBLER  OS_CPU_A                                                             05/26/2014 18:04:22 PAGE     2

                      50     ;** 日　期: 2002年12月30日
                      51     ;** 描　述: 根据新版本要求更改少量代码
                      52     ;**----------------------------------------------------------------------------------------
                             --------------
                      53     ;** 修改人: 陈明计
                      54     ;** 版  本: V1.12.1
                      55     ;** 日　期: 2002年2月5日
                      56     ;** 描　述: 更正LoadCtx中OS_MAX_TASKS为8或16的bug
                      57     ;**---------------------当前版本修订-------------------------------------------------------
                             ----------------
                      58     ;** 修改人:
                      59     ;** 日　期:
                      60     ;** 描　述:
                      61     ;**
                      62     ;**----------------------------------------------------------------------------------------
                             --------------
                      63     ;******************************************************************************************
                             **************/
                      64     ;#include "OS_CPU.H"
                +1    65     
                +1    66     
                +1    67     
                +1    68     
                +1    69     
                +1    70     
                +1    71     
                +1    72     
                +1    73     
                +1    74     
                +1    75     
                +1    76     
                +1    77     
                +1    78     
                +1    79     
                +1    80     
                +1    81     
                +1    82     
                +1    83     
                +1    84     
                +1    85     
                +1    86     
                +1    87     
                +1    88     
                +1    89     
                +1    90     
                +1    91     
                +1    92     
                +1    93     
                +1    94     
                +1    95     
                +1    96     
                +1    97     
                +1    98     
                +1    99     
                +1   100     
                +1   101     
                +1   102     
                +1   103     
                +1   104     
                +1   105     
                +1   106     
                +1   107     
                +1   108     
                +1   109     
                +1   110     
                +1   111     
A51 MACRO ASSEMBLER  OS_CPU_A                                                             05/26/2014 18:04:22 PAGE     3

                +1   112     
                +1   113     
                +1   114     
                +1   115     
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1   163     
                +1   164     
                +1   165     
                +1   166     
                +1   167     SET_EA   MACRO
                +1   168                  SETB     EA
                +1   169              ENDM
                +1   170              
                +1   171     
                +1   172     
                +1   173     
                +1   174     
                +1   175     
                     176     
                     177     ;#include "OS_CFG.H"
A51 MACRO ASSEMBLER  OS_CPU_A                                                             05/26/2014 18:04:22 PAGE     4

                +1   178     
                +1   179     
                +1   180     
                +1   181     
                +1   182     
                +1   183     
                +1   184     
                +1   185     
                +1   186     
                +1   187     
                +1   188     
                +1   189     
                +1   190     
                +1   191     
                +1   192     
                +1   193     
                +1   194     
                +1   195     
                +1   196     
                +1   197     
                +1   198     
                +1   199     
                +1   200     
                +1   201     
                +1   202     
                +1   203     
                +1   204     
                +1   205     
                +1   206     
                +1   207     
                +1   208     
                +1   209     
                +1   210     
                +1   211     
                +1   212     
                +1   213     
                +1   214     
                +1   215     
                +1   216     
                +1   217     
                +1   218     
                +1   219     
                +1   220     
                +1   221     
                +1   222     
                +1   223     
                +1   224     
                +1   225     
                +1   226     
                +1   227     
                +1   228     
                +1   229     
                +1   230     
                +1   231     
                +1   232     
                +1   233     
                +1   234     
                +1   235     
                +1   236     
                +1   237     
                +1   238                                                 
                +1   239     
                +1   240     
                +1   241     
                +1   242     
                +1   243     
A51 MACRO ASSEMBLER  OS_CPU_A                                                             05/26/2014 18:04:22 PAGE     5

                +1   244     
                +1   245     
                +1   246     
                +1   247     
                +1   248     
                +1   249     
                +1   250                                                 
                +1   251     
                +1   252     
                +1   253     
                +1   254     
                +1   255     
                +1   256     
                +1   257     
                +1   258     
                +1   259     
                +1   260     
                +1   261     
                +1   262     
                +1           
                +1           
                +1   265     
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1   273     
                +1   274     
                +1   275     
                     276     
                     277     
                     278     
                             
                             
                     281     
                     282     
                     283     
                     284     
                     285         NAME    OS_CPU_A_ASM
                     286     
                     287     ?PR?OSCtxSw?OS_CPU_A                     SEGMENT CODE
                     288     ?PR?OSIntCtxSw?OS_CPU_A                  SEGMENT CODE
                     289     ?PR?LoadCtx?OS_CPU_A                     SEGMENT CODE
                     290     ?PR?C_OSCtxSw?OS_CPU_A                   SEGMENT CODE 
                     291     ?PR?_OSTaskStkInit?OS_CPU_A              SEGMENT CODE 
                     292     
                     293     
                     294         EXTRN   CODE (OSMapTbl)
                     295         EXTRN   DATA (OSFastSwap)
                     296         EXTRN   DATA (OSTaskID)
                     297         EXTRN   DATA (OSNextTaskID)
                     298         EXTRN   DATA (OSTsakStackBotton)
                     299         EXTRN   DATA (Os_Enter_Sum)
                     300     IF 0  <> 0
                                 EXTRN   IDATA (Sp2)
                             ENDIF
                     303     IF 0 > 0
                                 EXTRN   DATA (?C_XBP)
                             ENDIF
                     306     
                     307         PUBLIC  _OSTaskStkInit
                     308         PUBLIC  LoadCtx
                     309         PUBLIC  OSIntCtxSw
A51 MACRO ASSEMBLER  OS_CPU_A                                                             05/26/2014 18:04:22 PAGE     6

                     310         PUBLIC  OSCtxSw
                     311         PUBLIC  STACK
                     312         PUBLIC  C_OSCtxSw
                     313     
                     314     ;****************************************************************************************
                     315     ;?STACK SEGMENT IDATA
                     316     
                     317     ?STACK      SEGMENT   IDATA
                     318     
----                 319             RSEG    ?STACK
0000                 320     STACK:                                          ;堆栈
0000                 321             DS  1
                     322     
                     323     ; /****************************************************************************************
                             *****************
                     324     ; ** 函数名称: OSTaskStkInit
                     325     ; ** 功能描述: 任务堆栈初始化
                     326     ; ** 输　入: 无
                     327     ; ** 输　出 : 无
                     328     ; ** 全局变量: OSTaskID,OSTsakStackBotton,SP
                     329     ; ** 调用模块: LoadCtx
                     330     ; ** 
                     331     ; ** 作　者: 陈明计
                     332     ; ** 日　期: 2002年2月22日
                     333     ; **---------------------------------------------------------------------------------------
                             ----------------
                     334     ; ** 修改人:
                     335     ; ** 日　期:
                     336     ; **---------------------------------------------------------------------------------------
                             ----------------
                     337     ; *****************************************************************************************
                             ***************/
                     338      
----                 339         RSEG  ?PR?_OSTaskStkInit?OS_CPU_A
0000                 340     _OSTaskStkInit:
                     341         USING   0
                     342     ;---- Variable 'cp?147' assigned to Register 'R0' ----
                     343     ;---- Variable 'cp?146' assigned to Register 'R1' ----
                     344     ;---- Variable 'i?145' assigned to Register 'R2' ----
                     345     ;---- Variable 'TaskID?144' assigned to Register 'R3' ----
                     346     ;---- Variable 'ptos?143' assigned to Register 'R4/R5' ----
                     347         
0000 C006            348         PUSH    AR6
0002 C007            349         PUSH    AR7
                     350     ; {
                     351     
                     352     ;         OSFastSwap[0] &= ~OSMapTbl[TaskID];             //清0  
0004 EB              353         MOV     A,R3
0005 900000   F      354         MOV     DPTR,#OSMapTbl
0008 93              355         MOVC    A,@A+DPTR
0009 4200     F      356         ORL     OSFastSwap,A
                             
                             
                                 
                                 
                                 
                                 
                                 
                             
                             
                                 
                                 
                                 
                             
                                 
                             
A51 MACRO ASSEMBLER  OS_CPU_A                                                             05/26/2014 18:04:22 PAGE     7

                             
                             
                             
                                 
                                 
                                 
                                 
                             
                             
                             
                     382     
                     383     ;     if (TaskID < OSRunningTaskID())
000B EB              384         MOV     A,R3
000C C3              385         CLR     C
000D 9500     F      386         SUBB    A,OSTaskID
000F 502E            387         JNC     StkInit5
                     388     ;     {
                     389     ;         i =  OSRunningTaskID() - TaskID;
0011 C3              390         CLR     C
0012 E500     F      391         MOV     A,OSTaskID
0014 9B              392         SUBB    A,R3
0015 FA              393         MOV     R2,A
                     394     ;         cp = (uint8 idata *)(&(OSTsakStackBotton[TaskID + 1]));
0016 7400     F      395         MOV     A,#LOW (OSTsakStackBotton+01H)
0018 2B              396         ADD     A,R3
0019 F9              397         MOV     R1,A
001A                 398     StkInit8:
                     399     ;         do
                     400     ;         {
                     401     ;             *cp += SP_ADD_BYTE;
001A 7403            402         MOV     A,#3
001C 27              403         ADD     A,@R1
001D F7              404         MOV     @R1,A
                     405     ;             cp++;
001E 09              406         INC     R1
                     407     ;         } while (--i != 0);
001F DAF9            408         DJNZ    R2,StkInit8
                     409     
                     410     ;         cp1 = (uint8 idata *)SP;
0021 A881            411         MOV     R0,SP
                     412     ;         SP = SP + SP_ADD_BYTE;
                     413                 ; SOURCE LINE # 172
0023 7403            414         MOV     A,#3
0025 2581            415         ADD     A,SP
0027 F581            416         MOV     SP,A
                     417     ;         i = SP - (uint8)(OSTsakStackBotton[TaskID + 1]) + 1;
0029 7400     F      418         MOV     A,#LOW (OSTsakStackBotton+01H)
002B 2B              419         ADD     A,R3
002C F9              420         MOV     R1,A
002D 8707            421         MOV     AR7,@R1
002F C3              422         CLR     C
0030 E581            423         MOV     A,SP
0032 9F              424         SUBB    A,R7
0033 FA              425         MOV     R2,A
0034 0A              426         INC     R2
                     427     ;         cp = (uint8 idata *)SP;
0035 A981            428         MOV     R1,SP
0037                 429     StkInit11:
                     430     ;         do
                     431     ;         {
                     432     ;             *cp-- = *cp1--;
0037 E6              433         MOV     A,@R0
0038 F7              434         MOV     @R1,A
0039 18              435         DEC     R0
003A 19              436         DEC     R1
                     437     ;         } while (--i != 0);
A51 MACRO ASSEMBLER  OS_CPU_A                                                             05/26/2014 18:04:22 PAGE     8

003B DAFA            438         DJNZ    R2,StkInit11
                     439     ;     }
003D 802C            440         SJMP    StkInit12
003F                 441     StkInit5:
                     442     ;     else
                     443     ;     {
                     444     ;         cp1 = (uint8 idata *)(&(OSTsakStackBotton[OSRunningTaskID() + 1]));
003F 7400     F      445         MOV     A,#LOW (OSTsakStackBotton+01H)
0041 2500     F      446         ADD     A,OSTaskID
0043 F8              447         MOV     R0,A
                     448     ;         i = TaskID - OSRunningTaskID();
0044 C3              449         CLR     C
0045 EB              450         MOV     A,R3
0046 9500     F      451         SUBB    A,OSTaskID
0048 FA              452         MOV     R2,A
0049                 453     StkInit15:
                     454     ;         do
                     455     ;         {
                     456     ;             *cp1 -= SP_ADD_BYTE;
0049 74FD            457         MOV     A,#(-3)
004B 26              458         ADD     A,@R0
004C F6              459         MOV     @R0,A
                     460     ;             cp1++;
004D 08              461         INC     R0
                     462     ;         } while (--i != 0);
004E DAF9            463         DJNZ    R2,StkInit15
                     464     ;         
                     465     ;         cp = OSTsakStackBotton[OSRunningTaskID() + 1];
0050 7400     F      466         MOV     A,#LOW (OSTsakStackBotton+01H)
0052 2500     F      467         ADD     A,OSTaskID
0054 F8              468         MOV     R0,A
0055 E6              469         MOV     A,@R0
0056 F9              470         MOV     R1,A
                     471     ;         i = OSTsakStackBotton[TaskID] - cp - SP_ADD_BYTE;
0057 E9              472         MOV     A,R1
0058 24FD            473         ADD     A,#(-3)
005A FF              474         MOV     R7,A
                     475     
005B 7400     F      476         MOV     A,#LOW (OSTsakStackBotton)
005D 2B              477         ADD     A,R3
005E F8              478         MOV     R0,A
005F E6              479         MOV     A,@R0
0060 C3              480         CLR     C
0061 9F              481         SUBB    A,R7
0062 FA              482         MOV     R2,A
                     483     ;         cp1 = cp - SP_ADD_BYTE;
0063 A807            484         MOV     R0,AR7
0065                 485     StkInit18:
                     486     ;         do
                     487     ;         {
                     488     ;             *cp1++ = *cp++;
0065 E7              489         MOV     A,@R1
0066 F6              490         MOV     @R0,A
0067 08              491         INC     R0
0068 09              492         INC     R1
                     493     ;         } while (--i != 0);
0069 DAFA            494         DJNZ    R2,StkInit18
                     495     ;     }
006B                 496     StkInit12:
                     497     ;     cp = OSTsakStackBotton[TaskID];
006B 7400     F      498         MOV     A,#LOW (OSTsakStackBotton)
006D 2B              499         ADD     A,R3
006E F8              500         MOV     R0,A
006F E6              501         MOV     A,@R0
0070 F9              502         MOV     R1,A
                     503     ;     *cp++ = (uint16)task % 256;
A51 MACRO ASSEMBLER  OS_CPU_A                                                             05/26/2014 18:04:22 PAGE     9

0071 D0E0            504         pop     ACC
0073 F7              505         MOV     @R1,A
0074 09              506         INC     R1
                     507     ;     *cp++ = (uint16)task / 256;
0075 D0E0            508         pop     ACC
0077 F7              509         MOV     @R1,A
0078 09              510         INC     R1
                     511     
                             
                                 
                                 
                             
                                 
                                 
                             
                     519     ;     *cp = 0;
0079 E4              520         CLR     A
007A F7              521         MOV     @R1,A
                     522     ; }
007B 22              523         RET     
                     524     
                     525     ;/*****************************************************************************************
                             ****************
                     526     ;** 函数名称: LoadCtx
                     527     ;** 功能描述: 任务环境恢复函数
                     528     ;** 输　入: OSTaskID,OSFastSwap
                     529     ;** 输　出 : 无
                     530     ;** 全局变量: 无
                     531     ;** 调用模块: 无
                     532     ;** 
                     533     ;** 作　者: 陈明计
                     534     ;** 日　期: 2002年2月22日
                     535     ;**----------------------------------------------------------------------------------------
                             ---------------
                     536     ;** 修　改: 陈明计
                     537     ;** 日　期: 2002年12月2日
                     538     ;**----------------------------------------------------------------------------------------
                             ---------------
                     539     ;** 修　改: 陈明计
                     540     ;** 日　期: 2003年2月5日
                     541     ;**----------------------------------------------------------------------------------------
                             ---------------
                     542     ;** 修　改:
                     543     ;** 日　期:
                     544     ;**----------------------------------------------------------------------------------------
                             ---------------
                     545     ;******************************************************************************************
                             **************/
                     546     
----                 547         RSEG  ?PR?LoadCtx?OS_CPU_A
0000                 548     LoadCtx:
                     549         USING   0
                     550        
0000 D000     F      551         POP     Os_Enter_Sum            ;恢复关中断计数器
                     552     
                     553     
                                 
                                 
                             
                     557     
                     558                                         ;判断是否需要恢复所有寄存器
0002 E500     F      559         MOV     A,OSTaskID
0004 B40502          560         CJNE    A,#5,LoadCtx_0
0007 8022            561         SJMP    LoadCtx_2
0009                 562     LoadCtx_0:
0009 900000   F      563         MOV     DPTR,#OSMapTbl
A51 MACRO ASSEMBLER  OS_CPU_A                                                             05/26/2014 18:04:22 PAGE    10

                     564     
000C 93              565         MOVC    A,@A+DPTR
000D 5500     F      566         ANL     A,OSFastSwap
                             
                                 
                                 
                                 
                                 
                                 
                                 
                             
                                 
                                 
                             
000F 701A            578         JNZ     LoadCtx_2
                     579                                         ;恢复寄存器
0011 D007            580         POP     7
0013 D006            581         POP     6
0015 D005            582         POP     5
0017 D004            583         POP     4
0019 D003            584         POP     3
001B D002            585         POP     2
001D D001            586         POP     1
001F D000            587         POP     0
0021 D0D0            588         POP     PSW
0023 D082            589         POP     DPL
0025 D083            590         POP     DPH
0027 D0F0            591         POP     B
0029 D0E0            592         POP     ACC
002B                 593     LoadCtx_2:
                     594                                         ;判断是否需要开中断
002B 0500     F      595         INC     Os_Enter_Sum
002D D50002   F      596         djnz    Os_Enter_Sum,LoadCtx_3
                     597         SET_EA                          ;开中断
0032                 599     LoadCtx_3:
0032 22              600         RET
                     601     
                     602     
                     603     ;/*****************************************************************************************
                             ****************
                     604     ;** 函数名称: OSCtxSw
                     605     ;** 功能描述: 任务主动放弃CPU环境保存函数
                     606     ;** 输　入: OSTaskID
                     607     ;** 输　出 : 无
                     608     ;** 全局变量: OSFastSwap
                     609     ;** 调用模块: 无
                     610     ;** 
                     611     ;** 作　者: 陈明计
                     612     ;** 日　期: 2002年2月22日
                     613     ;**----------------------------------------------------------------------------------------
                             ---------------
                     614     ;** 修　改:
                     615     ;** 日　期:
                     616     ;**----------------------------------------------------------------------------------------
                             ---------------
                     617     ;******************************************************************************************
                             **************/
----                 618         RSEG  ?PR?OSCtxSw?OS_CPU_A
0000                 619     OSCtxSw:
                     620         USING   0
                     621     
                     622     
                                 
                                 
                             
                     626     
A51 MACRO ASSEMBLER  OS_CPU_A                                                             05/26/2014 18:04:22 PAGE    11

0000 C000     F      627         PUSH    Os_Enter_Sum            ;保存关中断计数器
                     628                                         ;设置标志：任务再次恢复运行时不必恢复所有寄存器
0002 900000   F      629         MOV     DPTR,#OSMapTbl
0005 E500     F      630         MOV     A,OSTaskID
                     631     
0007 93              632         MOVC    A,@A+DPTR
0008 4200     F      633         ORL     OSFastSwap,A
                             
                                 
                                 
                                 
                                 
                                 
                                 
                             
                                 
                                 
                                 
                             
000A 020000   F      646         LJMP    C_OSCtxSw
                     647     ;****************************************************************************************
                     648     ;/*****************************************************************************************
                             ****************
                     649     ;** 函数名称: C_OSCtxSw
                     650     ;** 功能描述: 堆栈处理函数
                     651     ;** 输　入: 无
                     652     ;** 输　出 : 无
                     653     ;** 全局变量: OSTaskID,OSTsakStackBotton,SP
                     654     ;** 调用模块: LoadCtx
                     655     ;** 
                     656     ;** 作　者: 陈明计
                     657     ;** 日　期: 2002年2月22日
                     658     ;**----------------------------------------------------------------------------------------
                             ---------------
                     659     ;** 修　改: 陈明计
                     660     ;** 日　期: 2002年12月2日
                     661     ;**----------------------------------------------------------------------------------------
                             ---------------
                     662     ;** 修　改:
                     663     ;** 日　期:
                     664     ;**----------------------------------------------------------------------------------------
                             ---------------
                     665     ;******************************************************************************************
                             **************/
----                 666         RSEG  ?PR?C_OSCtxSw?OS_CPU_A
0000                 667     C_OSCtxSw:
                     668     
0000 AA81            669         mov     r2,sp
                     670         
                     671     ;     cp1 = (unsigned char idata *)SP +1;
0002 A881            672         MOV     R0,SP
                     673     
                     674     IF 0  <> 0
                                 mov     sp,#(Sp2-1)             ;堆栈指向临时空间，允许“软非屏蔽中断”
                             ENDIF
                     677     
0004 08              678         INC     R0
                     679     ;     temp = (unsigned char )OSTsakStackBotton[OSNextTaskID+1];
0005 7400     F      680         MOV     A,#LOW (OSTsakStackBotton+01H)
0007 2500     F      681         ADD     A,OSNextTaskID
0009 F9              682         MOV     R1,A
000A E7              683         MOV     A,@R1
000B FF              684         MOV     R7,A
                     685     ;     cp2 = OSTsakStackBotton[OSTaskID+1];
000C 7400     F      686         MOV     A,#LOW (OSTsakStackBotton+01H)
000E 2500     F      687         ADD     A,OSTaskID
A51 MACRO ASSEMBLER  OS_CPU_A                                                             05/26/2014 18:04:22 PAGE    12

0010 F9              688         MOV     R1,A
0011 E7              689         MOV     A,@R1
0012 F9              690         MOV     R1,A
                     691     ;     if( OSNextTaskID > OSTaskID)
0013 E500     F      692         MOV     A,OSNextTaskID
0015 D3              693         SETB    C
0016 9500     F      694         SUBB    A,OSTaskID
0018 4033            695         JC      ?C0001
                     696     ;     {
                     697     ;         while(cp2 != (unsigned char idata *)temp)
                     698     ;         {
                     699     ;             *cp1++ = *cp2++;
                     700     ;         }
001A EF              701         MOV     A,R7
001B C3              702         CLR     C
001C 99              703         SUBB    A,R1
001D FE              704         MOV     R6,A
001E                 705     ?C0002:
001E E7              706         MOV     A,@R1
001F F6              707         MOV     @R0,A
0020 08              708         INC     R0
0021 09              709         INC     R1
0022 DEFA            710         DJNZ    R6,?C0002
0024                 711     ?C0003:
                     712     ;         temp = OSTsakStackBotton[OSTaskID+1] - (unsigned char idata *)SP-1;
0024 7400     F      713         MOV     A,#LOW (OSTsakStackBotton+1)
0026 2500     F      714         ADD     A,OSTaskID
0028 F9              715         MOV     R1,A
0029 E7              716         MOV     A,@R1
002A D3              717         SETB    C
                     718         ;SUBB    A,sp
002B 9A              719         SUBB    A,r2
002C FF              720         MOV     R7,A
                     721     ;         SP = (unsigned char )cp1 - 1;
002D 18              722         DEC     R0;
002E 8881            723         MOV     SP,R0
                     724     ;         for(i = OSTaskID+1;i < OSNextTaskID+1; i++)
                     725     ;         {
                     726     ;             OSTsakStackBotton[i] -= temp;
                     727     ;         }
0030 E500     F      728         MOV     A,OSNextTaskID
0032 C3              729         CLR     C
0033 9500     F      730         SUBB    A,OSTaskID
0035 FE              731         MOV     R6,A
0036 600F            732         JZ      ?C0005
                     733     
0038 7400     F      734         MOV     A,#LOW (OSTsakStackBotton)
003A 2500     F      735         ADD     A,OSTaskID
003C F9              736         MOV     R1,A    
003D EF              737         MOV     A,R7
003E F4              738         CPL     A
003F 04              739         INC     A
0040 FF              740         MOV     R7,A
0041                 741     ?C0004:
0041 09              742         INC     R1
0042 EF              743         MOV     A,R7
0043 27              744         ADD     A,@R1    
0044 F7              745         MOV     @R1,A
0045 DEFA            746         DJNZ    R6,?C0004
0047                 747     ?C0005:
                     748     ;         OSTaskID = OSNextTaskID;
0047 850000   F      749         MOV     OSTaskID,OSNextTaskID
                     750     ;         LoadCtx();    
004A 020000   F      751         LJMP    LoadCtx
                     752     ;     }
004D                 753     ?C0001:
A51 MACRO ASSEMBLER  OS_CPU_A                                                             05/26/2014 18:04:22 PAGE    13

                     754     ; 
                     755     ;     if( OSNextTaskID != OSTaskID)
004D E500     F      756         MOV     A,OSNextTaskID
004F 6500     F      757         XRL     A,OSTaskID
0051 6036            758         JZ      ?C000r
                     759     ;     {
                     760     ;          cp2--;
                     761     ;          cp1--;
                     762     ;         while(cp2 != (unsigned char idata *)temp)
                     763     ;         {
                     764     ;             *cp2-- = *cp1--;
                     765     ;         }
                     766         ;MOV     A,R7
                     767         ;CLR     C
                     768         ;SUBB    A,R1
                     769         ;MOV     R6,A
0053 E8              770         mov     a,r0
0054 C3              771         clr     c
0055 9F              772         subb    a,r7
0056 FE              773         mov     r6,a
0057                 774     ?C0008:
0057 18              775         DEC     R0
0058 19              776         DEC     R1
0059 E6              777         MOV     A,@R0
005A F7              778         MOV     @R1,A
005B DEFA            779         DJNZ    R6,?C0008
005D                 780     ?C0009:
                     781     ;         temp = OSTsakStackBotton[OSTaskID+1] - (unsigned char idata *)SP-1;
005D 7400     F      782         MOV     A,#LOW (OSTsakStackBotton+01H)
005F 2500     F      783         ADD     A,OSTaskID
0061 F9              784         MOV     R1,A
0062 E7              785         MOV     A,@R1
0063 D3              786         SETB    C
                     787         ;SUBB    A,SP
0064 9A              788         SUBB    A,r2
0065 FF              789         MOV     R7,A
                     790     ;         SP = (unsigned char )OSTsakStackBotton[OSNextTaskID+1];
0066 7400     F      791         MOV     A,#LOW (OSTsakStackBotton+01H)
0068 2500     F      792         ADD     A,OSNextTaskID
006A F9              793         MOV     R1,A
006B E7              794         MOV     A,@R1
006C F581            795         MOV     SP,A
                     796     ;         for(i = OSNextTaskID+1;i < OSTaskID+1; i++)
                     797     ;         {
                     798     ;             OSTsakStackBotton[i] += temp;
                     799     ;         }
                     800     
006E E500     F      801         MOV     A,OSTaskID
0070 C3              802         CLR     C
0071 9500     F      803         SUBB    A,OSNextTaskID
0073 600C            804         JZ      ?C0011
                     805     
0075 FE              806         MOV     R6,A
0076 7400     F      807         MOV     A,#LOW (OSTsakStackBotton)
0078 2500     F      808         ADD     A,OSNextTaskID
007A F9              809         MOV     R1,A    
007B                 810     ?C0010:
007B 09              811         INC     R1
007C EF              812         MOV     A,R7
007D 27              813         ADD     A,@R1    
007E F7              814         MOV     @R1,A
007F DEFA            815         DJNZ    R6,?C0010
                     816     
0081                 817     ?C0011:
                     818     ;         OSTaskID = OSNextTaskID;        
0081 850000   F      819         MOV     OSTaskID,OSNextTaskID
A51 MACRO ASSEMBLER  OS_CPU_A                                                             05/26/2014 18:04:22 PAGE    14

                     820     ;         SP--;
0084 1581            821         DEC     SP
                     822     ;     }
0086                 823     ?C0007:
                     824     ;     LoadCtx();
0086 020000   F      825         LJMP    LoadCtx
0089                 826     ?C000r:
                     827     IF 0  <> 0
                                 mov     SP,r2
                             ENDIF
0089 020000   F      830         LJMP    LoadCtx
                     831     ;****************************************************************************************
                     832     ;/*****************************************************************************************
                             ****************
                     833     ;** 函数名称: OSIntCtxSw
                     834     ;** 功能描述: 中断使任务放弃CPU环境保存函数
                     835     ;** 输　入: OSTaskID
                     836     ;** 输　出 : 无
                     837     ;** 全局变量: OSFastSwap
                     838     ;** 调用模块: 无
                     839     ;** 
                     840     ;** 作　者: 陈明计
                     841     ;** 日　期: 2002年2月22日
                     842     ;**----------------------------------------------------------------------------------------
                             ---------------
                     843     ;** 修　改: 陈明计
                     844     ;** 日　期: 2002年12月2日
                     845     ;**----------------------------------------------------------------------------------------
                             ---------------
                     846     ;** 修　改:
                     847     ;** 日　期:
                     848     ;**----------------------------------------------------------------------------------------
                             ---------------
                     849     ;******************************************************************************************
                             **************/
----                 850         RSEG  ?PR?OSIntCtxSw?OS_CPU_A
0000                 851     OSIntCtxSw:
                     852         USING   0
                     853                                             ;是否是优先级最低任务
0000 7405            854         MOV     A,#5
0002 6500     F      855         XRL     A,OSTaskID
0004 700F            856         JNZ     OSIntCtxSw_0
                     857                                             ;是则不需要保存所有寄存器
                     858     ;SP=SP-13-4                             ;4:两层函数调用堆栈，13：寄存器数目
0006 74EF            859         MOV     A,#(-17)
0008 2581            860         ADD     A,SP
000A F581            861         MOV     SP,A
                     862                                             ;跳转到OSCtxSw，同时通知CPU中断处理完成
000C 7400     F      863         MOV     A, #LOW  OSCtxSw
000E C0E0            864         PUSH    ACC
0010 7400     F      865         MOV     A, #HIGH OSCtxSw
0012 C0E0            866         PUSH    ACC
0014 32              867         RETI
                     868                                             ;需要保存所有寄存器
0015                 869     OSIntCtxSw_0:
                     870     ;SP=SP-4                                ;4:两层函数调用堆栈
0015 74FC            871         MOV     A,#0FCH
0017 2581            872         ADD     A,SP
0019 F581            873         MOV     SP,A
                     874                                             ;设置标志：任务再次恢复运行时需要恢复所有寄存器
001B 900000   F      875         MOV     DPTR,#OSMapTbl
001E E500     F      876         MOV     A,OSTaskID
                     877     
0020 93              878         MOVC    A,@A+DPTR
0021 F4              879         CPL     A
0022 5200     F      880         ANL     OSFastSwap,A
A51 MACRO ASSEMBLER  OS_CPU_A                                                             05/26/2014 18:04:22 PAGE    15

                             
                                 
                                 
                                 
                                 
                                 
                                 
                                 
                             
                                 
                                 
                                 
                                 
                             
                             
                     896     
                     897     
                                 
                                 
                             
0024 C000     F      901         PUSH    Os_Enter_Sum            ;保存关中断计数器
                     902                                             ;跳转到堆栈处理，同时通知CPU中断处理完成
0026 7400     F      903         MOV     A, #LOW  C_OSCtxSw
0028 C0E0            904         PUSH    ACC
002A 7400     F      905         MOV     A, #HIGH C_OSCtxSw
002C C0E0            906         PUSH    ACC
002E 32              907         RETI
                     908     
                     909     ;/*****************************************************************************************
                             ****************
                     910     ;**                            End Of File
                     911     ;******************************************************************************************
                             **************/
                     912         END
A51 MACRO ASSEMBLER  OS_CPU_A                                                             05/26/2014 18:04:22 PAGE    16

SYMBOL TABLE LISTING
------ ----- -------


N A M E                      T Y P E  V A L U E   ATTRIBUTES

?C0001. . . . . . . . . . .  C ADDR   004DH   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?C0002. . . . . . . . . . .  C ADDR   001EH   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?C0003. . . . . . . . . . .  C ADDR   0024H   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?C0004. . . . . . . . . . .  C ADDR   0041H   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?C0005. . . . . . . . . . .  C ADDR   0047H   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?C0007. . . . . . . . . . .  C ADDR   0086H   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?C0008. . . . . . . . . . .  C ADDR   0057H   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?C0009. . . . . . . . . . .  C ADDR   005DH   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?C000R. . . . . . . . . . .  C ADDR   0089H   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?C0010. . . . . . . . . . .  C ADDR   007BH   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?C0011. . . . . . . . . . .  C ADDR   0081H   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
?PR?C_OSCTXSW?OS_CPU_A. . .  C SEG    008CH       REL=UNIT
?PR?LOADCTX?OS_CPU_A. . . .  C SEG    0033H       REL=UNIT
?PR?OSCTXSW?OS_CPU_A. . . .  C SEG    000DH       REL=UNIT
?PR?OSINTCTXSW?OS_CPU_A . .  C SEG    002FH       REL=UNIT
?PR?_OSTASKSTKINIT?OS_CPU_A  C SEG    007CH       REL=UNIT
?STACK. . . . . . . . . . .  I SEG    0001H       REL=UNIT
ACC . . . . . . . . . . . .  D ADDR   00E0H   A   
AR6 . . . . . . . . . . . .  D ADDR   0006H   A   
AR7 . . . . . . . . . . . .  D ADDR   0007H   A   
B . . . . . . . . . . . . .  D ADDR   00F0H   A   
C_OSCTXSW . . . . . . . . .  C ADDR   0000H   R   SEG=?PR?C_OSCTXSW?OS_CPU_A
DPH . . . . . . . . . . . .  D ADDR   0083H   A   
DPL . . . . . . . . . . . .  D ADDR   0082H   A   
EA. . . . . . . . . . . . .  B ADDR   00A8H.7 A   
LOADCTX . . . . . . . . . .  C ADDR   0000H   R   SEG=?PR?LOADCTX?OS_CPU_A
LOADCTX_0 . . . . . . . . .  C ADDR   0009H   R   SEG=?PR?LOADCTX?OS_CPU_A
LOADCTX_2 . . . . . . . . .  C ADDR   002BH   R   SEG=?PR?LOADCTX?OS_CPU_A
LOADCTX_3 . . . . . . . . .  C ADDR   0032H   R   SEG=?PR?LOADCTX?OS_CPU_A
OSCTXSW . . . . . . . . . .  C ADDR   0000H   R   SEG=?PR?OSCTXSW?OS_CPU_A
OSFASTSWAP. . . . . . . . .  D ADDR   -----       EXT
OSINTCTXSW. . . . . . . . .  C ADDR   0000H   R   SEG=?PR?OSINTCTXSW?OS_CPU_A
OSINTCTXSW_0. . . . . . . .  C ADDR   0015H   R   SEG=?PR?OSINTCTXSW?OS_CPU_A
OSMAPTBL. . . . . . . . . .  C ADDR   -----       EXT
OSNEXTTASKID. . . . . . . .  D ADDR   -----       EXT
OSTASKID. . . . . . . . . .  D ADDR   -----       EXT
OSTSAKSTACKBOTTON . . . . .  D ADDR   -----       EXT
OS_CPU_A_ASM. . . . . . . .  N NUMB   -----       
OS_ENTER_SUM. . . . . . . .  D ADDR   -----       EXT
PSW . . . . . . . . . . . .  D ADDR   00D0H   A   
SP. . . . . . . . . . . . .  D ADDR   0081H   A   
STACK . . . . . . . . . . .  I ADDR   0000H   R   SEG=?STACK
STKINIT11 . . . . . . . . .  C ADDR   0037H   R   SEG=?PR?_OSTASKSTKINIT?OS_CPU_A
STKINIT12 . . . . . . . . .  C ADDR   006BH   R   SEG=?PR?_OSTASKSTKINIT?OS_CPU_A
STKINIT15 . . . . . . . . .  C ADDR   0049H   R   SEG=?PR?_OSTASKSTKINIT?OS_CPU_A
STKINIT18 . . . . . . . . .  C ADDR   0065H   R   SEG=?PR?_OSTASKSTKINIT?OS_CPU_A
STKINIT5. . . . . . . . . .  C ADDR   003FH   R   SEG=?PR?_OSTASKSTKINIT?OS_CPU_A
STKINIT8. . . . . . . . . .  C ADDR   001AH   R   SEG=?PR?_OSTASKSTKINIT?OS_CPU_A
_OSTASKSTKINIT. . . . . . .  C ADDR   0000H   R   SEG=?PR?_OSTASKSTKINIT?OS_CPU_A


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
