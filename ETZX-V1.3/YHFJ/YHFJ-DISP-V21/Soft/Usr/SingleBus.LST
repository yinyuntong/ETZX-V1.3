C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE SINGLEBUS
OBJECT MODULE PLACED IN SingleBus.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE SingleBus.c LARGE BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*
   2          ************************Copyright(c)************************
   3          *                                  湖南一特电子股份有限公司
   4          *                               All Rights Reserved
   5          *                                        
   6          *
   7          *-----------------------文件信息---------------------------
   8          *文件名称               :SingleBus.c
   9          *文件描述               :单总线程序
  10          *创建人                 :尹运同
  11          *创建日期               :2008-9-22
  12          *版本号                 :V1.0
  13          *注释                   :                                       
  14          *----------------------------------------------------------
  15          *修改人                         :
  16          *修改日期                       :
  17          *版本号                 :
  18          *注释                   :
  19          ***********************************************************
  20          */
  21          #define _IN_SINGLE_BUS_
  22          #include "config.h"
  23          
  24          //总线0变量定义
  25          uint8 bdata byBus0State0        = 0;                                                    //单总线0状态字1
  26          sbit  bBus0StartRec                     = byBus0State0^0;                               //单总线0开始接收起始位标志
  27          sbit  bBus0OnRec                        = byBus0State0^1;                               //单总线0开始接收数据位标志
  28          sbit  bBus0Enable                       = byBus0State0^2;                               //单总线0允许发送标志
  29          sbit  bBus0ReqSend                      = byBus0State0^3;                               //单总线0请求发送标志
  30          sbit  bBus0OnSendBit            = byBus0State0^4;                               //单总线0正在发送一个数据位标志
  31          sbit  bBus0OnSendFreq           = byBus0State0^5;                               //单总线0正在发送一个数据帧标志
  32          sbit  bBus0SendError            = byBus0State0^6;                               //单总线0发送错误标志
  33          sbit  bBus0Error                        = byBus0State0^7;                               //单总线0故障标志
  34          uint8 bdata byBus0State1        = 0;                                                    //单总线0状态字2
  35          sbit  bBus0RecFinish            = byBus0State1^0;                               //单总线0接收完成标志
  36          sbit  bBus0RecBit9                      = byBus0State1^1;                               //单总线0接收字节数据的第9位
  37          sbit  bBus0SendFinish           = byBus0State1^2;                               //单总线0发送完成标志
  38          sbit  bBus0Disable                      = byBus0State1^3;                               //单总线0禁止发送标志
  39          sbit  bBus0SendBit                      = byBus0State1^4;                               //单总线0正在发送的数据位
  40          sbit  bBus0RecBit                       = byBus0State1^5;                               //单总线0正在接收的数据位
  41          uint8 xdata byBus0RecCount = 0;                                                         //高4位是总线0接收定时中断计数，低4位是接收到的位计数
  42          uint8 xdata byBus0RecBuf;                                                                       //总线0接收缓冲单元
  43          uint8 xdata byBus0SendBuf;                                                                      //总线0发送缓冲单元     
  44          uint8 data byBus0RecData[BUS0_FREQ_SIZE];                                       //总线0接收缓冲区
  45          uint8 data byBus0SendData[BUS0_FREQ_SIZE];                                      //总线0发送缓冲区
  46          uint8 xdata byBus0SendCount = 0;                                                                //高4位是总线0发送定时中断计数，低4位是发送的位计数
  47          uint8 xdata byBus0RecSendCount = 0;                                                     //高4位是总线0接收到的字节计数，低4位是总线0发送完的字节计数
  48          uint8 xdata byBus0SendStopCount;                                                                //总线0停止时间计数
  49          uint8 xdata byBus0RecTimeOut = 0;                                                       //总线0接收超时计数
  50          uint8 xdata byBus0DisableCount = 0;                                                     //总线0禁止计数  
  51          uint8 xdata byBus0TxQ[BUS0_TX_Q_ZISE];                                          //总线0发送队列                                                 
  52          uint8 xdata byBus0TxHead = 0;                                                           //单总线0发送队列头指针
  53          uint8 xdata byBus0TxTail = 0;                                                           //单总线0发送队列尾指针
  54          #define IncBus0TxPtr(addr)    {addr=(addr+1)%BUS0_TX_Q_ZISE;}
  55          #define Bus0TxBuffLen()       ((byBus0TxTail+BUS0_TX_Q_ZISE-byBus0TxHead)%BUS0_TX_Q_ZISE) 
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 2   

  56          
  57          
  58          sbit  Bus0RecPin        = P3^3;                                                                 //单总线0接收引脚定义
  59          sbit  Bus0SendPin       = P3^4;                                                                 //单总线0发送引脚定义
  60          
  61          uint8 xdata VolumnValue=0;
  62          
  63          bit bSecondDisState;                                                                            //秒钟闪烁标志
  64          bit bSignflag=0;                                                                                        //正负符号标志
  65          
  66          //STBusFreq xdata stBus0RxQ[MAX_FREQ_NUMBER];                                           ////总线0接收队列
  67          //uint8 xdata byBus0FreqNum=0;                                                  //帧数
  68          uint8 xdata byBus0RxQ[BUS0_RX_Q_ZISE];                                          //总线0接收队列
  69          uint8 xdata byBus0RxHead = 0;                                                           //单总线0接收队列头指针
  70          uint8 xdata byBus0RxTail = 0;                                                           //单总线0接收队列尾指针
  71          
  72          uint8 code byNumPW[7]={8,8,6,6,2,2,4};                                          //编号密码
  73          
  74          
  75          uint8 Bus0RecData(uint8* pbyData);
  76          
  77          /**********************************************************
  78          *函数名称                       :SingleBusInit  
  79          *函数描述               :单总线初始化
  80          *输入参数               :
  81          *返回值                         :       
  82          *全局变量                       :
  83          *调用模块                       :
  84          ***********************************************************
  85          *创建人                 :尹运同
  86          *创建日期                       :2008-9-22
  87          ***********************************************************
  88          *修改人                         :
  89          *修改日期               :
  90          *注释                   :
  91          **********************************************************/
  92          void SingleBusInit(void)
  93          {
  94   1              //STC12C54/56系列M0=0,M1=0:准双向，M0=0,M1=1:推挽，M0=1,M1=0:高阻，M0=1,M1=1:开漏
  95   1              //总线0发送脚设置为推挽输出，接收脚设置为高阻输入:
  96   1      
  97   1      
  98   1              //STC12C52/5A系列:M0=0,M1=0:准双向，M0=0,M1=1:高阻，M0=1,M1=0:推挽，M0=1,M1=1:开漏
  99   1              //总线0接收脚设置为高阻输入:发送脚设置为推挽输出，
 100   1              //P3^3,高阻输入
 101   1              P3M0 &= (~Bin(0,0,0,0,1,0,0,0));
 102   1              P3M1 |=   Bin(0,0,0,0,1,0,0,0);
 103   1      
 104   1              //P3^4推挽输出
 105   1      //      P3M0 |=   Bin(0,0,0,1,0,0,0,0);
 106   1      //      P3M1 &= (~Bin(0,0,0,1,0,0,0,0));
 107   1      
 108   1              //P3^4开漏输出
 109   1              P3M0 |=   Bin(0,0,0,1,0,0,0,0);
 110   1              P3M1 |=   Bin(0,0,0,1,0,0,0,0);
 111   1      
 112   1      
 113   1              //总线电平设置
 114   1              Bus0SendPin = 1;
 115   1              Bus0RecPin = 1;  
 116   1              
 117   1              
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 3   

 118   1      
 119   1              TMOD &= 0xf0;   //  ;t1作波特率发生器(不变)，
 120   1              TMOD |= 0X01;   //t0作方式1（16位)定时器
 121   1      
 122   1              TL0 = TIMER0_L;
 123   1              TH0 = TIMER0_H;
 124   1      
 125   1      /*      TMOD |= 0X02;   //T0作方式2（8位)定时器
 126   1              TL0 = TIMER0_COUNT;
 127   1              TH0 = TIMER0_COUNT;*/
 128   1              
 129   1              TF0 = 0;                                                                                                //清除中断标志
 130   1              AUXR &= (~T0x12);                                                                               //传统12分频速度  
 131   1              ET0 = 1;                                                                                                //允许定时器0中断 
 132   1              TR0 = 1;                                                                                                //启动定时器
 133   1              //其它控制设置
 134   1              byBus0SendStopCount = 240;                                                              //上电总线0禁止发送时间设置             
 135   1              IE1 = 0;                                                                                                //清除中断标志
 136   1              IT1 = 1;                                                                                                //外部中断1为下降沿触发模式                                     
 137   1              if(Bus0RecPin)
 138   1              {       //如果总线正常,开中断   
 139   2                      EX1 = 1;
 140   2              }
 141   1              else
 142   1              {       //如果总线不正常,置总线故障标志                                 
 143   2                      bBus0Error = 1;
 144   2              }       
 145   1      }
 146          /**********************************************************
 147          *函数名称                       :Bus0RecInt     
 148          *函数描述               :外部中断0函数,单总线0接收中断
 149          *输入参数               :
 150          *返回值                         :       
 151          *全局变量                       :
 152          *调用模块                       :
 153          ***********************************************************
 154          *创建人                 :尹运同
 155          *创建日期                       :2008-9-22
 156          ***********************************************************
 157          *修改人                         :
 158          *修改日期               :
 159          *注释                   :
 160          **********************************************************/
 161          #pragma disable
 162          void Bus0RecInt(void) interrupt X1_INTNO
 163          {       
 164   1              DisableBus0RecInt();                                                                    //禁止再次下降沿中断
 165   1              bBus0StartRec = 1;                                                                              //启动起始位沿检测
 166   1              bBus0Enable = 0;                                                                                //禁止总线发送                                                  
 167   1              byBus0RecCount = 0;                                                                             //清接收寄存器          
 168   1      }
 169          /**********************************************************
 170          *函数名称                       :Timer0Int      
 171          *函数描述               :定时器0溢出中断,定时器每500us中断一次
 172                                                   程序间隔检查总线0与总线1的接收和发送
 173          *输入参数               :
 174          *返回值                         :       
 175          *全局变量                       :
 176          *调用模块                       :
 177          ***********************************************************
 178          *创建人                 :陈卫国
 179          *创建日期                       :2008-9-22
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 4   

 180          ***********************************************************
 181          *修改人                         :
 182          *修改日期               :
 183          *注释                   :
 184          **********************************************************/
 185          #pragma disable
 186          void Timer0Int(void) interrupt T0_INTNO
 187          { 
 188   1              TR0=0;
 189   1              TH0=TIMER0_H;
 190   1              TL0=TIMER0_L;
 191   1              TR0=1;
 192   1              
 193   1              bBus0RecBit = Bus0RecPin;       
 194   1              /*******************************总线0接收处理***********************************/
 195   1              if(bBus0StartRec)                                                                               //判断总线所处的状态，接收到起始位
 196   1              {                       
 197   2                      byBus0RecCount += 0x10;                                                         //增加定时中断计数次数
 198   2                      if(0x50 == (byBus0RecCount & 0xf0))                                     //到总线起始位检测时间
 199   2                      {                       
 200   3                              bBus0StartRec = 0;
 201   3                              byBus0RecCount = 0x00;                                                  //重新开始计数                  
 202   3                              if(bBus0RecBit)                 
 203   3                              {       //无效起始位                                                                                                                                            
 204   4                                      if((!bBus0SendError)&&bBus0OnSendFreq)
 205   4                                      {       //没有发生过总线发送错误,且有一帧数据正在发送,停止帧数据发送,置发送错误标志                                             
 206   5                                              byBus0State0 &= (~BUS0_SEND_CON);
 207   5                                              bBus0SendError = 1;
 208   5                                              Bus0SendPin = 1;                                                //释放总线                                      
 209   5                                      }                               
 210   4                                      byBus0SendStopCount = 240;                                      
 211   4                                      byBus0RecSendCount = 0x00;                                      //接收出错,重置接收发送计数值
 212   4                                      EnableBus0RecInt();                             
 213   4                              }
 214   3                              else                                                            
 215   3                              {       //有效起始位
 216   4                                      bBus0OnRec = 1;                                                         //开始接收数据位                                                                                        
 217   4                              }
 218   3                      }
 219   2              }
 220   1              else if(bBus0OnRec)
 221   1              {               
 222   2                      byBus0RecCount += 0x10;                                                         //增加定时中断计数次数                  
 223   2                      if(0xa0 == (byBus0RecCount & 0xf0))
 224   2                      {
 225   3                              byBus0RecCount &= 0x0f;                                                 //清除定时中断计数次数
 226   3                              byBus0RecCount += 0x01;
 227   3                              if(0x0a == (byBus0RecCount & 0x0f))     
 228   3                              {       //收到第10位,结束位                                     
 229   4                                      bBus0OnRec = 0;                                                         //停止数据接收                                  
 230   4                                      if(bBus0RecBit)
 231   4                                      {       //有效的结束位                                                  
 232   5                                              if(((bit)(byBus0RecSendCount & 0xf0) == bBus0RecBit9)) 
 233   5                                              {       //数据桢错误
 234   6                                                      byBus0RecTimeOut = 0;
 235   6                                                      byBus0RecSendCount &= 0x0f;                                                                                     
 236   6                                              }
 237   5                                              else 
 238   5                                              {       //数据桢正确                                    
 239   6                                                      byBus0RecTimeOut = 230;                         //设置下一个字节数据接收超时时间
 240   6                                                      byBus0RecData[byBus0RecSendCount>>4] = byBus0RecBuf;
 241   6                                                      byBus0RecSendCount += 0x10;                                                                                                                                                                     
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 5   

 242   6                                                      if((byBus0RecSendCount & 0xf0) >= BUS0_FREQ_SIZE_HI)
 243   6                                                      {                                                                                                                                                                               
 244   7                                                              byBus0RecSendCount &= 0x0f;                                                     
 245   7                                                              if(!((bBus0OnSendFreq == 1)&&(bBus0ReqSend == 0)))
 246   7                                                              {       //如果接收到的这帧数据是自己发送的不置标志                                                      
 247   8                                                                      if(TRUE==Bus0RecData(byBus0RecData))
 248   8                                                                      {//保存到队列中 
 249   9                                                                              //bBus0RecFinish = 1;
 250   9                                                                      }
 251   8                                                              }                                                                                                                                               
 252   7                                                              byBus0RecTimeOut = 0;
 253   7                                                              byBus0DisableCount = 10;
 254   7                                                              bBus0Disable = 1;                               //禁止总线使用                                                  
 255   7                                                      }       
 256   6                                              }                               
 257   5                                              byBus0SendStopCount = 240;
 258   5                                              EnableBus0RecInt();                                             
 259   5                                      }
 260   4                                      else                                                    
 261   4                                      {       //无效结束位
 262   5                                              bBus0Error = 1;                                                                         
 263   5                                              if((!bBus0SendError) && bBus0OnSendFreq)
 264   5                                              {       //没有发生过总线发送错误,且有一帧数据正在发送,停止帧数据发送,置发送错误标志
 265   6                                                      byBus0State0 &= (~BUS0_SEND_CON);
 266   6                                                      bBus0SendError = 1;                                                     
 267   6                                                      Bus0SendPin = 1;                                        //释放总线
 268   6                                              }
 269   5                                              byBus0RecSendCount = 0x00;                              //接收出错,重置接收发送计数值                                   
 270   5                                      }
 271   4                              }
 272   3                              else if(0x09 == (byBus0RecCount & 0x0f))
 273   3                              {       //第9位数据
 274   4                                      bBus0RecBit9 = bBus0RecBit;                                     
 275   4                              }
 276   3                              else                                                                                    
 277   3                              {       //有效数据位
 278   4                                      byBus0RecBuf >>= 1;
 279   4                                      if(bBus0RecBit)
 280   4                                      {       //为高电平
 281   5                                              byBus0RecBuf |= 0x80;
 282   5                                      }       
 283   4                              }
 284   3                      }
 285   2              }
 286   1              /*******************************总线0发送处理***********************************/
 287   1              if((byBus0State0 & BUS0_CAN_SEND) == BUS0_CAN_SEND)
 288   1              {       //总线0上有数据发送请求,且总线允许发送          
 289   2                      if(bBus0RecBit)
 290   2                      {       //总线正常,可以发送
 291   3                              Bus0SendPin = 0;
 292   3                              bBus0SendBit = 0;                                                               //发送起始位数据                        
 293   3                              byBus0SendCount = 0;
 294   3                              byBus0State0 &= (~BUS0_CAN_SEND);
 295   3                              byBus0SendBuf = byBus0SendData[byBus0RecSendCount & 0x0f];
 296   3                              bBus0OnSendBit = 1;                                                             //取出待发送的数据并置正在发送标志              
 297   3                      }
 298   2                      else
 299   2                      {       //总线不正常,停止发送
 300   3                              byBus0State0 &= (~BUS0_SEND_CON);
 301   3                              bBus0SendError = 1;                     
 302   3                              byBus0RecSendCount &= 0xf0;
 303   3                              Bus0SendPin = 1;
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 6   

 304   3                              byBus0SendStopCount = 240;
 305   3                      }
 306   2              }
 307   1              else if(bBus0OnSendBit)
 308   1              {       //有数据位正在发送,首先发送的是起始位                   
 309   2                      if(bBus0SendBit == bBus0RecBit)                 
 310   2                      {       //发送的数据和接收的数据相同
 311   3                              byBus0SendCount += 0x10;
 312   3                              if(0xa0 == (byBus0SendCount & 0xf0))
 313   3                              {       //一位数据发送完毕,首先发送的是起始位
 314   4                                      byBus0SendCount &= 0x0f;
 315   4                                      byBus0SendCount += 0x01;                                
 316   4                                      if(0x09 == (byBus0SendCount & 0x0f))
 317   4                                      {       //发送到第9位了
 318   5                                              bBus0SendBit = !(bit)(byBus0RecSendCount & 0x0f);
 319   5                                              Bus0SendPin = bBus0SendBit;                                             
 320   5                                      }
 321   4                                      else if(0x0a == (byBus0SendCount & 0x0f))
 322   4                                      {       //发送到结束位了
 323   5                                              bBus0SendBit = 1;
 324   5                                              Bus0SendPin = 1;        
 325   5                                      }
 326   4                                      else if(0x0b == (byBus0SendCount & 0x0f))
 327   4                                      {       //已经发送完结束位了
 328   5                                              bBus0OnSendBit = 0;                                             
 329   5                                              byBus0RecSendCount += 0x01;                                                                     
 330   5                                              if((byBus0RecSendCount & 0x0f) >= BUS0_FREQ_SIZE)
 331   5                                              {       //发送完一帧数据                                                                                                
 332   6                                                      byBus0RecSendCount &= 0xf0;                     //重新进入数据帧的发送阶段
 333   6                                                      byBus0State0 &= (~BUS0_SEND_CON);
 334   6                                                      byBus0SendStopCount = 240;
 335   6                                                      byBus0State1 |= BUS0_SEND_FINISH;                                                               
 336   6                                                      byBus0DisableCount = 10;                                                
 337   6                                              }
 338   5                                              else
 339   5                                              {                                               
 340   6                                                      byBus0SendStopCount = 10;
 341   6                                                      bBus0ReqSend = 1;
 342   6                                              }
 343   5                                              EnableBus0RecInt();                                             //再次使能接收中断
 344   5                                      }
 345   4                                      else
 346   4                                      {
 347   5                                              if(byBus0SendBuf & 0x01)
 348   5                                              {       //发送高电平
 349   6                                                      bBus0SendBit = 1;
 350   6                                                      Bus0SendPin = 1;                                        
 351   6                                              }
 352   5                                              else
 353   5                                              {       //发送低电平
 354   6                                                      bBus0SendBit = 0;
 355   6                                                      Bus0SendPin = 0;
 356   6                                              }
 357   5                                              byBus0SendBuf >>= 1;                                    //发送数据位移位操作
 358   5                                      }
 359   4                              }
 360   3                      }
 361   2                      else
 362   2                      {       //不相同,发送失败                                                               
 363   3                              byBus0State0 &= ~BUS0_SEND_CON;
 364   3                              byBus0RecSendCount &= 0xf0;
 365   3                              bBus0SendError = 1;                                     
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 7   

 366   3                              Bus0SendPin = 1; 
 367   3                              byBus0SendStopCount = 240;
 368   3                      }
 369   2              }       
 370   1              /*******************************总线0控制处理***********************************/
 371   1              if(0 == (byBus0State0 & BUS0_ON_REC))
 372   1              {       
 373   2                      if(byBus0SendStopCount != 0)
 374   2                      {
 375   3                              if((--byBus0SendStopCount) == 0)
 376   3                              {                               
 377   4                                      bBus0Enable = 1;                                                                
 378   4                              }
 379   3                      }               
 380   2                      if(bBus0Error)
 381   2                      {                                                               
 382   3                              bBus0Enable = 0;                        
 383   3                              if(bBus0RecBit)
 384   3                              {                               
 385   4                                      bBus0Error = 0;
 386   4                                      EnableBus0RecInt();
 387   4                                      byBus0SendStopCount = 240;
 388   4                              }
 389   3                      }
 390   2              }       
 391   1              /*******************************总线0超时处理***********************************/
 392   1              if(byBus0RecTimeOut != 0)
 393   1              {
 394   2                      if(--byBus0RecTimeOut == 0)                                                     
 395   2                      {       //接收超时到
 396   3                              byBus0RecSendCount &= 0x0f;                     
 397   3                      }
 398   2              }
 399   1              if(byBus0DisableCount != 0)
 400   1              {
 401   2                      if(--byBus0DisableCount == 0)                                           
 402   2                      {       //禁止超时到            
 403   3                              bBus0Disable = 0;
 404   3                      }
 405   2              }       
 406   1              /***********总线0自动发送管理**********/         
 407   1              if((byBus0State0 & BUS0_ON_WORK) == 0x00)                               
 408   1              {       //总线0没有工作                         
 409   2                      if(bBus0SendError)                                              
 410   2                      {       //产生了发送错误,自动重发                                                               
 411   3                              bBus0SendError = 0;                             
 412   3                              byBus0State0 |= BUS0_REQ_SEND;          
 413   3                      }
 414   2                      else                                                                    
 415   2                      {       //总线0无发送错误               
 416   3                              if(!(bBus0SendFinish|bBus0Disable))
 417   3                              {       //总线0没有禁止使用,且发送结束处理已经完成
 418   4                                      if(Bus0TxBuffLen() >= BUS0_FREQ_SIZE)
 419   4                                      {       //有一帧完整的数据在发送队列中                                                                                                                                          
 420   5                                              byBus0SendData[0] = byBus0TxQ[byBus0TxHead];
 421   5                                              IncBus0TxPtr(byBus0TxHead);
 422   5                                              byBus0SendData[1] = byBus0TxQ[byBus0TxHead];
 423   5                                              IncBus0TxPtr(byBus0TxHead);
 424   5                                              byBus0SendData[2] = byBus0TxQ[byBus0TxHead];
 425   5                                              IncBus0TxPtr(byBus0TxHead);
 426   5                                              byBus0SendData[3] = byBus0TxQ[byBus0TxHead];
 427   5                                              IncBus0TxPtr(byBus0TxHead);
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 8   

 428   5                                              byBus0SendData[4] = byBus0TxQ[byBus0TxHead];
 429   5                                              IncBus0TxPtr(byBus0TxHead);
 430   5                                              byBus0SendData[5] = byBus0TxQ[byBus0TxHead];
 431   5                                              IncBus0TxPtr(byBus0TxHead);
 432   5                                              byBus0SendData[6] = byBus0TxQ[byBus0TxHead];
 433   5                                              IncBus0TxPtr(byBus0TxHead);     
 434   5                                              byBus0State0 |= BUS0_REQ_SEND;                                          
 435   5                                      }
 436   4                                      else
 437   4                                      {       //没有一帧完整的数据在发送队列中了
 438   5                                              byBus0TxHead = byBus0TxTail = 0;
 439   5                                      }                                                               
 440   4                              }
 441   3                      }
 442   2              }       
 443   1      }
 444          
 445          /**********************************************************
 446          *函数名称                       :Bus0OutputData 
 447          *函数描述               :单总线0将待发送数据放入缓冲区
 448          *输入参数               :pbyData:待发送的数据指针
 449          *返回值                         :TRUE:发送成功,FALSE:队列满,发送失败    
 450          *全局变量                       :
 451          *调用模块                       :
 452          ***********************************************************
 453          *创建人                 :尹运同
 454          *创建日期                       :2008-9-22
 455          ***********************************************************
 456          *修改人                         :
 457          *修改日期               :
 458          *注释                   :
 459          **********************************************************/
 460          uint8 Bus0OutputData(uint8* pbyData)
 461          {
 462   1              uint8 byTemp = BUS0_FREQ_SIZE;
 463   1      
 464   1              OS_ENTER_CRITICAL();
 465   1              if(Bus0TxBuffLen() >= (BUS0_TX_Q_ZISE - 1))
 466   1              {       //没有空间存储了,失败   
 467   2                      OS_EXIT_CRITICAL();
 468   2                      return(FALSE);
 469   2              }       
 470   1              while(byTemp--)
 471   1              {       //数据入发送队列
 472   2                      byBus0TxQ[byBus0TxTail] = *pbyData++;
 473   2                      IncBus0TxPtr(byBus0TxTail);
 474   2              }
 475   1              OS_EXIT_CRITICAL();     
 476   1              return(TRUE);   
 477   1      }
 478          
 479          
 480          /**********************************************************
 481          *函数名称                       :Bus0RecData    
 482          *函数描述               :单总线0将单总线上接收的数据放入缓冲区
 483          *输入参数               :pbyData:待接收的数据指针
 484          *返回值                         :TRUE:接收成功,FALSE:队列满,接收失败    
 485          *全局变量                       :
 486          *调用模块                       :
 487          ***********************************************************
 488          *创建人                 :尹运同
 489          *创建日期                       :2008-9-22
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 9   

 490          ***********************************************************
 491          *修改人                         :
 492          *修改日期               :
 493          *注释                   :
 494          **********************************************************/
 495          uint8 Bus0RecData(uint8* pbyData)
 496          {
 497   1              uint8 byTemp = BUS0_FREQ_SIZE;
 498   1      
 499   1              OS_ENTER_CRITICAL();
 500   1              if(Bus0RxBuffLen() >= (BUS0_RX_Q_ZISE - 1))
 501   1              {       //没有空间存储了,失败   
 502   2                      OS_EXIT_CRITICAL();
 503   2                      return(FALSE);
 504   2              }       
 505   1              while(byTemp--)
 506   1              {       //数据入发送队列
 507   2                      byBus0RxQ[byBus0RxTail] = *pbyData++;
 508   2                      IncBus0RxPtr(byBus0RxTail);
 509   2              }
 510   1              OS_EXIT_CRITICAL(); 
 511   1              return(TRUE);
 512   1      
 513   1      }
 514          
 515          /**********************************************************
 516          *函数名称                       :BcdToHex       
 517          *函数描述               :BCD转换成十六进制
 518          *输入参数               :byData:待转换的BCD码数据
 519          *返回值                         :
 520          *全局变量                       :
 521          *调用模块                       :
 522          ***********************************************************
 523          *创建人                 :陈卫国
 524          *创建日期                       :2008-9-22
 525          ***********************************************************
 526          *修改人                         :
 527          *修改日期               :
 528          *注释                   :
 529          **********************************************************/ 
 530          uint8 BcdToHex(uint8 byData)
 531          {
 532   1              uint8 xdata byRet;
 533   1      
 534   1              byRet = byData >> 4;
 535   1              byRet *= 10;
 536   1              byData &= 0x0f;
 537   1              byRet += byData;
 538   1              return(byRet);
 539   1      }
 540          
 541          /**********************************************************
 542          *函数名称                       :AddrCompare    
 543          *函数描述               :比较地址(含广播地址)
 544          *输入参数               :pstBusFreq:待比较的数据帧指针
 545          *返回值                         :1:发送到本机的数据,0:不是发送到本机的数据      
 546          *全局变量                       :
 547          *调用模块                       :
 548          ***********************************************************
 549          *创建人                 :尹运同
 550          *创建日期                       :2008-9-22
 551          ***********************************************************
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 10  

 552          *修改人                         :
 553          *修改日期               :
 554          *注释                   :
 555          **********************************************************/
 556          bit AddrCompare(pSTBusFreq pstBusFreq)
 557          {
 558   1              if((pstBusFreq->byRecSecAddr != 0xff) && (pstBusFreq->byRecSecAddr != stLocalControl.stEepromCfgData.bySe
             -lfSecAddr))
 559   1              {       
 560   2                      return(0);
 561   2              } 
 562   1              if((pstBusFreq->byRecRoomAddr != 0xff) && (pstBusFreq->byRecRoomAddr != stLocalControl.stEepromCfgData.by
             -SelfRoomAddr))
 563   1              {       
 564   2                      return(0);
 565   2              }
 566   1              if((pstBusFreq->byRecBedAddr != 0xff) && (pstBusFreq->byRecBedAddr != stLocalControl.stEepromCfgData.bySe
             -lfBedAddr))
 567   1              {       
 568   2                      return(0);
 569   2              }
 570   1              return(1); 
 571   1      
 572   1      /*      if((pstBusFreq->byRecSecAddr  == 0xff)&&
 573   1                 (pstBusFreq->byRecRoomAddr == 0xff)&&
 574   1                 (pstBusFreq->byRecBedAddr  == 0xff))
 575   1                      return(1);
 576   1              else if((pstBusFreq->byRecSecAddr == stLocalControl.stEepromCfgData.bySelfSecAddr)&&
 577   1                         (pstBusFreq->byRecRoomAddr== stLocalControl.stEepromCfgData.bySelfRoomAddr)&&
 578   1                         (pstBusFreq->byRecBedAddr == stLocalControl.stEepromCfgData.bySelfBedAddr))
 579   1                         return(1);
 580   1              else return(0);
 581   1      */
 582   1      }
 583          /**********************************************************
 584          *函数名称                       :DirAddrCompare 
 585          *函数描述               :绝对比较地址
 586          *输入参数               :pstBusFreq:待比较的数据帧指针
 587          *返回值                         :1:发送到本机的数据,0:不是发送到本机的数据      
 588          *全局变量                       :
 589          *调用模块                       :
 590          ***********************************************************
 591          *创建人                 :尹运同
 592          *创建日期                       :2008-9-22
 593          ***********************************************************
 594          *修改人                         :
 595          *修改日期               :
 596          *注释                   :
 597          **********************************************************/
 598          bit DirAddrCompare(pSTBusFreq pstBusFreq)
 599          {
 600   1              if(pstBusFreq->byRecSecAddr != stLocalControl.stEepromCfgData.bySelfSecAddr)
 601   1              {       
 602   2                      return(0);
 603   2              } 
 604   1              if(pstBusFreq->byRecRoomAddr != stLocalControl.stEepromCfgData.bySelfRoomAddr)
 605   1              {       
 606   2                      return(0);
 607   2              }
 608   1              if(pstBusFreq->byRecBedAddr != stLocalControl.stEepromCfgData.bySelfBedAddr)
 609   1              {       
 610   2                      return(0);
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 11  

 611   2              }
 612   1              return(1); 
 613   1      }
 614          /**********************************************************
 615          *函数名称                       :MakeCH0TimerOut        
 616          *函数描述               :设置通道0超时参数
 617          *输入参数               :byTimerOut:超时时间,byTimerOutCount:超时次数
 618          *返回值                         :
 619          *全局变量                       :stLocalControl
 620          *调用模块                       :
 621          ***********************************************************
 622          *创建人                 :尹运同
 623          *创建日期                       :2008-9-22
 624          ***********************************************************
 625          *修改人                         :
 626          *修改日期               :
 627          *注释                   :
 628          **********************************************************/  
 629          void MakeCH0TimerOut(uint8 byTimerOut, uint8 byTimerOutCount)
 630          {
 631   1              stLocalControl.stCH0TimerOut.byTimerOutSet = byTimerOut;
 632   1              stLocalControl.stCH0TimerOut.byTimerOut = byTimerOut;
 633   1              stLocalControl.stCH0TimerOut.byTimerOutCount = byTimerOutCount; 
 634   1      }
 635          
 636          
 637          /**********************************************************
 638          *函数名称                       :AddCallNod     
 639          *函数描述               :增加呼叫节点
 640          *输入参数               :pstBusFreq:待入链表的总线数据指针
 641          *返回值                         :SAVE_FAIL:失败,SAVE_NORMAL:成功,
 642                                                   SAVE_PRIO_HI:成功,且有高优先级                              
 643          *全局变量                       :stLocalControl
 644          *调用模块                       :
 645          ***********************************************************
 646          *创建人                 :尹运同
 647          *创建日期                       :2009-4-6
 648          ***********************************************************
 649          *修改人                         :
 650          *修改日期               :
 651          *注释                   :
 652          **********************************************************/
 653          uint8 AddCallNod(pSTBusFreq pstBusFreq)
 654          {
 655   1              uint8 xdata i;
 656   1               WDT_CONTR = 0x3d; 
 657   1              if(stLocalControl.byCallCount ==0)
 658   1              {//呼叫队列空
 659   2                      memcpy(stLocalControl.byCallArray[0],pstBusFreq,4);
 660   2                      stLocalControl.byCallCount++;
 661   2                      return true;
 662   2              }
 663   1              else 
 664   1              {//呼叫队列非空,先查找是否有该节点了
 665   2                      for(i=0;i<stLocalControl.byCallCount;i++)
 666   2                      {
 667   3                              if((stLocalControl.byCallArray[i][0]==pstBusFreq->bySndSecAddr)&&
 668   3                                 (stLocalControl.byCallArray[i][1]==pstBusFreq->bySndRoomAddr)&&
 669   3                                 (stLocalControl.byCallArray[i][2]==pstBusFreq->bySndBedAddr)&&
 670   3                                 (stLocalControl.byCallArray[i][3]==pstBusFreq->byCmd))
 671   3                                 break;       //已有该节点,退出
 672   3                      }
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 12  

 673   2                      if(i>=stLocalControl.byCallCount)
 674   2                      {//没有该节点,
 675   3                              if(stLocalControl.byCallCount<MAX_CALL_COUNT)
 676   3                              {
 677   4                                      //将该节点加入到呼叫队列中
 678   4                                      memcpy(stLocalControl.byCallArray[stLocalControl.byCallCount],pstBusFreq,4);
 679   4                                      stLocalControl.byCallCount++;
 680   4                                      return true;
 681   4                              }
 682   3                              else return false;
 683   3                              
 684   3                      }
 685   2                      else return false;
 686   2              }
 687   1              
 688   1      }
 689          /**********************************************************
 690          *函数名称                       :RemoveCallNod  
 691          *函数描述               :删除呼叫节点
 692          *输入参数               :pstBusFreq:待删除的节点数据指针
 693          *返回值                         :
 694          *全局变量                       :stLocalControl
 695          *调用模块                       :
 696          ***********************************************************
 697          *创建人                 :尹运同
 698          *创建日期                       :2009-4-6
 699          ***********************************************************
 700          *修改人                         :
 701          *修改日期               :
 702          *注释                   :
 703          **********************************************************/
 704          void RemoveCallNod(pSTBusFreq pstBusFreq)
 705          {
 706   1      
 707   1              uint8 xdata i;
 708   1               WDT_CONTR = 0x3d; 
 709   1              if(stLocalControl.byCallCount ==0)
 710   1              {//呼叫队列空
 711   2                      return;
 712   2              }
 713   1              else 
 714   1              {//呼叫队列非空,先查找是否有该节点
 715   2                      for(i=0;i<stLocalControl.byCallCount;i++)
 716   2                      {
 717   3                              if((stLocalControl.byCallArray[i][0]==pstBusFreq->byRecSecAddr)&&
 718   3                                 (stLocalControl.byCallArray[i][1]==pstBusFreq->byRecRoomAddr)&&
 719   3                                 (stLocalControl.byCallArray[i][2]==pstBusFreq->byRecBedAddr)&&
 720   3                                 (stLocalControl.byCallArray[i][3]==pstBusFreq->byCmd))
 721   3                                 break;       //已有该节点,退出循环
 722   3                      }
 723   2                      if(i>=stLocalControl.byCallCount)
 724   2                      {//没有该节点,
 725   3                              return;
 726   3                      }
 727   2                      else 
 728   2                      {
 729   3                              stLocalControl.byUpdataRecNum=i;
 730   3                              stLocalControl.byCallCount--;
 731   3                              if(stLocalControl.byUpdataRecNum != stLocalControl.byCallCount)
 732   3                              {//更新的记录不是最后一条记录
 733   4                                      memcpy(stLocalControl.byCallArray[i],stLocalControl.byCallArray[stLocalControl.byCallCount],4);
 734   4                              }
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 13  

 735   3                              memset(stLocalControl.byCallArray[stLocalControl.byCallCount],0x00,4);
 736   3                      }
 737   2              }       
 738   1      }
 739          
 740          
 741          
 742          /**********************************************************
 743          *函数名称                       :SysReset       
 744          *函数描述               :系统复位,该函数仅仅将通道0复位,将通道0
 745                                                   恢复到空闲状态
 746          *输入参数               :
 747          *返回值                         :
 748          *全局变量                       :
 749          *调用模块                       :
 750          ***********************************************************
 751          *创建人                 :尹运同
 752          *创建日期                       :2008-9-22
 753          ***********************************************************
 754          *修改人                         :
 755          *修改日期               :
 756          *注释                   :
 757          **********************************************************/
 758          void SysReset(void)
 759          {       
 760   1      
 761   1      }
 762          
 763          uint8 ParaCrcCheck(uint16 addr)
 764          {
 765   1              uint8 crcResult=0;
 766   1              uint8 crcData =0;
 767   1              uint8 i;
 768   1              uint8 paraData;
 769   1              EnableIAP(IAP_READ);
 770   1              for(i=0;i<sizeof(STEepromCfgData)-1;i++)
 771   1              {
 772   2                      paraData = IapReadByte(addr);
 773   2                      crcResult +=paraData; /*IapReadByte(addr)*/;
 774   2                      addr++;
 775   2              }
 776   1              crcData = IapReadByte(addr);
 777   1              DisableIAP();
 778   1              
 779   1              if(crcData == crcResult) return 1;
 780   1              else return 0;
 781   1      }
 782          
 783          
 784          
 785          uint8 CalcParaCrc(void)
 786          {
 787   1              uint8 crcResult=0;
 788   1              uint8 i;
 789   1              uint8 *addr= &(stLocalControl.stEepromCfgData.byInitFlag);
 790   1              EnableIAP(IAP_READ);
 791   1              for(i=0;i<sizeof(STEepromCfgData)-1;i++)
 792   1              {
 793   2                      crcResult += *addr;
 794   2                      addr++;
 795   2              }
 796   1              DisableIAP();
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 14  

 797   1              return crcResult;
 798   1      }
 799          
 800          
 801          
 802          
 803          
 804          
 805          /**********************************************************
 806          *函数名称                       :SaveParameter  
 807          *函数描述               :存储配置参数,存储参数前先擦除整个扇区,
 808                                                   然后将所有参数重新写入扇区
 809          *输入参数               :
 810          *返回值                         :
 811          *全局变量                       :stLocalControl
 812          *调用模块                       :EnableIAP,IapErase,IapWriteByte,DisableIAP
 813          ***********************************************************
 814          *创建人                 :尹运同
 815          *创建日期                       :2008-9-22
 816          ***********************************************************
 817          *修改人                         :
 818          *修改日期               :
 819          *注释                   :
 820          **********************************************************/
 821          void SaveParameter(uint16 addr)
 822          {  
 823   1              uint8 i;
 824   1              uint16 addr_temp=addr;
 825   1              uint8 *pbyData;
 826   1              uint8 readtimes;
 827   1              uint8 writetimes;
 828   1      
 829   1              stLocalControl.stEepromCfgData.byCrc = CalcParaCrc();
 830   1              WDT_CONTR = 0x3d;       //喂狗
 831   1              writetimes =3;
 832   1              do
 833   1              {
 834   2                      EnableIAP(IAP_ERASE);
 835   2                      IapErase(addr); 
 836   2      
 837   2                      
 838   2                      EnableIAP(IAP_WRITE); 
 839   2                      addr = addr_temp;
 840   2                      pbyData=&(stLocalControl.stEepromCfgData.byInitFlag);
 841   2                      for(i=0;i<sizeof(STEepromCfgData);i++)
 842   2                      {
 843   3                              IapWriteByte(addr,*pbyData);
 844   3                              pbyData++;
 845   3                              addr++;
 846   3                      }
 847   2      
 848   2                      //地址紧跟前一数据区
 849   2                      pbyData=&(stLocalControl.stEepromCfgData.byInitFlag);
 850   2                      for(i=0;i<sizeof(STEepromCfgData);i++)
 851   2                      {
 852   3                              IapWriteByte(addr,*pbyData);
 853   3                              pbyData++;
 854   3                              addr++;
 855   3                      }
 856   2                      
 857   2      
 858   2                      EnableIAP(IAP_READ);
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 15  

 859   2                      readtimes=3;
 860   2                      do
 861   2                      {
 862   3                              WDT_CONTR = 0x3d;       //喂狗
 863   3                              pbyData=&(stLocalControl.stEepromCfgData.byInitFlag);
 864   3                              addr = addr_temp;
 865   3      
 866   3      
 867   3                              for(i=0;i<(sizeof(STEepromCfgData))*2;)
 868   3                              {
 869   4                                      if(*pbyData != IapReadByte(addr)) break;
 870   4                                      
 871   4                                      pbyData++;
 872   4                                      addr++;
 873   4                                      i++;
 874   4                                      if(i== sizeof(STEepromCfgData)) pbyData=&(stLocalControl.stEepromCfgData.byInitFlag);
 875   4                              }       
 876   3      
 877   3                              if(i>= (sizeof(STEepromCfgData)*2))
 878   3                              {//写进去的数据与读出来的数据相同
 879   4                                      break;
 880   4                              }
 881   3                      
 882   3                      }while(--readtimes);
 883   2      
 884   2                      if(readtimes)
 885   2                      {
 886   3                              break;  //相同
 887   3                      }
 888   2              }while(--writetimes);
 889   1      
 890   1              
 891   1              DisableIAP();
 892   1      
 893   1      }
 894          
 895          /**********************************************************
 896          *函数名称                       :ReadParameter  
 897          *函数描述               :将Flash中的配置数据读入到内存中
 898          *输入参数               :
 899          *返回值                         :
 900          *全局变量                       :stLocalControl
 901          *调用模块                       :EnableIAP,IapReadByte,DisableIAP
 902          ***********************************************************
 903          *创建人                 :尹运同
 904          *创建日期                       :2008-9-22
 905          ***********************************************************
 906          *修改人                         :
 907          *修改日期               :
 908          *注释                   :
 909          **********************************************************/
 910          void ReadParameter(uint16 addr)
 911          {
 912   1              uint8 i=0;
 913   1              uint8 *pbyData = &(stLocalControl.stEepromCfgData.byInitFlag);
 914   1              
 915   1              EnableIAP(IAP_READ); 
 916   1              for(i=0;i<sizeof(STEepromCfgData);i++)
 917   1              {
 918   2                      *pbyData = IapReadByte(addr);
 919   2                      pbyData++;
 920   2                      addr++;
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 16  

 921   2              }
 922   1              DisableIAP();
 923   1      
 924   1      }
 925          /**********************************************************
 926          *函数名称                       :InitParameter  
 927          *函数描述               :初始化Flash中的配置数据
 928          *输入参数               :
 929          *返回值                         :
 930          *全局变量                       :stLocalControl
 931          *调用模块                       :EnableIAP,IapReadByte,DisableIAP
 932          ***********************************************************
 933          *创建人                 :尹运同
 934          *创建日期                       :2008-9-22
 935          ***********************************************************
 936          *修改人                         :
 937          *修改日期               :
 938          *注释                   :
 939          **********************************************************/
 940          void InitParameter(void)
 941          {
 942   1              uint8 flagData;
 943   1              uint8 readtimes=3;
 944   1      CheckIapSec0:   
 945   1      
 946   1              do
 947   1              {
 948   2      
 949   2                      if(ParaCrcCheck(IAP0_ADDR) ==1)  break;
 950   2                              
 951   2      
 952   2              }while(--readtimes);
 953   1      
 954   1      
 955   1              if(readtimes)
 956   1              {//第一块校验和正确
 957   2      
 958   2                      EnableIAP(IAP_READ);
 959   2                      flagData = IapReadByte(IAP0_ADDR);
 960   2                      DisableIAP();
 961   2                      
 962   2                      if(flagData == INIT_FLAG)
 963   2                      {//数据已经初始化完毕了,读取数据参数
 964   3                              ReadParameter(IAP0_ADDR);
 965   3                              return;
 966   3                      }
 967   2                      else    goto CheckIapSec1;      
 968   2              }
 969   1      
 970   1              else
 971   1              {
 972   2      CheckIapSec1:   
 973   2                      readtimes=3;    
 974   2                      do
 975   2                      {
 976   3                              if(ParaCrcCheck(IAP0_ADDR+sizeof(STEepromCfgData)) ==1)  break;
 977   3                                      
 978   3                      }while(--readtimes);
 979   2              
 980   2              
 981   2                      if(readtimes)
 982   2                      {//第二块校验和正确
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 17  

 983   3                              EnableIAP(IAP_READ);
 984   3                              flagData = IapReadByte(IAP0_ADDR+sizeof(STEepromCfgData));
 985   3                              DisableIAP();
 986   3                              
 987   3                              if(flagData == INIT_FLAG)
 988   3                              {//数据已经初始化完毕了,读取数据参数
 989   4                                      ReadParameter(IAP0_ADDR+sizeof(STEepromCfgData));
 990   4                                      SaveParameter(IAP0_ADDR);
 991   4                                      return;
 992   4                              }
 993   3                              else    goto UseInitValue;      
 994   3                      }
 995   2                      else
 996   2                      {//第一块和第二块存储区3次读取都失败或者未初始化，应用初始值，但不保存到内部EEPROM中去
 997   3      UseInitValue:
 998   3                              stLocalControl.stEepromCfgData.byInitFlag = INIT_FLAG;
 999   3                              stLocalControl.stEepromCfgData.bySelfSecAddr = 0x01;
1000   3                              stLocalControl.stEepromCfgData.bySelfRoomAddr = YHFJ_ROOM_ADDR;
1001   3                              stLocalControl.stEepromCfgData.bySelfBedAddr = 0x01;
1002   3                              stLocalControl.stEepromCfgData.bySerialNum1= 0xff;
1003   3                              stLocalControl.stEepromCfgData.bySerialNum2= 0xff;
1004   3                              stLocalControl.stEepromCfgData.bySerialNum3= 0xff;
1005   3                              stLocalControl.stEepromCfgData.byVersionHi = 0x03;
1006   3                              stLocalControl.stEepromCfgData.byVersionLo= 0x00;
1007   3                              stLocalControl.stEepromCfgData.byXCoorPara = 0x64;
1008   3                              stLocalControl.stEepromCfgData.byYCoorPara = 0x53;
1009   3                              
1010   3                              stLocalControl.stEepromCfgData.byXTopLeftADValue = 0x0c;
1011   3                              stLocalControl.stEepromCfgData.byYTopLeftADValue = 0x16;
1012   3                              
1013   3                              stLocalControl.stEepromCfgData.uiRs485Brt = 57600;      //黪认波特率57600
1014   3                              stLocalControl.stEepromCfgData.byMaxPlayVolVal=8;
1015   3      
1016   3                              stLocalControl.stEepromCfgData.byCrc = CalcParaCrc();
1017   3                              
1018   3                      }       
1019   2              }
1020   1              DisableIAP();   
1021   1      }
*** WARNING C280 IN LINE 944 OF SINGLEBUS.C: 'CheckIapSec0': unreferenced label
1022          /**********************************************************
1023          *函数名称                       :Bus0RecDeal    
1024          *函数描述               :单总线0收到一帧数据处理函数,该函数首先
1025                                                   取出收到的数据,针对每条命令执行对应的控
1026                                                   制动作
1027          *输入参数               :
1028          *返回值                         :
1029          *全局变量                       :stLocalControl
1030          *调用模块                       :
1031          ***********************************************************
1032          *创建人                 :尹运同
1033          *创建日期                       :2008-9-22
1034          ***********************************************************
1035          *修改人                         :
1036          *修改日期               :
1037          *注释                   :
1038          **********************************************************/
1039          void Bus0RecDeal(void)
1040          {
1041   1      
1042   1              uint16 xdata x,y;
1043   1              
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 18  

1044   1      /*      //取出收到的数据帧
1045   1              uint8 xdata i;
1046   1              OS_ENTER_CRITICAL();
1047   1      //      memcpy(&(stLocalControl.stBusDealFreq), byBus0RecData, sizeof(STBusFreq));
1048   1      //      bBus0RecFinish = 0;
1049   1              memcpy(&(stLocalControl.stBusDealFreq), stBus0RxQ, sizeof(STBusFreq));
1050   1              byBus0FreqNum--;
1051   1              for(i=0;i<byBus0FreqNum;i++)
1052   1              {
1053   1                      stBus0RxQ[i] = stBus0RxQ[i+1];
1054   1              }
1055   1      
1056   1              OS_EXIT_CRITICAL();     
1057   1      */
1058   1      
1059   1      //以下仅供测试用
1060   1              Send_Data((uint8 *)&(stLocalControl.stBusDealFreq),7);
1061   1      
1062   1      /////////////////////////////////////////////////////////////////////////////////////
1063   1      
1064   1      
1065   1      
1066   1              if(bLanding && (stLocalControl.stBusDealFreq.byCmd != CMD_ENTER))
1067   1              {       //如果是登记状态,收到的命令不是登记确认命令,不作处理
1068   2                      return;
1069   2              }       
1070   1              switch(stLocalControl.stBusDealFreq.byCmd)
1071   1              {
1072   2                      case CMD_ENTER:                                                                         //确认登记命令                          
1073   2                              if(bLanding)
1074   2                              {                                       
1075   3                                      bLanding =0;
1076   3                                      MakeCH0TimerOut(0, 0);
1077   3                                      stLocalControl.stEepromCfgData.bySelfSecAddr= stLocalControl.stBusDealFreq.bySndSecAddr;
1078   3                                      stLocalControl.stEepromCfgData.bySelfRoomAddr= stLocalControl.stBusDealFreq.bySndRoomAddr;
1079   3                                      stLocalControl.stEepromCfgData.bySelfBedAddr= stLocalControl.stBusDealFreq.bySndBedAddr;
1080   3                                      SaveParameter(IAP0_ADDR);                                                               
1081   3                              }                       
1082   2                              break;
1083   2                      case CMD_QUEST:                                                                         //查询命令
1084   2                              if(DirAddrCompare(&(stLocalControl.stBusDealFreq)))
1085   2                              {
1086   3                                      stLocalControl.stBusDealFreq.bySndSecAddr = stLocalControl.stEepromCfgData.bySelfSecAddr;
1087   3                                      stLocalControl.stBusDealFreq.bySndRoomAddr = stLocalControl.stEepromCfgData.bySelfRoomAddr;
1088   3                                      stLocalControl.stBusDealFreq.bySndBedAddr = stLocalControl.stEepromCfgData.bySelfBedAddr;
1089   3                                      stLocalControl.stBusDealFreq.byCmd = CMD_QUEST_ANSWER; 
1090   3                                      Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
1091   3                              }
1092   2                              break;
1093   2      
1094   2                      case CMD_DATE_SEND:                                                                     //收到校时命令
1095   2                              stLocalControl.stTime.bySec = stLocalControl.stBusDealFreq.bySndSecAddr & 0x7f;
1096   2                              stLocalControl.stTime.byMin = stLocalControl.stBusDealFreq.bySndRoomAddr & 0x7f;
1097   2                              stLocalControl.stTime.byHour = stLocalControl.stBusDealFreq.bySndBedAddr & 0x3f;
1098   2                              stLocalControl.stTime.byDay = stLocalControl.stBusDealFreq.byRecSecAddr & 0x3f;
1099   2                              stLocalControl.stTime.byMonth = stLocalControl.stBusDealFreq.byRecRoomAddr & 0x1f;
1100   2                              stLocalControl.stTime.byYear = stLocalControl.stBusDealFreq.byRecBedAddr;
1101   2      
1102   2      
1103   2                              DisplayDigit(128,0,stLocalControl.stTime.byYear>>4,WHITE,BLUE,3,DIS_FRAM_MEM0);
1104   2                              DisplayDigit(144,0,stLocalControl.stTime.byYear&0x0f,WHITE,BLUE,3,DIS_FRAM_MEM0);
1105   2                              
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 19  

1106   2                              DisplayDigit(176,0,stLocalControl.stTime.byMonth>>4,WHITE,BLUE,3,DIS_FRAM_MEM0);
1107   2                              DisplayDigit(192,0,stLocalControl.stTime.byMonth&0x0f,WHITE,BLUE,3,DIS_FRAM_MEM0);      
1108   2                                                      
1109   2                              DisplayDigit(224,0,stLocalControl.stTime.byDay>>4,WHITE,BLUE,3,DIS_FRAM_MEM0);
1110   2                              DisplayDigit(240,0,stLocalControl.stTime.byDay&0x0f,WHITE,BLUE,3,DIS_FRAM_MEM0);
1111   2      
1112   2                              DisplayDigit(304,0,stLocalControl.stTime.byHour>>4,WHITE,BLUE,3,DIS_FRAM_MEM0);
1113   2                              DisplayDigit(320,0,stLocalControl.stTime.byHour&0x0f,WHITE,BLUE,3,DIS_FRAM_MEM0);
1114   2                              
1115   2                              DisplayDigit(352,0,stLocalControl.stTime.byMin>>4,WHITE,BLUE,3,DIS_FRAM_MEM0);
1116   2                              DisplayDigit(368,0,stLocalControl.stTime.byMin&0x0f,WHITE,BLUE,3,DIS_FRAM_MEM0); 
1117   2      
1118   2                              
1119   2                              if(stLocalControl.byDisplayFace==SEC_INFO_FACE) Set_VisualPage(DIS_FRAM_MEM0);                          
1120   2                              break;
1121   2                              
1122   2                      case CMD_CALL_LISTEN:                                                           //接听命令
1123   2                              ShowTalkFace(stLocalControl.stBusDealFreq.bySndRoomAddr, stLocalControl.stBusDealFreq.bySndBedAddr,DIS_
             -FRAM_MEM1);
1124   2                              stLocalControl.byKeyInTimes =0;
1125   2                              break;
1126   2                      case CMD_BROADCAST1:
1127   2                      case CMD_BROADCAST2:
1128   2                      case CMD_BROADCAST3:
1129   2                              if((stLocalControl.stBusDealFreq.bySndSecAddr == stLocalControl.stEepromCfgData.bySelfSecAddr) &&
1130   2                                 (stLocalControl.stBusDealFreq.bySndRoomAddr == stLocalControl.stEepromCfgData.bySelfRoomAddr) &&
1131   2                                 (stLocalControl.stBusDealFreq.bySndBedAddr == stLocalControl.stEepromCfgData.bySelfBedAddr))
1132   2                              {       //这条命令是本机发送的
1133   3                                      ShowBroadFace(stLocalControl.stBusDealFreq.bySndRoomAddr, stLocalControl.stBusDealFreq.bySndBedAddr, 1
             -,DIS_FRAM_MEM1);
1134   3                              }
1135   2                              else
1136   2                              {       //这条命令是其他分机发送的
1137   3                                      ShowBroadFace(stLocalControl.stBusDealFreq.bySndRoomAddr, stLocalControl.stBusDealFreq.bySndBedAddr, 0
             -,DIS_FRAM_MEM1);
1138   3                              }
1139   2                              break;
1140   2                              
1141   2      /*              case CMD_INFUSION_CALL:                                                         //输液呼叫命令
1142   2                      case CMD_SERVICE_CALL:                                                          //服务呼叫命令
1143   2                      case CMD_EMERGENCY_CALL:                                                        //紧急呼叫命令
1144   2                      case CMD_HELP_CALL:                                                                     //求援呼叫命令
1145   2                              if(AddCallNod(&(stLocalControl.stBusDealFreq)))
1146   2                              {//成功
1147   2                                      ShowCallFace(0x00);
1148   2                              }
1149   2                              break;  
1150   2      */
1151   2      
1152   2                      case CMD_INFUSION_ENTER:                                                        //输液呼叫命令
1153   2                      case CMD_SERVICE_ENTER:                                                         //服务呼叫命令
1154   2                      case CMD_EMERGENCY_ENTER:                                                       //紧急呼叫命令
1155   2                      case CMD_HELP_ENTER:                                                            //求援呼叫命令
1156   2                              stLocalControl.stBusDealFreq.bySndSecAddr = stLocalControl.stBusDealFreq.byRecSecAddr;
1157   2                              stLocalControl.stBusDealFreq.bySndRoomAddr = stLocalControl.stBusDealFreq.byRecRoomAddr;
1158   2                              stLocalControl.stBusDealFreq.bySndBedAddr = stLocalControl.stBusDealFreq.byRecBedAddr;
1159   2                              stLocalControl.stBusDealFreq.byCmd -= 0x1b;             //将清除命令还原成对应的呼叫命令
1160   2                              AddCallNod(&(stLocalControl.stBusDealFreq));
1161   2                              ShowCallFace1(DIS_FRAM_MEM2);
1162   2                              break;  
1163   2                              
1164   2                      case CMD_INFO_INDICATION:                                                       //屏显示呼叫信息
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 20  

1165   2                              if(stLocalControl.byDisplayFace != INFO_INDICATION_FACE)
1166   2                              {//之前显示界面不是信息指示界面
1167   3                                      if(stLocalControl.byCallCount)
1168   3                                      {
1169   4                                              ShowCallFace0(DIS_FRAM_MEM2);
1170   4                                      }
1171   3                              }
1172   2                              break;
1173   2                              
1174   2                      case CMD_STOP_INDICATION:                                                       //屏关闭呼叫信息显示                            
1175   2                              //ShowSecInfo();
1176   2                              DisplayBlock(0,240,479,271,BLUE,DIS_FRAM_MEM0);
1177   2                              if(stLocalControl.byCallCount==0)
1178   2                              {
1179   3                                      Set_VisualPage(DIS_FRAM_MEM0);
1180   3                                      stLocalControl.byDisplayFace = SEC_INFO_FACE;
1181   3                              }
1182   2                              break;
1183   2                      case CMD_INFUSION_CLEAR:                                                        //清除输液呼叫命令
1184   2                      case CMD_SERVICE_CLEAR:                                                         //清除服务呼叫命令
1185   2                      case CMD_HELP_CLEAR:                                                            //清除求援呼叫命令
1186   2                      case CMD_EMERGENCY_CLEAR:                                                       //清除紧急呼叫命令
1187   2                              stLocalControl.stBusDealFreq.byCmd -= 0x0a;             //将清除命令还原成对应的呼叫命令                
1188   2                              RemoveCallNod(&(stLocalControl.stBusDealFreq));
1189   2      //                      if(stLocalControl.stCallPointer.pstHead)
1190   2                              if(stLocalControl.byCallCount)
1191   2                              {//队列不为空
1192   3                                      ShowCallFace2(DIS_FRAM_MEM2);
1193   3                              }
1194   2                              else
1195   2                              {
1196   3                                      Set_VisualPage(DIS_FRAM_MEM0);
1197   3                                      stLocalControl.byDisplayFace=SEC_INFO_FACE;                     
1198   3                              }
1199   2                              break;
1200   2      
1201   2                      case CMD_INFUSION_ANSWER:                                                       //处理输液呼叫命令
1202   2                      case CMD_SERVICE_ANSWER:                                                        //处理服务呼叫命令
1203   2                      case CMD_EMERGENCY_ANSWER:                                                      //处理紧急呼叫命令
1204   2                      case CMD_HELP_ANSWER:                                                           //处理求援呼叫命令
1205   2                              stLocalControl.stBusDealFreq.byCmd -= 0x06;             //将清除命令还原成对应的呼叫命令                
1206   2                              RemoveCallNod(&(stLocalControl.stBusDealFreq));
1207   2                              if((stLocalControl.stBusDealFreq.bySndSecAddr != stLocalControl.stEepromCfgData.bySelfSecAddr)||
1208   2                                 (stLocalControl.stBusDealFreq.bySndRoomAddr != stLocalControl.stEepromCfgData.bySelfRoomAddr)||
1209   2                                 (stLocalControl.stBusDealFreq.bySndBedAddr != stLocalControl.stEepromCfgData.bySelfBedAddr))
1210   2                              {//不是本医护分机处理的
1211   3                                      if(stLocalControl.byDisplayFace == INFO_INDICATION_FACE)
1212   3                                      {
1213   4                                              if(stLocalControl.byCallCount)
1214   4                                              {//队列不为空
1215   5                                                      ShowCallFace2(DIS_FRAM_MEM2);
1216   5                                              }
1217   4                                              else
1218   4                                              {
1219   5                                                      Set_VisualPage(DIS_FRAM_MEM0);
1220   5                                                      stLocalControl.byDisplayFace=SEC_INFO_FACE;                     
1221   5                                              }
1222   4                                              break;                          
1223   4                                      }
1224   3                              }
1225   2      //                      ShowTalkFace(stLocalControl.stBusDealFreq.byRecRoomAddr,stLocalControl.stBusDealFreq.byRecBedAddr,DIS
             -_FRAM_MEM1);                         
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 21  

1226   2                              break;                  
1227   2      
1228   2                      
1229   2      
1230   2                      case CMD_CLEAR_LCD:                                                                     //清除液晶命令
1231   2                              if(AddrCompare(&(stLocalControl.stBusDealFreq)))
1232   2                              {
1233   3                              Lcd_Clear(BLUE,DIS_FRAM_MEM1);
1234   3                              }
1235   2                              break;
1236   2      
1237   2                      case CMD_POWER_ON:                                                                      //本机重新热启动
1238   2                              if(AddrCompare(&(stLocalControl.stBusDealFreq)))
1239   2                              {       
1240   3                                      OS_ENTER_CRITICAL();                                            
1241   3                                      //关闭所有中断
1242   3                                      CCAPM0 = 0;
1243   3                                      ET0 = 0;
1244   3                                      TR0 = 0;
1245   3                                      EX1 = 0;
1246   3                                      ISP_CONTR = 0x20;                       
1247   3                              }
1248   2                              break;                  
1249   2      
1250   2                                
1251   2                      case CMD_CHANNEL_CLOSE:
1252   2                                //ShowSecInfo();
1253   2                                DisplayBlock(0,240,479,271,BLUE,DIS_FRAM_MEM0);
1254   2                                DisplayBlock(16,240,479,271,BLUE,DIS_FRAM_MEM1);      //将通话音量区域清空
1255   2                                Set_VisualPage(DIS_FRAM_MEM0);
1256   2                                stLocalControl.byDisplayFace = SEC_INFO_FACE;
1257   2                                stLocalControl.byKeyInTimes =0;
1258   2                                break;        
1259   2      
1260   2                      case CMD_KEY_DOWN:              
1261   2                              switch(stLocalControl.byDisplayFace)
1262   2                              {
1263   3                                      case MAIN_MENU_FACE:
1264   3                                               switch(stLocalControl.stBusDealFreq.bySndSecAddr)
1265   3                                              {
1266   4                                                      case KEY_1:     //时间设置
1267   4                                                              memset((unOperData.ASCII_BCD),0x00,10);
1268   4                                                              stLocalControl.byInputBox = INPUT_YEAR;
1269   4                                                              stLocalControl.uiCursorX = 244;         //(480-24*11)/2+5.5*24+4=244
1270   4                                                              stLocalControl.uiCursorY = 51;          //(272-32*5-10)/2=51
1271   4                                                              ShowTimeSet(DIS_FRAM_MEM1);     //在1页显示
1272   4                                                              break;                                                  
1273   4                                                      case KEY_2:     //分机编号设置
1274   4                                                              ShowNumberPWInputFace(DIS_FRAM_MEM1);
1275   4                                                              //ShowNumberSetFace(DIS_FRAM_MEM1);
1276   4                                                              break;                                                  
1277   4                                                      case KEY_3:     
1278   4                                                              stLocalControl.stBusDealFreq.byCmd = CMD_VOICE_TIMER_GET;
1279   4                                                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
1280   4                                                              break;
1281   4                                                      case KEY_4:
1282   4                                                              stLocalControl.stBusDealFreq.byCmd = CMD_BL_TIMER_GET;
1283   4                                                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));                                                   
1284   4                                                              break;
1285   4                                                      case KEY_5:
1286   4                                                              memset((unOperData.ASCII_BCD),0x00,10);
1287   4                                                              stLocalControl.byInputBox = INPUT_WARD_SEC;
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 22  

1288   4                                                              stLocalControl.uiCursorX = 72;          
1289   4                                                              stLocalControl.uiCursorY = 72;  
1290   4                                                              stLocalControl.byKeyInTimes = 0;
1291   4                                                              ShowSecInfoSet(DIS_FRAM_MEM1);  //病区信息设置
1292   4                                                              break;
1293   4      
1294   4                                                      case KEY_6:
1295   4                                                              memset((unOperData.ASCII_BCD),0x00,10);
1296   4                                                              //stLocalControl.byInputBox = INPUT_FIRST_OPER;
1297   4                                                              stLocalControl.uiCursorX = 364;
1298   4                                                              stLocalControl.uiCursorY = 104;
1299   4                                                              stLocalControl.byKeyInTimes = 0;
1300   4                                                              stLocalControl.byOperType = 0;
1301   4                                                              bSignflag = 0;
1302   4                                                              ShowCalculateFace(DIS_FRAM_MEM1);       //显示计算界面
1303   4                                                              break;  
1304   4                                                              
1305   4      
1306   4                                                      case KEY_7:     
1307   4                                                              //stLocalControl.stBusDealFreq.byCmd = CMD_MAX_VOL_GET;
1308   4                                                              //Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));         
1309   4                                                              
1310   4                                                              memset((unOperData.ASCII_BCD),0x00,10);
1311   4                                                              stLocalControl.byInputBox = INPUT_PLAY_VOL_MAX;                 
1312   4                                                              stLocalControl.uiCursorX = 272;
1313   4                                                              stLocalControl.uiCursorY = 60;
1314   4                                                              ShowMaxVolSetFace(DIS_FRAM_MEM1);       //显示最大音量设置界面
1315   4                                                              break;
1316   4                                                              
1317   4                                                      case KEY_9:     
1318   4                                                      case KEY_0:                                                     
1319   4                                                              break;
1320   4                                                      case KEY_CLEAR:
1321   4                                                              Set_VisualPage(DIS_FRAM_MEM0);
1322   4                                                              stLocalControl.byDisplayFace = SEC_INFO_FACE;
1323   4                                                              memcpy(&(stLocalControl.stBusDealFreq.bySndSecAddr),&(stLocalControl.stEepromCfgData.bySelfSecAddr)
             -,3);
1324   4                                                              memcpy(&(stLocalControl.stBusDealFreq.byRecSecAddr),&(stLocalControl.stEepromCfgData.bySelfSecAddr)
             -,3);
1325   4                                                              stLocalControl.stBusDealFreq.byCmd = CMD_MAIN_MENU_ESC;
1326   4                                                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
1327   4                                                              stLocalControl.byKeyInTimes =0 ;
1328   4                                                              break;
1329   4                                                      default:
1330   4                                                              break;
1331   4                                                      
1332   4                                               }
1333   3                                               break;
1334   3                                      case NUMBER_PW_INPUT_FACE://编号密码输入界面
1335   3                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
1336   3                                              {
1337   4                                                      uint8 i=0;
1338   4                                                      y=30;x=250;
1339   4                                                      for(;i<6;i++)
1340   4                                                      {
1341   5                                                              (unOperData.ASCII_BCD)[i]=(unOperData.ASCII_BCD)[i+1];
1342   5                                                              
1343   5                                                      }
1344   4                                                      (unOperData.ASCII_BCD)[6] = stLocalControl.stBusDealFreq.bySndSecAddr;
1345   4                                                      DisplayDigitString(&x,&y,(unOperData.ASCII_BCD),7,BLUE,WHITE,3,DIS_FRAM_MEM1);
1346   4                                              }
1347   3                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr==KEY_ENTER)
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 23  

1348   3                                              {
1349   4                                                      uint8 i=0;
1350   4                                                      for(;i<7;i++)
1351   4                                                      {
1352   5                                                              if(byNumPW[i]!=(unOperData.ASCII_BCD)[i]) break;
1353   5                                                      }
1354   4                                                      if(i>=7)        //密码正确
1355   4                                                      {
1356   5                                                              ShowNumberSetFace(DIS_FRAM_MEM1);
1357   5                                                      }
1358   4                                              }
1359   3                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr==KEY_CLEAR)
1360   3                                              {
1361   4                                                      ShowMainMenuFace(DIS_FRAM_MEM1);
1362   4                                                      stLocalControl.byKeyInTimes =0 ;                                
1363   4                                              }
1364   3                                              break;
1365   3                                              
1366   3                                      case NUMBER_SET_FACE:
1367   3                                               switch(stLocalControl.stBusDealFreq.bySndSecAddr)
1368   3                                               {
1369   4                                                      case KEY_1://本医护分机编号
1370   4                                                              memset((unOperData.ASCII_BCD),0x00,10);
1371   4                                                              stLocalControl.byInputBox = INPUT_SECTION;
1372   4                                                              //stLocalControl.byInputBox = INPUT_BED;
1373   4                                                              stLocalControl.uiCursorX = 204;         //(480-24*8)/2+5*12=204
1374   4                                                              stLocalControl.uiCursorY = 118;         //(272-24*4-8)/2+34=118
1375   4                                                              ShowSelfNumberSet(DIS_FRAM_MEM1);       //在1页显示 
1376   4                                                              break;
1377   4      
1378   4                                                      case KEY_2://卫浴门口分机编号
1379   4                                                              memset((unOperData.ASCII_BCD),0x00,10);
1380   4                                                              //stLocalControl.byInputBox = INPUT_SECTION;
1381   4                                                              stLocalControl.byInputBox = INPUT_BED;
1382   4                                                              stLocalControl.uiCursorX = 204;         //(480-24*8)/2+5*12=204
1383   4                                                              stLocalControl.uiCursorY = 118;         //(272-24*4-8)/2+34=118
1384   4                                                              ShowWcDoorFjNumberSet(DIS_FRAM_MEM1);   //在1页显示 
1385   4                                                              break;
1386   4      
1387   4                                                      case KEY_3:// 移动分机在线编号
1388   4                                                              memset((unOperData.ASCII_BCD),0x00,10);
1389   4                                                              //stLocalControl.byInputBox = INPUT_SECTION;
1390   4                                                              stLocalControl.byInputBox = INPUT_BED;
1391   4                                                              stLocalControl.uiCursorX = 204;         
1392   4                                                              stLocalControl.uiCursorY = 102;         
1393   4                                                              ShowMoveFjNumberSet(DIS_FRAM_MEM1);     //在1页显示 
1394   4                                                              break;
1395   4      
1396   4                                                      case KEY_4:// 加床分机在线编号
1397   4                                                              memset((unOperData.ASCII_BCD),0x00,10);
1398   4                                                              //stLocalControl.byInputBox = INPUT_SECTION;
1399   4                                                              stLocalControl.byInputBox = INPUT_BED;
1400   4                                                              stLocalControl.uiCursorX = 204;         //(480-24*8)/2+5*12=204
1401   4                                                              stLocalControl.uiCursorY = 118;         //(272-24*4-8)/2+34=118
1402   4                                                              ShowAddFjNumberSet(DIS_FRAM_MEM1);      //在1页显示 
1403   4                                                              break;
1404   4                                                              
1405   4                                                      case KEY_5:     //床头分机号码设置
1406   4                                                              memset((unOperData.ASCII_BCD),0x00,10);
1407   4                                                              //stLocalControl.byInputBox = INPUT_SECTION;
1408   4                                                              stLocalControl.byInputBox = INPUT_ROOM;
1409   4                                                              stLocalControl.uiCursorX = 204;         //(480-24*8)/2+5*12=204
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 24  

1410   4                                                              stLocalControl.uiCursorY = 118;         //(272-24*4-8)/2+34=118
1411   4                                                              ShowBedFjNumberSet(DIS_FRAM_MEM1);      //在1页显示*/
1412   4                                                              break;
1413   4                                                              
1414   4                                                      case KEY_CLEAR:
1415   4                                                              ShowMainMenuFace(DIS_FRAM_MEM1);
1416   4                                                              stLocalControl.byKeyInTimes =0 ;
1417   4                                                              break;
1418   4                                               }
1419   3                                               break;
1420   3      
1421   3                                      case TIME_SET_FACE:
1422   3                                              switch(stLocalControl.byInputBox)
1423   3                                              {
1424   4                                                      case INPUT_YEAR:
1425   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
1426   4                                                              {
1427   5                                                                      (unOperData.ASCII_BCD)[0]=(unOperData.ASCII_BCD)[1];
1428   5                                                                      (unOperData.ASCII_BCD)[1]=stLocalControl.stBusDealFreq.bySndSecAddr;
1429   5      
1430   5                                                                      x=stLocalControl.uiCursorX;
1431   5                                                                      y=stLocalControl.uiCursorY;
1432   5                                                                      DisplayDigitString(&x,&y,(unOperData.ASCII_BCD),2,BLUE,WHITE,2,DIS_FRAM_MEM1);
1433   5                                                              }
1434   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
1435   4                                                              {
1436   5                                                                      x=stLocalControl.uiCursorX;
1437   5                                                                      y=stLocalControl.uiCursorY;             
1438   5                                                                      x -=4;
1439   5                                                                      DisplayDigitString(&x,&y,(unOperData.ASCII_BCD),2,WHITE,BLUE,2,DIS_FRAM_MEM1);//已完成输入框颜色恢
             -复正常
1440   5                                                                      DisplayBlock(x,y,x+159,y+23,BLUE,DIS_FRAM_MEM1);
1441   5                                                                      stLocalControl.byInputBox = INPUT_MONTH;
1442   5                                                                      stLocalControl.uiCursorX = 244;         
1443   5                                                                      stLocalControl.uiCursorY = 85;          //51+34=85      
1444   5                                                                      x= stLocalControl.uiCursorX+60;         //28+32
1445   5                                                                      y= stLocalControl.uiCursorY;
1446   5                                                                      DisplayString(&x,&y,"按[确认]键",10,YELLOW,BLUE,2,DIS_FRAM_MEM1);
1447   5                                                              }
1448   4                                                              break;
1449   4                                                      case INPUT_MONTH:
1450   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
1451   4                                                              {
1452   5                                                                      (unOperData.ASCII_BCD)[2]=(unOperData.ASCII_BCD)[3];
1453   5                                                                      (unOperData.ASCII_BCD)[3]=stLocalControl.stBusDealFreq.bySndSecAddr;
1454   5      
1455   5                                                                      x=stLocalControl.uiCursorX;
1456   5                                                                      y=stLocalControl.uiCursorY;
1457   5                                                                      DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[2]),2,BLUE,WHITE,2,DIS_FRAM_MEM1);
1458   5                                                              }
1459   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
1460   4                                                              {
1461   5                                                                      if((((unOperData.ASCII_BCD)[2]*16+(unOperData.ASCII_BCD)[3])<=0x12) && (((unOperData.ASCII_BCD)[2]
             -*16+(unOperData.ASCII_BCD)[3])!=0x00))
1462   5                                                                      {//输入月份数据有效
1463   6                                                                              x=stLocalControl.uiCursorX;
1464   6                                                                              y=stLocalControl.uiCursorY;     
1465   6                                                                              x -= 4;
1466   6                                                                              DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[2]),2,WHITE,BLUE,2,DIS_FRAM_MEM1);//已完成输入
             -蜓丈恢复正常
1467   6                                                                              DisplayBlock(x,y,x+159,y+23,BLUE,DIS_FRAM_MEM1);
1468   6                                                                              stLocalControl.byInputBox = INPUT_DAY;
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 25  

1469   6                                                                              stLocalControl.uiCursorX = 244;         
1470   6                                                                              stLocalControl.uiCursorY = 119;         //85+34=119     
1471   6                                                                              x= stLocalControl.uiCursorX+60;         //28+32
1472   6                                                                              y= stLocalControl.uiCursorY;
1473   6                                                                              DisplayString(&x,&y,"按[确认]键",10,YELLOW,BLUE,2,DIS_FRAM_MEM1);
1474   6      
1475   6                                                                      }
1476   5                                                              }
1477   4                                                              break;                                                  
1478   4                                                      case INPUT_DAY:
1479   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
1480   4                                                              {
1481   5                                                                      (unOperData.ASCII_BCD)[4]=(unOperData.ASCII_BCD)[5];
1482   5                                                                      (unOperData.ASCII_BCD)[5]=stLocalControl.stBusDealFreq.bySndSecAddr;
1483   5      
1484   5                                                                      x=stLocalControl.uiCursorX;
1485   5                                                                      y=stLocalControl.uiCursorY;
1486   5                                                                      DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[4]),2,BLUE,WHITE,2,DIS_FRAM_MEM1);
1487   5                                                              }
1488   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
1489   4                                                              {
1490   5                                                                      if((((unOperData.ASCII_BCD)[4]*16+(unOperData.ASCII_BCD)[5])<=0x31) && (((unOperData.ASCII_BCD)[4]
             -*16+(unOperData.ASCII_BCD)[5])!=0x00))
1491   5                                                                      {//输入日期数据有效                                                     
1492   6                                                                              x=stLocalControl.uiCursorX;
1493   6                                                                              y=stLocalControl.uiCursorY;     
1494   6                                                                              x -=4;
1495   6                                                                              DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[4]),2,WHITE,BLUE,2,DIS_FRAM_MEM1);//已完成输入
             -蜓丈恢复正常
1496   6                                                                              DisplayBlock(x,y,x+159,y+23,BLUE,DIS_FRAM_MEM1);
1497   6                                                                              stLocalControl.byInputBox = INPUT_HOUR;
1498   6                                                                              stLocalControl.uiCursorX = 244;         
1499   6                                                                              stLocalControl.uiCursorY = 153;         //119+34=153    
1500   6                                                                              x= stLocalControl.uiCursorX+60;         //28+32
1501   6                                                                              y= stLocalControl.uiCursorY;
1502   6                                                                              DisplayString(&x,&y,"按[确认]键",10,YELLOW,BLUE,2,DIS_FRAM_MEM1);                                                       
1503   6                                                                      }
1504   5                                                              }
1505   4                                                              break;  
1506   4                                                      case INPUT_HOUR:
1507   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
1508   4                                                              {
1509   5                                                                      (unOperData.ASCII_BCD)[6]=(unOperData.ASCII_BCD)[7];
1510   5                                                                      (unOperData.ASCII_BCD)[7]=stLocalControl.stBusDealFreq.bySndSecAddr;
1511   5      
1512   5                                                                      x=stLocalControl.uiCursorX;
1513   5                                                                      y=stLocalControl.uiCursorY;
1514   5                                                                      DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[6]),2,BLUE,WHITE,2,DIS_FRAM_MEM1);
1515   5                                                              }
1516   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
1517   4                                                              {
1518   5                                                                      if(((unOperData.ASCII_BCD)[6]*16+(unOperData.ASCII_BCD)[7])<0x24)
1519   5                                                                      {//输入小时数据有效                                                             
1520   6                                                                              x=stLocalControl.uiCursorX;
1521   6                                                                              y=stLocalControl.uiCursorY;
1522   6                                                                              x -=4;
1523   6                                                                              DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[6]),2,WHITE,BLUE,2,DIS_FRAM_MEM1);//已完成输入
             -蜓丈恢复正常
1524   6                                                                              DisplayBlock(x,y,x+159,y+23,BLUE,DIS_FRAM_MEM1);
1525   6                                                                              stLocalControl.byInputBox = INPUT_MIN;
1526   6                                                                              stLocalControl.uiCursorX = 244;         
1527   6                                                                              stLocalControl.uiCursorY = 187;         //153+34=187    
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 26  

1528   6                                                                              x= stLocalControl.uiCursorX+60;         //28+32
1529   6                                                                              y= stLocalControl.uiCursorY;
1530   6                                                                              DisplayString(&x,&y,"按[确认]键",10,YELLOW,BLUE,2,DIS_FRAM_MEM1);                                                       
1531   6                                                                      }
1532   5                                                              }
1533   4                                                              break;  
1534   4                                                      case INPUT_MIN:
1535   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
1536   4                                                              {
1537   5                                                                      (unOperData.ASCII_BCD)[8]=(unOperData.ASCII_BCD)[9];
1538   5                                                                      (unOperData.ASCII_BCD)[9]=stLocalControl.stBusDealFreq.bySndSecAddr;
1539   5      
1540   5                                                                      x=stLocalControl.uiCursorX;
1541   5                                                                      y=stLocalControl.uiCursorY;
1542   5                                                                      DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[8]),2,BLUE,WHITE,2,DIS_FRAM_MEM1);
1543   5                                                              }
1544   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
1545   4                                                              {
1546   5                                                                      if(((unOperData.ASCII_BCD)[8]*16+(unOperData.ASCII_BCD)[9])<0x60)
1547   5                                                                      {//输入分钟数据有效                                                     
1548   6                                                                              x=stLocalControl.uiCursorX;
1549   6                                                                              y=stLocalControl.uiCursorY;     
1550   6                                                                              x -=4;
1551   6                                                                              DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[8]),2,WHITE,BLUE,2,DIS_FRAM_MEM1);//已完成输入
             -蜓丈恢复正常
1552   6      
1553   6                                                                              stLocalControl.stTime.byYear  = (unOperData.ASCII_BCD)[0]*16+(unOperData.ASCII_BCD)[1]; //年
1554   6                                                                              stLocalControl.stTime.byMonth =  (unOperData.ASCII_BCD)[2]*16+(unOperData.ASCII_BCD)[3];        //月
1555   6                                                                              stLocalControl.stTime.byDay = (unOperData.ASCII_BCD)[4]*16+(unOperData.ASCII_BCD)[5];   //日
1556   6                                                                              stLocalControl.stTime.byHour= (unOperData.ASCII_BCD)[6]*16+(unOperData.ASCII_BCD)[7];   //时
1557   6                                                                              stLocalControl.stTime.byMin= (unOperData.ASCII_BCD)[8]*16+(unOperData.ASCII_BCD)[9];    //分
1558   6                                                                              stLocalControl.stTime.bySec = 0x00;
1559   6      
1560   6                                                                              //发送到总线顺序：秒，分，时，命令，天，月，年
1561   6                                                                              stLocalControl.stBusDealFreq.bySndSecAddr = stLocalControl.stTime.bySec;
1562   6                                                                              stLocalControl.stBusDealFreq.bySndRoomAddr = stLocalControl.stTime.byMin;
1563   6                                                                              stLocalControl.stBusDealFreq.bySndBedAddr = stLocalControl.stTime.byHour;
1564   6                                                                              stLocalControl.stBusDealFreq.byCmd = CMD_DATE_SEND;
1565   6                                                                              stLocalControl.stBusDealFreq.byRecSecAddr = stLocalControl.stTime.byDay;
1566   6                                                                              stLocalControl.stBusDealFreq.byRecRoomAddr = stLocalControl.stTime.byMonth;
1567   6                                                                              stLocalControl.stBusDealFreq.byRecBedAddr = stLocalControl.stTime.byYear;
1568   6                                                                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
1569   6      
1570   6                                                                              ShowMainMenuFace(DIS_FRAM_MEM1);
1571   6                                                                      }
1572   5                                                                                                                      
1573   5                                                              }
1574   4                                                              break;  
1575   4                                              }
1576   3                                              if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_CLEAR)
1577   3                                              {
1578   4                                                      ShowMainMenuFace(DIS_FRAM_MEM1);
1579   4                                              }
1580   3                                              break;
1581   3                                              
1582   3                                      case BED_FJ_NUMBER_SET_FACE:
1583   3                                              switch(stLocalControl.byInputBox)
1584   3                                              {
1585   4      /*                                              case INPUT_SECTION:
1586   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
1587   4                                                              {
1588   4                                                                      (unOperData.ASCII_BCD)[0]=(unOperData.ASCII_BCD)[1];
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 27  

1589   4                                                                      (unOperData.ASCII_BCD)[1]=(unOperData.ASCII_BCD)[2];
1590   4                                                                      (unOperData.ASCII_BCD)[2]=stLocalControl.stBusDealFreq.bySndSecAddr;
1591   4                                                              
1592   4                                                                      x=stLocalControl.uiCursorX;
1593   4                                                                      y=stLocalControl.uiCursorY;
1594   4                                                                      DisplayDigitString(&x,&y,(unOperData.ASCII_BCD),3,BLUE,WHITE,2,DIS_FRAM_MEM1);
1595   4                                                              }
1596   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
1597   4                                                              {
1598   4                                                                      if((unOperData.ASCII_BCD)[0]*100+(unOperData.ASCII_BCD)[1]*10+(unOperData.ASCII_BCD)[2] <255)
1599   4                                                                      {
1600   4                                                                              x=stLocalControl.uiCursorX;
1601   4                                                                              y=stLocalControl.uiCursorY; 
1602   4                                                                              DisplayDigitString(&x,&y,(unOperData.ASCII_BCD),3,WHITE,BLUE,2,DIS_FRAM_MEM1);//已完成输入框颜色
             -指凑常
1603   4                                                                              DisplayBlock(x,y,x+151,y+23,BLUE,DIS_FRAM_MEM1);        //32+120
1604   4                                                                              stLocalControl.byInputBox = INPUT_ROOM;
1605   4                                                                              stLocalControl.uiCursorX = 204;         
1606   4                                                                              stLocalControl.uiCursorY = 152;         //118+34=152
1607   4                                                                              x=stLocalControl.uiCursorX;
1608   4                                                                              y=stLocalControl.uiCursorY;
1609   4                                                                              DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[3]),3,BLUE,WHITE,2,DIS_FRAM_MEM1);    //显示下一个
             -输入框        
1610   4                                                                              x= stLocalControl.uiCursorX+68;         //36+32
1611   4                                                                              y= stLocalControl.uiCursorY;
1612   4                                                                              DisplayString(&x,&y,"按[确认]键",10,YELLOW,BLUE,2,DIS_FRAM_MEM1);                                               
1613   4                                                                              
1614   4                                                                      }
1615   4                                                              }
1616   4                                                              break;*/
1617   4                                                      case INPUT_ROOM:
1618   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
1619   4                                                              {
1620   5                                                                      (unOperData.ASCII_BCD)[3]=(unOperData.ASCII_BCD)[4];
1621   5                                                                      (unOperData.ASCII_BCD)[4]=(unOperData.ASCII_BCD)[5];
1622   5                                                                      (unOperData.ASCII_BCD)[5]=stLocalControl.stBusDealFreq.bySndSecAddr;
1623   5                                                              
1624   5                                                                      x=stLocalControl.uiCursorX;
1625   5                                                                      y=stLocalControl.uiCursorY;
1626   5                                                                      DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[3]),3,BLUE,WHITE,2,DIS_FRAM_MEM1);
1627   5                                                              }
1628   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
1629   4                                                              {
1630   5                                                                      if((unOperData.ASCII_BCD)[3]*100+(unOperData.ASCII_BCD)[4]*10+(unOperData.ASCII_BCD)[5] <255)
1631   5                                                                      {                                                       
1632   6                                                                              x=stLocalControl.uiCursorX;
1633   6                                                                              y=stLocalControl.uiCursorY; 
1634   6                                                                              DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[3]),3,WHITE,BLUE,2,DIS_FRAM_MEM1);//已完成输入
             -蜓丈恢复正常
1635   6                                                                              DisplayBlock(x,y,x+151,y+23,BLUE,DIS_FRAM_MEM1);        //32+120
1636   6                                                                              stLocalControl.byInputBox = INPUT_BED;
1637   6                                                                              stLocalControl.uiCursorX = 204;         
1638   6                                                                              //stLocalControl.uiCursorY = 186;               //152+34=186
1639   6                                                                              stLocalControl.uiCursorY = 152;         //118+34=152
1640   6      
1641   6                                                                              x=stLocalControl.uiCursorX;
1642   6                                                                              y=stLocalControl.uiCursorY;                                             
1643   6                                                                              DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[6]),3,BLUE,WHITE,2,DIS_FRAM_MEM1);    //显示下一个
             -输入框                                                                        
1644   6                                                                              x= stLocalControl.uiCursorX+68;         //36+32
1645   6                                                                              y= stLocalControl.uiCursorY;
1646   6                                                                              DisplayString(&x,&y,"按[确认]键",10,YELLOW,BLUE,2,DIS_FRAM_MEM1);                                                                       
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 28  

1647   6                                                                      }
1648   5                                                              }
1649   4                                                              break;
1650   4                                                      case INPUT_BED:
1651   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
1652   4                                                              {
1653   5                                                                      (unOperData.ASCII_BCD)[6]=(unOperData.ASCII_BCD)[7];
1654   5                                                                      (unOperData.ASCII_BCD)[7]=(unOperData.ASCII_BCD)[8];
1655   5                                                                      (unOperData.ASCII_BCD)[8]=stLocalControl.stBusDealFreq.bySndSecAddr;
1656   5                                                              
1657   5                                                                      x=stLocalControl.uiCursorX;
1658   5                                                                      y=stLocalControl.uiCursorY;
1659   5                                                                      DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[6]),3,BLUE,WHITE,2,DIS_FRAM_MEM1);
1660   5                                                              }
1661   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
1662   4                                                              {
1663   5                                                                      if((unOperData.ASCII_BCD)[6]*100+(unOperData.ASCII_BCD)[7]*10+(unOperData.ASCII_BCD)[8] <255)
1664   5                                                                      {                                                       
1665   6                                                                              x=stLocalControl.uiCursorX;
1666   6                                                                              y=stLocalControl.uiCursorY;                                                             
1667   6                                                                              DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[6]),3,WHITE,BLUE,2,DIS_FRAM_MEM1);//已完成输入
             -蜓丈恢复正常
1668   6                                                                              DisplayBlock(x,y,x+151,y+23,BLUE,DIS_FRAM_MEM1);        //32+120        
1669   6                                                                              
1670   6                                                                              //stLocalControl.stBusDealFreq.bySndSecAddr = (unOperData.ASCII_BCD)[0]*100+(unOperData.ASCII_BCD
             -)[1]*10+(unOperData.ASCII_BCD)[2];
1671   6                                                                              stLocalControl.stBusDealFreq.bySndSecAddr = stLocalControl.stEepromCfgData.bySelfSecAddr;
1672   6                                                                              stLocalControl.stBusDealFreq.bySndRoomAddr = (unOperData.ASCII_BCD)[3]*100+(unOperData.ASCII_BCD)
             -[4]*10+(unOperData.ASCII_BCD)[5];
1673   6                                                                              stLocalControl.stBusDealFreq.bySndBedAddr = (unOperData.ASCII_BCD)[6]*100+(unOperData.ASCII_BCD)[
             -7]*10+(unOperData.ASCII_BCD)[8];
1674   6                                                                              stLocalControl.stBusDealFreq.byCmd = CMD_SET_NUMBER;
1675   6                                                                              stLocalControl.stBusDealFreq.byRecSecAddr = 0x01;       //开始编号;
1676   6                                                                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
1677   6      
1678   6                                                                              
1679   6                                                                              (unOperData.ASCII_BCD)[8] += 1;
1680   6                                                                              if((unOperData.ASCII_BCD)[8]==10)
1681   6                                                                              {
1682   7                                                                                      (unOperData.ASCII_BCD)[8]=0;
1683   7                                                                                      (unOperData.ASCII_BCD)[7]+= 1;
1684   7                                                                                      if((unOperData.ASCII_BCD)[7]==10)
1685   7                                                                                      {
1686   8                                                                                              (unOperData.ASCII_BCD)[7]=0;
1687   8                                                                                              (unOperData.ASCII_BCD)[6]+= 1;
1688   8                                                                                      }
1689   7                                                                              }
1690   6                                                                              
1691   6                                                                              //stLocalControl.byInputBox = INPUT_SECTION;
1692   6                                                                              stLocalControl.byInputBox = INPUT_ROOM;
1693   6                                                                              stLocalControl.uiCursorX = 204;         
1694   6                                                                              stLocalControl.uiCursorY = 118;         
1695   6                                                                              x=stLocalControl.uiCursorX;
1696   6                                                                              y=stLocalControl.uiCursorY;
1697   6                                                                              DisplayDigitString(&x,&y,&(unOperData.ASCII_BCD[3]),3,BLUE,WHITE,2,DIS_FRAM_MEM1);
1698   6                                                                              
1699   6                                                                              x= stLocalControl.uiCursorX+68;         //36+32
1700   6                                                                              y= stLocalControl.uiCursorY;
1701   6                                                                              DisplayString(&x,&y,"按[确认]键",10,YELLOW,BLUE,2,DIS_FRAM_MEM1);
1702   6                                                                                      
1703   6                                                                      }
1704   5                                                              }
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 29  

1705   4                                                              break;                                                  
1706   4      
1707   4                                              }
1708   3                                              if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_CLEAR)
1709   3                                              {
1710   4                                                      ShowNumberSetFace(DIS_FRAM_MEM1);
1711   4                                              }
1712   3                                              break;
1713   3                                                                                      
1714   3                                      case VOICE_TIMER_SET_FACE:
1715   3                                              switch(stLocalControl.byInputBox)
1716   3                                              {
1717   4                                                      case INPUT_VOICE_START_HOUR:
1718   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
1719   4                                                              {
1720   5                                                                      (unOperData.ASCII_BCD)[0]=(unOperData.ASCII_BCD)[1];
1721   5                                                                      (unOperData.ASCII_BCD)[1]=stLocalControl.stBusDealFreq.bySndSecAddr;
1722   5                                                              
1723   5                                                                      x=stLocalControl.uiCursorX;
1724   5                                                                      y=stLocalControl.uiCursorY;
1725   5                                                                      DisplayDigitString(&x,&y,(unOperData.ASCII_BCD),2,POWDER_BLUE,CYAN,2,DIS_FRAM_MEM1);
1726   5                                                              }
1727   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
1728   4                                                              {
1729   5                                                                      (unOperData.ASCII_BCD)[5] = (unOperData.ASCII_BCD)[0]*16+(unOperData.ASCII_BCD)[1];
1730   5                                                                      if((unOperData.ASCII_BCD)[5] <0x24)
1731   5                                                                      {
1732   6                                                                              x=stLocalControl.uiCursorX;
1733   6                                                                              y=stLocalControl.uiCursorY; 
1734   6                                                                              DisplayDigitString(&x,&y,(unOperData.ASCII_BCD),2,BLACK,YELLOW,2,DIS_FRAM_MEM1);//已完成输入框颜
             -恢复正常
1735   6                                                                              DisplayBlock(x,y,x+151,y+23,YELLOW,DIS_FRAM_MEM1);      //32+120
1736   6                                                                              stLocalControl.byInputBox = INPUT_VOICE_START_MIN;
1737   6                                                                              stLocalControl.uiCursorX = 196;
1738   6                                                                              stLocalControl.uiCursorY = 85;  //51+34=85 
1739   6                                                                              x= stLocalControl.uiCursorX+56;         //24+32
1740   6                                                                              y= stLocalControl.uiCursorY;
1741   6                                                                              DisplayString(&x,&y,"按[确认]键",10,YELLOW,CYAN,2,DIS_FRAM_MEM1);
1742   6                                                                              unOperData.ASCII_BCD[0] =unOperData.ASCII_BCD[6]>>4;
1743   6                                                                              unOperData.ASCII_BCD[1] =unOperData.ASCII_BCD[6]&0x0f;
1744   6      
1745   6                                                                      }
1746   5                                                              }
1747   4                                                              break;
1748   4                                                      case INPUT_VOICE_START_MIN:
1749   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
1750   4                                                              {
1751   5                                                                      (unOperData.ASCII_BCD)[0]=(unOperData.ASCII_BCD)[1];
1752   5                                                                      (unOperData.ASCII_BCD)[1]=stLocalControl.stBusDealFreq.bySndSecAddr;
1753   5                                                              
1754   5                                                                      x=stLocalControl.uiCursorX;
1755   5                                                                      y=stLocalControl.uiCursorY;
1756   5                                                                      DisplayDigitString(&x,&y,unOperData.ASCII_BCD,2,POWDER_BLUE,CYAN,2,DIS_FRAM_MEM1);
1757   5                                                              }
1758   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
1759   4                                                              {
1760   5                                                                      (unOperData.ASCII_BCD)[6] = (unOperData.ASCII_BCD)[0]*16+(unOperData.ASCII_BCD)[1];
1761   5                                                                      if((unOperData.ASCII_BCD)[6]<0x60)
1762   5                                                                      {                                                       
1763   6                                                                              x=stLocalControl.uiCursorX;
1764   6                                                                              y=stLocalControl.uiCursorY; 
1765   6                                                                              DisplayDigitString(&x,&y,unOperData.ASCII_BCD,2,BLACK,YELLOW,2,DIS_FRAM_MEM1);//已完成输入框颜色
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 30  

             -指凑常
1766   6                                                                              DisplayBlock(x,y,x+151,y+23,YELLOW,DIS_FRAM_MEM1);
1767   6                                                                              stLocalControl.byInputBox = INPUT_VOICE_END_HOUR;
1768   6                                                                              stLocalControl.uiCursorX = 196;
1769   6                                                                              stLocalControl.uiCursorY = 153;         //51+34+34*2=153
1770   6                                                                              x= stLocalControl.uiCursorX+56;         //24+32
1771   6                                                                              y= stLocalControl.uiCursorY;
1772   6                                                                              DisplayString(&x,&y,"按[确认]键",10,YELLOW,CYAN,2,DIS_FRAM_MEM1);
1773   6                                                                              unOperData.ASCII_BCD[0] =unOperData.ASCII_BCD[7]>>4;
1774   6                                                                              unOperData.ASCII_BCD[1] =unOperData.ASCII_BCD[7]&0x0f;                                                                  
1775   6                                                                      }
1776   5                                                              }
1777   4                                                              break;
1778   4                                                      case INPUT_VOICE_END_HOUR:
1779   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
1780   4                                                              {
1781   5                                                                      (unOperData.ASCII_BCD)[0]=(unOperData.ASCII_BCD)[1];
1782   5                                                                      (unOperData.ASCII_BCD)[1]=stLocalControl.stBusDealFreq.bySndSecAddr;
1783   5                                                              
1784   5                                                                      x=stLocalControl.uiCursorX;
1785   5                                                                      y=stLocalControl.uiCursorY;
1786   5                                                                      DisplayDigitString(&x,&y,unOperData.ASCII_BCD,2,POWDER_BLUE,CYAN,2,DIS_FRAM_MEM1);
1787   5                                                              }
1788   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
1789   4                                                              {
1790   5                                                                      (unOperData.ASCII_BCD)[7] = (unOperData.ASCII_BCD)[0]*16+(unOperData.ASCII_BCD)[1];
1791   5                                                                      if((unOperData.ASCII_BCD)[7] <0x24)
1792   5                                                                      {                                                       
1793   6                                                                              x=stLocalControl.uiCursorX;
1794   6                                                                              y=stLocalControl.uiCursorY; 
1795   6                                                                              DisplayDigitString(&x,&y,unOperData.ASCII_BCD,2,BLACK,YELLOW,2,DIS_FRAM_MEM1);//已完成输入框颜色
             -指凑常
1796   6                                                                              DisplayBlock(x,y,x+151,y+23,YELLOW,DIS_FRAM_MEM1);
1797   6                                                                              stLocalControl.byInputBox = INPUT_VOICE_END_MIN;
1798   6                                                                              stLocalControl.uiCursorX = 196;
1799   6                                                                              stLocalControl.uiCursorY = 187;         //153+34=187
1800   6                                                                              x= stLocalControl.uiCursorX+56;         //24+32
1801   6                                                                              y= stLocalControl.uiCursorY;
1802   6                                                                              DisplayString(&x,&y,"按[确认]键",10,YELLOW,CYAN,2,DIS_FRAM_MEM1);
1803   6                                                                              unOperData.ASCII_BCD[0] =unOperData.ASCII_BCD[8]>>4;
1804   6                                                                              unOperData.ASCII_BCD[1] =unOperData.ASCII_BCD[8]&0x0f;                                                                  
1805   6                                                                      }
1806   5                                                              }
1807   4                                                              break;  
1808   4                                                              
1809   4                                              case INPUT_VOICE_END_MIN:
1810   4                                                      if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
1811   4                                                      {
1812   5                                                              (unOperData.ASCII_BCD)[0]=(unOperData.ASCII_BCD)[1];
1813   5                                                              (unOperData.ASCII_BCD)[1]=stLocalControl.stBusDealFreq.bySndSecAddr;
1814   5                                                      
1815   5                                                              x=stLocalControl.uiCursorX;
1816   5                                                              y=stLocalControl.uiCursorY;
1817   5                                                              DisplayDigitString(&x,&y,unOperData.ASCII_BCD,2,POWDER_BLUE,CYAN,2,DIS_FRAM_MEM1);
1818   5                                                      }
1819   4                                                      else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
1820   4                                                      {
1821   5                                                              (unOperData.ASCII_BCD)[8] = (unOperData.ASCII_BCD)[0]*16+(unOperData.ASCII_BCD)[1];
1822   5                                                              if((unOperData.ASCII_BCD)[8] <0x60)
1823   5                                                              {                                                       
1824   6                                                                      x=stLocalControl.uiCursorX;
1825   6                                                                      y=stLocalControl.uiCursorY; 
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 31  

1826   6                                                                      DisplayDigitString(&x,&y,unOperData.ASCII_BCD,2,BLACK,YELLOW,2,DIS_FRAM_MEM1);//已完成输入框颜色恢
             -复正常
1827   6                                                                      DisplayBlock(x,y,x+151,y+23,YELLOW,DIS_FRAM_MEM1);
1828   6                                                                      
1829   6                                                                      stLocalControl.byInputBox = INPUT_VOICE_VALUE;
1830   6                                                                      stLocalControl.uiCursorX = 196;
1831   6                                                                      stLocalControl.uiCursorY = 221;         //187+34=221
1832   6                                                                      x= stLocalControl.uiCursorX+56;         //24+32
1833   6                                                                      y= stLocalControl.uiCursorY;
1834   6                                                                      DisplayString(&x,&y,"按[确认]键",10,YELLOW,CYAN,2,DIS_FRAM_MEM1);
1835   6                                                                      unOperData.ASCII_BCD[0] =unOperData.ASCII_BCD[9]>>4;
1836   6                                                                      unOperData.ASCII_BCD[1] =unOperData.ASCII_BCD[9]&0x0f;          
1837   6                                                              }
1838   5                                                      }
1839   4                                                      break;
1840   4      
1841   4                                              case INPUT_VOICE_VALUE:
1842   4                                                      if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
1843   4                                                      {
1844   5                                                              (unOperData.ASCII_BCD)[0]=(unOperData.ASCII_BCD)[1];
1845   5                                                              (unOperData.ASCII_BCD)[1]=stLocalControl.stBusDealFreq.bySndSecAddr;
1846   5      
1847   5                                                              x=stLocalControl.uiCursorX;
1848   5                                                              y=stLocalControl.uiCursorY;
1849   5                                                              DisplayDigitString(&x,&y,unOperData.ASCII_BCD,2,POWDER_BLUE,CYAN,2,DIS_FRAM_MEM1);
1850   5                                                      }
1851   4                                                      else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
1852   4                                                      {
1853   5                                                              (unOperData.ASCII_BCD)[9] = (unOperData.ASCII_BCD)[0]*10+(unOperData.ASCII_BCD)[1];
1854   5                                                              if((unOperData.ASCII_BCD)[9] <9)
1855   5                                                              {                                                       
1856   6                                                                      x=stLocalControl.uiCursorX;
1857   6                                                                      y=stLocalControl.uiCursorY; 
1858   6                                                                      DisplayDigitString(&x,&y,unOperData.ASCII_BCD,2,BLACK,YELLOW,2,DIS_FRAM_MEM1);//已完成输入框颜色恢
             -复正常
1859   6                                                                      DisplayBlock(x,y,x+151,y+23,YELLOW,DIS_FRAM_MEM1);
1860   6      
1861   6                                                                      stLocalControl.stBusDealFreq.bySndSecAddr =     (unOperData.ASCII_BCD)[5];              //开始小时
1862   6                                                                      stLocalControl.stBusDealFreq.bySndRoomAddr =    (unOperData.ASCII_BCD)[6];              //开始分钟
1863   6                                                                      stLocalControl.stBusDealFreq.bySndBedAddr =     0x00;
1864   6                                                                      stLocalControl.stBusDealFreq.byCmd = CMD_VOICE_TIMER_SET;
1865   6                                                                      stLocalControl.stBusDealFreq.byRecSecAddr =     (unOperData.ASCII_BCD)[7];              //开始小时
1866   6                                                                      stLocalControl.stBusDealFreq.byRecRoomAddr =    (unOperData.ASCII_BCD)[8];              //开始分钟
1867   6                                                                      stLocalControl.stBusDealFreq.byRecBedAddr =     (unOperData.ASCII_BCD)[9];
1868   6      
1869   6                                                                      Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
1870   6                                                                      ShowMainMenuFace(DIS_FRAM_MEM1);                
1871   6                                                              }
1872   5                                                      }
1873   4                                                      break;                                                  
1874   4                                              }
1875   3                                              if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_CLEAR)
1876   3                                              {
1877   4                                                      ShowMainMenuFace(DIS_FRAM_MEM1);
1878   4                                              }
1879   3                                              break;
1880   3      
1881   3                                      case MAX_VOL_SET_FACE:
1882   3                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<9)         //有效的音量值
1883   3                                              {
1884   4                                                      (unOperData.ASCII_BCD)[0]= stLocalControl.stBusDealFreq.bySndSecAddr;
1885   4                                                      x=stLocalControl.uiCursorX;
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 32  

1886   4                                                      y=stLocalControl.uiCursorY;
1887   4                                                      DisplayDigitString(&x,&y,unOperData.ASCII_BCD,1,RED,CYAN,2,DIS_FRAM_MEM1);
1888   4                                              }
1889   3                                              
1890   3                                              else  if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
1891   3                                              {
1892   4                                                      stLocalControl.stEepromCfgData.byMaxPlayVolVal= (unOperData.ASCII_BCD)[0];
1893   4                                                              
1894   4                                                      stLocalControl.stBusDealFreq.bySndSecAddr =     stLocalControl.stEepromCfgData.byMaxPlayVolVal;
1895   4                                                      stLocalControl.stBusDealFreq.byCmd = CMD_MAX_VOL_SET;
1896   4                                                      Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
1897   4                                                      ShowMainMenuFace(DIS_FRAM_MEM1);        
1898   4                                                      SaveParameter(IAP0_ADDR);
1899   4                                              }
1900   3                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr==KEY_CLEAR)
1901   3                                              {
1902   4                                                      ShowMainMenuFace(DIS_FRAM_MEM1);
1903   4                                              }
1904   3                                              break;
1905   3      
1906   3                                      case BACK_LIGHT_TIMER_SET_FACE:
1907   3                                              switch(stLocalControl.byInputBox)
1908   3                                              {
1909   4                                                      case INPUT_BL_START_HOUR:
1910   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
1911   4                                                              {
1912   5                                                                      (unOperData.ASCII_BCD)[0]=(unOperData.ASCII_BCD)[1];
1913   5                                                                      (unOperData.ASCII_BCD)[1]=stLocalControl.stBusDealFreq.bySndSecAddr;
1914   5                                                              
1915   5                                                                      x=stLocalControl.uiCursorX;
1916   5                                                                      y=stLocalControl.uiCursorY;
1917   5                                                                      DisplayDigitString(&x,&y,(unOperData.ASCII_BCD),2,BLACK,RED,2,DIS_FRAM_MEM1);
1918   5                                                              }
1919   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
1920   4                                                              {
1921   5                                                                      (unOperData.ASCII_BCD)[5] = (unOperData.ASCII_BCD)[0]*16+(unOperData.ASCII_BCD)[1];
1922   5                                                                      if((unOperData.ASCII_BCD)[5] <0x24)
1923   5                                                                      {
1924   6                                                                              x=stLocalControl.uiCursorX;
1925   6                                                                              y=stLocalControl.uiCursorY; 
1926   6                                                                              DisplayDigitString(&x,&y,(unOperData.ASCII_BCD),2,BLACK,CYAN,2,DIS_FRAM_MEM1);//已完成输入框颜色
             -指凑常
1927   6                                                                              DisplayBlock(x,y,x+151,y+23,CYAN,DIS_FRAM_MEM1);        //32+120        //清除"按确认键"
1928   6                                                                              stLocalControl.byInputBox = INPUT_BL_START_MIN;
1929   6                                                                              stLocalControl.uiCursorX = 196;
1930   6                                                                              stLocalControl.uiCursorY = 85;  //51+34=85  
1931   6                                                                              x= stLocalControl.uiCursorX+56;         //24+32
1932   6                                                                              y= stLocalControl.uiCursorY;
1933   6                                                                              DisplayString(&x,&y,"按[确认]键",10,YELLOW,CYAN,2,DIS_FRAM_MEM1);
1934   6                                                                              unOperData.ASCII_BCD[0] =unOperData.ASCII_BCD[6]>>4;
1935   6                                                                              unOperData.ASCII_BCD[1] =unOperData.ASCII_BCD[6]&0x0f;
1936   6                                                                      }
1937   5                                                              }
1938   4                                                              break;
1939   4                                                      case INPUT_BL_START_MIN:
1940   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
1941   4                                                              {
1942   5                                                                      (unOperData.ASCII_BCD)[0]=(unOperData.ASCII_BCD)[1];
1943   5                                                                      (unOperData.ASCII_BCD)[1]=stLocalControl.stBusDealFreq.bySndSecAddr;
1944   5                                                              
1945   5                                                                      x=stLocalControl.uiCursorX;
1946   5                                                                      y=stLocalControl.uiCursorY;
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 33  

1947   5                                                                      DisplayDigitString(&x,&y,unOperData.ASCII_BCD,2,BLACK,RED,2,DIS_FRAM_MEM1);
1948   5                                                              }
1949   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
1950   4                                                              {
1951   5                                                                      (unOperData.ASCII_BCD)[6] = (unOperData.ASCII_BCD)[0]*16+(unOperData.ASCII_BCD)[1];
1952   5                                                                      if((unOperData.ASCII_BCD)[6] <0x60)
1953   5                                                                      {                                                       
1954   6                                                                              x=stLocalControl.uiCursorX;
1955   6                                                                              y=stLocalControl.uiCursorY; 
1956   6                                                                              DisplayDigitString(&x,&y,unOperData.ASCII_BCD,2,BLACK,CYAN,2,DIS_FRAM_MEM1);//已完成输入框颜色恢
             -凑常
1957   6                                                                              DisplayBlock(x,y,x+151,y+23,CYAN,DIS_FRAM_MEM1);        //32+120        //清除"按确认键"
1958   6                                                                              stLocalControl.byInputBox = INPUT_BL_END_HOUR;
1959   6                                                                              stLocalControl.uiCursorX = 196;
1960   6                                                                              stLocalControl.uiCursorY = 187;         //51+34+34*3=187
1961   6                                                                              x= stLocalControl.uiCursorX+56;         //24+32
1962   6                                                                              y= stLocalControl.uiCursorY;
1963   6                                                                              DisplayString(&x,&y,"按[确认]键",10,YELLOW,CYAN,2,DIS_FRAM_MEM1);
1964   6                                                                              unOperData.ASCII_BCD[0] =unOperData.ASCII_BCD[7]>>4;
1965   6                                                                              unOperData.ASCII_BCD[1] =unOperData.ASCII_BCD[7]&0x0f;                                                                  
1966   6                                                                      }
1967   5                                                              }
1968   4                                                              break;
1969   4                                                      case INPUT_BL_END_HOUR:
1970   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
1971   4                                                              {
1972   5                                                                      (unOperData.ASCII_BCD)[0]=(unOperData.ASCII_BCD)[1];
1973   5                                                                      (unOperData.ASCII_BCD)[1]=stLocalControl.stBusDealFreq.bySndSecAddr;
1974   5                                                              
1975   5                                                                      x=stLocalControl.uiCursorX;
1976   5                                                                      y=stLocalControl.uiCursorY;
1977   5                                                                      DisplayDigitString(&x,&y,unOperData.ASCII_BCD,2,BLACK,RED,2,DIS_FRAM_MEM1);
1978   5                                                              }
1979   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
1980   4                                                              {
1981   5                                                                      (unOperData.ASCII_BCD)[7] = (unOperData.ASCII_BCD)[0]*16+(unOperData.ASCII_BCD)[1];
1982   5                                                                      if((unOperData.ASCII_BCD)[7] <0x24)
1983   5                                                                      {                                                       
1984   6                                                                              x=stLocalControl.uiCursorX;
1985   6                                                                              y=stLocalControl.uiCursorY; 
1986   6                                                                              DisplayDigitString(&x,&y,unOperData.ASCII_BCD,2,BLACK,CYAN,2,DIS_FRAM_MEM1);//已完成输入框颜色恢
             -凑常
1987   6                                                                              DisplayBlock(x,y,x+151,y+23,CYAN,DIS_FRAM_MEM1);        //32+120        //清除"按确认键"
1988   6                                                                              stLocalControl.byInputBox = INPUT_BL_END_MIN;
1989   6                                                                              stLocalControl.uiCursorX = 196;
1990   6                                                                              stLocalControl.uiCursorY = 221;         //51+34+34*3+34=221
1991   6                                                                              x= stLocalControl.uiCursorX+56;         //24+32
1992   6                                                                              y= stLocalControl.uiCursorY;
1993   6                                                                              DisplayString(&x,&y,"按[确认]键",10,YELLOW,CYAN,2,DIS_FRAM_MEM1);
1994   6                                                                              unOperData.ASCII_BCD[0] =unOperData.ASCII_BCD[8]>>4;
1995   6                                                                              unOperData.ASCII_BCD[1] =unOperData.ASCII_BCD[8]&0x0f;                                                                          
1996   6                                                                      }
1997   5                                                              }
1998   4                                                              break;  
1999   4                                                              
2000   4                                              case INPUT_BL_END_MIN:
2001   4                                                      if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
2002   4                                                      {
2003   5                                                              (unOperData.ASCII_BCD)[0]=(unOperData.ASCII_BCD)[1];
2004   5                                                              (unOperData.ASCII_BCD)[1]=stLocalControl.stBusDealFreq.bySndSecAddr;
2005   5                                                      
2006   5                                                              x=stLocalControl.uiCursorX;
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 34  

2007   5                                                              y=stLocalControl.uiCursorY;
2008   5                                                              DisplayDigitString(&x,&y,unOperData.ASCII_BCD,2,BLACK,RED,2,DIS_FRAM_MEM1);
2009   5                                                      }
2010   4                                                      else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
2011   4                                                      {
2012   5                                                              (unOperData.ASCII_BCD)[8] = (unOperData.ASCII_BCD)[0]*16+(unOperData.ASCII_BCD)[1];
2013   5                                                              if((unOperData.ASCII_BCD)[8] <0x60)
2014   5                                                              {                                                       
2015   6                                                                      x=stLocalControl.uiCursorX;
2016   6                                                                      y=stLocalControl.uiCursorY; 
2017   6                                                                      DisplayDigitString(&x,&y,unOperData.ASCII_BCD,2,BLACK,CYAN,2,DIS_FRAM_MEM1);//已完成输入框颜色恢复
             -正常
2018   6                                                                      DisplayBlock(x,y,x+151,y+23,CYAN,DIS_FRAM_MEM1);        //32+120        //清除"按确认键"                                                
2019   6                                                                      stLocalControl.stBusDealFreq.bySndSecAddr =     (unOperData.ASCII_BCD)[5];              //开始小时
2020   6                                                                      stLocalControl.stBusDealFreq.bySndRoomAddr =    (unOperData.ASCII_BCD)[6];              //开始分钟
2021   6                                                                      stLocalControl.stBusDealFreq.bySndBedAddr =     0x00;
2022   6                                                                      stLocalControl.stBusDealFreq.byCmd = CMD_BL_TIMER_SET;
2023   6                                                                      stLocalControl.stBusDealFreq.byRecSecAddr =     (unOperData.ASCII_BCD)[7];              //开始小时
2024   6                                                                      stLocalControl.stBusDealFreq.byRecRoomAddr =    (unOperData.ASCII_BCD)[8];              //开始分钟
2025   6                                                                      stLocalControl.stBusDealFreq.byRecBedAddr =     0x00;
2026   6      
2027   6                                                                      Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
2028   6                                                                      ShowMainMenuFace(DIS_FRAM_MEM1);                
2029   6                                                              }
2030   5                                                      }
2031   4                                                      break;                                  
2032   4                                              }
2033   3                                              if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_CLEAR)
2034   3                                              {
2035   4                                                      ShowMainMenuFace(DIS_FRAM_MEM1);
2036   4                                              }
2037   3                                              break;
2038   3      
2039   3                                      case SEC_INFO_SET_FACE:
2040   3                                              stLocalControl.bySecondFlashTime =0;
2041   3                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
2042   3                                              {
2043   4                                                      if(stLocalControl.byKeyInTimes<3)
2044   4                                                      {
2045   5                                                              (unOperData.ASCII_BCD)[stLocalControl.byKeyInTimes]= stLocalControl.stBusDealFreq.bySndSecAddr;
2046   5                                                              stLocalControl.byKeyInTimes ++;
2047   5                                                      }
2048   4                                                      else
2049   4                                                      {
2050   5                                                              (unOperData.ASCII_BCD)[0]=stLocalControl.stBusDealFreq.bySndSecAddr;
2051   5                                                              stLocalControl.byKeyInTimes =1;
2052   5                                                      }
2053   4                                                      
2054   4                                                      x=stLocalControl.uiCursorX;
2055   4                                                      y=stLocalControl.uiCursorY;
2056   4                                                      DisplayBlock(x,y,x+39,y+23,GREEN,DIS_FRAM_MEM1);
2057   4                                                      DisplayDigitString(&x,&y,(unOperData.ASCII_BCD),stLocalControl.byKeyInTimes,BLACK,GREEN,2,DIS_FRAM_M
             -EM1);
2058   4                                              }
2059   3                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_MR)    //退格
2060   3                                              {
2061   4                                                      if(stLocalControl.byKeyInTimes>0)
2062   4                                                      {
2063   5                                                              stLocalControl.byKeyInTimes--;
2064   5                                                              x=stLocalControl.uiCursorX;
2065   5                                                              y=stLocalControl.uiCursorY;
2066   5                                                              DisplayBlock(x,y,x+39,y+23,GREEN,DIS_FRAM_MEM1);
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 35  

2067   5                                                              DisplayDigitString(&x,&y,(unOperData.ASCII_BCD),stLocalControl.byKeyInTimes,BLACK,GREEN,2,DIS_FRAM_
             -MEM1);                                                                        
2068   5                                                      }
2069   4                                              }
2070   3                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
2071   3                                              {
2072   4                                                      stLocalControl.bySecondFlashTime =25;
2073   4                                                      if(stLocalControl.byKeyInTimes==0)
2074   4                                                      {
2075   5                                                              (unOperData.uiOperData)[4] = WardDataBuff[stLocalControl.byInputBox+6];
2076   5                                                              (unOperData.ASCII_BCD)[0] = (unOperData.uiOperData)[4]/100;
2077   5                                                              (unOperData.ASCII_BCD)[1] = ((unOperData.uiOperData)[4]%100)/10;
2078   5                                                              (unOperData.ASCII_BCD)[2] = ((unOperData.uiOperData)[4]%100)%10;
2079   5                                                              if((unOperData.ASCII_BCD)[0])
2080   5                                                              {
2081   6                                                                      stLocalControl.byKeyInTimes =3;         //虚拟一个3
2082   6                                                              }
2083   5                                                              else if((unOperData.ASCII_BCD)[1])
2084   5                                                              {
2085   6                                                                      (unOperData.ASCII_BCD)[0] =(unOperData.ASCII_BCD)[1];
2086   6                                                                      (unOperData.ASCII_BCD)[1] =(unOperData.ASCII_BCD)[2];
2087   6                                                                      stLocalControl.byKeyInTimes =2;         //虚拟一个2
2088   6                                                              }
2089   5                                                              else 
2090   5                                                              {                                                       
2091   6                                                                      (unOperData.ASCII_BCD)[0] =(unOperData.ASCII_BCD)[2];
2092   6                                                                      stLocalControl.byKeyInTimes =1;         //虚拟一个1
2093   6                                                              }                                                       
2094   5                                                      }
2095   4      
2096   4                                                      else 
2097   4                                                      {
2098   5                                                              if(stLocalControl.byKeyInTimes==3)
2099   5                                                              {
2100   6                                                                      (unOperData.uiOperData)[4] = (unOperData.ASCII_BCD)[0]*100+(unOperData.ASCII_BCD)[1]*10+(unOperDat
             -a.ASCII_BCD)[2];
2101   6                                                                      
2102   6                                                              }
2103   5                                                              else if(stLocalControl.byKeyInTimes==2)
2104   5                                                              {
2105   6                                                                      (unOperData.uiOperData)[4] = (unOperData.ASCII_BCD)[0]*10+(unOperData.ASCII_BCD)[1];
2106   6                                                                      
2107   6                                                              }
2108   5                                                              else if(stLocalControl.byKeyInTimes==1)
2109   5                                                              {
2110   6                                                                      (unOperData.uiOperData)[4] = (unOperData.ASCII_BCD)[0];
2111   6                                                                      
2112   6                                                              }                                                       
2113   5                                                      }
2114   4                                                      if((unOperData.uiOperData)[4]<=255)
2115   4                                                      {
2116   5                                                              x=stLocalControl.uiCursorX;
2117   5                                                              y=stLocalControl.uiCursorY; 
2118   5                                                              DisplayBlock(x,y,x+39,y+23,WHITE,DIS_FRAM_MEM1);
2119   5                                                              DisplayDigitString(&x,&y,(unOperData.ASCII_BCD),stLocalControl.byKeyInTimes,BLACK,WHITE,2,DIS_FRAM_
             -MEM1);//已完成输入框颜色恢复正常
2120   5                                                                                                                              
2121   5                                                              switch(stLocalControl.byInputBox)
2122   5                                                              {
2123   6                                                                      case INPUT_WARD_SEC:                                                    
2124   6                                                                              WardDataBuff[6]= (uint8)(unOperData.uiOperData)[4];
2125   6                                                                              stLocalControl.byInputBox = INPUT_PATIENT_SUM;
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 36  

2126   6                                                                              stLocalControl.uiCursorX = 360;
2127   6                                                                              stLocalControl.uiCursorY = 72;
2128   6                                                                              break;                                                  
2129   6                                                                      case INPUT_PATIENT_SUM:                                                 
2130   6                                                                              WardDataBuff[7]= (uint8)(unOperData.uiOperData)[4];
2131   6                                                                              stLocalControl.byInputBox = INPUT_TERMINAL_PATIENT_SUM;
2132   6                                                                              stLocalControl.uiCursorX = 72;
2133   6                                                                              stLocalControl.uiCursorY = 107;
2134   6                                                                              break;
2135   6                                                                      case INPUT_TERMINAL_PATIENT_SUM:
2136   6                                                                              WardDataBuff[8]= (uint8)(unOperData.uiOperData)[4];
2137   6                                                                              stLocalControl.byInputBox = INPUT_BED_SUM;
2138   6                                                                              stLocalControl.uiCursorX = 232;
2139   6                                                                              stLocalControl.uiCursorY = 107;
2140   6                                                                              break;  
2141   6                                                                      case INPUT_BED_SUM:
2142   6                                                                              WardDataBuff[9]= (uint8)(unOperData.uiOperData)[4];
2143   6                                                                              stLocalControl.byInputBox = INPUT_EMPTY_BED_SUM;
2144   6                                                                              stLocalControl.uiCursorX = 392;
2145   6                                                                              stLocalControl.uiCursorY = 107;
2146   6                                                                              break;
2147   6                                                                      case INPUT_EMPTY_BED_SUM:
2148   6                                                                              WardDataBuff[10]= (uint8)(unOperData.uiOperData)[4];
2149   6                                                                              stLocalControl.byInputBox = INPUT_ADMISSION_SUM;
2150   6                                                                              stLocalControl.uiCursorX = 72;
2151   6                                                                              stLocalControl.uiCursorY = 142;
2152   6                                                                              break;
2153   6                                                                      case INPUT_ADMISSION_SUM:
2154   6                                                                              WardDataBuff[11]= (uint8)(unOperData.uiOperData)[4];
2155   6                                                                              stLocalControl.byInputBox = INPUT_DISCHARGE_SUM;
2156   6                                                                              stLocalControl.uiCursorX = 312;
2157   6                                                                              stLocalControl.uiCursorY = 142;
2158   6                                                                              break;  
2159   6                                                                      case INPUT_DISCHARGE_SUM:       //出院
2160   6                                                                              WardDataBuff[12]= (uint8)(unOperData.uiOperData)[4];
2161   6                                                                              stLocalControl.byInputBox = INPUT_SWITCH_IN_SUM;
2162   6                                                                              stLocalControl.uiCursorX = 72;
2163   6                                                                              stLocalControl.uiCursorY = 175;
2164   6                                                                              break;
2165   6                                                                      case INPUT_SWITCH_IN_SUM:
2166   6                                                                              WardDataBuff[13]= (uint8)(unOperData.uiOperData)[4];
2167   6                                                                              stLocalControl.byInputBox = INPUT_SWITCH_OUT_SUM;
2168   6                                                                              stLocalControl.uiCursorX = 312;
2169   6                                                                              stLocalControl.uiCursorY = 175;
2170   6                                                                              break;  
2171   6                                                                      case INPUT_SWITCH_OUT_SUM:
2172   6                                                                              WardDataBuff[14]= (uint8)(unOperData.uiOperData)[4];
2173   6                                                                              stLocalControl.byInputBox = INPUT_PRIMARY_CARE_SUM;
2174   6                                                                              stLocalControl.uiCursorX = 120;
2175   6                                                                              stLocalControl.uiCursorY = 209;
2176   6                                                                              break;
2177   6                                                                      case INPUT_PRIMARY_CARE_SUM:
2178   6                                                                              WardDataBuff[15]= (uint8)(unOperData.uiOperData)[4];
2179   6                                                                              stLocalControl.byInputBox = INPUT_OXYGEN_SUPPLY_SUM;
2180   6                                                                              stLocalControl.uiCursorX = 312;
2181   6                                                                              stLocalControl.uiCursorY = 209;
2182   6                                                                              break;  
2183   6                                                                      case INPUT_OXYGEN_SUPPLY_SUM:
2184   6                                                                              WardDataBuff[16]= (uint8)(unOperData.uiOperData)[4];
2185   6      
2186   6                                                                              AAI_Write(WARD_FACE_DATA_START_ADDR,WardDataBuff,WARD_FACE_DATA_LEN);
2187   6      
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 37  

2188   6                                                                              ShowMainMenuFace(DIS_FRAM_MEM1);
2189   6                                                                              StoreSecInfo(DIS_FRAM_MEM0);
2190   6      
2191   6                                                                              memcpy(&(stLocalControl.stBusDealFreq.bySndSecAddr),&(WardDataBuff[6]),0x03);
2192   6                                                                              stLocalControl.stBusDealFreq.byCmd = CMD_WARD_SEC_INFO_SET;
2193   6                                                                              stLocalControl.stBusDealFreq.byRecSecAddr =  WardDataBuff[9];
2194   6                                                                              stLocalControl.stBusDealFreq.byRecRoomAddr = WardDataBuff[10];
2195   6                                                                              stLocalControl.stBusDealFreq.byRecBedAddr = 0x01;       //第一帧数据
2196   6                                                                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
2197   6                                                                              //OSWait(K_TMO,100);    //延时500ms
2198   6                                                                              Delayms(1000);
2199   6      
2200   6                                                                              memcpy(&(stLocalControl.stBusDealFreq.bySndSecAddr),&(WardDataBuff[11]),0x03);
2201   6                                                                              stLocalControl.stBusDealFreq.byCmd = CMD_WARD_SEC_INFO_SET;
2202   6                                                                              stLocalControl.stBusDealFreq.byRecSecAddr =  WardDataBuff[14];
2203   6                                                                              stLocalControl.stBusDealFreq.byRecRoomAddr = WardDataBuff[15];
2204   6                                                                              stLocalControl.stBusDealFreq.byRecBedAddr = 0x02;       //第二帧数据
2205   6                                                                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
2206   6                                                                              //OSWait(K_TMO,100);    //延时500ms
2207   6                                                                              Delayms(1000);
2208   6      
2209   6                                                                              stLocalControl.stBusDealFreq.bySndSecAddr = WardDataBuff[16];
2210   6                                                                              stLocalControl.stBusDealFreq.byCmd = CMD_WARD_SEC_INFO_SET;
2211   6                                                                              stLocalControl.stBusDealFreq.byRecBedAddr = 0x03;       //第三帧数据
2212   6                                                                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));                                                                   
2213   6                                                                              break;                                                                          
2214   6                                                              }
2215   5                                                              stLocalControl.byKeyInTimes =0;
2216   5                                                      }
2217   4                                              }                                                       
2218   3                                                      
2219   3                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_CLEAR)
2220   3                                              {
2221   4                                                      stLocalControl.bySecondFlashTime =25;
2222   4                                                      ShowMainMenuFace(DIS_FRAM_MEM1);
2223   4                                              }                                       
2224   3                                              break;
2225   3      
2226   3      
2227   3                                      case MOVE_FJ_NUMBER_SET_FACE:
2228   3                                              switch(stLocalControl.byInputBox)
2229   3                                              {
2230   4      
2231   4                                                      case INPUT_BED:
2232   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
2233   4                                                              {
2234   5                                                                      (unOperData.ASCII_BCD)[0]=(unOperData.ASCII_BCD)[1];
2235   5                                                                      (unOperData.ASCII_BCD)[1]=(unOperData.ASCII_BCD)[2];
2236   5                                                                      (unOperData.ASCII_BCD)[2]=stLocalControl.stBusDealFreq.bySndSecAddr;
2237   5                                                              
2238   5                                                                      x=stLocalControl.uiCursorX;
2239   5                                                                      y=stLocalControl.uiCursorY;
2240   5                                                                      DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[0]),3,BLUE,WHITE,2,DIS_FRAM_MEM1);
2241   5                                                              }
2242   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
2243   4                                                              {
2244   5                                                                      if((unOperData.ASCII_BCD)[0]*100+(unOperData.ASCII_BCD)[1]*10+(unOperData.ASCII_BCD)[2] <255)
2245   5                                                                      {                                                       
2246   6                                                                      x=stLocalControl.uiCursorX;
2247   6                                                                              y=stLocalControl.uiCursorY;                                                             
2248   6                                                                              DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[0]),3,WHITE,BLUE,2,DIS_FRAM_MEM1);//已完成输入
             -蜓丈恢复正常
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 38  

2249   6                                                                              DisplayBlock(x,y,x+151,y+23,BLUE,DIS_FRAM_MEM1);        //32+120
2250   6                                                                              
2251   6                                                                              stLocalControl.byInputBox = INPUT_BED_START;
2252   6                                                                              stLocalControl.uiCursorX = 228;         
2253   6                                                                              stLocalControl.uiCursorY = 136;         
2254   6                                                                              x=stLocalControl.uiCursorX;
2255   6                                                                              y=stLocalControl.uiCursorY;
2256   6                                                                              DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[3]),3,BLUE,WHITE,2,DIS_FRAM_MEM1);    //显示下一个
             -输入框        
2257   6                                                                              x= stLocalControl.uiCursorX+68;         //36+32
2258   6                                                                              y= stLocalControl.uiCursorY;
2259   6                                                                              DisplayString(&x,&y,"按[确认]键",10,YELLOW,BLUE,2,DIS_FRAM_MEM1);       
2260   6                                                                      }
2261   5                                                              }
2262   4                                                              break;
2263   4      
2264   4      
2265   4                                                      case INPUT_BED_START:
2266   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
2267   4                                                              {
2268   5                                                                      (unOperData.ASCII_BCD)[3]=(unOperData.ASCII_BCD)[4];
2269   5                                                                      (unOperData.ASCII_BCD)[4]=(unOperData.ASCII_BCD)[5];
2270   5                                                                      (unOperData.ASCII_BCD)[5]=stLocalControl.stBusDealFreq.bySndSecAddr;
2271   5                                                              
2272   5                                                                      x=stLocalControl.uiCursorX;
2273   5                                                                      y=stLocalControl.uiCursorY;
2274   5                                                                      DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[3]),3,BLUE,WHITE,2,DIS_FRAM_MEM1);
2275   5                                                              }
2276   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
2277   4                                                              {
2278   5                                                                      if((unOperData.ASCII_BCD)[3]*100+(unOperData.ASCII_BCD)[4]*10+(unOperData.ASCII_BCD)[5] <=255)
2279   5                                                                      {                                                       
2280   6                                                                              x=stLocalControl.uiCursorX;
2281   6                                                                              y=stLocalControl.uiCursorY;                                                             
2282   6                                                                              DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[3]),3,WHITE,BLUE,2,DIS_FRAM_MEM1);//已完成输入
             -蜓丈恢复正常
2283   6                                                                              DisplayBlock(x,y,x+151,y+23,BLUE,DIS_FRAM_MEM1);        //32+120
2284   6                                                                              
2285   6                                                                              stLocalControl.byInputBox = INPUT_BED_END;
2286   6                                                                              stLocalControl.uiCursorX = 228;         
2287   6                                                                              stLocalControl.uiCursorY = 170;         
2288   6                                                                              x=stLocalControl.uiCursorX;
2289   6                                                                              y=stLocalControl.uiCursorY;
2290   6                                                                              DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[6]),3,BLUE,WHITE,2,DIS_FRAM_MEM1);    //显示下一个
             -输入框        
2291   6                                                                              x= stLocalControl.uiCursorX+68;         //36+32
2292   6                                                                              y= stLocalControl.uiCursorY;
2293   6                                                                              DisplayString(&x,&y,"按[确认]键",10,YELLOW,BLUE,2,DIS_FRAM_MEM1);       
2294   6                                                                      }
2295   5                                                              }
2296   4                                                              break;
2297   4      
2298   4                                                                              
2299   4                                                                              
2300   4                                                      case INPUT_BED_END:
2301   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
2302   4                                                              {
2303   5                                                                      (unOperData.ASCII_BCD)[6]=(unOperData.ASCII_BCD)[7];
2304   5                                                                      (unOperData.ASCII_BCD)[7]=(unOperData.ASCII_BCD)[8];
2305   5                                                                      (unOperData.ASCII_BCD)[8]=stLocalControl.stBusDealFreq.bySndSecAddr;
2306   5                                                              
2307   5                                                                      x=stLocalControl.uiCursorX;
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 39  

2308   5                                                                      y=stLocalControl.uiCursorY;
2309   5                                                                      DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[6]),3,BLUE,WHITE,2,DIS_FRAM_MEM1);
2310   5                                                              }
2311   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
2312   4                                                              {
2313   5                                                                      if((unOperData.ASCII_BCD)[6]*100+(unOperData.ASCII_BCD)[7]*10+(unOperData.ASCII_BCD)[8] <=255)
2314   5                                                                      {                                                       
2315   6                                                                              x=stLocalControl.uiCursorX;
2316   6                                                                              y=stLocalControl.uiCursorY;                                                             
2317   6                                                                              DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[6]),3,WHITE,BLUE,2,DIS_FRAM_MEM1);//已完成输入
             -蜓丈恢复正常
2318   6                                                                              DisplayBlock(x,y,x+151,y+23,BLUE,DIS_FRAM_MEM1);        //32+120
2319   6      
2320   6      
2321   6                                                                              stLocalControl.stBusDealFreq.bySndSecAddr = stLocalControl.stEepromCfgData.bySelfSecAddr;
2322   6                                                                              stLocalControl.stBusDealFreq.bySndRoomAddr = 251;
2323   6                                                                              stLocalControl.stBusDealFreq.bySndBedAddr = (unOperData.ASCII_BCD)[0]*100+(unOperData.ASCII_BCD)[
             -1]*10+(unOperData.ASCII_BCD)[2];
2324   6                                                                              stLocalControl.stBusDealFreq.byCmd = CMD_SET_NUMBER;
2325   6                                                                              stLocalControl.stBusDealFreq.byRecSecAddr =  (unOperData.ASCII_BCD)[3]*100+(unOperData.ASCII_BCD)
             -[4]*10+(unOperData.ASCII_BCD)[5];
2326   6                                                                              stLocalControl.stBusDealFreq.byRecRoomAddr = (unOperData.ASCII_BCD)[6]*100+(unOperData.ASCII_BCD)
             -[7]*10+(unOperData.ASCII_BCD)[8];
2327   6                                                                              stLocalControl.stBusDealFreq.byRecBedAddr  =  0x00;
2328   6                                                                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));                                                                                   
2329   6      
2330   6                                                                              (unOperData.ASCII_BCD)[2] += 1;
2331   6                                                                              if((unOperData.ASCII_BCD)[2]==10)
2332   6                                                                              {
2333   7                                                                                      (unOperData.ASCII_BCD)[2]=0;
2334   7                                                                                      (unOperData.ASCII_BCD)[1]+= 1;
2335   7                                                                                      if((unOperData.ASCII_BCD)[1]==10)
2336   7                                                                                      {
2337   8                                                                                              (unOperData.ASCII_BCD)[1]=0;
2338   8                                                                                              (unOperData.ASCII_BCD)[0]+= 1;
2339   8                                                                                      }
2340   7                                                                              }
2341   6                                                                              
2342   6                                                                              //stLocalControl.byInputBox = INPUT_SECTION;
2343   6                                                                              stLocalControl.byInputBox = INPUT_BED;
2344   6                                                                              stLocalControl.uiCursorX = 204;         
2345   6                                                                              stLocalControl.uiCursorY = 102;         
2346   6                                                                              x=stLocalControl.uiCursorX;
2347   6                                                                              y=stLocalControl.uiCursorY;
2348   6                                                                              DisplayDigitString(&x,&y,&(unOperData.ASCII_BCD[0]),3,BLUE,WHITE,2,DIS_FRAM_MEM1);
2349   6                                                                              
2350   6                                                                              x= stLocalControl.uiCursorX+68;         //36+32
2351   6                                                                              y= stLocalControl.uiCursorY;
2352   6                                                                              DisplayString(&x,&y,"按[确认]键",10,YELLOW,BLUE,2,DIS_FRAM_MEM1);                                                                                       
2353   6      
2354   6                                                                      }
2355   5                                                              }
2356   4                                                              break;                                                  
2357   4                                              }
2358   3                                              
2359   3                                                      
2360   3                                              if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_CLEAR)
2361   3                                              {
2362   4                                                      ShowNumberSetFace(DIS_FRAM_MEM1);                                               
2363   4                                                      
2364   4                                              }                                       
2365   3                                              break;
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 40  

2366   3      
2367   3      
2368   3      
2369   3                                      case WC_FJ_NUMBER_SET_FACE:
2370   3                                      //case MOVE_FJ_NUMBER_SET_FACE:
2371   3                                      case ADD_FJ_NUMBER_SET_FACE:
2372   3                                              switch(stLocalControl.byInputBox)
2373   3                                              {
2374   4                                                      case INPUT_BED:
2375   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
2376   4                                                              {
2377   5                                                                      (unOperData.ASCII_BCD)[6]=(unOperData.ASCII_BCD)[7];
2378   5                                                                      (unOperData.ASCII_BCD)[7]=(unOperData.ASCII_BCD)[8];
2379   5                                                                      (unOperData.ASCII_BCD)[8]=stLocalControl.stBusDealFreq.bySndSecAddr;
2380   5                                                              
2381   5                                                                      x=stLocalControl.uiCursorX;
2382   5                                                                      y=stLocalControl.uiCursorY;
2383   5                                                                      DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[6]),3,BLUE,WHITE,2,DIS_FRAM_MEM1);
2384   5                                                              }
2385   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
2386   4                                                              {
2387   5                                                                      if((unOperData.ASCII_BCD)[6]*100+(unOperData.ASCII_BCD)[7]*10+(unOperData.ASCII_BCD)[8] <255)
2388   5                                                                      {                                                       
2389   6                                                              /*              x=stLocalControl.uiCursorX;
2390   6                                                                              y=stLocalControl.uiCursorY;                                                             
2391   6                                                                              DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[6]),3,WHITE,BLUE,2,DIS_FRAM_MEM1);//已完成输入
             -蜓丈恢复正常
2392   6                                                                              DisplayBlock(x,y,x+151,y+23,BLUE,DIS_FRAM_MEM1);        //32+120        */
2393   6      
2394   6                                                                              switch(stLocalControl.byDisplayFace) 
2395   6                                                                              {
2396   7                                                                                      
2397   7                                                                                      case WC_FJ_NUMBER_SET_FACE:
2398   7                                                                                              //stLocalControl.stBusDealFreq.bySndSecAddr = (unOperData.ASCII_BCD)[0]*100+(unOperData.ASCII_B
             -CD)[1]*10+(unOperData.ASCII_BCD)[2];
2399   7                                                                                              stLocalControl.stBusDealFreq.bySndSecAddr = stLocalControl.stEepromCfgData.bySelfSecAddr;
2400   7                                                                                              stLocalControl.stBusDealFreq.bySndRoomAddr = (unOperData.ASCII_BCD)[6]*100+(unOperData.ASCII_BC
             -D)[7]*10+(unOperData.ASCII_BCD)[8];
2401   7                                                                                              stLocalControl.stBusDealFreq.bySndBedAddr = 0x00;
2402   7                                                                                              stLocalControl.stBusDealFreq.byCmd = CMD_SET_NUMBER;
2403   7                                                                                              stLocalControl.stBusDealFreq.byRecSecAddr = 0x01;       //开始编号;
2404   7                                                                                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));                                                                                   
2405   7                                                                                              break;
2406   7                                                                                      
2407   7                                                                                      //case MOVE_FJ_NUMBER_SET_FACE:
2408   7                                                                                              //stLocalControl.stBusDealFreq.bySndSecAddr = (unOperData.ASCII_BCD)[0]*100+(unOperData.ASCII_B
             -CD)[1]*10+(unOperData.ASCII_BCD)[2];
2409   7                                                                                              stLocalControl.stBusDealFreq.bySndSecAddr = stLocalControl.stEepromCfgData.bySelfSecAddr;
2410   7                                                                                              stLocalControl.stBusDealFreq.bySndRoomAddr = 251;
2411   7                                                                                              stLocalControl.stBusDealFreq.bySndBedAddr = (unOperData.ASCII_BCD)[6]*100+(unOperData.ASCII_BCD
             -)[7]*10+(unOperData.ASCII_BCD)[8];
2412   7                                                                                              stLocalControl.stBusDealFreq.byCmd = CMD_SET_NUMBER;
2413   7                                                                                              stLocalControl.stBusDealFreq.byRecSecAddr = 0x01;       //开始编号;
2414   7                                                                                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));                                                                                   
2415   7                                                                                              break;
2416   7      
2417   7                                                                                      case ADD_FJ_NUMBER_SET_FACE:
2418   7                                                                                              //stLocalControl.stBusDealFreq.bySndSecAddr = (unOperData.ASCII_BCD)[0]*100+(unOperData.ASCII_B
             -CD)[1]*10+(unOperData.ASCII_BCD)[2];
2419   7                                                                                              stLocalControl.stBusDealFreq.bySndSecAddr = stLocalControl.stEepromCfgData.bySelfSecAddr;
2420   7                                                                                              stLocalControl.stBusDealFreq.bySndRoomAddr = 250;
2421   7                                                                                              stLocalControl.stBusDealFreq.bySndBedAddr = (unOperData.ASCII_BCD)[6]*100+(unOperData.ASCII_BCD
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 41  

             -)[7]*10+(unOperData.ASCII_BCD)[8];
2422   7                                                                                              stLocalControl.stBusDealFreq.byCmd = CMD_SET_NUMBER;
2423   7                                                                                              stLocalControl.stBusDealFreq.byRecSecAddr = 0x01;       //开始编号;
2424   7                                                                                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));                                                                                   
2425   7                                                                                              break;                                                                                  
2426   7      
2427   7      
2428   7                                                                                      default:
2429   7                                                                                              break;
2430   7                                                                              }
2431   6      
2432   6                                                                              (unOperData.ASCII_BCD)[8] += 1;
2433   6                                                                              if((unOperData.ASCII_BCD)[8]==10)
2434   6                                                                              {
2435   7                                                                                      (unOperData.ASCII_BCD)[8]=0;
2436   7                                                                                      (unOperData.ASCII_BCD)[7]+= 1;
2437   7                                                                                      if((unOperData.ASCII_BCD)[7]==10)
2438   7                                                                                      {
2439   8                                                                                              (unOperData.ASCII_BCD)[7]=0;
2440   8                                                                                              (unOperData.ASCII_BCD)[6]+= 1;
2441   8                                                                                      }
2442   7                                                                              }
2443   6                                                                              
2444   6                                                                              //stLocalControl.byInputBox = INPUT_SECTION;
2445   6                                                                              stLocalControl.byInputBox = INPUT_BED;
2446   6                                                                              stLocalControl.uiCursorX = 204;         
2447   6                                                                              stLocalControl.uiCursorY = 118;         
2448   6                                                                              x=stLocalControl.uiCursorX;
2449   6                                                                              y=stLocalControl.uiCursorY;
2450   6                                                                              DisplayDigitString(&x,&y,&(unOperData.ASCII_BCD[6]),3,BLUE,WHITE,2,DIS_FRAM_MEM1);
2451   6                                                                              
2452   6                                                                              x= stLocalControl.uiCursorX+68;         //36+32
2453   6                                                                              y= stLocalControl.uiCursorY;
2454   6                                                                              DisplayString(&x,&y,"按[确认]键",10,YELLOW,BLUE,2,DIS_FRAM_MEM1);                                                                                       
2455   6      
2456   6                                                                      }
2457   5                                                              }
2458   4                                                              break;                                                  
2459   4                                              }
2460   3                                              
2461   3                                                      
2462   3                                              if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_CLEAR)
2463   3                                              {
2464   4                                                      ShowNumberSetFace(DIS_FRAM_MEM1);                                               
2465   4                                                      
2466   4                                              }                                       
2467   3                                              break;
2468   3      
2469   3      
2470   3                                      case SELF_NUMBER_SET_FACE:
2471   3                                              switch(stLocalControl.byInputBox)
2472   3                                              {
2473   4                                                      case INPUT_SECTION:
2474   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
2475   4                                                              {
2476   5                                                                      (unOperData.ASCII_BCD)[0]=(unOperData.ASCII_BCD)[1];
2477   5                                                                      (unOperData.ASCII_BCD)[1]=(unOperData.ASCII_BCD)[2];
2478   5                                                                      (unOperData.ASCII_BCD)[2]=stLocalControl.stBusDealFreq.bySndSecAddr;
2479   5                                                              
2480   5                                                                      x=stLocalControl.uiCursorX;
2481   5                                                                      y=stLocalControl.uiCursorY;
2482   5                                                                      DisplayDigitString(&x,&y,(unOperData.ASCII_BCD),3,BLUE,WHITE,2,DIS_FRAM_MEM1);
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 42  

2483   5                                                              }
2484   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
2485   4                                                              {
2486   5                                                                      if((unOperData.ASCII_BCD)[0]*100+(unOperData.ASCII_BCD)[1]*10+(unOperData.ASCII_BCD)[2] <255)
2487   5                                                                      {
2488   6                                                                              x=stLocalControl.uiCursorX;
2489   6                                                                              y=stLocalControl.uiCursorY; 
2490   6                                                                              DisplayDigitString(&x,&y,(unOperData.ASCII_BCD),3,WHITE,BLUE,2,DIS_FRAM_MEM1);//已完成输入框颜色
             -指凑常
2491   6                                                                              DisplayBlock(x,y,x+151,y+23,BLUE,DIS_FRAM_MEM1);        //32+120
2492   6                                                                              stLocalControl.byInputBox = INPUT_BED;
2493   6                                                                              stLocalControl.uiCursorX = 204;         
2494   6                                                                              stLocalControl.uiCursorY = 152;         //118+34=152
2495   6                                                                              x=stLocalControl.uiCursorX;
2496   6                                                                              y=stLocalControl.uiCursorY;
2497   6                                                                              DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[6]),3,BLUE,WHITE,2,DIS_FRAM_MEM1);    //显示下一个
             -输入框        
2498   6                                                                              x= stLocalControl.uiCursorX+68;         //36+32
2499   6                                                                              y= stLocalControl.uiCursorY;
2500   6                                                                              DisplayString(&x,&y,"按[确认]键",10,YELLOW,BLUE,2,DIS_FRAM_MEM1);                                               
2501   6                                                                              
2502   6                                                                      }
2503   5                                                              }
2504   4                                                              break;
2505   4                                                              
2506   4      
2507   4                                                      case INPUT_BED:
2508   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr<10)
2509   4                                                              {
2510   5                                                                      (unOperData.ASCII_BCD)[6]=(unOperData.ASCII_BCD)[7];
2511   5                                                                      (unOperData.ASCII_BCD)[7]=(unOperData.ASCII_BCD)[8];
2512   5                                                                      (unOperData.ASCII_BCD)[8]=stLocalControl.stBusDealFreq.bySndSecAddr;
2513   5                                                              
2514   5                                                                      x=stLocalControl.uiCursorX;
2515   5                                                                      y=stLocalControl.uiCursorY;
2516   5                                                                      DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[6]),3,BLUE,WHITE,2,DIS_FRAM_MEM1);
2517   5                                                              }
2518   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ENTER)
2519   4                                                              {
2520   5                                                                      if((unOperData.ASCII_BCD)[6]*100+(unOperData.ASCII_BCD)[7]*10+(unOperData.ASCII_BCD)[8] <255)
2521   5                                                                      {                                                       
2522   6              
2523   6                                                                              stLocalControl.stEepromCfgData.bySelfSecAddr = (unOperData.ASCII_BCD)[0]*100+(unOperData.ASCII_BC
             -D)[1]*10+(unOperData.ASCII_BCD)[2];
2524   6                                                                              stLocalControl.stEepromCfgData.bySelfRoomAddr = 253;
2525   6                                                                              stLocalControl.stEepromCfgData.bySelfBedAddr = (unOperData.ASCII_BCD)[6]*100+(unOperData.ASCII_BC
             -D)[7]*10+(unOperData.ASCII_BCD)[8];
2526   6                                                                              SaveParameter(IAP0_ADDR);
2527   6                                                                              stLocalControl.stBusDealFreq.bySndSecAddr = stLocalControl.stEepromCfgData.bySelfSecAddr;
2528   6                                                                              stLocalControl.stBusDealFreq.bySndRoomAddr = stLocalControl.stEepromCfgData.bySelfRoomAddr;
2529   6                                                                              stLocalControl.stBusDealFreq.bySndBedAddr = stLocalControl.stEepromCfgData.bySelfBedAddr;
2530   6                                                                              stLocalControl.stBusDealFreq.byCmd = CMD_SELF_SET_NUMBER;
2531   6                                                                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
2532   6                                                                                      
2533   6                                                                              ShowNumberSetFace(DIS_FRAM_MEM1);
2534   6                                                                      }
2535   5                                                              }
2536   4                                                              break;                                                  
2537   4                                              }
2538   3                                              
2539   3                                                      
2540   3                                              if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_CLEAR)
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 43  

2541   3                                              {
2542   4                                                      ShowNumberSetFace(DIS_FRAM_MEM1);                                               
2543   4                                                      
2544   4                                              }                                       
2545   3                                              break;
2546   3                                              
2547   3                                      case CALCULATE_FACE:
2548   3                                               switch(stLocalControl.stBusDealFreq.bySndSecAddr)
2549   3                                              {
2550   4                                                      case KEY_0:
2551   4                                                      case KEY_1:
2552   4                                                      case KEY_2:
2553   4                                                      case KEY_3:     
2554   4                                                      case KEY_4:
2555   4                                                      case KEY_5:
2556   4                                                      case KEY_6:
2557   4                                                      case KEY_7:
2558   4                                                      case KEY_8:
2559   4                                                      case KEY_9:     
2560   4                                                              if((stLocalControl.byKeyInTimes==0)&& (stLocalControl.stBusDealFreq.bySndSecAddr==KEY_0))
2561   4                                                                      break;
2562   4                                                              if(stLocalControl.byKeyInTimes==0) 
2563   4                                                              {
2564   5                                                                      DisplayBlock(100,104,380,127,WHITE,DIS_FRAM_MEM1);
2565   5                                                                      bSignflag = 0;  
2566   5                                                              }
2567   4                                                              (unOperData.ASCII_BCD)[stLocalControl.byKeyInTimes]= stLocalControl.stBusDealFreq.bySndSecAddr;
2568   4                                                              stLocalControl.byKeyInTimes++;
2569   4                                                              if(stLocalControl.byKeyInTimes==6)
2570   4                                                              {//最多只能输入5位数
2571   5                                                                      DisplayBlock(304,104,380,127,WHITE,DIS_FRAM_MEM1);
2572   5                                                                      stLocalControl.byKeyInTimes=0;
2573   5                                                                      if(stLocalControl.stBusDealFreq.bySndSecAddr==KEY_0)    break;
2574   5                                                                      (unOperData.ASCII_BCD)[0] = stLocalControl.stBusDealFreq.bySndSecAddr;
2575   5                                                                      stLocalControl.byKeyInTimes=1;
2576   5                                                              }
2577   4                                                              x=stLocalControl.uiCursorX-(stLocalControl.byKeyInTimes-1)*12;
2578   4                                                              y=stLocalControl.uiCursorY;
2579   4                                                              DisplayDigitString(&x,&y,(unOperData.ASCII_BCD),stLocalControl.byKeyInTimes,BLACK,WHITE,2,DIS_FRAM_
             -MEM1);
2580   4                                                              break;
2581   4      
2582   4                                                      case KEY_ADDBED:        // +
2583   4                                                      case KEY_SEC:           // - 
2584   4                                                      case KEY_BROAD:         // X
2585   4                                                      case KEY_MUSIC:         //  /
2586   4                                                              switch(stLocalControl.byKeyInTimes)
2587   4                                                              {
2588   5                                                                      case 5:
2589   5                                                                              (unOperData.uiOperData)[3] = (unOperData.ASCII_BCD)[0]*10000+
2590   5                                                                                                                                       (unOperData.ASCII_BCD)[1]*1000+ 
2591   5                                                                                                                                       (unOperData.ASCII_BCD)[2]*100+
2592   5                                                                                                                                       (unOperData.ASCII_BCD)[3]*10+ 
2593   5                                                                                                                                       (unOperData.ASCII_BCD)[4];
2594   5                                                                              break;
2595   5                                                                      case 4:
2596   5                                                                              (unOperData.uiOperData)[3] = (unOperData.ASCII_BCD)[0]*1000+
2597   5                                                                                                                                       (unOperData.ASCII_BCD)[1]*100+ 
2598   5                                                                                                                                       (unOperData.ASCII_BCD)[2]*10+
2599   5                                                                                                                                       (unOperData.ASCII_BCD)[3];
2600   5                                                                              break;
2601   5                                                                      case 3:
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 44  

2602   5                                                                              (unOperData.uiOperData)[3] = (unOperData.ASCII_BCD)[0]*100+
2603   5                                                                                                                                       (unOperData.ASCII_BCD)[1]*10+ 
2604   5                                                                                                                                       (unOperData.ASCII_BCD)[2];
2605   5                                                                              break;
2606   5                                                                      case 2:
2607   5                                                                              (unOperData.uiOperData)[3] = (unOperData.ASCII_BCD)[0]*10+
2608   5                                                                                                                                       (unOperData.ASCII_BCD)[1]; 
2609   5                                                                              break;  
2610   5                                                                      case 1:
2611   5                                                                              (unOperData.uiOperData)[3] = (unOperData.ASCII_BCD)[0]; 
2612   5                                                                              break;  
2613   5                                                              
2614   5                                                                      default:
2615   5                                                                              break;
2616   5                                                              }
2617   4      
2618   4                                                              if(bSignflag)
2619   4                                                              {//是一个负数
2620   5                                                                      (unOperData.uiOperData)[3] = (unOperData.uiOperData)[3] ^ 0xffff;
2621   5                                                                      (unOperData.uiOperData)[3] = (unOperData.uiOperData)[3]+1;
2622   5                                                                      (unOperData.uiOperData)[3] = (unOperData.uiOperData)[3] | 0x8000;
2623   5                                                              }
2624   4      //                                                      Send_Data(&((unOperData.uiOperData)[3]),2);
2625   4      
2626   4                                                              if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_ADDBED)
2627   4                                                              {
2628   5                                                                      DisplayASCII(120,104,'+',BLACK,WHITE,2,DIS_FRAM_MEM1);
2629   5                                                                      stLocalControl.byOperType = ADD_OPER;
2630   5                                                              }
2631   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_SEC)
2632   4                                                              {
2633   5                                                                      DisplayASCII(120,104,'-',BLACK,WHITE,2,DIS_FRAM_MEM1);
2634   5                                                                      stLocalControl.byOperType = SUB_OPER;
2635   5                                                              }
2636   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_BROAD)
2637   4                                                              {
2638   5                                                                      DisplayASCII(120,104,'*',BLACK,WHITE,2,DIS_FRAM_MEM1);
2639   5                                                                      stLocalControl.byOperType = MUL_OPER;
2640   5                                                              }
2641   4                                                              else if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_MUSIC)
2642   4                                                              {
2643   5                                                                      DisplayASCII(120,104,'/',BLACK,WHITE,2,DIS_FRAM_MEM1);
2644   5                                                                      stLocalControl.byOperType = DIV_OPER;
2645   5                                                              }                                                       
2646   4                                                              stLocalControl.byKeyInTimes = 0;
2647   4                                                              bSignflag = 0;
2648   4                                                              return;
2649   4      
2650   4                                                      
2651   4                                                      default:
2652   4                                                              break;
2653   4                                               }
2654   3                                              if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_CLEAR)
2655   3                                              {
2656   4                                                      ShowMainMenuFace(DIS_FRAM_MEM1);
2657   4                                                      return;
2658   4                                              }
2659   3      
2660   3                                              if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_MR)         //预留作退格键用
2661   3                                              {
2662   4                                                      DisplayBlock(100,104,380,127,WHITE,DIS_FRAM_MEM1);      //先清空
2663   4                                                      if(stLocalControl.byKeyInTimes)                                         
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 45  

2664   4                                                      {
2665   5                                                              stLocalControl.byKeyInTimes--;                                          
2666   5                                                              x=stLocalControl.uiCursorX-(stLocalControl.byKeyInTimes-1)*12;
2667   5                                                              y=stLocalControl.uiCursorY;
2668   5                                                              DisplayDigitString(&x,&y,(unOperData.ASCII_BCD),stLocalControl.byKeyInTimes,BLACK,WHITE,2,DIS_FRAM_
             -MEM1);                                                        
2669   5                                                      }
2670   4                                                      else bSignflag = 0;
2671   4                                                      return;
2672   4                                              }
2673   3      
2674   3      
2675   3                                              if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_SEARCH)             //计算器用+/-键
2676   3                                              {
2677   4                                                      if(stLocalControl.byKeyInTimes)
2678   4                                                      {
2679   5                                                              if(bSignflag)
2680   5                                                              {//1--原为负号,再按一次,则为正号
2681   6                                                                      DisplayBlock(292,104,303,127,WHITE,DIS_FRAM_MEM1);      //清空
2682   6                                                                      bSignflag = 0;
2683   6                                                              }
2684   5                                                              else
2685   5                                                              {
2686   6                                                                      DisplayASCII(292,104,'-',BLACK,WHITE,2,DIS_FRAM_MEM1);
2687   6                                                                      bSignflag = 1;
2688   6                                                              }
2689   5                                                      }
2690   4                                                      return;
2691   4                                              }                                       
2692   3                                              
2693   3                                              if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_CALCULATE)
2694   3                                              {
2695   4                                                      switch(stLocalControl.byKeyInTimes)
2696   4                                                      {
2697   5                                                              case 5:
2698   5                                                                      (unOperData.uiOperData)[4] = (unOperData.ASCII_BCD)[0]*10000+
2699   5                                                                                                       (unOperData.ASCII_BCD)[1]*1000+ 
2700   5                                                                                                       (unOperData.ASCII_BCD)[2]*100+
2701   5                                                                                                       (unOperData.ASCII_BCD)[3]*10+ 
2702   5                                                                                                       (unOperData.ASCII_BCD)[4];
2703   5                                                                      break;
2704   5                                                              case 4:
2705   5                                                                      (unOperData.uiOperData)[4] = (unOperData.ASCII_BCD)[0]*1000+
2706   5                                                                                                       (unOperData.ASCII_BCD)[1]*100+ 
2707   5                                                                                                       (unOperData.ASCII_BCD)[2]*10+
2708   5                                                                                                       (unOperData.ASCII_BCD)[3];
2709   5                                                                      break;
2710   5                                                              case 3:
2711   5                                                                      (unOperData.uiOperData)[4] = (unOperData.ASCII_BCD)[0]*100+
2712   5                                                                                                       (unOperData.ASCII_BCD)[1]*10+ 
2713   5                                                                                                       (unOperData.ASCII_BCD)[2];
2714   5                                                                      break;
2715   5                                                              case 2:
2716   5                                                                      (unOperData.uiOperData)[4] = (unOperData.ASCII_BCD)[0]*10+
2717   5                                                                                                       (unOperData.ASCII_BCD)[1];     
2718   5                                                                      break;  
2719   5                                                              case 1:
2720   5                                                                      (unOperData.uiOperData)[4] = (unOperData.ASCII_BCD)[0]; 
2721   5                                                                      break;  
2722   5      
2723   5                                                              default:
2724   5                                                                      break;
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 46  

2725   5                                                      }
2726   4                                                      
2727   4                                                      if(bSignflag)
2728   4                                                      {//是一个负数
2729   5                                                              (unOperData.uiOperData)[4] = (unOperData.uiOperData)[4] ^ 0xffff;       //反码
2730   5                                                              (unOperData.uiOperData)[4] = (unOperData.uiOperData)[4]+1;                      //补码
2731   5                                                              (unOperData.uiOperData)[4] = (unOperData.uiOperData)[4] | 0x8000;
2732   5                                                              bSignflag = 0;
2733   5                                                      }
2734   4      
2735   4      //                                              Send_Data(&((unOperData.uiOperData)[4]),2);
2736   4                                                      DisplayASCII(120,104,'=',BLACK,WHITE,2,DIS_FRAM_MEM1);
2737   4      
2738   4                                                      switch(stLocalControl.byOperType)
2739   4                                                      {
2740   5                                                              case ADD_OPER:
2741   5                                                                      (unOperData.uiOperData)[0] =(unOperData.uiOperData)[3]+(unOperData.uiOperData)[4];
2742   5                                                                      break;
2743   5                                                              case SUB_OPER:
2744   5                                                                      (unOperData.uiOperData)[0] =(unOperData.uiOperData)[3]-(unOperData.uiOperData)[4];
2745   5                                                                      break;
2746   5                                                              case MUL_OPER:
2747   5                                                                      (unOperData.uiOperData)[0] =(unOperData.uiOperData)[3]*(unOperData.uiOperData)[4];      
2748   5                                                                      break;  
2749   5                                                              case DIV_OPER:
2750   5                                                                      (unOperData.uiOperData)[0] =(unOperData.uiOperData)[3]/(unOperData.uiOperData)[4];      
2751   5                                                                      break;                                                          
2752   5                                                      }
2753   4                                                      (unOperData.uiOperData)[3] =(unOperData.uiOperData)[0]; //保留在(unOperData.uiOperData)[3]中,作为下
             -卧怂愕脑床僮魇
2754   4                                                      (unOperData.uiOperData)[4] =(unOperData.uiOperData)[0];
2755   4                                                      if( (unOperData.uiOperData)[4] & 0x8000 )
2756   4                                                      {
2757   5                                                              DisplayASCII(292,104,'-',BLUE,WHITE,2,DIS_FRAM_MEM1);
2758   5                                                              (unOperData.uiOperData)[4] = (unOperData.uiOperData)[4]&0x7fff ;
2759   5                                                              (unOperData.uiOperData)[4] = (unOperData.uiOperData)[4]-1;
2760   5                                                              (unOperData.uiOperData)[4] = (unOperData.uiOperData)[4]^0x7fff;
2761   5                                                              bSignflag = 0;  
2762   5                                                      }
2763   4                                                      //else bSignflag =0;    //结果是正数
2764   4      
2765   4      //                                              Send_Data(&((unOperData.uiOperData)[4]),2);     
2766   4                                                      
2767   4                                                      (unOperData.ASCII_BCD)[0]  = (unOperData.uiOperData)[4]/10000;
2768   4                                                      (unOperData.uiOperData)[4] = (unOperData.uiOperData)[4]%10000;
2769   4                                                      (unOperData.ASCII_BCD)[1]  = (unOperData.uiOperData)[4]/1000;
2770   4                                                      (unOperData.uiOperData)[4] = (unOperData.uiOperData)[4]%1000;
2771   4                                                      (unOperData.ASCII_BCD)[2]  = (unOperData.uiOperData)[4]/100;
2772   4                                                      (unOperData.uiOperData)[4] = (unOperData.uiOperData)[4]%100;
2773   4                                                      (unOperData.ASCII_BCD)[3]  = (unOperData.uiOperData)[4]/10;
2774   4                                                      (unOperData.ASCII_BCD)[4] = (unOperData.uiOperData)[4]%10;
2775   4                                                      
2776   4                                                      DisplayBlock(304,104,380,127,WHITE,DIS_FRAM_MEM1);      //先清空
2777   4                                                      stLocalControl.byKeyInTimes = 0;
2778   4                                                      stLocalControl.byOperType = 0;
2779   4      
2780   4      
2781   4                                                      if((unOperData.ASCII_BCD)[0])
2782   4                                                      {
2783   5                                                              x=316;y=104;
2784   5                                                              DisplayDigitString(&x,&y,(unOperData.ASCII_BCD),5,BLUE,WHITE,2,DIS_FRAM_MEM1);
2785   5                                                      }
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 47  

2786   4                                                      else if((unOperData.ASCII_BCD)[1])
2787   4                                                      {
2788   5                                                              x=328;y=104;
2789   5                                                              DisplayDigitString(&x,&y,&(unOperData.ASCII_BCD)[1],4,BLUE,WHITE,2,DIS_FRAM_MEM1);
2790   5                                                      }
2791   4                                                      else if((unOperData.ASCII_BCD)[2])
2792   4                                                      {
2793   5                                                              x=340;y=104;
2794   5                                                              DisplayDigitString(&x,&y,&(unOperData.ASCII_BCD)[2],3,BLUE,WHITE,2,DIS_FRAM_MEM1);
2795   5                                                      }
2796   4                                                      else if((unOperData.ASCII_BCD)[3])
2797   4                                                      {
2798   5                                                              x=352;y=104;
2799   5                                                              DisplayDigitString(&x,&y,&(unOperData.ASCII_BCD)[3],2,BLUE,WHITE,2,DIS_FRAM_MEM1);
2800   5                                                      }
2801   4                                                      else 
2802   4                                                      {
2803   5                                                              x=364;y=104;
2804   5                                                              DisplayDigitString(&x,&y,&(unOperData.ASCII_BCD)[4],1,BLUE,WHITE,2,DIS_FRAM_MEM1);                                                      
2805   5                                                      }
2806   4                                                      return;
2807   4                                              }                                       
2808   3                                               break;
2809   3                                               
2810   3      /*                              case TOUCH_ADJUST_FACE:
2811   3                                              if(stLocalControl.stBusDealFreq.bySndSecAddr == KEY_CLEAR)
2812   3                                              {
2813   3                                                      ShowMainMenuFace(DIS_FRAM_MEM1);
2814   3                                                      return;
2815   3                                              }
2816   3                                              break;*/
2817   3                                      
2818   3                                      case SEC_INFO_FACE:
2819   3                                               switch(stLocalControl.stBusDealFreq.bySndSecAddr)
2820   3                                              {
2821   4                                                      case KEY_0:
2822   4                                                      case KEY_1:
2823   4                                                      case KEY_2:
2824   4                                                      case KEY_3:     
2825   4                                                      case KEY_4:
2826   4                                                      case KEY_5:
2827   4                                                      case KEY_6:
2828   4                                                      case KEY_7:
2829   4                                                      case KEY_8:
2830   4                                                      case KEY_9:     
2831   4                                                              if(stLocalControl.byKeyInTimes==0)
2832   4                                                              {
2833   5                                                                      DisplayBlock(0,240,479,271,BLUE,DIS_FRAM_MEM0);
2834   5                                                              }
2835   4                                                              DisplayDigit(stLocalControl.byKeyInTimes*16,240,stLocalControl.stBusDealFreq.bySndSecAddr,WHITE,BLU
             -E,3,DIS_FRAM_MEM0);
2836   4                                                              if(++stLocalControl.byKeyInTimes==30) stLocalControl.byKeyInTimes=0;
2837   4                                                              Set_VisualPage(DIS_FRAM_MEM0);
2838   4                                                              stLocalControl.byDisplayFace = SEC_INFO_FACE;
2839   4                                                              break;
2840   4                                                      case KEY_MODE:
2841   4                                                              DisplayASCII(stLocalControl.byKeyInTimes*16,240,'M',WHITE,BLUE,3,DIS_FRAM_MEM0);
2842   4                                                              if(++stLocalControl.byKeyInTimes==30) stLocalControl.byKeyInTimes=0;
2843   4                                                              Set_VisualPage(DIS_FRAM_MEM0);
2844   4                                                              stLocalControl.byDisplayFace = SEC_INFO_FACE;
2845   4                                                              break;
2846   4      
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 48  

2847   4                                                      case KEY_ROOM:
2848   4                                                              DisplayASCII(stLocalControl.byKeyInTimes*16,240,'R',WHITE,BLUE,3,DIS_FRAM_MEM0);
2849   4                                                              if(++stLocalControl.byKeyInTimes==30) stLocalControl.byKeyInTimes=0;
2850   4                                                              Set_VisualPage(DIS_FRAM_MEM0);
2851   4                                                              stLocalControl.byDisplayFace = SEC_INFO_FACE;
2852   4                                                              break;
2853   4      
2854   4                                                      case KEY_SEC:
2855   4                                                              DisplayASCII(stLocalControl.byKeyInTimes*16,240,'S',WHITE,BLUE,3,DIS_FRAM_MEM0);
2856   4                                                              if(++stLocalControl.byKeyInTimes==30) stLocalControl.byKeyInTimes=0;
2857   4                                                              Set_VisualPage(DIS_FRAM_MEM0);
2858   4                                                              stLocalControl.byDisplayFace = SEC_INFO_FACE;
2859   4                                                              break;
2860   4                                                      case KEY_ADDBED:
2861   4                                                              DisplayASCII(stLocalControl.byKeyInTimes*16,240,'B',WHITE,BLUE,3,DIS_FRAM_MEM0);
2862   4                                                              if(++stLocalControl.byKeyInTimes==30) stLocalControl.byKeyInTimes=0;
2863   4                                                              Set_VisualPage(DIS_FRAM_MEM0);
2864   4                                                              stLocalControl.byDisplayFace = SEC_INFO_FACE;
2865   4                                                              break;
2866   4                                                              
2867   4                                                      case KEY_CLEAR:
2868   4                                                              DisplayBlock(0,240,479,271,BLUE,DIS_FRAM_MEM0);
2869   4                                                              stLocalControl.byKeyInTimes=0;
2870   4                                                              Set_VisualPage(DIS_FRAM_MEM0);
2871   4                                                              stLocalControl.byDisplayFace = SEC_INFO_FACE;
2872   4                                                              break;
2873   4                                                              
2874   4                                                      case KEY_ENTER:
2875   4                                                              if(stLocalControl.byKeyInTimes == 0)
2876   4                                                              {
2877   5                                                                      ShowMainMenuFace(DIS_FRAM_MEM1);
2878   5                                                                      memcpy(&(stLocalControl.stBusDealFreq.bySndSecAddr),&(stLocalControl.stEepromCfgData.bySelfSecAddr
             -),3);
2879   5                                                                      memcpy(&(stLocalControl.stBusDealFreq.byRecSecAddr),&(stLocalControl.stEepromCfgData.bySelfSecAddr
             -),3);
2880   5                                                                      stLocalControl.stBusDealFreq.byCmd = CMD_MAIN_MENU_SET;
2881   5                                                                      Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));
2882   5                                                              }
2883   4                                                              break;
2884   4                                                                                                              
2885   4                                                      default:
2886   4                                                              stLocalControl.byKeyInTimes=0;
2887   4                                                              DisplayBlock(0,240,479,271,BLUE,DIS_FRAM_MEM0);
2888   4                                                              if(stLocalControl.byDisplayFace == SEC_INFO_FACE)
2889   4                                                                      Set_VisualPage(DIS_FRAM_MEM0);
2890   4                                                              break;
2891   4                                                      }                                               
2892   3                                               break;
2893   3                                      
2894   3                                      }
2895   2                               break;
2896   2                      case CMD_INCREACE_VOL:
2897   2                      case CMD_DECREACE_VOL:                  
2898   2                              x=16;y=240;
2899   2                              if(INFO_INDICATION_FACE == stLocalControl.byDisplayFace)
2900   2                              {//信息指示界面
2901   3                                      DisplayChineseString(&x,&y,"音量",2,WHITE,BLUE,3,DIS_FRAM_MEM2);
2902   3                                      DisplayASCIIString(&x,&y,":",1,WHITE,BLUE,3,DIS_FRAM_MEM2);
2903   3                                      DisplayDigitString(&x,&y,&(stLocalControl.stBusDealFreq.byRecSecAddr),1,WHITE,BLUE,3,DIS_FRAM_MEM2);
2904   3                                      Set_VisualPage(DIS_FRAM_MEM2);                                  
2905   3                              }
2906   2                              else
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 49  

2907   2                              {
2908   3                                      DisplayChineseString(&x,&y,"音量",2,WHITE,BLUE,3,DIS_FRAM_MEM1);
2909   3                                      DisplayASCIIString(&x,&y,":",1,WHITE,BLUE,3,DIS_FRAM_MEM1);
2910   3                                      DisplayDigitString(&x,&y,&(stLocalControl.stBusDealFreq.byRecSecAddr),1,WHITE,BLUE,3,DIS_FRAM_MEM1);
2911   3                                      Set_VisualPage(DIS_FRAM_MEM1);
2912   3                              }
2913   2                              break;
2914   2                              
2915   2                      case CMD_SET_NUMBER:
2916   2                              if(stLocalControl.stBusDealFreq.byRecSecAddr==0x01)
2917   2                              {               
2918   3                                      ShowStartNumSet(DIS_FRAM_MEM1);
2919   3                                      break;
2920   3                              }
2921   2                              if(stLocalControl.stBusDealFreq.byRecSecAddr==0x02)
2922   2                              {
2923   3                                      ShowNumSetOk(DIS_FRAM_MEM1);    
2924   3                                      stLocalControl.byDispNumSetOkTime=50;           //显示一秒
2925   3                                      //保存地址
2926   3                                      stLocalControl.stEepromCfgData.bySelfSecAddr = stLocalControl.stBusDealFreq.bySndSecAddr;
2927   3                                      stLocalControl.stEepromCfgData.bySelfRoomAddr = stLocalControl.stBusDealFreq.bySndRoomAddr;
2928   3                                      stLocalControl.stEepromCfgData.bySelfBedAddr = stLocalControl.stBusDealFreq.bySndBedAddr;
2929   3                                      SaveParameter(IAP0_ADDR);                       
2930   3                                      break;
2931   3                              }
2932   2                              if(stLocalControl.stBusDealFreq.byRecSecAddr==0x00)     //编号超时
2933   2                              {
2934   3                                      Set_VisualPage(DIS_FRAM_MEM0);
2935   3                                      stLocalControl.byDisplayFace=SEC_INFO_FACE;
2936   3                                      break;
2937   3                              }
2938   2                              break;
2939   2      
2940   2                      case CMD_SUPPLY_OX_START:
2941   2                              WardDataBuff[16]=Read(WARD_FACE_DATA_START_ADDR+16);
2942   2                              WardDataBuff[16]++;
2943   2                              AAI_Write(WARD_FACE_DATA_START_ADDR,WardDataBuff,WARD_FACE_DATA_LEN);
2944   2      
2945   2                              x=312;y=175 /*209*/;
2946   2                              DisplayBlock(312,175/*209*/,312+35,175/*209*/+23,BLUE,DIS_FRAM_MEM0);
2947   2                              (unOperData.ASCII_BCD)[0]=WardDataBuff[16]/100;
2948   2                              
2949   2                              (unOperData.ASCII_BCD)[1]=(WardDataBuff[16]%100)/10;    
2950   2                              (unOperData.ASCII_BCD)[2]=(WardDataBuff[16]%100)%10;
2951   2                              
2952   2                              if((unOperData.ASCII_BCD)[0])   //百位不为0
2953   2                              {
2954   3                                      DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[0]),3,WHITE,BLUE,2,DIS_FRAM_MEM0);
2955   3                              }
2956   2                              else
2957   2                              {
2958   3                                      if((unOperData.ASCII_BCD)[1])   //十位不为0
2959   3                                              DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[1]),2,WHITE,BLUE,2,DIS_FRAM_MEM0);
2960   3                                      else  DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[2]),1,WHITE,BLUE,2,DIS_FRAM_MEM0);
2961   3                              }       
2962   2                              break;
2963   2      
2964   2                      case CMD_SUPPLY_OX_END:
2965   2                              WardDataBuff[16]=Read(WARD_FACE_DATA_START_ADDR+16);
2966   2                              WardDataBuff[16]--;
2967   2                              AAI_Write(WARD_FACE_DATA_START_ADDR,WardDataBuff,WARD_FACE_DATA_LEN);
2968   2      
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 50  

2969   2                              x=312;y=175/*209*/;
2970   2                              DisplayBlock(312,175/*209*/,312+35,175/*209*/+23,BLUE,DIS_FRAM_MEM0);
2971   2                              (unOperData.ASCII_BCD)[0]=WardDataBuff[16]/100;
2972   2                              
2973   2                              (unOperData.ASCII_BCD)[1]=(WardDataBuff[16]%100)/10;    
2974   2                              (unOperData.ASCII_BCD)[2]=(WardDataBuff[16]%100)%10;
2975   2                              
2976   2                              if((unOperData.ASCII_BCD)[0])   //百位不为0
2977   2                              {
2978   3                                      DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[0]),3,WHITE,BLUE,2,DIS_FRAM_MEM0);
2979   3                              }
2980   2                              else
2981   2                              {
2982   3                                      if((unOperData.ASCII_BCD)[1])   //十位不为0
2983   3                                              DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[1]),2,WHITE,BLUE,2,DIS_FRAM_MEM0);
2984   3                                      else  DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[2]),1,WHITE,BLUE,2,DIS_FRAM_MEM0);
2985   3                              }       
2986   2                              break;  
2987   2      
2988   2                      case CMD_VOICE_TIMER_GET:
2989   2                              memset((unOperData.ASCII_BCD),0x00,10);
2990   2                              unOperData.ASCII_BCD[5] =stLocalControl.stBusDealFreq.bySndSecAddr;
2991   2                              unOperData.ASCII_BCD[6] =stLocalControl.stBusDealFreq.bySndRoomAddr;
2992   2                              unOperData.ASCII_BCD[7] =stLocalControl.stBusDealFreq.byRecSecAddr;
2993   2                              unOperData.ASCII_BCD[8] =stLocalControl.stBusDealFreq.byRecRoomAddr;
2994   2                              unOperData.ASCII_BCD[9] =stLocalControl.stBusDealFreq.byRecBedAddr;
2995   2                              stLocalControl.byInputBox = INPUT_VOICE_START_HOUR;
2996   2                              stLocalControl.uiCursorX = 196;         //64+12*11=196
2997   2                              stLocalControl.uiCursorY = 51;          //(272-32*7-14)/2+34=51
2998   2                              ShowVoiceTimerSet(DIS_FRAM_MEM1);       //音量时间段设置  在1页显示 
2999   2                              break;
3000   2                      case CMD_BL_TIMER_GET:
3001   2                              memset((unOperData.ASCII_BCD),0x00,10);
3002   2                              unOperData.ASCII_BCD[5] =stLocalControl.stBusDealFreq.bySndSecAddr;
3003   2                              unOperData.ASCII_BCD[6] =stLocalControl.stBusDealFreq.bySndRoomAddr;
3004   2                              unOperData.ASCII_BCD[7] =stLocalControl.stBusDealFreq.byRecSecAddr;
3005   2                              unOperData.ASCII_BCD[8] =stLocalControl.stBusDealFreq.byRecRoomAddr;            
3006   2                              stLocalControl.byInputBox = INPUT_BL_START_HOUR;
3007   2                              stLocalControl.uiCursorX = 196;         //64+12*11=196
3008   2                              stLocalControl.uiCursorY = 51;          //(272-32*7-14)/2+34=51                 
3009   2                              ShowBackLightTimerSet(DIS_FRAM_MEM1);   //背光时间段设置  在1页显示                     
3010   2                              break;
3011   2      
3012   2      
3013   2      /*              case CMD_MAX_VOL_GET:
3014   2                              memset((unOperData.ASCII_BCD),0x00,10);
3015   2                              unOperData.ASCII_BCD[5] =stLocalControl.stBusDealFreq.bySndSecAddr;             //语音报号最大音量
3016   2                              unOperData.ASCII_BCD[6] =stLocalControl.stBusDealFreq.bySndRoomAddr;    //预留 : 语音报号最小音量
3017   2                              unOperData.ASCII_BCD[7] =stLocalControl.stBusDealFreq.byRecSecAddr;             //预留 : 听筒通话时最大音量
3018   2                              unOperData.ASCII_BCD[8] =stLocalControl.stBusDealFreq.byRecRoomAddr;    //预留 : 听筒通话时最小音量     
3019   2                              stLocalControl.byInputBox = INPUT_PLAY_VOL_MAX;                 
3020   2                              stLocalControl.uiCursorX = 272;
3021   2                              stLocalControl.uiCursorY = 60;
3022   2                              ShowMaxVolSetFace(DIS_FRAM_MEM1);       //显示最大音量设置界面
3023   2                              break;
3024   2      */                                                      
3025   2      
3026   2                      case CMD_WARD_SEC_INFO_SET:
3027   2                              switch(stLocalControl.stBusDealFreq.byRecBedAddr)
3028   2                              {//帧号标志
3029   3                                      case 1:
3030   3                                              memcpy(&(WardDataBuff[6]),&(stLocalControl.stBusDealFreq.bySndSecAddr),0x03);
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 51  

3031   3                                              WardDataBuff[9] =       stLocalControl.stBusDealFreq.byRecSecAddr;
3032   3                                              WardDataBuff[10]=       stLocalControl.stBusDealFreq.byRecRoomAddr;
3033   3      //                                      AAI_Write(WARD_FACE_DATA_START_ADDR,WardDataBuff,WARD_FACE_DATA_LEN);
3034   3      //                                      StoreSecInfo(DIS_FRAM_MEM0);
3035   3      //                                      if(stLocalControl.byDisplayFace == SEC_INFO_FACE) Set_VisualPage(DIS_FRAM_MEM0);
3036   3                                              break;
3037   3                                      case 2:
3038   3                                              memcpy(&(WardDataBuff[11]),&(stLocalControl.stBusDealFreq.bySndSecAddr),0x03);
3039   3                                              WardDataBuff[14]        =       stLocalControl.stBusDealFreq.byRecSecAddr;
3040   3                                              WardDataBuff[15]=       stLocalControl.stBusDealFreq.byRecRoomAddr;
3041   3      //                                      AAI_Write(WARD_FACE_DATA_START_ADDR,WardDataBuff,WARD_FACE_DATA_LEN);
3042   3      //                                      StoreSecInfo(DIS_FRAM_MEM0);
3043   3      //                                      if(stLocalControl.byDisplayFace == SEC_INFO_FACE) Set_VisualPage(DIS_FRAM_MEM0);                                        
3044   3                                              break;
3045   3                                              
3046   3                                      case 3:
3047   3                                              WardDataBuff[16]        =       stLocalControl.stBusDealFreq.bySndSecAddr;
3048   3                                              AAI_Write(WARD_FACE_DATA_START_ADDR,WardDataBuff,WARD_FACE_DATA_LEN);
3049   3                                              StoreSecInfo(DIS_FRAM_MEM0);
3050   3                                              if(stLocalControl.byDisplayFace == SEC_INFO_FACE) Set_VisualPage(DIS_FRAM_MEM0);                                        
3051   3                                              break;
3052   3                                              
3053   3                              }
3054   2                              break;
3055   2                              
3056   2                      case CMD_RS485_BRT_SET:
3057   2                              switch(stLocalControl.stBusDealFreq.byRecSecAddr)
3058   2                              {
3059   3                                      case 1:
3060   3                                              stLocalControl.stEepromCfgData.uiRs485Brt       =1200;
3061   3                                              break;
3062   3                                      case 2:
3063   3                                              stLocalControl.stEepromCfgData.uiRs485Brt       = 2400;
3064   3                                              break;
3065   3                                      case 3:
3066   3                                              stLocalControl.stEepromCfgData.uiRs485Brt       = 4800;
3067   3                                              break;
3068   3                                      case 4:
3069   3                                              stLocalControl.stEepromCfgData.uiRs485Brt       = 9600;
3070   3                                              break;
3071   3                                      case 5:
3072   3                                              stLocalControl.stEepromCfgData.uiRs485Brt       = 14400;
3073   3                                              break;
3074   3                                      case 6:
3075   3                                              stLocalControl.stEepromCfgData.uiRs485Brt       = 19200;
3076   3                                              break;
3077   3                                      case 7:
3078   3                                              stLocalControl.stEepromCfgData.uiRs485Brt       = 28800;
3079   3                                              break;
3080   3                                      case 8:
3081   3                                              stLocalControl.stEepromCfgData.uiRs485Brt       = 38400;
3082   3                                              break;
3083   3                                      case 9:
3084   3                                              stLocalControl.stEepromCfgData.uiRs485Brt       = 57600;
3085   3                                              break;
3086   3                                      default:
3087   3                                              return;         //其它无效，退出
3088   3                                              
3089   3                              }
3090   2                              UsartInit();
3091   2                              stLocalControl.stBusDealFreq.byCmd = CMD_GET_BUS;
3092   2                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));                   
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 52  

3093   2                              break;
3094   2                              
3095   2                      case CMD_SYSTEM_SEC_SET:
3096   2                              stLocalControl.stEepromCfgData.bySelfSecAddr    = stLocalControl.stBusDealFreq.byRecSecAddr;
3097   2                              stLocalControl.stBusDealFreq.byCmd = CMD_GET_BUS;
3098   2                              Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));                   
3099   2                              break;
3100   2                      default:
3101   2                              break;
3102   2      
3103   2              }       
3104   1      }
3105          /**********************************************************                                                                                      
3106          *函数名称                       :Bus0SendDeal   
3107          *函数描述               :单总线0发送完一帧数据处理函数,该函数首先
3108                                                   取出收到的数据,针对每条命令执行对应的控
3109                                                   制动作
3110          *输入参数               :
3111          *返回值                         :
3112          *全局变量                       :stLocalControl
3113          *调用模块                       :
3114          ***********************************************************
3115          *创建人                 :尹运同
3116          *创建日期                       :2008-9-22
3117          ***********************************************************
3118          *修改人                         :
3119          *修改日期               :
3120          *注释                   :
3121          **********************************************************/
3122          void Bus0SendDeal(void)
3123          { 
3124   1              //取出发送完成的数据帧
3125   1              OS_ENTER_CRITICAL();
3126   1              memcpy(&(stLocalControl.stBusDealFreq), byBus0SendData, sizeof(STBusFreq));             
3127   1              bBus0SendFinish = 0;
3128   1              OS_EXIT_CRITICAL();     
3129   1      
3130   1              //以下仅供测试用
3131   1              Send_Data((uint8 *)&(stLocalControl.stBusDealFreq),7);
3132   1              /////////////////////////////////////////////////////////////////////////////////////
3133   1      
3134   1              switch(stLocalControl.stBusDealFreq.byCmd)
3135   1              {
3136   2                      case CMD_LANDING:                                                                       //登记命令
3137   2                              if(bLanding)
3138   2                              {       //本机确实处在登记状态,设置等待确认超时
3139   3      /*                              CCAPM0=0X48;    //禁止调度
3140   3                                      CCF0=0;
3141   3                                      MCUMasterSPI(); //在此反复进行主从模式切换测试,成功
3142   3                                      FRAM_TEST();    
3143   3                                      EPH1660MasterSPI();
3144   3                                      CCAPM0=0X49;    //开启调度*/
3145   3                                      MakeCH0TimerOut(150, 0);                                
3146   3                              }                       
3147   2                              break;
3148   2                              
3149   2                      case CMD_GET_BUS:                                                                       //占用总线
3150   2                              Bus0SendPin = 0;                                                                //制造总线故障
3151   2                              SaveParameter(IAP0_ADDR);
3152   2                              Bus0SendPin = 1;                                                                //释放总线                              
3153   2                              break;  
3154   2                              
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 53  

3155   2                      default:
3156   2                              break;
3157   2      
3158   2              }       
3159   1      }
3160          /**********************************************************
3161          *函数名称                       :Bus0Manage     
3162          *函数描述               :单总线0管理线程
3163          *输入参数               :
3164          *返回值                         :
3165          *全局变量                       :byMainCmdQ
3166          *调用模块                       :OSQPost
3167          ***********************************************************
3168          *创建人                 :尹运同
3169          *创建日期                       :2008-9-22
3170          ***********************************************************
3171          *修改人                         :
3172          *修改日期               :
3173          *注释                   :
3174          **********************************************************/
3175          void Bus0Manage(void)
3176          {       
3177   1              while(TRUE)
3178   1              {               
3179   2                      WDT_CONTR = 0x3d; 
3180   2                      if(bBus0RecFinish)                                                                      //总线0收到数据
3181   2                      {       
3182   3                              OSQPost(byMainCmdQ, BUS0_REC);                          
3183   3                      }
3184   2                      if(bBus0SendFinish)                                                                     //总线0发送完数据帧
3185   2                      {
3186   3                              OSQPost(byMainCmdQ, BUS0_SND);                  
3187   3                      } 
3188   2                      OSWait(K_TMO, 1);       
3189   2              }
3190   1      }
3191          /**********************************************************
3192          *函数名称                       :TimerOutDeal   
3193          *函数描述               :超时处理函数
3194          *输入参数               :
3195          *返回值                         :
3196          *全局变量                       :stLocalControl
3197          *调用模块                       :Bus0OutputData,Bus1OutputData,VoiceChannelCtx,
3198                                                   LedControl,SetHandLedState
3199          ***********************************************************
3200          *创建人                 :尹运同
3201          *创建日期                       :2008-9-22
3202          ***********************************************************
3203          *修改人                         :
3204          *修改日期               :
3205          *注释                   :
3206          **********************************************************/
3207          void TimerOutDeal(void)
3208          { 
3209   1      
3210   1              uint16 xdata x;
3211   1              uint16 xdata y;
3212   1              if(stLocalControl.stCH0TimerOut.byTimerOut != 0)
3213   1              {       //有超时设置存在
3214   2                      stLocalControl.stCH0TimerOut.byTimerOut--;
3215   2                      if(stLocalControl.stCH0TimerOut.byTimerOut == 0)
3216   2                      {       //超时一次到了 
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 54  

3217   3                              if(stLocalControl.stCH0TimerOut.byTimerOutCount == 0x00)
3218   3                              {       //所有超时完成
3219   4                                      goto TIMER0OUTDEAL;
3220   4                              }
3221   3                              else
3222   3                              {       //超时次数没有完
3223   4                                      stLocalControl.stCH0TimerOut.byTimerOutCount--;
3224   4                                      if(stLocalControl.stCH0TimerOut.byTimerOutCount == 0x00)
3225   4                                      {       //所有超时完成
3226   5      TIMER0OUTDEAL:
3227   5                                              if(bLanding)
3228   5                                              {       //上电状态
3229   6                                                      stLocalControl.stBusDealFreq.bySndSecAddr = stLocalControl.stEepromCfgData.bySelfSecAddr;
3230   6                                                      stLocalControl.stBusDealFreq.bySndRoomAddr = stLocalControl.stEepromCfgData.bySelfRoomAddr;
3231   6                                                      stLocalControl.stBusDealFreq.bySndBedAddr = stLocalControl.stEepromCfgData.bySelfBedAddr;
3232   6                                                      stLocalControl.stBusDealFreq.byCmd = CMD_LANDING;
3233   6                                                      stLocalControl.stBusDealFreq.byRecSecAddr = stLocalControl.stEepromCfgData.bySerialNum1;
3234   6                                                      stLocalControl.stBusDealFreq.byRecRoomAddr = stLocalControl.stEepromCfgData.bySerialNum2;
3235   6                                                      stLocalControl.stBusDealFreq.byRecBedAddr = stLocalControl.stEepromCfgData.bySerialNum3;
3236   6                                                      Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));                                           
3237   6                                              }
3238   5                                      }
3239   4                                      else
3240   4                                      {       //超时次数没有完成，重新加载单位超时时间                                
3241   5                                              stLocalControl.stCH0TimerOut.byTimerOut = stLocalControl.stCH0TimerOut.byTimerOutSet;
3242   5                                      }
3243   4                              }                       
3244   3                      }
3245   2              }
3246   1              if(--stLocalControl.bySecondFlashTime==0)
3247   1              {
3248   2                      stLocalControl.bySecondFlashTime=25;
3249   2                      
3250   2                      bSecondDisState=!bSecondDisState;
3251   2                      if(stLocalControl.byDisplayFace==SEC_INFO_FACE)
3252   2                      {
3253   3                              if(bSecondDisState)
3254   3                              {
3255   4                                      Display_ASCII(336,0,ColonCode16x32,WHITE,BLUE,3,DIS_FRAM_MEM0); //":"                           
3256   4                              }
3257   3                              else
3258   3                              {
3259   4                                      DisplayBlock(336,0,336+15,31,BLUE,DIS_FRAM_MEM0);
3260   4                              }
3261   3                              Set_VisualPage(DIS_FRAM_MEM0);
3262   3                      }
3263   2                      else if(stLocalControl.byDisplayFace == SEC_INFO_SET_FACE)
3264   2                      {
3265   3                              (unOperData.ASCII_BCD)[9]= WardDataBuff[stLocalControl.byInputBox+6];   //获取要闪烁的数据
3266   3                              x = stLocalControl.uiCursorX;
3267   3                              y = stLocalControl.uiCursorY;
3268   3                              if(bSecondDisState)
3269   3                              {       
3270   4                                      (unOperData.ASCII_BCD)[0]=(unOperData.ASCII_BCD)[9]/100;
3271   4                                      (unOperData.ASCII_BCD)[1]=((unOperData.ASCII_BCD)[9]%100)/10;   
3272   4                                      (unOperData.ASCII_BCD)[2]=((unOperData.ASCII_BCD)[9]%100)%10;
3273   4                                      
3274   4                                      DisplayDigitString(&x,&y,&((unOperData.ASCII_BCD)[0]),3,WHITE,BLUE,2,DIS_FRAM_MEM1);
3275   4                                      
3276   4                              }
3277   3                              else
3278   3                              {
C51 COMPILER V9.00   SINGLEBUS                                                             02/18/2019 16:52:19 PAGE 55  

3279   4                                      DisplayBlock(x,y,x+35,y+23,BLUE,DIS_FRAM_MEM1);
3280   4                              }
3281   3      
3282   3                      }
3283   2              }
3284   1              
3285   1              if(stLocalControl.byDispNumSetOkTime)
3286   1              {
3287   2                      if(--stLocalControl.byDispNumSetOkTime==0)
3288   2                      {
3289   3                              Set_VisualPage(DIS_FRAM_MEM0);
3290   3                              stLocalControl.byDisplayFace = SEC_INFO_FACE;
3291   3                      }
3292   2              }
3293   1      
3294   1      }
3295          /**********************************************************
3296          *函数名称                       :TimerOutManager        
3297          *函数描述               :超时管理线程
3298          *输入参数               :
3299          *返回值                         :
3300          *全局变量                       :stLocalControl,byMainCmdQ
3301          *调用模块                       :OSQPost                                
3302          ***********************************************************
3303          *创建人                 :尹运同
3304          *创建日期                       :2008-9-22
3305          ***********************************************************
3306          *修改人                         :
3307          *修改日期               :
3308          *注释                   :
3309          **********************************************************/     
3310          void TimerOutManager(void)       
3311          {       
3312   1              while(1)
3313   1              {       
3314   2                      WDT_CONTR = 0x3d; 
3315   2                      OSWait(K_TMO, 4);                                                                       //设置20ms超时
3316   2                      if(stLocalControl.stCH0TimerOut.byTimerOut)
3317   2                      {       
3318   3                              OSQPost(byMainCmdQ, TIMER_OUT);                         
3319   3                      }
3320   2                      else
3321   2                      {               
3322   3                              OSQPost(byMainCmdQ, TIMER_OUT); 
3323   3                      }                       
3324   2              }
3325   1      } 
3326                    


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =  20256    ----
   CONSTANT SIZE    =     25    ----
   XDATA SIZE       =    155      48
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     21    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
