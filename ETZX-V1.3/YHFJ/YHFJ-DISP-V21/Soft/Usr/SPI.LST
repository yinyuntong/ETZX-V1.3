C51 COMPILER V9.00   SPI                                                                   02/18/2019 16:52:20 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE SPI
OBJECT MODULE PLACED IN SPI.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE SPI.C LARGE BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*
   2          ************************Copyright(c)************************
   3          *                                  湖南一特电子股份有限公司
   4          *                               All Rights Reserved
   5          *                                        
   6          *
   7          *-----------------------文件信息---------------------------
   8          *文件名称               :SPI.c
   9          *文件描述               :SPI驱动程序
  10          *创建人                 :尹运同
  11          *创建日期               :2008-9-22
  12          *版本号                 :V1.0
  13          *注释                                                           
  14          *----------------------------------------------------------
  15          *修改人                         :
  16          *修改日期                       :
  17          *版本号                 :
  18          *注释                   :
  19          ***********************************************************
  20          */
  21          #define _IN_SPI_
  22          #include "config.h"
  23          
  24          void MCUMasterSPI(void);
  25          uint8 SPI_WriteByte(uint8 dat);
  26          void EPH1660MasterSPI(void);
  27          
  28          
  29           
  30          /**********************************************************
  31          *函数名称                       :SpiInit
  32          *函数描述               :SPI接口初始化
  33          *输入参数               :
  34          *返回值                         :       
  35          *全局变量                       :
  36          *调用模块                       :
  37          ***********************************************************
  38          *创建人                 :尹运同
  39          *创建日期                       :2008-9-22
  40          ***********************************************************
  41          *修改人                         :
  42          *修改日期               :
  43          *注释                   :
  44          **********************************************************/
  45          void MCUMasterSPI(void)
  46          {       
  47   1      
  48   1              //全部禁止
  49   1              SST25VF_CS = 1;
  50   1              GT23L_CS = 1;
  51   1              ADS7843_CS = 1;
  52   1              EPH1660_CS=0;   //禁止EPH1660
  53   1      
  54   1              SPCTL  &= ~SPEN;        //关SPI功能
  55   1              //SCLK   P1.7改为准双向口
C51 COMPILER V9.00   SPI                                                                   02/18/2019 16:52:20 PAGE 2   

  56   1              P1M0 &= 0x7f;
  57   1              P1M1 &= 0x7f;
  58   1              SCLK=1;
  59   1              while(!SCLK);   //等待SCLK恢复为高
  60   1              
  61   1              SPCTL   =       (SSIG|SPEN|MSTR|CPOL|CPHA|SPSPEEDLL);
  62   1              SPSTAT |= (SPIF|WCOL);
  63   1              IE2 &= ~ESPI;   //关闭SPI中断
  64   1                      
  65   1      }
  66          
  67          /**********************************************************
  68          *函数名称                       :SpiInt
  69          *函数描述               :SPI中断服务程序
  70          *输入参数               :
  71          *返回值                         :       
  72          *全局变量                       :
  73          *调用模块                       :
  74          ***********************************************************
  75          *创建人                 :尹运同
  76          *创建日期                       :2008-9-22
  77          ***********************************************************
  78          *修改人                         :
  79          *修改日期               :
  80          *注释                   :
  81          **********************************************************/
  82          
  83          /*void SpiInt(void) interrupt SPI_INTNO         //9号中断
  84          {
  85                  SPSTAT |= SPIF;         //清标志
  86                  IE2 &= ~ESPI;
  87          }*/
  88          
  89          /**********************************************************
  90          *函数名称                       :SPI_WriteByte  
  91          *函数描述               :写一个字节
  92          *输入参数               :dat:要写入的数据
  93          *返回值                         :       
  94          *全局变量                       :
  95          *调用模块                       :
  96          ***********************************************************
  97          *创建人                 :尹运同
  98          *创建日期                       :2008-9-22
  99          ***********************************************************
 100          *修改人                         :
 101          *修改日期               :
 102          *注释                   :
 103          **********************************************************/
 104          uint8 SPI_WriteByte(uint8 dat)
 105          {
 106   1              SPDAT=dat;                                              
 107   1              while((SPSTAT & SPIF) == 0x00);                                         //等待发送完成 
 108   1              SPSTAT  |=      SPIF;//SPI传输完成标志,当SPI中断使能时会触发SPI中断请求,需要用软件向此位写"1"来清0
 109   1              return(SPDAT);
 110   1      }
 111          
 112          
 113          
 114          void EPH1660MasterSPI(void)     //EPH1660作主机
 115          {
 116   1              //全部禁止
 117   1              EPH1660_CS = 0; 
C51 COMPILER V9.00   SPI                                                                   02/18/2019 16:52:20 PAGE 3   

 118   1              SST25VF_CS = 1;
 119   1              GT23L_CS = 1;
 120   1              ADS7843_CS = 1; 
 121   1      
 122   1              //WKICOM=1; //唤醒EPH1660   //推挽输出
 123   1              WKICOM=1;
 124   1                      
 125   1              //SPI_CMD高阻输入(悬浮)
 126   1              SPI_CMD=1;              //悬浮状态也可用高电平输入
 127   1      
 128   1      
 129   1              SPCTL &= ~SPEN;
 130   1              
 131   1              //以下单片机为从机模式,EPH1660为主机模式
 132   1              SPCTL = (SSIG|SPEN/*|MSTR|CPOL*/|CPHA|SPSPEEDHH);//;
 133   1              MOSI=1;    //作输入
 134   1              SCLK =1;        //作输入
 135   1              SPSTAT |= (SPIF|WCOL);  //清中断                
 136   1              IE2 |= ESPI;                    //打开SPI中断
 137   1      
 138   1              IP2     |= PSPI;
 139   1              IP2H|= PSPIH;   //SPI优先级最高
 140   1              EPH1660_CS = 1;
 141   1      }
 142          
 143          
 144          
 145          
 146          void SPIInt(void) interrupt SPI_INTNO           //9号中断
 147          {
 148   1      
 149   1              EA=0;
 150   1              SPSTAT |= (SPIF|WCOL);  //清中断
 151   1      
 152   1      /*
 153   1      
 154   1              if(MCUSndFlag==0)       //接收过程中
 155   1              {
 156   1                      Rec_Data[InNum++]=SPDAT;
 157   1                      if(InNum==MAXLEN) InNum=0;
 158   1      
 159   1              }
 160   1              else
 161   1              {
 162   1                      if(MCUSndDataLength==0) //有错误产生
 163   1                      {
 164   1                              goto MCUSndCmdFinish;           
 165   1                      }
 166   1                      else
 167   1                      {
 168   1                              MCUSndDataLength--;
 169   1                              MCUSndDataPosition++;
 170   1                              if(MCUSndDataLength)    //发送还未完成
 171   1                              {
 172   1                                      SPDAT=MCUSndDataBuff[MCUSndDataPosition];
 173   1                              }
 174   1                              else            //整帧命令发送完成
 175   1                              {
 176   1      MCUSndCmdFinish:
 177   1                                      MCUSndCmdFinishFlag=1;
 178   1                                      MCUSndFlag=0;
 179   1                                      WKICOM=1;
C51 COMPILER V9.00   SPI                                                                   02/18/2019 16:52:20 PAGE 4   

 180   1                              }
 181   1                      }
 182   1              }
 183   1      */
 184   1              EA=1;
 185   1      
 186   1      }
 187          
 188          
 189          
 190          
 191          
 192          
 193          
 194          
 195          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =     90    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
