C51 COMPILER V8.08   MAIN                                                                  07/06/2011 08:51:32 PAGE 1   


C51 COMPILER V8.08, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*
   2          ************************Copyright(c)************************
   3          *                                  湖南熙旺达科技有限公司
   4          *                               All Rights Reserved
   5          *                                        
   6          *
   7          *-----------------------文件信息---------------------------
   8          *文件名称               :main.c
   9          *文件描述               :主函数
  10          *创建人                 :陈卫国
  11          *创建日期               :2008-9-22
  12          *版本号                 :V1.0
  13          *注释                   :                                       
  14          *----------------------------------------------------------
  15          *修改人                         :
  16          *修改日期                       :
  17          *版本号                 :
  18          *注释                   :
  19          ***********************************************************
  20          */
  21          #define  _IN_MAIN_
  22          #include "config.h"
  23          
  24          uint16  uiIsrTimerCount = ISR_INC_COUNT;                                        //系统时钟定时值
  25          uint8   OS_Q_MEM_SEL    byMainCmdQ[16];                                         //主线程消息队列
  26          STLocalControl  xdata stLocalControl;                                           //全局变量结构体
  27          
  28          
  29          
  30          /**********************************************************
  31          *函数名称                       :delay_nus      
  32          *函数描述               :纳秒级延时操作
  33          *输入参数               :i:延时的us数
  34          *返回值                         :       
  35          *全局变量                       :
  36          *调用模块                       :
  37          ***********************************************************
  38          *创建人                 :尹运同
  39          *创建日期                       :2008-9-22
  40          ***********************************************************
  41          *修改人                         :
  42          *修改日期               :
  43          *注释                   :
  44          **********************************************************/
  45          void delay_nus(unsigned char i)
  46          {
  47   1              unsigned char j;
  48   1      
  49   1              for(;i>0;i--)
  50   1              {
  51   2                      for(j=2;j>0;j--);
  52   2              }
  53   1               
  54   1      }
  55          
C51 COMPILER V8.08   MAIN                                                                  07/06/2011 08:51:32 PAGE 2   

  56          /*---------------------------------------------------------------------------
  57          函数原型: void Delayms(uint16 ms)
  58          参数说明: ms--需要延时的值
  59          返 回 值: 无
  60          函数功能：延时程序(对于18.432M晶振单指令周期延时1mS)
  61          ----------------------------------------------------------------------------*/
  62          void Delayms(uint16 ms)   
  63          {
  64   1         uint16 xdata i;
  65   1         for(;ms!=0;ms--)
  66   1                      for(i=900;i!=0;i--);
  67   1      }
  68          
  69          
  70          
  71          
  72          void UsartInit(void)
  73          {
  74   1                 SCON=0X50;      //工作方式1
  75   1                 TMOD&=0X0F;     //TO方式不变
  76   1                 TMOD|=0X20;     //;t1 方式2作波特率发生器
  77   1              
  78   1              
  79   1                 TL1 =   0XF6;           //波特率4800  在18.432M晶振的情况下
  80   1                 TH1 =   TL1;
  81   1                 PCON    &=  ~SMOD;   //      ;波特率倍增选择            smod=0
  82   1              // AUXR    &=  0xBf;       //传统12分频速度
  83   1                 AUXR |= T1x12;          //1T模式,最后波特率为:4800*12=57.6K
  84   1                 TF1=0;
  85   1                 TR1=1;
  86   1                 
  87   1                 RI=0;
  88   1                 TI=0;
  89   1                 REN=1;
  90   1                 ES=1;   
  91   1      
  92   1      
  93   1      }
  94          /***********************************************************/
  95          
  96          void Send_Data(uint8 *Databuf,uint8 l)
  97          { 
  98   1          uint8 i;
  99   1          ES=0;
 100   1              for(i=0;i<l;i++)
 101   1           {
 102   2                 SBUF=*Databuf;
 103   2             while(!TI);
 104   2                 TI=0;
 105   2                 Databuf++;
 106   2               }
 107   1              ES=1;
 108   1      }
 109          
 110          
 111          
 112          /**********************************************************
 113          *函数名称                       :Init   
 114          *函数描述               :硬件初始化操作
 115          *输入参数               :
 116          *返回值                         :       
 117          *全局变量                       :
C51 COMPILER V8.08   MAIN                                                                  07/06/2011 08:51:32 PAGE 3   

 118          *调用模块                       :
 119          ***********************************************************
 120          *创建人                 :陈卫国
 121          *创建日期                       :2008-9-22
 122          ***********************************************************
 123          *修改人                         :
 124          *修改日期               :
 125          *注释                   :
 126          **********************************************************/
 127          void Init(void)
 128          {
 129   1              CMOD = 0x02;
 130   1              CCON = 0x00;    
 131   1              CL = 0x00;
 132   1              CH = 0x00;
 133   1              CCAP0L = (uint8)uiIsrTimerCount;
 134   1              CCAP0H = (uint8)(uiIsrTimerCount>>8);
 135   1              //设置PCA模块0为16位软件定时器，ECCF0=1允许PCA模块0中断
 136   1              CCAPM0 = 0x49;  
 137   1              //开PCA中断和LVD(低压检测)中断共享的总中断控制位
 138   1              EPCA_LVD = 1;
 139   1              //启动PCA计数器计数
 140   1              CR = 1; 
 141   1      //      //复位看门狗
 142   1      //      WDT_CONTR = 0x3a;               
 143   1              //参数初始化
 144   1              InitParameter();
 145   1      
 146   1      //      UsartInit();
 147   1              //单总线初始化 
 148   1              SingleBusInit();        
 149   1              //状态初始化
 150   1              byDevState1 = 0x01;
 151   1              MakeCH0TimerOut(50, 0);         
 152   1      }
 153          /**********************************************************
 154          *函数名称                       :GetMessage     
 155          *函数描述               :获取主线程消息队列中的消息(无消息则挂起自身)
 156          *输入参数               :Msg:存储消息指针
 157          *返回值                         :       
 158          *全局变量                       :
 159          *调用模块                       :
 160          ***********************************************************
 161          *创建人                 :陈卫国
 162          *创建日期                       :2008-9-22
 163          ***********************************************************
 164          *修改人                         :
 165          *修改日期               :
 166          *注释                   :
 167          **********************************************************/
 168          void GetMessage(uint8 data *Msg)
 169          {
 170   1              OSQPend(Msg, byMainCmdQ, 0);
 171   1      }
 172          /**********************************************************
 173          *函数名称                       :DispatchMessage        
 174          *函数描述               :分发处理获取的主线程消息
 175          *输入参数               :Msg:消息,高3位是命令类型,低5位是命令数据
 176          *返回值                         :       
 177          *全局变量                       :
 178          *调用模块                       :
 179          ***********************************************************
C51 COMPILER V8.08   MAIN                                                                  07/06/2011 08:51:32 PAGE 4   

 180          *创建人                 :陈卫国
 181          *创建日期                       :2008-9-22
 182          ***********************************************************
 183          *修改人                         :
 184          *修改日期               :
 185          *注释                   :
 186          **********************************************************/
 187          void DispatchMessage(uint8 Msg)
 188          {
 189   1              switch(Msg&0xe0)
 190   1              {
 191   2                      case BUS0_REC:                                                                  //总线0收到数据帧
 192   2                              Bus0RecDeal();
 193   2                              break;
 194   2                      case BUS0_SND:                                                                  //总线0数据发送完成
 195   2                              Bus0SendDeal();
 196   2                              break;          
 197   2                      case KEY_DOWN:                                                                  //按键按下处理                                  
 198   2                              KeyDownDeal(Msg & 0x1f);
 199   2                              break;
 200   2                      case KEY_UP:                                                                    //按键弹起处理
 201   2                              KeyUpDeal(Msg & 0x1f);
 202   2                              break;
 203   2                      case TIMER_OUT:                                                                 //超时处理
 204   2                              TimerOutDeal();                                 
 205   2                              break;
 206   2              }       
 207   1      }
 208          /**********************************************************
 209          *函数名称                       :MainTask       
 210          *函数描述               :系统主线程,负责整个系统的消息处理
 211          *输入参数               :
 212          *返回值                         :       
 213          *全局变量                       :
 214          *调用模块                       :
 215          ***********************************************************
 216          *创建人                 :陈卫国
 217          *创建日期                       :2008-9-22
 218          ***********************************************************
 219          *修改人                         :
 220          *修改日期               :
 221          *注释                   :
 222          **********************************************************/
 223          void MainTask(void)
 224          {
 225   1              static uint8 data Msg;  
 226   1              
 227   1              //系统硬件初始化
 228   1              Init();
 229   1              //创建主线程消息队列    
 230   1              OSQCreate(byMainCmdQ, 16);
 231   1              //以下为创建任务线程    
 232   1              OSTaskCreate(Bus0Manage, NULL, 1);      
 233   1              OSTaskCreate(KeyManager, NULL, 2);
 234   1              OSTaskCreate(TimerOutManager, NULL, 3);
 235   1              
 236   1              //进入消息循环
 237   1              while(TRUE)
 238   1              {
 239   2                      GetMessage(&Msg);
 240   2                      DispatchMessage(Msg);
 241   2              }
C51 COMPILER V8.08   MAIN                                                                  07/06/2011 08:51:32 PAGE 5   

 242   1      } 
 243          /**********************************************************
 244          *函数名称                       :main   
 245          *函数描述               :系统主函数,整个软件的入口
 246          *输入参数               :
 247          *返回值                         :       
 248          *全局变量                       :
 249          *调用模块                       :
 250          ***********************************************************
 251          *创建人                 :陈卫国
 252          *创建日期                       :2008-9-22
 253          ***********************************************************
 254          *修改人                         :
 255          *修改日期               :
 256          *注释                   :
 257          **********************************************************/
 258          void main(void)
 259          {       
 260   1              //操作系统初始化                        
 261   1              OSInit();       
 262   1              //创建系统主线程
 263   1              OSTaskCreate(MainTask, NULL, 0);        
 264   1              while(1)
 265   1          {
 266   2             PCON = PCON | 0x01;                    //CPU进入休眠状态     
 267   2          }    
 268   1      }
 269          
 270          
 271          void sint(void ) interrupt 4
 272          {
 273   1              ES=0;
 274   1      }
 275          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    302    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     24       2
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      3       1
   IDATA SIZE       =     16    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
