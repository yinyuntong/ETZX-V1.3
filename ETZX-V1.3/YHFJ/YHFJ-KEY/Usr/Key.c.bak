/*
************************Copyright(c)************************
*	  			   湖南熙旺达科技有限公司
*			       	All Rights Reserved
*			     		 
*
*-----------------------文件信息---------------------------
*文件名称     		:Key.c
*文件描述    		:医护分机键盘处理程序
*创建人     		:陈卫国
*创建日期   		:2008-9-22
*版本号       		:V1.0
*注释	     		:					
*----------------------------------------------------------
*修改人  			:
*修改日期  			:
*版本号        		:
*注释	     		:
***********************************************************
*/
#define _IN_KEY_
#include "config.h"

#define KeyScanWait()	{_nop_();_nop_();}
//32个按键状态联合体	 
typedef union 
{
	uint8 	byKeyValue[4];
	uint32 	ulKeyValue;
} UNKeyValue, *pUNKeyValue;	 
//按键扫描引脚定义
sbit 	KBit1 	= P3^0;
sbit    KBit2	= P3^1;
sbit	KBit3 	= P3^5;
sbit	KBit4	= P3^7;	 
extern uint8	OS_Q_MEM_SEL	byMainCmdQ[];	  
extern STLocalControl 	xdata stLocalControl;

/**********************************************************
*函数名称			:KeyScan	
*函数描述        	:键盘扫描函数
*输入参数   		:
*返回值				:   	
*全局变量			:
*调用模块  			:
***********************************************************
*创建人	      		:陈卫国
*创建日期	 		:2008-9-22
***********************************************************
*修改人	  			:
*修改日期    		:
*注释		      	:
**********************************************************/
uint8 KeyScan(void)
{
	UNKeyValue 	unKeyValue;
	uint8 		byKeyValue;
	
	KBit1 = 0;
	KeyScanWait();
	unKeyValue.byKeyValue[3] = ~P1;		
	KBit1 = 1;
	KBit2 = 0;
	KeyScanWait();
	unKeyValue.byKeyValue[2] = ~P1;
	KBit2 = 1;
	KBit3 = 0;
	KeyScanWait();
	unKeyValue.byKeyValue[1] = ~P1;
	KBit3 = 1;
	KBit4 = 0;
	KeyScanWait();
	unKeyValue.byKeyValue[0] = ~P1;
	KBit4 = 1;
	byKeyValue = 0;
	while(unKeyValue.ulKeyValue)
	{
		if(unKeyValue.ulKeyValue & 0x00000001)
		{	//检测到有按键按下
			return(byKeyValue);
		}
		unKeyValue.ulKeyValue >>= 1;
		byKeyValue++;
	}
	return(NO_KEY);
}
/**********************************************************
*函数名称			:KeyManager	
*函数描述        	:键盘监控程序
*输入参数   		:
*返回值				:   	
*全局变量			:
*调用模块  			:
***********************************************************
*创建人	      		:陈卫国
*创建日期	 		:2008-9-22
***********************************************************
*修改人	  			:
*修改日期    		:
*注释		      	:
**********************************************************/
void KeyManager(void)
{ 	
	static uint8 byKeyValue;	

	//P3.0,P3.1,P3.5,P3.7设置为准双向口输出
	P3M0 &= 0x5c;
	P3M1 &= 0x5c;
	KBit1 = KBit2 = KBit3 = KBit4 = 1;	
	//按键输入引脚设置为准双向口,弱上拉	
	P1 = 0xff;									
	P1M0 = 0x00;
	P1M1 = 0x00;
    while (TRUE)
    {
        OSWait(K_TMO, OS_TICKS_PER_SEC/50);           		//延时20ms        
        byKeyValue = KeyScan();              				//获当前按键状态
        if(byKeyValue == NO_KEY)
        {        	
       		continue;
        }        
        OSWait(K_TMO, OS_TICKS_PER_SEC/50);           		//延时20ms 
        if(byKeyValue != KeyScan())
        {
            continue;
        }
        OSQPost(byMainCmdQ, KEY_DOWN|byKeyValue);			//处理按键闭合事件	
		//等待按键松开                                                  
        while(byKeyValue == KeyScan())
        {	//处理按键连击事件
			OSWait(K_TMO, OS_TICKS_PER_SEC/50);         
        }
		OSQPost(byMainCmdQ, KEY_UP|byKeyValue);				//处理按键弹起事件			
    }
}
/**********************************************************
*函数名称			:KeyDownDeal	
*函数描述        	:按键按下处理程序
*输入参数   		:
*返回值				:   	
*全局变量			:
*调用模块  			:
***********************************************************
*创建人	      		:陈卫国
*创建日期	 		:2008-9-22
***********************************************************
*修改人	  			:
*修改日期    		:
*注释		      	:
**********************************************************/
void KeyDownDeal(uint8 byKey)
{
	stLocalControl.stBusDealFreq.bySndSecAddr = byKey;
	stLocalControl.stBusDealFreq.bySndRoomAddr = 0x00;
	stLocalControl.stBusDealFreq.bySndBedAddr = 0x00;
	stLocalControl.stBusDealFreq.byCmd = CMD_KEY_DOWN;
	stLocalControl.stBusDealFreq.byRecSecAddr = 0xff;
	stLocalControl.stBusDealFreq.byRecRoomAddr = 0xff;
	stLocalControl.stBusDealFreq.byRecBedAddr = 0xff;
	Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));  
}
/**********************************************************
*函数名称			:KeyUpDeal	
*函数描述        	:按键弹起处理程序
*输入参数   		:
*返回值				:   	
*全局变量			:
*调用模块  			:
***********************************************************
*创建人	      		:陈卫国
*创建日期	 		:2008-9-22
***********************************************************
*修改人	  			:
*修改日期    		:
*注释		      	:
**********************************************************/
/***************************************************************************
*Function Name		:KeyUpDeal
*Description        :按键弹起处理程序
*Input parameters   :
*Return Values:   	:
*Global Variables 	:
*Calling Modules  	:
***
*Create By	      	:陈卫国
*Create Tate	 	:2008-7-8
***
*Modified By	  	:
*Modified Date    	:
*Note		      	:
****************************************************************************/
void KeyUpDeal(uint8 byKey)
{
	stLocalControl.stBusDealFreq.bySndSecAddr = byKey;
	stLocalControl.stBusDealFreq.bySndRoomAddr = 0x00;
	stLocalControl.stBusDealFreq.bySndBedAddr = 0x00;
	stLocalControl.stBusDealFreq.byCmd = CMD_KEY_UP;
	stLocalControl.stBusDealFreq.byRecSecAddr = 0xff;
	stLocalControl.stBusDealFreq.byRecRoomAddr = 0xff;
	stLocalControl.stBusDealFreq.byRecBedAddr = 0xff;
	Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));  
}
