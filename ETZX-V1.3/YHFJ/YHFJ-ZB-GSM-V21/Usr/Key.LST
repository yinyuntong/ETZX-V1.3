C51 COMPILER V9.00   KEY                                                                   02/18/2019 15:28:54 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE KEY
OBJECT MODULE PLACED IN Key.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE Key.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*
   2          ************************Copyright(c)************************
   3          *                                  湖南一特股份有限公司
   4          *                               All Rights Reserved
   5          *                                        
   6          *
   7          *-----------------------文件信息---------------------------
   8          *文件名称               :Key.c
   9          *文件描述               :听筒监控程序
  10          *创建人                 :尹运同
  11          *创建日期               :2008-9-22
  12          *版本号                 :V1.0
  13          *注释                   :
  14          *----------------------------------------------------------
  15          *修改人                         :
  16          *修改日期                       :
  17          *版本号                 :
  18          *注释                   :
  19          ***********************************************************
  20          */
  21          #define _IN_KEY_
  22          #include "config.h"
  23          
  24          sbit    HandlerKey = P4^3;
  25          extern uint8    OS_Q_MEM_SEL    byMainCmdQ[];  
  26          extern STLocalControl   xdata stLocalControl;
  27           
  28          /**********************************************************
  29          *函数名称                       :KeyManager     
  30          *函数描述               :听筒监控线程
  31          *输入参数               :
  32          *返回值                         :       
  33          *全局变量                       :
  34          *调用模块                       :
  35          ***********************************************************
  36          *创建人                 :尹运同
  37          *创建日期                       :2008-9-22
  38          ***********************************************************
  39          *修改人                         :
  40          *修改日期               :
  41          *注释                   :
  42          **********************************************************/     
  43          void KeyManager(void)
  44          {
  45   1              HandlerKey = 1;                                                                                 //听筒设置成弱上拉
  46   1              while(TRUE)
  47   1              {
  48   2                      WDT_CONTR = 0x3d;       //喂狗
  49   2                      OSTimeDly(OS_TICKS_PER_SEC/40);
  50   2                      if(HandlerKey == 0)                                                                     //听筒放下为低电平
  51   2                      {
  52   3                              continue;
  53   3                      }
  54   2                      OSTimeDly(OS_TICKS_PER_SEC/40);
  55   2                      if(HandlerKey == 0)
C51 COMPILER V9.00   KEY                                                                   02/18/2019 15:28:54 PAGE 2   

  56   2                      {
  57   3                              continue;
  58   3                      }
  59   2                      OSQPost(byMainCmdQ, KEY_UP);                                            //听筒摘机了
  60   2                      fled0=led0=1;
  61   2                      while(HandlerKey == 1)
  62   2                      {
  63   3                              WDT_CONTR = 0x3d;       //喂狗
  64   3                              OSTimeDly(OS_TICKS_PER_SEC/50);
  65   3                      }
  66   2                      OSQPost(byMainCmdQ, KEY_DOWN);                                          //听筒挂机了
  67   2                      fled0=led0=0;
  68   2              }
  69   1      }
  70          /**********************************************************
  71          *函数名称                       :KeyDown        
  72          *函数描述               :听筒挂机处理函数
  73          *输入参数               :
  74          *返回值                         :       
  75          *全局变量                       :
  76          *调用模块                       :
  77          ***********************************************************
  78          *创建人                 :尹运同
  79          *创建日期                       :2008-9-22
  80          ***********************************************************
  81          *修改人                         :
  82          *修改日期               :
  83          *注释                   :
  84          **********************************************************/ 
  85          void KeyDown(void)
  86          {
  87   1              bHandleDown = 1;                                                                                //保存听筒当前状态      
  88   1              VoiceChannelCtx();                                                                              //语音通道切换到免提上
  89   1              if((bChannel1Talk&bHandAnswer))
  90   1              {       //确实是用听筒主动呼叫的,缩短超时时间,超时后自动发送通道切换命令                
  91   2                      MakeCH1TimerOut(5, 0);
  92   2                      
  93   2              }       
  94   1              else if((bWaitAck|bWaitListen|bChannel0Talk|bSelfBroad)&&bHandAnswer)
  95   1              {       //确实是用听筒主动呼叫的,缩短超时时间,超时后自动发送复位命令            
  96   2                      MakeCH0TimerOut(5, 0);
  97   2                      
  98   2              }
  99   1              else if((!bHandAnswer)&&(!bKeyAnswer)&&(!bIndicatingOther))
 100   1              {                               
 101   2                      InitKeyCallAddr();
 102   2              }       
 103   1      }
 104          /**********************************************************
 105          *函数名称                       :KeyUp  
 106          *函数描述               :听筒摘机处理函数
 107          *输入参数               :
 108          *返回值                         :       
 109          *全局变量                       :
 110          *调用模块                       :
 111          ***********************************************************
 112          *创建人                 :尹运同
 113          *创建日期                       :2008-9-22
 114          ***********************************************************
 115          *修改人                         :
 116          *修改日期               :
 117          *注释                   :
C51 COMPILER V9.00   KEY                                                                   02/18/2019 15:28:54 PAGE 3   

 118          **********************************************************/ 
 119          void KeyUp(void)
 120          {
 121   1              bHandleDown = 0;                                                                                        //保存听筒当前状态
 122   1              VoiceChannelCtx();                                                                                      //语音切换到听筒上
 123   1              if(bIndicatingOther&&(!bHandAnswer)&&(!bKeyAnswer))
 124   1              {       //如果正在报号,发送处理呼叫命令(紧急呼叫发送清除命令)           
 125   2                      stLocalControl.stBusDealFreq.bySndSecAddr = stLocalControl.stEepromCfgData.bySelfSecAddr;
 126   2                      stLocalControl.stBusDealFreq.bySndRoomAddr = stLocalControl.stEepromCfgData.bySelfRoomAddr;
 127   2                      stLocalControl.stBusDealFreq.bySndBedAddr = stLocalControl.stEepromCfgData.bySelfBedAddr;
 128   2                      stLocalControl.stBusDealFreq.byRecSecAddr = stLocalControl.stIndicationData.stAddr.bySndSecAddr;
 129   2                      stLocalControl.stBusDealFreq.byRecRoomAddr = stLocalControl.stIndicationData.stAddr.bySndRoomAddr;
 130   2                      stLocalControl.stBusDealFreq.byRecBedAddr = stLocalControl.stIndicationData.stAddr.bySndBedAddr;                                
 131   2                      if(CMD_EMERGENCY_CALL == (stLocalControl.stIndicationData.byCallCmd & 0x1f))
 132   2                      {
 133   3                              stLocalControl.stBusDealFreq.byCmd = CMD_EMERGENCY_CLEAR;
 134   3                      }
 135   2                      else
 136   2                      {       //不是紧急呼叫,置听筒接听标志,发送处理命令                                                                      
 137   3                              stLocalControl.stBusDealFreq.byCmd = stLocalControl.stIndicationData.byCallCmd & 0x1f;
 138   3                              stLocalControl.stBusDealFreq.byCmd += 0x06; 
 139   3                      }               
 140   2                      if(TRUE == Bus0OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr)))
 141   2                      {
 142   3                              bCallDealSending = 1;
 143   3                      }               
 144   2              }
 145   1              else
 146   1              {
 147   2                      stLocalControl.stBusDealFreq.bySndSecAddr = KEY_CLEAR;
 148   2                      stLocalControl.stBusDealFreq.byCmd = CMD_KEY_DOWN;
 149   2                      Bus1OutputData(&(stLocalControl.stBusDealFreq.bySndSecAddr));           
 150   2                      stLocalControl.byKeyValue[MAX_KEY_SIZE-1] = 0xff;
 151   2                      bRoomAddr = 0;
 152   2                      bSetPrio = 0;
 153   2              }
 154   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    242    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
