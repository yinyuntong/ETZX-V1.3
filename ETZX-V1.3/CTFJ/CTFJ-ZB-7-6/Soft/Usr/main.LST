C51 COMPILER V9.00   MAIN                                                                  02/14/2019 10:02:45 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c LARGE BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          /*
   2          ************************Copyright(c)************************
   3          *            ºþÄÏÒ»ÌØµç×Ó¹É·ÝÓÐÏÞ¹«Ë¾
   4          *             All Rights Reserved
   5          *              
   6          *
   7          *-----------------------ÎÄ¼þÐÅÏ¢---------------------------
   8          *ÎÄ¼þÃû³Æ         :main.c
   9          *ÎÄ¼þÃèÊö       :Ö÷º¯Êý
  10          *´´½¨ÈË         :ÒüÔËÍ¬
  11          *´´½¨ÈÕÆÚ       :2008-9-22
  12          *°æ±¾ºÅ           :V1.0
  13          *×¢ÊÍ         :         
  14          *----------------------------------------------------------
  15          *ÐÞ¸ÄÈË       :
  16          *ÐÞ¸ÄÈÕÆÚ       :
  17          *°æ±¾ºÅ           :
  18          *×¢ÊÍ         :
  19          ***********************************************************
  20          */
  21          #include "config.h"
  22          #include "absacc.h"
  23          
  24          uint16  uiIsrTimerCount = ISR_INC_COUNT;          //ÏµÍ³Ê±ÖÓ¶¨Ê±Öµ
  25          uint8 OS_Q_MEM_SEL  byMainCmdQ[16];           //Ö÷Ïß³ÌÏûÏ¢¶ÓÁÐ
  26          STLocalControl  xdata stLocalControl;           //È«¾Ö±äÁ¿½á¹¹Ìå
  27          
  28          extern uint8 data byBus0RecData[];
  29          uint8 xdata UartRecData;
  30          uint8 xdata IrDataPosit=0;
  31          uint8 xdata RFSerial[6];    //±£´æÊäÒº±¨¾¯Æ÷¶ÔÂë¹ý³ÌÖÐµÄÐòÁÐºÅ
  32          
  33          uint8 code    run[12]={31,29,31,30,31,30,31,31,30,31,30,31};   
  34          uint8 code   notrun[12]={31,28,31,30,31,30,31,31,30,31,30,31};
  35          
  36          uint8 code byVersionHi=1;
  37          uint8 code byVersionLo=2;
  38          
  39          
  40          uint8 xdata BusLowDTime=0;
  41          uint8 xdata BusHighDTime=0;
  42          
  43          
  44          bit bFourByteRec=0;         //´®¿Ú½ÓÊÕµ½4×Ö½ÚÃüÁî
  45          bit bNumSeting=0;
  46          bit bRFNumSeting=0;
  47          bit bOxTimerKeyState=1;
  48          bit bEnableOxTimer=0;       //Èç¹ûÃ»ÊÕµ½Ê±¼äÊý¾Ý²»³äÐí¼ÆÊ±
  49          bit bWillSndOxSupplyStart=0;    //ÉÏµç´¦ÓÚ¹©Ñõ×´Ì¬
  50          bit bWillSndOxSupplyEnd=0;      //½«·¢ËÍ¹©Ñõ½áÊøÃüÁî
  51          bit bWillSndTotalOx;            //½«·¢ËÍ¹©Ñõ¼ÆÊ±ÐÅÏ¢
  52          bit bCloseCGB=0;          //¹ã²¥Ê±À®°È×´Ì¬±êÖ¾
  53          
  54          
  55          bit bBus1Answer =0;         //½ÓÊÕµ¥×ÜÏß1µÄÓ¦´ð±êÖ¾
C51 COMPILER V9.00   MAIN                                                                  02/14/2019 10:02:45 PAGE 2   

  56          bit bOxSupplyState=0;       //Õý´¦ÓÚ¹©Ñõ¼ÆÊ±×´Ì¬
  57          bit bSixByteRec=0;          //´®¿Ú½ÓÊÕµ½6×Ö½ÚÃüÁî
  58          
  59          
  60          void TIMER1Int(void) interrupt T1_INTNO   //3ºÅÖÐ¶Ï
  61          {
  62   1        ET1=0;
  63   1      }
  64          
  65          /*---------------------------------------------------------------------------
  66          º¯ÊýÔ­ÐÍ: void Delayms(uint ms)
  67          ²ÎÊýËµÃ÷: ms--ÐèÒªÑÓÊ±µÄÖµ
  68          ·µ »Ø Öµ: ÎÞ
  69          º¯Êý¹¦ÄÜ£ºÑÓÊ±³ÌÐò(¶ÔÓÚ18.432M¾§Õñµ¥Ö¸ÁîÖÜÆÚÑÓÊ±1mS)
  70          ----------------------------------------------------------------------------*/
  71          void Delayms(uint16 ms)   
  72          {
  73   1         uint16 xdata i;
  74   1         for(;ms!=0;ms--)
  75   1          for(i=900;i!=0;i--);
  76   1      }
  77          
  78          
  79          uint16   allday(STTime   a)   //·µ»Ø¶àÉÙÌì 
  80          {    
  81   1        uint16 xdata  x; 
  82   1        uint8 xdata i;
  83   1        x=(a.byYear)*365+a.byYear/4;   
  84   1        if((a.byYear%4)==0)  
  85   1        {   
  86   2          for(i=0;i<a.byMonth;i++)   
  87   2          {   
  88   3            if(i>0)   
  89   3            {   
  90   4               x=x+run[i-1];   
  91   4            }   
  92   3          }   
  93   2        }   
  94   1        else   
  95   1        {   
  96   2          for(i=0;i<a.byMonth;i++)   
  97   2          {   
  98   3            if(i>0)   
  99   3            {   
 100   4              x=x+notrun[i-1];   
 101   4            }   
 102   3          }   
 103   2        }   
 104   1        x=x+a.byDay;   
 105   1        return   x;   
 106   1      }  
 107          
 108          STOXTime   timeInterval(STTime a,STTime   b)    //a:½áÊøÊ±¼ä  b:ÆðÊ¼Ê±¼ä  
 109          {   
 110   1        uint16   xdata x,y;   
 111   1        STOXTime   xdata sum;   
 112   1        x=allday(a);   
 113   1        y=allday(b);   
 114   1        sum.uiHour=(x-y)*24+a.byHour-b.byHour;   
 115   1        if(a.byMin<b.byMin)   
 116   1        {   
 117   2          sum.byMin=a.byMin+60-b.byMin;
C51 COMPILER V9.00   MAIN                                                                  02/14/2019 10:02:45 PAGE 3   

 118   2        sum.uiHour=sum.uiHour-1;   
 119   2        }
 120   1        else  
 121   1        {   
 122   2        sum.byMin=a.byMin-b.byMin;   
 123   2        }   
 124   1        return   sum;   
 125   1       } 
 126          
 127          /***********************************************************/
 128          void UserTickTimer(void)   /* ÏµÍ³¶¨Ê±ÖÐ¶ÏÖÐµ÷ÓÃµÄÓÃ»§º¯ */
 129          { 
 130   1      #if STC90 == 1  
                TF2=0;
              #endif
 133   1      #if STC12C5A==1
 134   1        uiIsrTimerCount+=ISR_INC_COUNT;
 135   1        CCAP0L = (uint8)uiIsrTimerCount;
 136   1        CCAP0H = (uint8)(uiIsrTimerCount>>8);
 137   1        CCF0=0;
 138   1      #endif
 139   1      
 140   1      }
 141          
 142          
 143          
 144          void UsartInit(void)
 145          {
 146   1      
 147   1        RXD=1;
 148   1        TXD=1;
 149   1        SCON = 0X50;    //¹¤×÷·½Ê½1
 150   1      
 151   1      #if 0
               //   TMOD= 0x21;   //  ;t1×÷²¨ÌØÂÊ·¢ÉúÆ÷£¬t0×÷·½Ê½1£¨16Î»)¶¨Ê±Æ÷
                TMOD &= 0X0F;   //TO·½Ê½²»±ä
                TMOD |= 0X20;   //T1 8Î»×Ô¶¯ÖØÔØ
                TL1 = 0XF6;   //²¨ÌØÂÊ4800  ÔÚ18.432M¾§ÕñµÄÇé¿öÏÂ
                TH1 = 0XF6;
                  PCON &= (~SMOD);   //  ;²¨ÌØÂÊ±¶ÔöÑ¡Ôñ    smod=0
                  AUXR |= T1x12;    //1TÄ£Ê½,×îºó²¨ÌØÂÊÎª:4800*12=57.6K
                  TF1=0;
                  TR1=1;
              #endif
 162   1      
 163   1      
 164   1      #if 0
                TMOD &= 0X0F;    //TO·½Ê½²»±ä
                TMOD |= 0X20;    //T1 8Î»×Ô¶¯ÖØÔØ
                TL1 =   0Xec;    //²¨ÌØÂÊ2400  ÔÚ18.432M¾§ÕñµÄÇé¿öÏÂ
                TH1 =   TL1;
                PCON &= (~SMOD);   //  ;²¨ÌØÂÊ±¶ÔöÑ¡Ôñ     smod=0
                //     AUXR |= T1x12;    //1TÄ£Ê½,×îºó²¨ÌØÂÊÎª:4800*12=57.6K
                TF1=0;
                TR1=1;
              #endif
 174   1      
 175   1        TMOD &= 0X0F;    //TO·½Ê½²»±ä
 176   1        TMOD |= 0X20;    //T1 8Î»×Ô¶¯ÖØÔØ
 177   1        TL1 =   0Xd8;    //²¨ÌØÂÊ1200  ÔÚ18.432M¾§ÕñµÄÇé¿öÏÂ
 178   1        TH1 =   TL1;
 179   1        PCON &= (~SMOD);   //  ;²¨ÌØÂÊ±¶ÔöÑ¡Ôñ     smod=0
C51 COMPILER V9.00   MAIN                                                                  02/14/2019 10:02:45 PAGE 4   

 180   1        //     AUXR |= T1x12;    //1TÄ£Ê½,×îºó²¨ÌØÂÊÎª:4800*12=57.6K
 181   1        TF1=0;
 182   1        TR1=1;
 183   1      
 184   1      
 185   1        
 186   1        RI=0;
 187   1        TI=0;
 188   1        REN=1;
 189   1        ES=1; 
 190   1      }
 191          
 192          
 193          
 194          void Send_Data(uint8 *Databuf,uint8 xdata l)
 195          { 
 196   1        uint8 xdata i;
 197   1          ES=0;
 198   1        for(i=0;i<l;i++)
 199   1        {
 200   2          SBUF=*Databuf;
 201   2          while(!TI);
 202   2          TI=0;
 203   2          Databuf++;
 204   2        }
 205   1        ES=1;
 206   1       }
 207          
 208          void Send_Data_Byte(uint8 SendData)
 209          {
 210   1        ES=0;
 211   1          SBUF=SendData;
 212   1          while(!TI);
 213   1          TI=0;
 214   1        ES=1;
 215   1      }
 216          
 217          
 218          /*void RD_ID(void)
 219          {
 220            uint8 idata *p;
 221            p=0xf1;
 222            Send_Data(p,7);
 223          } */
 224          
 225          
 226          void UartInt(void) interrupt UART_INTNO
 227          {
 228   1        
 229   1        if(TI==1)
 230   1          TI=0;
 231   1        if(RI==1)
 232   1        {
 233   2          RI=0;
 234   2          UartRecData = ~SBUF;  //°´Î»È¡·´
 235   2          stLocalControl.byIrDataIntervalTimer=5;   //Ã¿×Ö½Ú¼ä¸ô²»³¬¹ý100ms
 236   2          if(IrDataPosit==0)
 237   2          { 
 238   3            if(UartRecData==0x05) //ÆðÊ¼Âë
 239   3              byIrDARecBuff[IrDataPosit++]= UartRecData;
 240   3          }
 241   2          
C51 COMPILER V9.00   MAIN                                                                  02/14/2019 10:02:45 PAGE 5   

 242   2          else 
 243   2          {
 244   3            byIrDARecBuff[IrDataPosit++]= UartRecData;
 245   3            if(IrDataPosit >=7)   IrDataPosit =0;
 246   3      /*      if(IrDataPosit==4)  
 247   3            {
 248   3              if(byIrDARecBuff[3]==(uint8)(byIrDARecBuff[0]+byIrDARecBuff[1]+byIrDARecBuff[2]))
 249   3              {
 250   3                bFourByteRec=1;
 251   3                IrDataPosit=0;
 252   3              }
 253   3            }
 254   3      
 255   3            else if(IrDataPosit==6)
 256   3            {
 257   3              if(byIrDARecBuff[5]==(uint8)(byIrDARecBuff[0]+byIrDARecBuff[1]+byIrDARecBuff[2]+byIrDARecBuff[3]+byIrD
             -ARecBuff[4]))
 258   3              {
 259   3      
 260   3                bSixByteRec =1;
 261   3              }
 262   3              IrDataPosit=0;  
 263   3            }*/
 264   3          } 
 265   2        }
 266   1      }
 267          
 268          void OXTimerKeyInit(void)
 269          {
 270   1      
 271   1      /*
 272   1      //OX_TIMER_KEY×¼Ë«Ïò¿Ú
 273   1      //  P3M0 &= 0xDF;
 274   1      //  P3M1 &= 0xDF; 
 275   1      
 276   1        //OX_TIMER_KEY¸ß×èÊäÈë
 277   1        P3M0 |= 0x20;
 278   1        P3M1 &= 0xDF; 
 279   1      
 280   1        OX_TIMER_KEY=1;
 281   1        bOxTimerKeyState=1;
 282   1        _nop_();
 283   1        _nop_();
 284   1        _nop_();
 285   1        _nop_();
 286   1        _nop_();
 287   1        _nop_();  
 288   1        if(OX_TIMER_KEY==0)
 289   1        {
 290   1          OSWait(K_TMO,4);
 291   1          if(OX_TIMER_KEY==0)  
 292   1          {
 293   1            bOxTimerKeyState=0;
 294   1            bWillSndOxSupplyStart=1;    //ÉÏµçÊ±¾Í´¦ÓÚ¹©Ñõ×´Ì¬
 295   1          }
 296   1          else 
 297   1          {
 298   1            bOxTimerKeyState=1;
 299   1      
 300   1          }
 301   1        }
 302   1        */
C51 COMPILER V9.00   MAIN                                                                  02/14/2019 10:02:45 PAGE 6   

 303   1      
 304   1        if(stLocalControl.stEepromCfgData.byBedFjFlag & OX_SUPPLY_STATE)  ///ÉÏµçÊ±¾Í´¦ÓÚ¹©Ñõ×´Ì¬
 305   1        {
 306   2          bWillSndOxSupplyStart=1;
 307   2        }
 308   1      
 309   1      }
 310          
 311          /**********************************************************
 312          *º¯ÊýÃû³Æ     :Init 
 313          *º¯ÊýÃèÊö         :Ó²¼þ³õÊ¼»¯²Ù×÷
 314          *ÊäÈë²ÎÊý       :
 315          *·µ»ØÖµ       :   
 316          *È«¾Ö±äÁ¿     :
 317          *µ÷ÓÃÄ£¿é       :
 318          ***********************************************************
 319          *´´½¨ÈË           :ÒüÔËÍ¬
 320          *´´½¨ÈÕÆÚ     :2008-9-22
 321          ***********************************************************
 322          *ÐÞ¸ÄÈË         :
 323          *ÐÞ¸ÄÈÕÆÚ       :
 324          *×¢ÊÍ           :
 325          **********************************************************/
 326          void Init(void)
 327          {
 328   1        CMOD = 0x02;    
 329   1        CCON = 0x00;  
 330   1        CL = 0x00;
 331   1        CH = 0x00;
 332   1        CCAP0L = (uint8)uiIsrTimerCount;
 333   1        CCAP0H = (uint8)(uiIsrTimerCount>>8);
 334   1        //ÉèÖÃPCAÄ£¿é0Îª16Î»Èí¼þ¶¨Ê±Æ÷,ECCF0=1ÔÊÐíPCAÄ£¿é0ÖÐ¶Ï
 335   1        CCAPM0 = 0x49;
 336   1      
 337   1        CR = 1; 
 338   1        EPCA_LVD =1;
 339   1        //¸´Î»¿´ÃÅ¹·                                                                                             
             -                                                                                                                        
             -                                                                
 340   1        //WDT_CONTR = 0x3a;   //@20MHz,157.3ms
 341   1        WDT_CONTR = 0x3d;   //@20MHz,1.25s  
 342   1      
 343   1      
 344   1      
 345   1        //²ÎÊý³õÊ¼»¯
 346   1        byDevState1 = 0;
 347   1        byDevState2 = 0;
 348   1        byDevState3 = 0;
 349   1      
 350   1        //ÄÚ´æÇå¿Õ
 351   1        memset(&(stLocalControl.byLedState),0x00,sizeof(STLocalControl));
 352   1      
 353   1      //STC12C56ÏµÁÐ::M0=0,M1=0:×¼Ë«Ïò£¬M0=0,M1=1:ÍÆÍì£¬M0=1,M1=0:¸ß×è£¬M0=1,M1=1:¿ªÂ©
 354   1      
 355   1      //ÌØ±ð×¢Òâ:ÒòÊäÈë¿ÚÏßÉÏÍâÎ§Î´ÅäÖÃÉÏÀ­µç×è£¬²»ÄÜÅäÖÃ³É¸ß×èÊäÈë£¬Ö»ÄÜÅäÖÃ³É×¼Ë«Ïò£¬·ñÔò¸Ã½ÅÔÚ¸ßµçÆ½Ê±´¦ÓÚÐü¸
             -¡×´Ì¬
 356   1        
 357   1      //IOC¿ªÂ©Êä³ö,ÖÃ¸ß:´ò¿ª,ÖÃµÍ:¹Ø±Õ
 358   1      //,LED¿ØÖÆÒý½ÅÉè¶¨ÎªÍÆÍìÊä³ö,RS485¿ØÖÆÏßÎª×¼Ë«Ïò¿Ú
 359   1      
 360   1      
 361   1        //IO³õÊ¼»¯
C51 COMPILER V9.00   MAIN                                                                  02/14/2019 10:02:45 PAGE 7   

 362   1        MUS = 0;  //ÌáÊ¾Òô¶Ë¿ÚÖÃ0
 363   1      
 364   1        //MUTÍÆÍìÊä³ö
 365   1        P1M0  &= (~Bin(0,1,0,0,0,0,0,0));
 366   1        P1M1  |=   Bin(0,1,0,0,0,0,0,0);
 367   1        bMUTState= MUT = 1;   //¹Ø±ÕMC34119
 368   1      
 369   1        P1M0 &= (~Bin(0,0,0,0,1,0,0,0));
 370   1        P1M1 |=   Bin(0,0,0,0,1,0,0,0);
 371   1        XTA = 0;  //¹Ø±ÕMICµ½SAµÄÉùÒôÍ¨µÀ
 372   1      
 373   1      
 374   1        P1M0 &= (~Bin(0,0,0,1,0,0,0,0));
 375   1        P1M1 |=   Bin(0,0,0,1,0,0,0,0);
 376   1        XTD = 0;  //¹Ø±ÕMICµ½SDµÄÉùÒôÍ¨µÀ 
 377   1      
 378   1        KDR = 0;  //ÔÊÐí485½ÓÊÕ
 379   1      
 380   1        //MUSÍÆÍìÊä³ö
 381   1        P1M0  &= (~Bin(0,0,0,0,0,0,1,0));
 382   1        P1M1  |=   Bin(0,0,0,0,0,0,1,0);
 383   1      
 384   1        MUS = 0;  //Ê¹SDÏßÂ·Á¬Í¨
 385   1      
 386   1        CloseCBD();
 387   1        CloseCGB();
 388   1      
 389   1        bNumSeting=0;
 390   1        bRFNumSeting=0;
 391   1        bEnableOxTimer=0;       //Èç¹ûÃ»ÊÕµ½Ê±¼äÊý¾Ý²»³äÐí¼ÆÊ±
 392   1        bWillSndOxSupplyStart=0;          //ÉÏµç´¦ÓÚ¹©Ñõ×´Ì¬
 393   1        bWillSndTotalOx=0;            //½«·¢ËÍ¹©Ñõ¼ÆÊ±×Ü¼ÆÐÅÏ¢
 394   1        bCloseCGB=0;          //¹ã²¥Ê±À®°È×´Ì¬±êÖ¾
 395   1      
 396   1        bBus1Answer =0;         //½ÓÊÕµ¥×ÜÏß1µÄÓ¦´ð±êÖ¾
 397   1        bOxSupplyState=0;       //Õý´¦ÓÚ¹©Ñõ¼ÆÊ±×´Ì¬  
 398   1      
 399   1      
 400   1          //´®¿Ú³õÊ¼»¯
 401   1          UsartInit();
 402   1      
 403   1      
 404   1        Delayms(200);
 405   1        //¶ÁÈ¡ÏµÍ³ÅäÖÃ×Ö
 406   1        InitParameter();
 407   1      
 408   1      
 409   1      
 410   1         // RD_ID();  //56ÏµÍ³Ã»ÓÐID
 411   1        
 412   1        //µ¥×ÜÏß³õÊ¼»¯  
 413   1        SingleBusInit();
 414   1      
 415   1        //ÉèÖÃÉÏµçÖ¸Ê¾µÆ×´Ì¬  
 416   1        SetLedDealState(LED_ON);
 417   1        
 418   1        stLocalControl.byLedTimeSet = 25;
 419   1        stLocalControl.byLedFlashTime = stLocalControl.byLedTimeSet;
 420   1      
 421   1        //³õÊ¼»¯ºìÍâ½ÓÊÕÊý¾Ý×Ö½Ú¼ä¸ôÊ±¼ä
 422   1        stLocalControl.byIrDataIntervalTimer=0; 
 423   1      
C51 COMPILER V9.00   MAIN                                                                  02/14/2019 10:02:45 PAGE 8   

 424   1        //³õÊ¼»¯µÆ¼°×´Ì¬±êÖ¾
 425   1        bLedDealState = LED_DEAL =0;
 426   1      
 427   1        OXTimerKeyInit();
 428   1      
 429   1        
 430   1        memset(&(stLocalControl.stTime.byYear),0x00,6); //Çåµ±Ç°Ê±¼äÊý¾Ý  
 431   1      
 432   1        stLocalControl.uiNurseInTime=0;
 433   1      
 434   1        stLocalControl.byNumSetTime=0;
 435   1      
 436   1        stLocalControl.uiRFNumSetTime=0;
 437   1        
 438   1      
 439   1      //  Send_Data(&(stLocalControl.stEepromCfgData.byRFSerialNum1),6);
 440   1        stLocalControl.uiBus1TestTime = BUS1_TEST_TIME; //Óëµ¥×ÜÏß1ÉÏµÄÄ£¿éÃ¿¸ô1Ãë¼ì²â1´Î
 441   1      
 442   1        //ÉèÖÃÉÏµçµÇ¼Ç±êÖ¾,µÆÉÁË¸Ê±¼ä³õÊ¼»¯,³¬Ê±ÉèÖÃ(³¬Ê±ºó×Ô¶¯·¢ËÍÉÏµçµÇ¼ÇÃüÁî)  
 443   1      //  bLanding = 1;
 444   1        bLanding=0;
 445   1        
 446   1      //  MakeCH0TimerOut(50, 0);
 447   1      
 448   1      
 449   1        BusLowDTime=100;
 450   1      }
 451          /**********************************************************
 452          *º¯ÊýÃû³Æ     :GetMessage 
 453          *º¯ÊýÃèÊö         :»ñÈ¡Ö÷Ïß³ÌÏûÏ¢¶ÓÁÐÖÐµÄÏûÏ¢(ÎÞÏûÏ¢Ôò¹ÒÆð×ÔÉí)
 454          *ÊäÈë²ÎÊý       :Msg:´æ´¢ÏûÏ¢Ö¸Õë
 455          *·µ»ØÖµ       :   
 456          *È«¾Ö±äÁ¿     :
 457          *µ÷ÓÃÄ£¿é       :
 458          ***********************************************************
 459          *´´½¨ÈË           :ÒüÔËÍ¬
 460          *´´½¨ÈÕÆÚ     :2008-9-22
 461          ***********************************************************
 462          *ÐÞ¸ÄÈË         :
 463          *ÐÞ¸ÄÈÕÆÚ       :
 464          *×¢ÊÍ           :
 465          **********************************************************/
 466          void GetMessage(uint8 data *Msg)
 467          {
 468   1        OSQPend(Msg, byMainCmdQ, 0);
 469   1      }
 470          /**********************************************************
 471          *º¯ÊýÃû³Æ     :DispatchMessage  
 472          *º¯ÊýÃèÊö         :·Ö·¢´¦Àí»ñÈ¡µÄÖ÷Ïß³ÌÏûÏ¢
 473          *ÊäÈë²ÎÊý       :Msg:ÏûÏ¢,¸ß4Î»ÊÇÃüÁîÀàÐÍ,µÍ4Î»ÊÇÃüÁîÊý¾Ý
 474          *·µ»ØÖµ       :   
 475          *È«¾Ö±äÁ¿     :
 476          *µ÷ÓÃÄ£¿é       :
 477          ***********************************************************
 478          *´´½¨ÈË           :ÒüÔËÍ¬
 479          *´´½¨ÈÕÆÚ     :2008-9-22
 480          ***********************************************************
 481          *ÐÞ¸ÄÈË         :
 482          *ÐÞ¸ÄÈÕÆÚ       :
 483          *×¢ÊÍ           :
 484          **********************************************************/
 485          void DispatchMessage(uint8 Msg)
C51 COMPILER V9.00   MAIN                                                                  02/14/2019 10:02:45 PAGE 9   

 486          {
 487   1        switch(Msg&0xf0)
 488   1        {
 489   2          case BUS0_REC:                    //×ÜÏß0ÊÕµ½Êý¾ÝÖ¡
 490   2            Bus0RecDeal();
 491   2            break;
 492   2          case BUS0_SND:                    //×ÜÏß0Êý¾Ý·¢ËÍÍê³É
 493   2            Bus0SendDeal();
 494   2            break;  
 495   2          case BUS1_REC:                    //×ÜÏß1ÊÕµ½Êý¾ÝÖ¡
 496   2            Bus1RecDeal();
 497   2            break;
 498   2          case BUS1_SND:                    //×ÜÏß1Êý¾Ý·¢ËÍÍê³É
 499   2            Bus1SendDeal();
 500   2            break;    
 501   2          case TIMER_OUT:                   //³¬Ê±´¦Àí
 502   2            TimerOutDeal();
 503   2            break;
 504   2          case KEY_DOWN:                    //¼ü°´ÏÂ´¦Àí          
 505   2            KeyDownDeal(Msg&0x0f);
 506   2            break;
 507   2          case KEY_ALWAYS:                  //¼ü³¤°´ÏÂ´¦Àí
 508   2            KeyAlwaysDeal(Msg&0x0f);
 509   2            break;
 510   2          case KEY_UP:                      //¼üµ¯Æð´¦Àí
 511   2            KeyUpDeal(Msg&0x0f);
 512   2            break;                
 513   2        } 
 514   1      }
 515          /**********************************************************
 516          *º¯ÊýÃû³Æ     :MainTask 
 517          *º¯ÊýÃèÊö         :ÏµÍ³Ö÷Ïß³Ì,¸ºÔðÕû¸öÏµÍ³µÄÏûÏ¢´¦Àí
 518          *ÊäÈë²ÎÊý       :
 519          *·µ»ØÖµ       :   
 520          *È«¾Ö±äÁ¿     :
 521          *µ÷ÓÃÄ£¿é       :
 522          ***********************************************************
 523          *´´½¨ÈË           :ÒüÔËÍ¬
 524          *´´½¨ÈÕÆÚ     :2008-9-22
 525          ***********************************************************
 526          *ÐÞ¸ÄÈË         :
 527          *ÐÞ¸ÄÈÕÆÚ       :
 528          *×¢ÊÍ           :
 529          **********************************************************/
 530          void MainTask(void)
 531          {
 532   1        static uint8 data Msg;  
 533   1        
 534   1        //ÏµÍ³Ó²¼þ³õÊ¼»¯
 535   1        Init();   
 536   1        //´´½¨Ö÷Ïß³ÌÏûÏ¢¶ÓÁÐ  
 537   1        OSQCreate(byMainCmdQ, 16);
 538   1        //ÒÔÏÂÎª´´½¨ÈÎÎñÏß³Ì  
 539   1      /*  OSTaskCreate(Bus0Manage, NULL, 1);  
 540   1        OSTaskCreate(Bus1Manage, NULL, 2);
 541   1        OSTaskCreate(TimerOutManager, NULL, 3);
 542   1        OSTaskCreate(KeyManager, NULL, 4);
 543   1        OSTaskCreate(OXManager, NULL, 5);
 544   1      */
 545   1        OSTaskCreate(BusManage, NULL, 1); 
 546   1        OSTaskCreate(TimerOutManager, NULL, 2);
 547   1        OSTaskCreate(KeyManager, NULL, 3);
C51 COMPILER V9.00   MAIN                                                                  02/14/2019 10:02:45 PAGE 10  

 548   1        //OSTaskCreate(OXManager, NULL, 4);
 549   1      
 550   1        //½øÈëÏûÏ¢Ñ­»·    
 551   1        while(TRUE)
 552   1        {
 553   2          GetMessage(&Msg);
 554   2          WDT_CONTR = 0x3d;   //@20MHz,1.25s
 555   2          DispatchMessage(Msg);
 556   2          if(bFourByteRec==1)
 557   2          {
 558   3            bFourByteRec=0;
 559   3            IrDATreat();      
 560   3          }
 561   2      
 562   2          if(bSixByteRec ==1)
 563   2          {
 564   3            bSixByteRec =0;
 565   3            IrDANumberSet();
 566   3          }
 567   2          
 568   2        }
 569   1      } 
 570          /**********************************************************
 571          *º¯ÊýÃû³Æ     :main 
 572          *º¯ÊýÃèÊö         :ÏµÍ³Ö÷º¯Êý,Õû¸öÈí¼þµÄÈë¿Ú
 573          *ÊäÈë²ÎÊý       :
 574          *·µ»ØÖµ       :   
 575          *È«¾Ö±äÁ¿     :
 576          *µ÷ÓÃÄ£¿é       :
 577          ***********************************************************
 578          *´´½¨ÈË           :ÒüÔËÍ¬
 579          *´´½¨ÈÕÆÚ     :2008-9-22
 580          ***********************************************************
 581          *ÐÞ¸ÄÈË         :
 582          *ÐÞ¸ÄÈÕÆÚ       :
 583          *×¢ÊÍ           :
 584          **********************************************************/
 585          void main(void)
 586          {     
 587   1        //²Ù×÷ÏµÍ³³õÊ¼»¯  
 588   1        OSInit();
 589   1        //´´½¨ÏµÍ³Ö÷Ïß³Ì
 590   1        OSTaskCreate(MainTask, NULL, 0); 
 591   1      
 592   1      
 593   1        while(1)
 594   1          {
 595   2          _nop_();
 596   2       //      PCON = PCON | 0x01;                    //CPU½øÈëÐÝÃß×´Ì¬
 597   2          }  
 598   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    906    ----
   CONSTANT SIZE    =     26    ----
   XDATA SIZE       =    104      24
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      1    ----
   IDATA SIZE       =     16    ----
   BIT SIZE         =     12    ----
END OF MODULE INFORMATION.

C51 COMPILER V9.00   MAIN                                                                  02/14/2019 10:02:45 PAGE 11  


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
