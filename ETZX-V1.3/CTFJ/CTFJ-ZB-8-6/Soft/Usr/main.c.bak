/*
************************Copyright(c)************************
*	  			   湖南熙旺达科技有限公司
*			       	All Rights Reserved
*			     		 
*
*-----------------------文件信息---------------------------
*文件名称     		:main.c
*文件描述    		:主函数
*创建人     		:陈卫国
*创建日期   		:2008-9-22
*版本号       		:V1.0
*注释	     		:					
*----------------------------------------------------------
*修改人  			:
*修改日期  			:
*版本号        		:
*注释	     		:
***********************************************************
*/
#include "config.h"

uint16	uiIsrTimerCount = ISR_INC_COUNT;					//系统时钟定时值
uint8	OS_Q_MEM_SEL	byMainCmdQ[16];						//主线程消息队列
STLocalControl 	xdata stLocalControl;						//全局变量结构体

/**********************************************************
*函数名称			:Init	
*函数描述        	:硬件初始化操作
*输入参数   		:
*返回值				: 	
*全局变量			:
*调用模块  			:
***********************************************************
*创建人	      		:陈卫国
*创建日期	 		:2008-9-22
***********************************************************
*修改人	  			:
*修改日期    		:
*注释		      	:
**********************************************************/
void Init(void)
{
	CMOD = 0x02;
	CCON = 0x00;	
	CL = 0x00;
	CH = 0x00;
	CCAP0L = (uint8)uiIsrTimerCount;
	CCAP0H = (uint8)(uiIsrTimerCount>>8);
	//设置PCA模块0为16位软件定时器,ECCF0=1允许PCA模块0中断
	CCAPM0 = 0x49;
	//设置PCA模块1为PWM工作方式	
	CCAP1H = 10;
	CCAPM1 = 0x42;
	PCA_PWM1 = 0x00;	
	//开PCA中断和LVD(低压检测)中断共享的总中断控制位
	EPCA_LVD = 1;
	//启动PCA计数器计数
	CR = 1;	
	//复位看门狗
	WDT_CONTR = 0x3a; 
	//IO口初始化,OC开漏输出,置高:打开,置低:关闭,LED控制引脚设定为推挽输出,RS485控制线为准双向口  	
	//P1^7,P1^6推挽,P1^5,P1^3准双向口,P1.1,P1.0准双向口
	P1M0 &= (~Bin(1,1,1,0,1,0,1,1));
	P1M1 |= Bin(1,1,0,0,0,0,0,0);
	P1M1 &= (~Bin(0,0,1,0,1,0,1,1));
	/*P1M1 |= 0xc3;
	P1M1 &= 0xd7;
	P1M0 |= 0x03;
	P1M0 &= 0x17;*/ 
	//CTA,CTD,KV置为推挽输出,MUS置为准双向口,P3^0,P3^1,P3^5推挽,P3^7准双向口
	P3M0 &= (~Bin(1,0,1,0,0,0,1,1));
	P3M1 |= Bin(0,0,1,0,0,0,1,1);
	P3M1 &= (~Bin(1,0,0,0,0,0,0,0));
	/*P3M1 |= 0x23;
	P3M0 &= 0xdc;*/ 
	//IO初始化
	MUS = 0;
	KV = 0;	
	PW = 0;
	CGB = 1; 	
	CBD = 1;
	CTA = 0;
	CTD = 0;		
	KDR = 1;  			
	//参数初始化
	byDevState1 = 0;
	byDevState2 = 0;
	byDevState3 = 0;
	//读取系统配置字
	ReadParameter();
	//单总线初始化 	
	SingleBusInit();
	//设置上电指示灯状态 	
	SetLedDealState(LED_ON);
	SetLedSetState(LED_ON);
	//设置上电登记标志,灯闪烁时间初始化,超时设置(超时后自动发送上电登记命令)	
	bLanding = 1;	
	stLocalControl.byLedTimeSet	= 25;
	stLocalControl.byLedFlashTime = stLocalControl.byLedTimeSet;
	MakeCH0TimerOut(50, 0);		
}
/**********************************************************
*函数名称			:GetMessage	
*函数描述        	:获取主线程消息队列中的消息(无消息则挂起自身)
*输入参数   		:Msg:存储消息指针
*返回值				: 	
*全局变量			:
*调用模块  			:
***********************************************************
*创建人	      		:陈卫国
*创建日期	 		:2008-9-22
***********************************************************
*修改人	  			:
*修改日期    		:
*注释		      	:
**********************************************************/
void GetMessage(uint8 data *Msg)
{
	OSQPend(Msg, byMainCmdQ, 0);
}
/**********************************************************
*函数名称			:DispatchMessage	
*函数描述        	:分发处理获取的主线程消息
*输入参数   		:Msg:消息,高4位是命令类型,低4位是命令数据
*返回值				: 	
*全局变量			:
*调用模块  			:
***********************************************************
*创建人	      		:陈卫国
*创建日期	 		:2008-9-22
***********************************************************
*修改人	  			:
*修改日期    		:
*注释		      	:
**********************************************************/
void DispatchMessage(uint8 Msg)
{
	switch(Msg&0xf0)
	{
		case BUS0_REC:										//总线0收到数据帧
			Bus0RecDeal();
			break;
		case BUS0_SND:	 									//总线0数据发送完成
			Bus0SendDeal();
			break;		
		case KEY_DOWN: 										//键按下处理   				
			KeyDownDeal(Msg&0x0f);
			break;
		case KEY_ALWAYS:									//键长按下处理
			KeyAlwaysDeal(Msg&0x0f);
			break;
		case KEY_UP:  										//键弹起处理
			KeyUpDeal(Msg&0x0f);
			break;			
		case TIMER_OUT:	 									//超时处理
			TimerOutDeal();
			break;
	}	
}
/**********************************************************
*函数名称			:MainTask	
*函数描述        	:系统主线程,负责整个系统的消息处理
*输入参数   		:
*返回值				: 	
*全局变量			:
*调用模块  			:
***********************************************************
*创建人	      		:陈卫国
*创建日期	 		:2008-9-22
***********************************************************
*修改人	  			:
*修改日期    		:
*注释		      	:
**********************************************************/
void MainTask(void)
{
	static uint8 data Msg;  
	
	//系统硬件初始化
	Init();
	//创建主线程消息队列	
	OSQCreate(byMainCmdQ, 16);
	//以下为创建任务线程	
	OSTaskCreate(Bus0Manage, NULL, 1);	
	OSTaskCreate(KeyManager, NULL, 2);
	OSTaskCreate(TimerOutManager, NULL, 3);
	//进入消息循环		
	while(TRUE)
	{
		GetMessage(&Msg);
		DispatchMessage(Msg);
	}
} 
/**********************************************************
*函数名称			:main	
*函数描述        	:系统主函数,整个软件的入口
*输入参数   		:
*返回值				: 	
*全局变量			:
*调用模块  			:
***********************************************************
*创建人	      		:陈卫国
*创建日期	 		:2008-9-22
***********************************************************
*修改人	  			:
*修改日期    		:
*注释		      	:
**********************************************************/
void main(void)
{  	
	//操作系统初始化			
	OSInit();	
	//创建系统主线程
	OSTaskCreate(MainTask, NULL, 0); 	
	while(1)
    {
       PCON = PCON | 0x01;                    //CPU进入休眠状态	    
    }	 
}