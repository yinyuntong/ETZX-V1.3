C51 COMPILER V9.00   OS_CORE                                                               02/18/2019 14:13:11 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE OS_CORE
OBJECT MODULE PLACED IN .\OS_CORE.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\OS\OS_CORE.C LARGE BROWSE DEBUG OBJECTEXTEND PRINT(.\OS_CORE.lst) OBJECT
                    -(.\OS_CORE.obj)

line level    source

   1          /*********************************************************************************************************
   2          **                                                             Small RTOS(51)
   3          **                                   The Real-Time Kernel(For Keil c51)
   4          **
   5          **                                  (c) Copyright 2002-2003, chenmingji
   6          **                                           All Rights Reserved
   7          **
   8          **                                                  V1.20.1
   9          **
  10          **
  11          **--------------文件信息--------------------------------------------------------------------------------
  12          **文   件   名: OS_CORE.C
  13          **创   建   人: 陈明计
  14          **最后修改日期: 2004年2月4日
  15          **描        述: Small RTOS(51)与CPU无关的核心代码
  16          **
  17          **--------------历史版本信息----------------------------------------------------------------------------
  18          ** 创建人: 陈明计
  19          ** 版  本: V0.50~V1.00
  20          ** 日　期: 2002年2月22日~2002年6月20日
  21          ** 描　述: 基本完成Small RTOS核
  22          **
  23          **------------------------------------------------------------------------------------------------------
  24          ** 修改人: 陈明计
  25          ** 版  本: V1.10~V1.21
  26          ** 日　期: 2002年9月1日~2003年1月23日
  27          ** 描　述: 完善Small RTOS
  28          **
  29          **------------------------------------------------------------------------------------------------------
  30          ** 修改人: 陈明计
  31          ** 版  本: V1.20.0
  32          ** 日　期: 2003年8月17日
  33          ** 描　述: 增加支持任务动态建立和删除，函数功能向一般的RTOS靠齐
  34          **
  35          **------------------------------------------------------------------------------------------------------
  36          ** 修改人: 陈明计
  37          ** 版  本: V1.20.1
  38          ** 日　期: 2004年2月4日
  39          ** 描　述: 修改OSWait(K_SIG | K_TMO, x) 只能通过信号唤醒的bug。
  40          **
  41          **--------------当前版本修订------------------------------------------------------------------------------
  42          ** 修改人: 
  43          ** 日　期:
  44          ** 描　述:
  45          **
  46          **------------------------------------------------------------------------------------------------------
  47          ********************************************************************************************************/
  48          
  49          #define  IN_OS_CORE
  50          #include "config.h"
  51          
  52          uint8 data OSIntNesting;
  53          
  54          uint8 data OSTaskID;
C51 COMPILER V9.00   OS_CORE                                                               02/18/2019 14:13:11 PAGE 2   

  55          uint8 data OSNextTaskID;
  56          
  57          uint8 data OSWaitTick[OS_MAX_TASKS];
  58          #if OS_MAX_TASKS < 9
  59          uint8 data OSTaskRuning[1];
  60          uint8 data OSTaskCreated[1];
  61          #else
              uint8 data OSTaskRuning[2];
              uint8 data OSTaskCreated[2];
              #endif
  65          
  66          uint8 const OSMapTbl[] = {0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x00};
  67          uint8 data Os_Enter_Sum;
  68          
  69          
  70          void  OSSched(void) small;
  71          
  72          /*********************************************************************************************************
  73          ** 函数名称: OSInit
  74          ** 功能描述: 系统变量初始化
  75          ** 输　入: 无
  76          ** 输　出: 无
  77          ** 全局变量: 
  78          ** 调用模块: 无
  79          **
  80          ** 作　者: 陈明计
  81          ** 日　期: 2003年8月3日
  82          **-------------------------------------------------------------------------------------------------------
  83          ** 修改人:
  84          ** 日　期:
  85          **------------------------------------------------------------------------------------------------------
  86          ********************************************************************************************************/
  87                  void OSInit(void) small
  88          {
  89   1          OSTaskRuning[0] = 0;
  90   1          OSTaskCreated[0] = 0;
  91   1      #if OS_MAX_TASKS > 8
                  OSTaskRuning[1] = 0;
                  OSTaskCreated[1] = 0;
              #endif
  95   1          Os_Enter_Sum = 0;
  96   1          OSTaskID = OS_MAX_TASKS;
  97   1          OSNextTaskID = 0;
  98   1          OSIntNesting = 0;
  99   1          OSCPUInit();
 100   1      }
 101          
 102          /*********************************************************************************************************
 103          ** 函数名称: _OSTaskCreate
 104          ** 功能描述: 创建任务
 105          ** 输　入: TaskID:任务ID
 106          **         task  :任务地址
 107          **         ptos  :任务堆栈，在51中为重入栈
 108          ** 输　出: 无
 109          ** 全局变量: 
 110          ** 调用模块: 无
 111          **
 112          ** 作　者: 陈明计
 113          ** 日　期: 2003年8月3日
 114          **-------------------------------------------------------------------------------------------------------
 115          ** 修改人:
 116          ** 日　期:
C51 COMPILER V9.00   OS_CORE                                                               02/18/2019 14:13:11 PAGE 3   

 117          **------------------------------------------------------------------------------------------------------
 118          ********************************************************************************************************/
 119                  uint8 _OSTaskCreate(uint8 TaskID, void (code * task)(void), void xdata *ptos) small
 120          {
 121   1          if (TaskID < OS_MAX_TASKS)
 122   1          {
 123   2              OS_ENTER_CRITICAL();
 124   2      #if OS_MAX_TASKS < 9
 125   2              if ((OSTaskCreated[0] & OSMapTbl[TaskID]) != 0)
 126   2              {
 127   3                  return FALSE;
 128   3              }
 129   2              OSTaskCreated[0] |= OSMapTbl[TaskID];
 130   2              OSTaskRuning[0] |= OSMapTbl[TaskID];
 131   2      #else
                      if (TaskID < 8)
                      {
                          if ((OSTaskCreated[0] & OSMapTbl[TaskID]) != 0)
                          {
                              return FALSE;
                          }
                          OSTaskCreated[0] |= OSMapTbl[TaskID];
                          OSTaskRuning[0] |= OSMapTbl[TaskID];
                      }
                      else
                      {
                          if ((OSTaskCreated[1] & OSMapTbl[TaskID & 0x07]) != 0)
                          {
                              return FALSE;
                          }
                          OSTaskCreated[1] |= OSMapTbl[TaskID & 0x07];
                          OSTaskRuning[1] |= OSMapTbl[TaskID & 0x07];
                      }
              #endif
 151   2              OSTaskStkInit(task, ptos, TaskID);
 152   2              OSSched();
 153   2              OS_EXIT_CRITICAL();
 154   2              return TRUE;
 155   2          }
 156   1          return FALSE;
 157   1      }
 158          
 159          /*********************************************************************************************************
 160          ** 函数名称: OSTaskDel
 161          ** 功能描述: 删除任务
 162          ** 输　入: TaskID:任务ID
 163          ** 输　出: 无
 164          ** 全局变量: 
 165          ** 调用模块: 无
 166          **
 167          ** 作　者: 陈明计
 168          ** 日　期: 2003年8月3日
 169          **-------------------------------------------------------------------------------------------------------
 170          ** 修改人:
 171          ** 日　期:
 172          **------------------------------------------------------------------------------------------------------
 173          ********************************************************************************************************/
 174          /*        uint8 OSTaskDel(uint8 TaskID) small
 175          {
 176              if (TaskID < OS_MAX_TASKS)
 177              {
 178                  OS_ENTER_CRITICAL();
C51 COMPILER V9.00   OS_CORE                                                               02/18/2019 14:13:11 PAGE 4   

 179          #if OS_MAX_TASKS < 9
 180                  OSTaskCreated[0] &= ~OSMapTbl[TaskID];
 181          #else
 182                  if (TaskID < 8)
 183                  {
 184                      OSTaskCreated[0] &= ~OSMapTbl[TaskID];
 185                  }
 186                  else
 187                  {
 188                      OSTaskCreated[1] &= ~OSMapTbl[TaskID & 0x07];
 189                  }
 190          #endif
 191                  OSTaskStkDel(TaskID);
 192                  OSSched();
 193                  OS_EXIT_CRITICAL();
 194                  return TRUE;
 195              }
 196              else
 197              {
 198                  return FALSE;
 199              }
 200          }
 201          */
 202          /*********************************************************************************************************
 203          ** 函数名称: OSTaskResume
 204          ** 功能描述: 恢复任务
 205          ** 输　入: TaskID : 任务ID
 206          ** 输　出: 无
 207          ** 全局变量: OSTaskRuning
 208          ** 调用模块: 无
 209          **
 210          ** 作　者: 陈明计
 211          ** 日　期: 2003年8月3日
 212          **-------------------------------------------------------------------------------------------------------
 213          ** 修改人:
 214          ** 日　期:
 215          **------------------------------------------------------------------------------------------------------
 216          ********************************************************************************************************/
 217                  void OSTaskResume(uint8 TaskID)  small
 218          {
 219   1          if (TaskID < OS_MAX_TASKS)
 220   1          {
 221   2              OS_ENTER_CRITICAL();
 222   2      #if OS_MAX_TASKS < 9
 223   2              OSTaskRuning[0] |= OSMapTbl[TaskID];
 224   2      #else
                      if (TaskID < 8)
                      {
                          OSTaskRuning[0] |= OSMapTbl[TaskID];
                      }
                      else
                      {
                          OSTaskRuning[1] |= OSMapTbl[TaskID & 0x07];
                      }
              #endif
 234   2              OS_EXIT_CRITICAL();
 235   2          }
 236   1          OSSched();                                              //开始任务切换
 237   1      }
 238          
 239          /*********************************************************************************************************
 240          ** 函数名称: OS_TaskSuspend
C51 COMPILER V9.00   OS_CORE                                                               02/18/2019 14:13:11 PAGE 5   

 241          ** 功能描述: 使指定任务休眠，但不进行任务切换
 242          ** 输　入: TaskID : 任务ID
 243          ** 输　出: 无
 244          ** 全局变量: OSWaitTick
 245          ** 调用模块: 无
 246          **
 247          ** 作　者: 陈明计
 248          ** 日　期: 2003年8月3日
 249          **-------------------------------------------------------------------------------------------------------
 250          ** 修改人:
 251          ** 日　期:
 252          **-------------------------------------------------------------------------------------------------------
 253          ********************************************************************************************************/
 254                  void OS_TaskSuspend(uint8 TaskID)    small
 255          {
 256   1          if (TaskID < OS_MAX_TASKS)
 257   1          {
 258   2              OS_ENTER_CRITICAL();
 259   2      #if OS_MAX_TASKS < 9
 260   2              OSTaskRuning[0] &= ~OSMapTbl[TaskID];
 261   2      #else
                      if (TaskID < 8)
                      {
                          OSTaskRuning[0] &= ~OSMapTbl[TaskID];
                      }
                      else
                      {
                          OSTaskRuning[1] &= ~OSMapTbl[TaskID & 0x07];
                      }
              #endif
 271   2              OS_EXIT_CRITICAL();
 272   2          }
 273   1      }
 274          
 275          
 276          /*********************************************************************************************************
 277          ** 函数名称: OSTaskSuspend
 278          ** 功能描述: 使指定任务休眠
 279          ** 输　入: TaskID : 任务ID
 280          ** 输　出: 无
 281          ** 全局变量: OSWaitTick
 282          ** 调用模块: OS_TaskSuspend,OSSched
 283          **
 284          ** 作　者: 陈明计
 285          ** 日　期: 2003年8月3日
 286          **-------------------------------------------------------------------------------------------------------
 287          ** 修改人:
 288          ** 日　期:
 289          **-------------------------------------------------------------------------------------------------------
 290          ********************************************************************************************************/
 291                  void OSTaskSuspend(uint8 TaskID)    small
 292          {
 293   1          OSWaitTick[TaskID] = 0;                                 /* 没有超时处理         */
 294   1      
 295   1          OS_TaskSuspend(TaskID);
 296   1          OSSched();                                              /* 开始任务切换 */
 297   1      }
 298          
 299          /*********************************************************************************************************
 300          ** 函数名称: OSFindNextRunningTask
 301          ** 功能描述: 查找下一个优先级最高的就绪任务
 302          ** 输　入: 无
C51 COMPILER V9.00   OS_CORE                                                               02/18/2019 14:13:11 PAGE 6   

 303          ** 输　出: OSNextTaskID:存储查找结果
 304          ** 全局变量: OSTaskRuning,OSTaskCreated
 305          ** 调用模块: 无
 306          **
 307          ** 作　者: 陈明计
 308          ** 日　期: 2003年8月3日
 309          **-------------------------------------------------------------------------------------------------------
 310          ** 修改人:
 311          ** 日　期:
 312          **-------------------------------------------------------------------------------------------------------
 313          ********************************************************************************************************/
 314                  void OSFindNextRunningTask(void) small
 315          {
 316   1          uint8 temp;
 317   1      
 318   1          temp = OSTaskRuning[0] & OSTaskCreated[0];
 319   1      #if OS_MAX_TASKS < 9
 320   1                      /* 查找处于就绪状态的任务中优先级最高的任务 */
 321   1          for (OSNextTaskID = 0; OSNextTaskID < OS_MAX_TASKS; OSNextTaskID++)
 322   1          {
 323   2              if ((temp & 0x01) != 0)
 324   2              {
 325   3                  break;
 326   3              }
 327   2              temp = temp >> 1;
 328   2          }
 329   1          return;
 330   1      #else
                              /* 查找处于就绪状态的任务中优先级最高的任务 */
                  for (OSNextTaskID = 0; OSNextTaskID < 8; OSNextTaskID++)
                  {
                      if ((temp & 0x01) != 0)
                      {
                          return;
                      }
                      temp = temp >> 1;
                  }
                  temp = OSTaskRuning[1] & OSTaskCreated[1];
                  for (; OSNextTaskID < OS_MAX_TASKS; OSNextTaskID++)
                  {
                      if ((temp & 0x01) != 0)
                      {
                          break;
                      }
                      temp = temp >> 1;
                  }
                  return;
              #endif
 351   1      }
 352          
 353          /*********************************************************************************************************
 354          ** 函数名称: OSIntExit
 355          ** 功能描述: 中断退出处理函数,在此进行中断后的任务切换
 356          ** 输　入: 无
 357          ** 输　出: 无
 358          ** 全局变量: OSIntNesting,OSNextTaskID
 359          ** 调用模块: OSIntCtxSw
 360          **
 361          ** 作　者: 陈明计
 362          ** 日　期: 2003年8月3日
 363          **-------------------------------------------------------------------------------------------------------
 364          ** 修改人:
C51 COMPILER V9.00   OS_CORE                                                               02/18/2019 14:13:11 PAGE 7   

 365          ** 日　期:
 366          **------------------------------------------------------------------------------------------------------
 367          ********************************************************************************************************/
 368                  uint8 OSIntExit(void)    small
 369          
 370          {
 371   1          OS_ENTER_CRITICAL();
 372   1                      /* 中断嵌套处理 */
 373   1          if (OSIntNesting > 0)
 374   1          {
 375   2              OSIntNesting--;
 376   2          }
 377   1          if (OSIntNesting == 0)
 378   1          {
 379   2              Os_Enter_Sum = 0;               /* 因为在中断中，所以关中断计数器为0 */
 380   2              OSFindNextRunningTask();
 381   2              OSIntCtxSw();                   /* 进行任务调度 */
 382   2              return TRUE;
 383   2          }
 384   1          OS_EXIT_CRITICAL();
 385   1          return FALSE;
 386   1      }
 387          
 388          /*********************************************************************************************************
 389          ** 函数名称: OSSched
 390          ** 功能描述: 非中断的任务切换函数
 391          ** 输　入: 无
 392          ** 输　出: 无
 393          ** 全局变量: OSIntNesting,OSNextTaskID
 394          ** 调用模块: OS_TASK_SW
 395          **
 396          ** 作　者: 陈明计
 397          ** 日　期: 2003年8月3日
 398          **------------------------------------------------------------------------------------------------------
 399          ** 修改人:
 400          ** 日　期:
 401          **-------------------------------------------------------------------------------------------------------
 402          ********************************************************************************************************/
 403                  void  OSSched(void) small
 404          
 405          {
 406   1          OS_ENTER_CRITICAL();
 407   1          if (OSIntNesting == 0)              /* 是否是中断中调用 */
 408   1          {
 409   2              OSFindNextRunningTask();
 410   2              OS_TASK_SW();                   /* 进行任务调度 */
 411   2          }
 412   1          OS_EXIT_CRITICAL();
 413   1      }
 414          
 415          /*********************************************************************************************************
 416          ** 函数名称: OSTimeTick
 417          ** 功能描述: 系统时钟处理函数,处理各个任务的延时
 418          ** 输　入: 无
 419          ** 输　出: 无
 420          ** 全局变量: OSWaitTick
 421          ** 调用模块: OSIntSendSignal
 422          **
 423          ** 作　者: 陈明计
 424          ** 日　期: 2003年8月3日
 425          **------------------------------------------------------------------------------------------------------
 426          ** 修改人:
C51 COMPILER V9.00   OS_CORE                                                               02/18/2019 14:13:11 PAGE 8   

 427          ** 日　期:
 428          **-------------------------------------------------------------------------------------------------------
 429          ********************************************************************************************************/
 430                  void  OSTimeTick(void)  small
 431          {
 432   1          uint8 i;
 433   1      
 434   1          for (i = 0; i < OS_MAX_TASKS; i++)                 
 435   1          {
 436   2              if (OSWaitTick[i] != 0 )
 437   2              {
 438   3                  OSWaitTick[i]--;
 439   3                  if (OSWaitTick[i] == 0)
 440   3                  {
 441   4      #if OS_MAX_TASKS < 9
 442   4                      OSTaskRuning[0] |= OSMapTbl[i];
 443   4      #else
                              if (i < 8)
                              {
                                  OSTaskRuning[0] |= OSMapTbl[i];
                              }
                              else
                              {
                                  OSTaskRuning[1] |= OSMapTbl[i & 0x07];
                              }
              #endif
 453   4                  }
 454   3              }
 455   2          }
 456   1          OSSched();
 457   1      }
 458          
 459          /*********************************************************************************************************
 460          ** 函数名称: OSTimeDly
 461          ** 功能描述: 系统等待函数,任务调用此函数可以等待一定时间
 462          ** 输　入:  ticks : 等待超时时的系统嘀嗒数
 463          ** 输　出 : 无
 464          **
 465          ** 全局变量: OSWaitTick
 466          ** 调用模块: OS_TaskSuspend,OSSched
 467          **
 468          ** 作　者: 陈明计
 469          ** 日　期: 2003年8月3日
 470          **-------------------------------------------------------------------------------------------------------
 471          ** 修改人:
 472          ** 日　期:
 473          **-------------------------------------------------------------------------------------------------------
 474          ********************************************************************************************************/
 475                  void OSTimeDly(uint8 ticks)     small
 476          {
 477   1          OSWaitTick[OSTaskID] = ticks;               /* 设置超时时间         */
 478   1          OS_ENTER_CRITICAL();
 479   1          while (OSWaitTick[OSTaskID] != 0)           /* 判断超时时间是否到   */
 480   1          {
 481   2              OS_TaskSuspend(OSTaskID);               /* 任务进入等待状态     */
 482   2              OSSched();                               /* 开始任务切换         */
 483   2          }
 484   1          OS_EXIT_CRITICAL();
 485   1      }
 486          
 487          /*********************************************************************************************************
 488          ** 函数名称: OSTimeDlyResume
C51 COMPILER V9.00   OS_CORE                                                               02/18/2019 14:13:11 PAGE 9   

 489          ** 功能描述: 让处在延时期的任务结束延时
 490          ** 输　入:  TaskID : 任务ID
 491          ** 输　出 : 无
 492          ** 全局变量: OSWaitTick
 493          ** 调用模块: OSTaskResume
 494          **
 495          ** 作　者: 陈明计
 496          ** 日　期: 2003年8月3日
 497          **-------------------------------------------------------------------------------------------------------
 498          ** 修改人:
 499          ** 日　期:
 500          **-------------------------------------------------------------------------------------------------------
 501          ********************************************************************************************************/
 502          /*        void OSTimeDlyResume(uint8 TaskID)    small
 503          {
 504              OSWaitTick[TaskID] = 0;
 505              OSTaskResume(TaskID);
 506          }
 507          */
 508          
 509          /*********************************************************************************************************
 510          ** 函数名称: OSWait
 511          ** 功能描述: 系统等待函数,任务调用此函数可以等待一定时间或信号
 512          ** 输　入: typ: 等待事件类型,目前可以取以下值,或是其中任意个值的按位或
 513          **             K_SIG: 等待信号
 514          **             K_TMO: 等待超时
 515          **        ticks : 等待超时时的系统嘀嗒数
 516          ** 输　出 : NOT_OK : 参数错误
 517          **         TMO_EVENT : 超时到
 518          **         SIG_EVENT : 有信号
 519          ** 全局变量: OSWaitTick
 520          ** 调用模块: OSTaskSuspend,OSTimeDly,OS_ENTER_CRITICAL,OS_EXIT_CRITICAL
 521          **
 522          ** 作　者: 陈明计
 523          ** 日　期: 2003年8月3日
 524          **------------------------------------------------------------------------------------------------------
 525          ** 修改人: 陈明计
 526          ** 日　期: 2004年2月4日
 527          **-------------------------------------------------------------------------------------------------------
 528          ********************************************************************************************************/
 529          #ifndef OSWait_EN
              #define OSWait_EN   0
              #endif
 532          
 533          #if OSWait_EN > 0
 534                  uint8 OSWait(uint8 typ, uint8 ticks)    small
 535          {
 536   1          OSWaitTick[OSTaskID] = ticks;               /* 设置超时时间         */
 537   1                                                      /* 可以优化寄存器的使用  */
 538   1          switch(typ)
 539   1          {
 540   2          case K_SIG:                                 /* 等待信号，即挂起自己  */
 541   2              OSTaskSuspend(OSTaskID);
 542   2              return SIG_EVENT;
 543   2          case K_TMO:                                 /* 等待超时，即延时一段时间 */
 544   2              OSTimeDly(OSWaitTick[OSTaskID]);
 545   2              return TMO_EVENT;
 546   2          case (K_TMO | K_SIG):                       /* 等待信号（挂起自己）直到超时  */
 547   2                                                      /* 别的任务或中断可以恢复它 */
 548   2              OS_ENTER_CRITICAL();
 549   2              if (OSWaitTick[OSTaskID] == 0)          /* 判断超时时间是否到   */
 550   2              {
C51 COMPILER V9.00   OS_CORE                                                               02/18/2019 14:13:11 PAGE 10  

 551   3                  return TMO_EVENT;
 552   3              }
 553   2              OS_TaskSuspend(OSTaskID);               /* 任务进入等待状态     */
 554   2              OSSched();
 555   2              OS_EXIT_CRITICAL();
 556   2              if (OSWaitTick[OSTaskID] != 0)
 557   2              {
 558   3                  OSWaitTick[OSTaskID] = 0;
 559   3                  return SIG_EVENT;
 560   3              }
 561   2              return TMO_EVENT;
 562   2          default:
 563   2              OSWaitTick[OSTaskID] = 0;
 564   2              return NOT_OK;
 565   2          }
 566   1      }
 567          #endif
 568          /*********************************************************************************************************
 569          **                            End Of File
 570          ********************************************************************************************************/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    378    ----
   CONSTANT SIZE    =      9    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     11    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
